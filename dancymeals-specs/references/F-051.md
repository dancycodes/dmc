# F-051 — User Detail View & Status Toggle

> Module: Admin
> Priority: Must-have
> Precedence: F-050
> Type: functional

---

## What It Does
Displays a comprehensive detail page for a single user within the admin panel. Shows profile information, roles across all tenants, order history summary, wallet balance, and a filtered activity log for this user. Allows toggling the user's active/inactive status. Deactivating a user immediately logs them out and prevents future login. All status changes are logged.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Super-Admin | Views user details, toggles user status |
| Admin | Views user details, toggles user status (cannot deactivate super-admins) |

---

## User Scenarios
### Scenario 1: Viewing user profile
An admin clicks on "Amara Njoh" from the user list. The detail page shows: full name, email, phone, profile photo, preferred language, registration date, last login, and account status.

### Scenario 2: Reviewing user roles
The admin sees a Roles section listing all roles the user holds: "Cook — Chef Amara's Kitchen", "Cook — Amara Catering", "Client (global)". Each tenant role links to the tenant detail page.

### Scenario 3: Deactivating a user
The admin toggles the status to Inactive. A confirmation dialog appears: "Deactivating this user will immediately log them out and prevent future login. Continue?" The admin confirms. The user is deactivated, their sessions are invalidated, and the status badge changes to Inactive.

### Scenario 4: Viewing order history summary
The admin sees an Order Summary section: Total Orders (45), Total Spent (XAF 180,000), as a client. If the user is also a cook, Cook Orders (230), Cook Revenue (XAF 920,000). Links to view full order history.

### Scenario 5: Reviewing activity log
The admin scrolls to the Activity Log section showing recent actions by this user: "Updated meal 'Ndole Special'", "Completed order #1042", "Logged in". Paginated, most recent first.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-097 | Deactivating a user invalidates all their active sessions immediately |
| BR-098 | Deactivated users cannot log in; login attempt shows "Your account has been deactivated" |
| BR-099 | Admins cannot deactivate super-admin accounts (only other super-admins can) |
| BR-100 | Admins cannot deactivate their own account from the admin panel |
| BR-101 | Reactivation allows the user to log in again; no data is lost |
| BR-102 | Status changes are recorded in the activity log with the admin as causer |
| BR-103 | Wallet balance is displayed but cannot be modified from this page |

---

## Data Involved
**Reads:**
- User: name, email, phone, photo, language_preference, is_active, created_at, last_login_at
- User roles (via Spatie): all roles with associated tenants
- Orders: aggregate counts and sums (as client and as cook)
- Wallet: current balance
- Activity log: entries where this user is causer or subject

**Creates:**
- Activity log entry on status change

**Updates:**
- User: is_active field
- Sessions: invalidated on deactivation

**Relationships:**
- F-050: Navigated from user list
- F-047: Tenant links in roles section

---

## Acceptance Criteria
- **Given** a user ID, **when** navigating to the detail page, **then** all profile information is displayed correctly
- **Given** a user with multiple roles, **when** viewing the Roles section, **then** all roles and their associated tenants are listed
- **Given** the status toggle set to Inactive with confirmation, **then** the user is deactivated and their sessions are invalidated
- **Given** a deactivated user, **when** they attempt to log in, **then** they see "Your account has been deactivated"
- **Given** an admin viewing a super-admin's profile, **when** attempting to toggle status, **then** the toggle is disabled
- **Given** activity log entries for the user, **when** viewing the Activity Log section, **then** entries are displayed chronologically

---

## Verification Steps
1. Navigate to a user with multiple roles — confirm all roles and tenant links are displayed
2. Deactivate a user — confirm their sessions are invalidated (user is logged out)
3. Attempt to log in as the deactivated user — confirm login is blocked with appropriate message
4. Reactivate the user — confirm they can log in again
5. Attempt to deactivate a super-admin as a regular admin — confirm the toggle is disabled
6. Check activity log — confirm status change is recorded

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| User has never placed an order | Order summary shows all zeros |
| User has no wallet | Wallet section shows "No wallet" |
| Deactivating a cook with active orders in progress | Orders remain active; another cook or admin must handle them |
| User's profile photo is missing | Default avatar placeholder is shown |
| Admin tries to deactivate themselves | Toggle is disabled with tooltip: "You cannot deactivate your own account" |
| User has hundreds of activity log entries | Activity log section is paginated (10 per page) |

---

## UI/UX Notes
- Top section: user avatar (large), name, email, phone, status badge, action buttons
- Two-column layout on desktop: left column for profile and roles, right for metrics and wallet
- Roles section: each role as a card with tenant name and link
- Order summary: compact cards showing client and cook metrics separately
- Activity log: timeline style with expandable entries for details
- Status toggle is prominent, near the top of the page
- Breadcrumb: Admin > Users > Amara Njoh

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-050 | User Management List | Parent navigation |
| F-047 | Tenant Detail View | Tenant links from roles section |
| F-006 | Spatie Permission Setup | Provides role and permission data |
