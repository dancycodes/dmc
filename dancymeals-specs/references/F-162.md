# F-162 — Order Cancellation

> Module: Order Tracking
> Priority: Must-have
> Precedence: F-161, F-212
> Type: functional

---

## What It Does
Allows a client to cancel their order within the cook's configured cancellation time window. The cancel button is visible on the order detail page with a countdown timer showing the remaining time. Once the timer expires, the button disappears. Cancellation is only available for orders in Paid or Confirmed status. The client must confirm the cancellation via a dialog. Upon cancellation, the order status changes to Cancelled, notifications are sent to the cook, and refund processing is triggered (F-163).

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Cancels their own order within the allowed time window |

---

## User Scenarios
### Scenario 1: Successful cancellation
The client views an order in Paid status, placed 10 minutes ago. The cook's cancellation window is 30 minutes. The cancel button shows "Cancel Order (20:00 remaining)." The client clicks it. A confirmation dialog appears: "Are you sure you want to cancel this order? You will receive a full refund to your wallet." The client confirms. The order status changes to Cancelled. A success toast shows "Order cancelled. Refund will be credited to your wallet."

### Scenario 2: Cancellation window expired
The client views an order placed 45 minutes ago with a 30-minute cancellation window. The cancel button is not visible. A note reads: "The cancellation window for this order has expired."

### Scenario 3: Timer expires while viewing
The client is viewing an order with 2 minutes remaining on the cancellation timer. The countdown ticks down in real-time. When it reaches 0, the cancel button disappears and the expiration note appears.

### Scenario 4: Cancellation from Confirmed status
The order has been confirmed by the cook but is still within the cancellation window. The client can still cancel. The same flow applies.

### Scenario 5: Order already being prepared
The order is in Preparing status (cook has started preparing). The cancel button is not visible regardless of the time window, because cancellation is not allowed after Confirmed status.

### Scenario 6: Client reconsiders
The confirmation dialog appears. The client clicks "Keep Order." The dialog closes and the order remains unchanged.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-236 | Cancellation is allowed only for orders in Paid or Confirmed status |
| BR-237 | The cancellation window is configured per cook (F-212); default is 30 minutes from order placement |
| BR-238 | The countdown timer starts from the order's `created_at` timestamp |
| BR-239 | The cancel button disappears when the window expires (client-side timer + server-side validation) |
| BR-240 | Cancellation requires explicit confirmation via a dialog |
| BR-241 | Server-side validation re-checks both status and time window before processing |
| BR-242 | On successful cancellation, order status is set to Cancelled |
| BR-243 | Cancellation triggers refund processing (F-163) |
| BR-244 | Cook and manager(s) are notified of the cancellation (push + DB) |
| BR-245 | Cancellation is logged via Spatie Activitylog |
| BR-246 | The client can only cancel their own orders |
| BR-247 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `orders` table for status and `created_at` timestamp
- Cook's cancellation window configuration (F-212)
- Current server time for window validation

**Creates:**
- Status transition record (to Cancelled)
- Activity log entry
- Notifications to cook and manager(s)

**Updates:**
- `orders.status` to Cancelled
- `orders.cancelled_at` timestamp

**Relationships:**
- Order belongsTo User (client)
- Order belongsTo Tenant (for cook notification)
- Cancellation triggers F-163 (refund processing)

---

## Acceptance Criteria
- **Given** a Paid order within the cancellation window, **when** the client views the order, **then** the cancel button is visible with a countdown
- **Given** the client clicks cancel and confirms, **when** the cancellation processes, **then** the order status changes to Cancelled
- **Given** the cancellation window has expired, **when** the client views the order, **then** the cancel button is not visible
- **Given** the timer reaches zero while viewing, **when** the countdown expires, **then** the button disappears dynamically
- **Given** an order in Preparing status, **when** the client views the order, **then** the cancel button is not visible regardless of time
- **Given** server-side validation, **when** a crafted request tries to cancel an expired-window order, **then** the server rejects with an error

---

## Verification Steps
1. View a Paid order within the cancellation window — verify cancel button and countdown
2. Click cancel, confirm, and verify status changes to Cancelled
3. Verify the cook receives a cancellation notification
4. Wait for the cancellation window to expire and verify the button disappears
5. Try to cancel an order in Preparing status — verify button is not shown
6. Send a direct API request to cancel an expired-window order — verify server rejects
7. Cancel a Confirmed order within the window — verify it works
8. Check the activity log for the cancellation entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook changes cancellation window after order was placed | Window for existing orders uses the setting at time of order placement |
| Client's internet disconnects during cancellation | On reconnection, client can retry if still within window |
| Cook updates order status to Preparing during client's cancellation attempt | Server-side validation catches the status change; cancellation rejected |
| Cancellation window is set to 0 minutes | No cancellation allowed; cancel button never shown |
| Order was placed exactly at the window boundary | Strict server-side check: window_end = created_at + window_minutes |

---

## UI/UX Notes
- Cancel button styled as a destructive action (red outline or text)
- Countdown timer format: "MM:SS remaining" for under 1 hour, "X hours Y minutes" for longer
- Timer updates every second in real-time (client-side countdown synchronized with server)
- Confirmation dialog: modal with warning icon, clear description of what happens
- Dialog shows: "Cancel this order? A full refund of {amount} XAF will be credited to your wallet."
- "Keep Order" and "Cancel Order" buttons in the dialog
- After cancellation: page refreshes to show Cancelled status
- Note when window expired: "The cancellation window has expired. Contact the cook for assistance."
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-161 | Client Order Detail & Status Tracking | Cancel button appears on this page |
| F-163 | Order Cancellation Refund Processing | Triggered after successful cancellation |
| F-212 | Cancellation Window Configuration | Cook configures the time window used here |
| F-159 | Order Status Transition Validation | Validates the Cancelled transition |
| F-192 | Order Status Update Notifications | Cook notified of cancellation |
