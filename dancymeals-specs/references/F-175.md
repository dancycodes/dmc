# F-175 — Commission Deduction on Completion

> Module: Wallet
> Priority: Must-have
> Precedence: F-169, F-062
> Type: functional

---

## What It Does
When an order is marked as Completed, the platform's commission is calculated and deducted from the order's payment amount before crediting the cook's wallet. Commission is based on the cook's individually configured rate (set by admin in F-062, default 10%). Commission applies to the order subtotal only; delivery fees are excluded. A commission transaction record is created. Commission is only charged on completed orders, never on cancelled or refunded orders.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Automatically calculates and deducts commission on order completion |
| Cook | Sees commission deductions in their wallet transactions |
| Admin | Configured the commission rate per cook (F-062) |

---

## User Scenarios
### Scenario 1: Standard commission deduction
An order is completed with subtotal 5,000 XAF and delivery fee 500 XAF. The cook's commission rate is 10%. Commission = 5,000 * 10% = 500 XAF. The cook receives 5,000 - 500 = 4,500 XAF (subtotal minus commission) plus the delivery fee is handled separately. Total to cook's wallet (unwithdrawable): 5,000 XAF (total order) - 500 XAF (commission) = 4,500 XAF + 500 XAF delivery = 5,000 XAF. Wait, let me clarify: the cook gets the full delivery fee and the subtotal minus commission.

### Scenario 2: Commission on pickup order (no delivery fee)
An order is completed with subtotal 5,000 XAF and no delivery fee (pickup). Commission = 500 XAF. Cook receives 4,500 XAF (unwithdrawable).

### Scenario 3: Cook has a custom commission rate
The admin set this cook's commission rate to 8% (instead of default 10%). An order with 10,000 XAF subtotal has commission of 800 XAF. Cook receives 9,200 XAF.

### Scenario 4: Order cancelled — no commission
An order is cancelled before completion. No commission is deducted. If the order was already in Preparing but then cancelled, still no commission since it never reached Completed.

### Scenario 5: Commission transaction in wallet
The cook views their wallet transactions and sees: "Commission on Order #ORD-1234 — -500 XAF — 10%." The commission is clearly itemized.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-377 | Commission is calculated when order status changes to Completed |
| BR-378 | Commission rate is per-cook, configured by admin (F-062); default 10% |
| BR-379 | Commission = order_subtotal * commission_rate |
| BR-380 | Delivery fee is excluded from commission calculation |
| BR-381 | Commission is never charged on non-completed orders (cancelled, refunded, etc.) |
| BR-382 | The cook's wallet receives: (order_subtotal - commission) + delivery_fee |
| BR-383 | A commission transaction record is created (type: commission_deducted) |
| BR-384 | The commission transaction references the order and shows the rate used |
| BR-385 | Platform revenue from commission is tracked separately for admin reporting |
| BR-386 | Commission deduction is logged via Spatie Activitylog |
| BR-387 | If the commission rate is 0%, no deduction occurs but a 0 XAF record is created for transparency |

---

## Data Involved
**Reads:**
- `orders` table for subtotal and delivery fee
- Cook's commission rate from tenant/admin configuration (F-062)

**Creates:**
- Cook wallet transaction (type: commission_deducted, amount, order reference, rate)
- Platform commission record (for admin revenue tracking)
- Activity log entry

**Updates:**
- Cook wallet balance: credited with (subtotal - commission + delivery_fee) as unwithdrawable
- Order record: `commission_amount` and `commission_rate` fields

**Relationships:**
- CommissionRecord belongsTo Order
- CommissionRecord belongsTo Tenant
- Cook wallet credited after commission deduction
- Triggers F-171 (withdrawable timer starts on the net amount)

---

## Acceptance Criteria
- **Given** an order is completed, **when** commission is calculated, **then** it equals subtotal * commission_rate
- **Given** the delivery fee is 500 XAF, **when** calculating commission, **then** the 500 XAF is excluded
- **Given** the commission is deducted, **when** checking the cook's wallet, **then** the credited amount is subtotal - commission + delivery_fee
- **Given** a cancelled order, **when** checking, **then** no commission was charged
- **Given** a custom commission rate of 8%, **when** an order completes, **then** the correct 8% rate is used
- **Given** commission is deducted, **when** checking transactions, **then** a commission transaction record exists with the rate

---

## Verification Steps
1. Complete an order and verify commission is calculated correctly
2. Verify the commission equals subtotal * rate (delivery fee excluded)
3. Verify the cook's wallet receives the correct net amount
4. Cancel an order and verify no commission was charged
5. Set a custom commission rate for a cook and verify it is used
6. Verify the commission transaction record in the wallet
7. Verify the platform commission record for admin reporting
8. Check the activity log for the commission entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Commission rate is 0% | Cook receives full amount; 0 XAF commission record created |
| Commission rate is 100% | Cook receives only the delivery fee; entire subtotal is commission |
| Order subtotal is 0 XAF (fully promo-covered) | Commission is 0 XAF |
| Commission rate changed after order was placed | Rate at the time of completion is used (current rate, not order-time rate) |
| Rounding: subtotal * rate results in fractional XAF | Round down to nearest whole XAF in cook's favor |
| Order marked Completed and then refunded via complaint | Commission is reversed as part of the refund process |

---

## UI/UX Notes
- No dedicated UI; commission deduction is automatic on order completion
- Cook sees commission in:
  - Wallet transactions (F-170): "Commission on Order #ORD-1234 — -500 XAF — 10%"
  - Wallet dashboard (F-169): net amount reflected in earnings summary
- Admin sees:
  - Commission configured per cook (F-062)
  - Platform revenue in financial reports (F-058)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-169 | Cook Wallet Dashboard | Shows net earnings after commission |
| F-170 | Cook Wallet Transaction History | Shows commission deduction transactions |
| F-062 | Commission Configuration per Cook | Sets the commission rate |
| F-171 | Withdrawable Timer Logic | Timer starts on the net (post-commission) amount |
| F-157 | Single Order Status Update | Completing an order triggers commission deduction |
| F-058 | Financial Reports & Export | Platform commission revenue reported here |
