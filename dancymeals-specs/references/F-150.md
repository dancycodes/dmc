# F-150 â€” Flutterwave Payment Initiation

> Module: Payment
> Priority: Must-have
> Precedence: F-149
> Type: functional

---

## What It Does
Initiates a mobile money payment via the Flutterwave v3 API when the client clicks "Pay Now" with MTN Mobile Money or Orange Money selected. Creates a charge request with the order amount, currency (XAF), customer information, selected payment method (mobile money), and a callback URL. Flutterwave sends a USSD prompt to the customer's phone for authorization. The UI shows a "Waiting for payment confirmation" loading state with a countdown timer. Commission is handled via Flutterwave split payment with the cook's subaccount.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Clicks "Pay Now" and receives a USSD prompt on their phone to authorize payment |
| System | Creates the Flutterwave charge and monitors for completion |

---

## User Scenarios
### Scenario 1: Successful payment initiation
The client clicks "Pay Now" with MTN MoMo selected. The system sends a charge request to Flutterwave. The UI shows "Payment initiated. Check your phone for the USSD prompt." The client's phone receives a push or USSD dialog to authorize the payment of 6,500 XAF.

### Scenario 2: Waiting for confirmation
After initiation, the UI shows a loading state: "Waiting for payment confirmation..." with a 15-minute countdown timer. The client authorizes on their phone. The webhook (F-151) confirms the payment.

### Scenario 3: Payment with split
The charge includes a split payment configuration: 90% goes to the cook's Flutterwave subaccount, 10% (commission) stays with the platform. The split is transparent to the client.

### Scenario 4: Initiation failure
Flutterwave returns an error (e.g., invalid number, service unavailable). The UI shows the error message: "Payment could not be initiated. Please check your phone number and try again."

### Scenario 5: Timeout
The client does not respond to the USSD prompt within 15 minutes. The UI shows "Payment timed out." The order status changes to "Payment Failed" and the retry flow (F-152) begins.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-354 | Payment is initiated via Flutterwave v3 mobile money charge API |
| BR-355 | Charge payload includes: amount, currency (XAF), customer (email, phone, name), payment type (mobilemoneycameroon), callback URL |
| BR-356 | Split payment configured: cook's Flutterwave subaccount receives (100% - commission%), platform keeps commission% |
| BR-357 | Default commission rate is 10%, configurable per cook |
| BR-358 | Order status is set to "Pending Payment" upon initiation |
| BR-359 | A transaction reference is generated and stored with the order |
| BR-360 | The UI shows a "Waiting for payment" loading state after initiation |
| BR-361 | Timeout after 15 minutes if no webhook confirmation received |
| BR-362 | Initiation errors are displayed to the client with actionable messages |
| BR-363 | All text must be localized via `__()` |

---

## Data Involved
**Reads:**
- Order total, customer info (email, phone, name)
- Cook's Flutterwave subaccount ID
- Cook's commission rate
- Payment method and phone number from F-149

**Creates:**
- Order record with status "Pending Payment"
- Transaction record with Flutterwave reference
- Flutterwave charge request

**Updates:**
- Order status to "Pending Payment"

**Relationships:**
- Follows F-149 (Payment Method Selection)
- Webhook response handled by F-151 (Payment Webhook Handling)
- Timeout triggers F-152 (Payment Retry with Timeout)
- Split payment uses cook's Flutterwave subaccount from cook onboarding

---

## Acceptance Criteria
- **Given** the client clicks "Pay Now" with valid details, **when** the charge is created, **then** Flutterwave sends a USSD prompt to the client's phone
- **Given** successful initiation, **when** the UI updates, **then** a "Waiting for payment" state with countdown timer is shown
- **Given** the charge includes split payment, **when** inspecting the Flutterwave payload, **then** the cook subaccount and commission are correctly configured
- **Given** initiation fails, **when** the error response is received, **then** the error message is displayed to the client
- **Given** no response within 15 minutes, **when** the timer expires, **then** "Payment timed out" is shown

---

## Verification Steps
1. Initiate a payment and verify Flutterwave API call is made with correct payload
2. Verify the USSD prompt is sent to the correct phone number
3. Verify the "Waiting for payment" UI state appears with countdown
4. Verify the split payment configuration in the charge payload
5. Verify the transaction reference is stored
6. Simulate an initiation failure and verify error display
7. Wait for timeout and verify the timeout message

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Flutterwave API is down | Show error: "Payment service is temporarily unavailable. Please try again later." |
| Invalid phone number rejected by Flutterwave | Show error with suggestion to check the number |
| Client closes the browser during "Waiting" | Order stays in "Pending Payment"; webhook still processes |
| Duplicate payment attempts | Transaction reference prevents duplicate charges |
| Network error during API call | Retry once; if still failing, show error |
| Cook has no Flutterwave subaccount | Should not reach this point; blocked at cook onboarding validation |

---

## UI/UX Notes
- "Pay Now" button shows loading spinner during API call
- After initiation: full-screen or modal overlay with "Waiting for payment" message
- Phone illustration or animation showing USSD prompt concept
- Countdown timer showing remaining time (15:00, 14:59, etc.)
- "Check your phone" instruction prominently displayed
- "Cancel" option available (cancels the order)
- On successful webhook: redirects to F-154 (Payment Receipt & Confirmation)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-149 | Payment Method Selection | Previous step providing payment details |
| F-151 | Payment Webhook Handling | Processes Flutterwave's response |
| F-152 | Payment Retry with Timeout | Handles timeout and retry logic |
| F-154 | Payment Receipt & Confirmation | Shown after successful payment |
