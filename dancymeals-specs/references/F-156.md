# F-156 â€” Cook Order Detail View

> Module: Order Mgmt
> Priority: Must-have
> Precedence: F-155
> Type: functional

---

## What It Does
Displays the full detail of a single order for the cook or manager. Shows client information (name, phone number), ordered items with their components, quantities, and individual prices, delivery or pickup choice with location details, payment status and method, current order status with a visual timeline of all status transitions, and any notes left by the client. Provides status update buttons to advance the order to the next valid state (see F-157). Includes a link to the order's message thread (F-188). All content is tenant-scoped and updates reactively via Gale.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Views full order details and updates status |
| Manager | Views full order details and updates status if granted `manage-orders` permission |

---

## User Scenarios
### Scenario 1: View order details
The cook clicks an order from the order list. The detail page shows all order information organized in clear sections: client info, items, delivery/pickup, payment, status timeline, and notes.

### Scenario 2: Review ordered items
The cook expands the items section to see each meal ordered, its selected components (e.g., "Ndole with Plantain and Garri"), quantities, and line prices. A subtotal is shown below the items.

### Scenario 3: Check delivery details
The order is for delivery. The cook sees the delivery address (town, quarter, landmark), delivery fee, and the client's phone number for contact.

### Scenario 4: Check pickup details
The order is for pickup. The cook sees the selected pickup location name and address.

### Scenario 5: View status timeline
The cook views a vertical timeline showing each status transition the order has gone through, with timestamps and who triggered each change. The current status is highlighted.

### Scenario 6: Update order status
The cook clicks the "Next Status" button (e.g., "Mark as Preparing"). A confirmation dialog appears. After confirming, the status updates and the timeline refreshes via Gale.

### Scenario 7: View client notes
The client left a note: "No pepper please." The note is displayed prominently in the order detail.

### Scenario 8: Access message thread
The cook clicks "Message Client" to open the order's message thread (F-188) for direct communication about the order.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-166 | Order detail is tenant-scoped; cook can only view orders belonging to their tenant |
| BR-167 | Client phone number is displayed for delivery coordination |
| BR-168 | Items section shows meal name, selected components with quantities, unit prices, and line totals |
| BR-169 | Delivery orders show: town, quarter, landmark/description, delivery fee |
| BR-170 | Pickup orders show: pickup location name and address |
| BR-171 | Status timeline shows all transitions with timestamps and the user who triggered each change |
| BR-172 | The status update button shows the next valid status only (see F-159 for transition rules) |
| BR-173 | Payment information shows: method (MTN MoMo/Orange Money/Wallet), amount, status, Flutterwave reference |
| BR-174 | Order notes from the client are displayed if present |
| BR-175 | Only users with `manage-orders` permission can access the order detail view |
| BR-176 | All amounts are displayed in XAF format |
| BR-177 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `orders` table for order data
- `users` table for client name, phone
- `order_items` table for items with components
- `meals` table for meal names
- `meal_components` table for component details
- `order_status_history` or activity log for status timeline
- Delivery/pickup location data
- Payment transaction data

**Creates:**
- Nothing (display only; status updates handled by F-157)

**Updates:**
- Nothing

**Relationships:**
- Order belongsTo User (client)
- Order hasMany OrderItem
- OrderItem belongsTo Meal
- OrderItem hasMany selected MealComponents
- Order hasOne delivery/pickup location reference
- Order hasMany StatusTransitions (or logged via Activitylog)

---

## Acceptance Criteria
- **Given** a cook clicks an order from the list, **when** the detail page loads, **then** all order sections are displayed correctly
- **Given** an order with items, **when** viewing the items section, **then** each item shows meal name, components, quantities, and prices
- **Given** a delivery order, **when** viewing delivery details, **then** town, quarter, landmark, and delivery fee are shown
- **Given** a pickup order, **when** viewing pickup details, **then** the pickup location name and address are shown
- **Given** status transitions have occurred, **when** viewing the timeline, **then** all transitions are listed with timestamps
- **Given** the order has a client note, **when** viewing the detail, **then** the note is prominently displayed
- **Given** the order has a next valid status, **when** viewing the detail, **then** a status update button is visible

---

## Verification Steps
1. Click an order from the order list and confirm the detail page loads
2. Verify client name and phone number are displayed
3. Verify items with components, quantities, and prices are listed correctly
4. Verify delivery details for a delivery order
5. Verify pickup details for a pickup order
6. Verify the status timeline shows all transitions with timestamps
7. Verify the status update button shows the correct next status
8. Verify the "Message Client" link navigates to the message thread
9. Verify client notes are displayed when present
10. Verify payment information is shown (method, amount, reference)

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Order has no client notes | Notes section hidden or shows "No notes" |
| Order is in Completed status | No status update button shown (terminal state) |
| Order is Cancelled or Refunded | Status update button hidden; status badge shows final state |
| Client account was deactivated after ordering | Client info still displayed; no impact on order view |
| Order has many items (10+) | Items section is scrollable or expandable |
| Cook accesses order from another tenant | 403 Forbidden response |

---

## UI/UX Notes
- Back navigation link to order list at the top
- Order ID and current status badge prominently displayed in the header
- Sections organized as cards: Client Info, Order Items, Delivery/Pickup, Payment, Status Timeline, Notes
- Status update button is a prominent CTA, positioned in the header area or floating on mobile
- Timeline uses a vertical line with dots for each status, timestamps on the side
- "Message Client" button with a chat icon
- Cook's WhatsApp link for the client displayed alongside phone number
- Mobile-first layout with stacked cards
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-155 | Cook Order List View | Navigates to this detail view when clicking an order |
| F-157 | Single Order Status Update | Status update button triggers this feature |
| F-159 | Order Status Transition Validation | Validates which status transitions are allowed |
| F-188 | Order Message Thread View | "Message Client" link opens this feature |
| F-134 | WhatsApp Contact & Social Links | Cook's WhatsApp contact info |
