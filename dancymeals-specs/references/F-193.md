# F-193 — Complaint Notifications

> Module: Notification
> Priority: Must-have
> Precedence: F-014, F-015, F-183
> Type: functional

---

## What It Does
Defines the notification behavior for all complaint lifecycle events. When a complaint is submitted, the cook/manager gets push + DB. When the cook responds, the client gets push + DB. When a complaint is escalated, the admin gets push + DB, the client gets push + DB, and the cook gets push + DB. When a complaint is resolved, the client gets push + DB + email with resolution details. This ensures all parties stay informed throughout the complaint process.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Receives notifications for cook response, escalation, and resolution |
| Cook | Receives notification for new complaint and escalation |
| Manager | Receives notification for new complaint if granted `manage-complaints` permission |
| Admin | Receives notification for escalated complaints |

---

## User Scenarios
### Scenario 1: Complaint submitted — cook notified
A client files a complaint. The cook receives push + DB: "New complaint on Order #1234 — Food Quality." Managers with complaint permissions also receive the notification.

### Scenario 2: Cook responds — client notified
The cook responds to the complaint with a partial refund offer. The client receives push + DB: "Chef Latifa responded to your complaint on Order #1234."

### Scenario 3: Complaint escalated — all parties notified
The 24-hour window expires without a cook response. Admin receives push + DB: "Complaint escalated — Order #1234 (no cook response)." Client receives: "Your complaint has been escalated to our support team." Cook receives: "Your complaint on Order #1234 was escalated due to no response."

### Scenario 4: Complaint resolved — client gets email
The admin resolves the complaint with a full refund. The client receives push + DB + email. Email subject: "Complaint Resolved — Order #1234." Email body includes: resolution type (full refund), refund amount, and any admin notes.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-289 | Complaint submitted: cook + managers with `manage-complaints` receive push + DB |
| BR-290 | Cook responds: client receives push + DB |
| BR-291 | Complaint escalated: admin receives push + DB; client receives push + DB; cook receives push + DB |
| BR-292 | Complaint resolved: client receives push + DB + email |
| BR-293 | Email is sent ONLY on resolution (not for other complaint events) |
| BR-294 | Resolution email includes: order ID, complaint category, resolution type, refund amount (if applicable), admin notes |
| BR-295 | All push and DB notifications link to the complaint detail/tracking page (F-187) |
| BR-296 | Admin escalation notifications link to the complaint in the admin panel |
| BR-297 | Notifications are queued to not block the triggering action |
| BR-298 | All notification text must use `__()` localization |

---

## Data Involved
**Creates:**
- Push notifications per event per recipient
- DB notification records per event per recipient
- Email to client on resolution

**Reads:**
- `complaints` table for complaint details
- `orders` table for order context
- `users` table for recipient contact info
- `tenants` table for tenant association (managers)

**Updates:**
- Nothing

**Relationships:**
- Notification references Complaint and Order

---

## Acceptance Criteria
- **Given** a new complaint, **when** submitted, **then** cook and managers receive push + DB
- **Given** a cook response, **when** submitted, **then** client receives push + DB
- **Given** escalation, **when** triggered, **then** admin, client, and cook each receive push + DB
- **Given** resolution, **when** processed, **then** client receives push + DB + email with details
- **Given** any complaint notification, **when** tapped, **then** it navigates to the complaint detail
- **Given** resolution email, **when** opened, **then** it includes resolution type and refund amount if applicable

---

## Verification Steps
1. Submit a complaint and verify cook receives push + DB notification
2. Respond as cook and verify client receives push + DB notification
3. Trigger auto-escalation and verify admin, client, and cook all receive notifications
4. Resolve complaint and verify client receives push + DB + email
5. Open resolution email and verify it contains correct resolution details
6. Tap push notification and verify navigation to complaint detail
7. Verify no email is sent for events other than resolution

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Admin resolves without prior escalation | Client still receives resolution push + DB + email |
| Multiple admins in the system | All admins receive escalation notifications |
| Cook responds after escalation | Client receives response notification; complaint remains escalated |
| Complaint resolved with "dismiss" (no refund) | Email states "Complaint reviewed — no action required" |
| Complaint resolved with "warn cook" | Client email states "Resolved — action taken"; no details about warning |

---

## UI/UX Notes
- Complaint notifications use a warning/alert icon in the notification center
- DB notifications in the center show complaint category badge and order ID
- Push notification text is concise and action-oriented
- Resolution email follows branded template with a prominent resolution summary card
- Email resolution card color: green for dismiss, blue for partial refund, orange for full refund
- "View Complaint" button in email links to the complaint tracking page

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-014 | PWA & Push Notification Infrastructure | Push delivery mechanism |
| F-015 | Notification Center | Displays DB notifications |
| F-183 | Client Complaint Submission | Triggers "complaint submitted" notification |
| F-184 | Cook/Manager Complaint Response | Triggers "cook responded" notification |
| F-185 | Complaint Auto-Escalation | Triggers "escalated" notifications |
| F-187 | Complaint Status Tracking | Destination when notification is tapped |
