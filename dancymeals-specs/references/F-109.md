# F-109 — Meal Image Upload & Carousel

> Module: Meal
> Priority: Must-have
> Precedence: F-108
> Type: functional

---

## What It Does
Allows a cook to upload images for a meal (maximum 3), reorder them via drag-and-drop, and preview them as an auto-animated carousel. Images are displayed on the tenant landing page in meal cards and the meal detail view. Supports jpg, png, and webp formats with a maximum file size of 2MB per image. Images are processed (resized and optimized) on upload. Individual images can be deleted. Managed via Gale from the meal edit page.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Uploads, reorders, and manages meal images |
| Manager | Manages images if granted `manage-meals` permission |
| Client | Views the image carousel on the tenant landing page and meal detail view |

---

## User Scenarios
### Scenario 1: Upload first image
The cook opens the meal edit page and navigates to the Images section. They click "Upload Image," select a jpg file (1.5 MB), and the image uploads via Gale. The image is processed, a thumbnail is generated, and it appears in the image preview area.

### Scenario 2: Upload maximum images
The cook uploads 3 images. The upload button becomes disabled or hidden. A message shows "Maximum 3 images reached."

### Scenario 3: Reorder images
The cook has 3 images and drags the third image to the first position. The order updates via Gale. The carousel on the public page now shows this image first.

### Scenario 4: Delete an image
The cook clicks the delete (X) button on the second image. A confirmation prompt appears. After confirming, the image is removed and the remaining images reorder automatically.

### Scenario 5: Upload an invalid file
The cook tries to upload a 5MB png. Validation fails: "Image must be 2MB or smaller." The cook tries uploading a .gif file. Validation fails: "Only jpg, png, and webp files are accepted."

### Scenario 6: Carousel preview
After uploading 2 images, the cook sees an auto-animated carousel preview that cycles between the images with a smooth transition.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-198 | Maximum 3 images per meal |
| BR-199 | Accepted formats: jpg/jpeg, png, webp |
| BR-200 | Maximum file size: 2MB per image |
| BR-201 | Images are resized/optimized on upload (maintain aspect ratio, max dimensions suitable for web) |
| BR-202 | A thumbnail version is generated for meal cards |
| BR-203 | Images can be reordered via drag-and-drop; order determines carousel sequence |
| BR-204 | First image in order is the primary/hero image shown on meal cards |
| BR-205 | Individual images can be deleted with confirmation |
| BR-206 | Images are tenant-scoped and meal-scoped |
| BR-207 | Only users with `manage-meals` permission can manage images |
| BR-208 | Image upload/delete is logged via Spatie Activitylog |
| BR-209 | Images are stored using the configured filesystem disk (local or cloud) |

---

## Data Involved
**Creates:**
- `MealImage` model with fields: `id`, `meal_id`, `path`, `thumbnail_path`, `position` (integer), `original_filename`, `mime_type`, `file_size`, `created_at`, `updated_at`
- Migration for `meal_images` table
- Stored image files (original + thumbnail)
- Factory for MealImage

**Reads:**
- Existing images for count validation and ordering
- Meal record for scoping

**Updates:**
- MealImage positions on reorder

**Deletes:**
- MealImage record and associated files on delete

**Relationships:**
- MealImage belongsTo Meal
- Meal hasMany MealImages (ordered by position)

---

## Acceptance Criteria
- **Given** a meal with no images, **when** the cook uploads a valid jpg, **then** the image is processed and displayed
- **Given** a meal with 3 images, **when** the cook tries to upload another, **then** the upload is blocked
- **Given** 3 images, **when** the cook drags image 3 to position 1, **then** the order updates and persists
- **Given** an image, **when** the cook clicks delete and confirms, **then** the image is removed
- **Given** a file over 2MB, **when** uploaded, **then** validation fails with a size error
- **Given** a .gif file, **when** uploaded, **then** validation fails with a format error
- **Given** multiple images, **when** viewing the meal, **then** an auto-animated carousel displays them

---

## Verification Steps
1. Upload a valid image — confirm it appears with a thumbnail
2. Upload 3 images — confirm the upload button is disabled
3. Reorder images via drag-and-drop — confirm new order persists
4. Delete an image — confirm it is removed and files are cleaned up
5. Upload a file over 2MB — confirm validation error
6. Upload a non-supported format — confirm validation error
7. View the carousel preview — confirm auto-animation works
8. Check public-facing meal card — confirm primary image displays

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Upload interrupted (network failure) | Partial upload cleaned up; error message shown |
| Image with EXIF orientation data | Auto-rotated to correct orientation on processing |
| Very small image (e.g., 10x10px) | Accepted but may look low quality; no minimum dimension enforced |
| All images deleted from a live meal | Meal remains live but shows a placeholder image on the landing page |
| Concurrent uploads of multiple images | Handled sequentially; count validated before each save |

---

## UI/UX Notes
- Images section on the meal edit page with dropzone for upload
- Click or drag-to-upload interaction
- Upload progress indicator per image
- Image preview grid (1-3 images) with drag handles for reordering
- Delete button (X icon) on each image with hover/tap reveal
- Auto-animated carousel preview below the image grid
- Carousel: smooth cross-fade or slide transition, 3-4 second interval
- Mobile: tap to cycle through images, swipe support
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-108 | Meal Creation Form | Creates the meal these images belong to |
| F-110 | Meal Edit | Images section is part of the meal edit page |
| F-128 | Available Meals Grid Display | Shows primary image on meal cards |
| F-129 | Meal Detail View | Shows full carousel on meal detail page |
