# F-199 â€” Reorder from Past Order

> Module: Favorites
> Priority: Should-have
> Precedence: F-160
> Type: functional

---

## What It Does
Adds a "Reorder" button on the detail page of past completed orders. When clicked, the system copies the same meal components and quantities from the original order into a new cart for the same cook's tenant. The user is redirected to the cook's tenant domain with the cart pre-filled. The system handles edge cases: unavailable components trigger a warning, price changes are shown with the new prices, and deleted meals show an error with an explanation.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Clicks "Reorder" on a past completed order to quickly place the same order again |

---

## User Scenarios
### Scenario 1: Successful reorder
The client views a past completed order for "Ndole x2, Plantains x1" from Chef Latifa. They click "Reorder." They are redirected to `latifa.dm.test` with a cart containing Ndole x2 and Plantains x1 at current prices. They proceed to checkout.

### Scenario 2: Price changed since original order
The client clicks "Reorder." Ndole was 2,500 XAF but is now 3,000 XAF. The cart shows the new price of 3,000 XAF with a note: "Price updated from 2,500 XAF to 3,000 XAF." The client can adjust quantities or proceed.

### Scenario 3: A meal component is unavailable
The client clicks "Reorder." Plantains have been marked as unavailable by the cook. A warning modal appears: "1 item from your original order is currently unavailable: Plantains. The remaining items have been added to your cart." The cart contains only Ndole x2.

### Scenario 4: All meals deleted
The client clicks "Reorder" on an old order. All meals from the original order have been deleted. An error message appears: "Sorry, the meals from this order are no longer available." The reorder cannot proceed.

### Scenario 5: Cook's tenant is deactivated
The client clicks "Reorder." The cook's tenant is no longer active. An error message appears: "This cook is no longer available on DancyMeals."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-356 | Reorder button appears only on Completed or Delivered orders |
| BR-357 | Clicking Reorder creates a new cart for the same tenant with the same items and quantities |
| BR-358 | Prices are always set to the current prices (not the original order's prices) |
| BR-359 | If a meal's price has changed, a visual note shows the old and new price |
| BR-360 | If a meal/component is unavailable (inactive or out of stock), it is excluded from the cart with a warning |
| BR-361 | If a meal has been deleted, it is excluded with an explanation |
| BR-362 | If all items are unavailable or deleted, the reorder fails with a clear error message |
| BR-363 | If the cook's tenant is inactive, the reorder fails with an error |
| BR-364 | The user is redirected to the cook's tenant domain with the cart pre-filled |
| BR-365 | If the user already has items in a cart for a different tenant, they are warned about replacing the cart |
| BR-366 | Reorder respects the cook's current minimum order amount (F-213) |
| BR-367 | All user-facing text must use `__()` localization |

---

## Data Involved
**Creates:**
- New cart entries (session or database) for the tenant with the reordered items

**Reads:**
- Original `order_items` for meal IDs and quantities
- `meals` table for current availability, prices, and status
- `tenants` table for tenant status and domain
- Existing cart data to check for conflicts

**Updates:**
- Cart: replaces or merges items for the target tenant

**Relationships:**
- OrderItem belongsTo Meal
- Order belongsTo Tenant
- Cart belongsTo Tenant (session-scoped)

---

## Acceptance Criteria
- **Given** a completed order with all items still available, **when** the client clicks "Reorder," **then** they are redirected to the tenant with a pre-filled cart
- **Given** a price change on one item, **when** reordering, **then** the new price is shown with a note about the change
- **Given** one unavailable item, **when** reordering, **then** a warning is shown and the available items are added to the cart
- **Given** all items unavailable, **when** reordering, **then** an error message is shown and no redirect happens
- **Given** an inactive tenant, **when** reordering, **then** an error message is shown
- **Given** an existing cart for a different tenant, **when** reordering, **then** a confirmation prompt asks about replacing the cart

---

## Verification Steps
1. Reorder a past order with all items available; verify cart is correctly populated
2. Change a meal's price and reorder; verify the new price is shown with a note
3. Mark a meal as unavailable and reorder; verify the warning and partial cart
4. Delete all meals from an old order and attempt reorder; verify error message
5. Deactivate a tenant and attempt reorder; verify error message
6. Have an existing cart for a different tenant and reorder; verify confirmation prompt
7. Complete the reorder flow through checkout to verify cart integrity
8. Verify the minimum order amount is enforced on the new cart

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Original order had a promo code applied | Promo is NOT re-applied; cart shows full current prices |
| Meal quantity exceeds current stock/availability | Quantity capped at available amount; user notified |
| Cook changed meal components since original order | Current meal configuration is used; differences may confuse user |
| Order from months ago with many changes | Best-effort matching; clear messaging about what changed |
| User is not logged in | Login prompt; after login, reorder proceeds |
| Reorder on mobile | Same flow but tenant redirect opens in the current tab |

---

## UI/UX Notes
- "Reorder" button prominently placed on the order detail page (primary action style)
- Icon: refresh/repeat icon alongside the text
- Loading state while checking item availability
- Warning modal/banner: lists unavailable items with explanations
- Price change notes inline on each affected item in the cart
- Confirmation dialog if replacing an existing cart
- Redirect transition: brief loading screen with "Preparing your cart..." message
- Error states: clear, actionable messages with links to discovery page as fallback
- All interactions via Gale until the cross-domain redirect

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-160 | Client Order Detail View | Reorder button appears on this page |
| F-146 | Cart Management | Pre-fills the cart with reorder items |
| F-213 | Minimum Order Amount Configuration | Cart must meet minimum order amount |
| F-126 | Tenant Landing Page | Destination after redirect |
