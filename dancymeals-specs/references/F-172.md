# F-172 â€” Cook Withdrawal Request

> Module: Wallet
> Priority: Must-have
> Precedence: F-169
> Type: functional

---

## What It Does
Allows the cook to request a withdrawal of funds from their withdrawable wallet balance to their mobile money account. The cook enters the withdrawal amount (up to their withdrawable balance), confirms their mobile money number, and submits the request. Platform-configurable minimum and maximum withdrawal amounts are enforced. A confirmation dialog reviews the details before submission. The request creates a withdrawal record that is then processed via Flutterwave Transfer (F-173).

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Requests withdrawal from the cook dashboard wallet section |

---

## User Scenarios
### Scenario 1: Standard withdrawal
The cook has 35,000 XAF withdrawable. They click "Withdraw," enter 20,000 XAF, confirm their mobile money number (670-123-456 MTN), and submit. A confirmation dialog shows: "Withdraw 20,000 XAF to MTN MoMo 670-123-456?" The cook confirms. The withdrawal is queued for processing.

### Scenario 2: Withdraw full balance
The cook enters their full withdrawable balance (35,000 XAF). The withdrawal request is submitted for the full amount.

### Scenario 3: Below minimum amount
The cook tries to withdraw 500 XAF but the platform minimum is 1,000 XAF. A validation error shows: "Minimum withdrawal amount is 1,000 XAF."

### Scenario 4: Exceeds daily maximum
The cook has already withdrawn 50,000 XAF today and tries to withdraw another 20,000 XAF. The platform daily maximum is 50,000 XAF. A validation error shows: "Daily withdrawal limit reached (50,000 XAF). Try again tomorrow."

### Scenario 5: Exceeds withdrawable balance
The cook has 10,000 XAF withdrawable and tries to withdraw 15,000 XAF. Validation error: "Insufficient withdrawable balance. Available: 10,000 XAF."

### Scenario 6: Mobile money number confirmation
The withdrawal form pre-fills the cook's registered mobile money number. The cook can update it if needed. The number is validated for format (Cameroon mobile number).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-344 | Withdrawal amount must be > 0 and <= withdrawable balance |
| BR-345 | Minimum withdrawal amount is platform-configurable (default 1,000 XAF) |
| BR-346 | Maximum daily withdrawal amount is platform-configurable (default 500,000 XAF) |
| BR-347 | Daily withdrawal limit is calculated from midnight to midnight (local time) |
| BR-348 | Cook must confirm their mobile money number before submitting |
| BR-349 | Mobile money number is validated for Cameroon format (MTN or Orange) |
| BR-350 | A confirmation dialog shows the amount and destination before final submission |
| BR-351 | Submitting the request creates a withdrawal record with status "pending" |
| BR-352 | The withdrawable balance is decremented immediately upon request submission (optimistic lock) |
| BR-353 | Only the cook can initiate withdrawals (not managers) |
| BR-354 | Withdrawal request is logged via Spatie Activitylog |
| BR-355 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `cook_wallets` for withdrawable balance
- Cook's registered mobile money number
- Platform settings for minimum/maximum amounts
- Today's withdrawal total for daily limit check

**Creates:**
- `withdrawal_requests` record (amount, mobile_money_number, status: pending, requested_at)
- Activity log entry

**Updates:**
- `cook_wallets.withdrawable_amount` decremented by withdrawal amount

**Relationships:**
- WithdrawalRequest belongsTo CookWallet
- WithdrawalRequest belongsTo Tenant
- Triggers F-173 (Flutterwave Transfer Execution)

---

## Acceptance Criteria
- **Given** a cook with withdrawable balance, **when** they enter a valid amount and confirm, **then** a withdrawal request is created
- **Given** the amount is below the minimum, **when** submitting, **then** a validation error is shown
- **Given** the daily limit has been reached, **when** submitting, **then** a validation error is shown
- **Given** the amount exceeds the withdrawable balance, **when** submitting, **then** a validation error is shown
- **Given** a valid request, **when** the confirmation dialog is shown, **then** the amount and mobile money number are displayed
- **Given** the cook confirms, **when** the request is submitted, **then** the withdrawable balance decreases immediately

---

## Verification Steps
1. Submit a valid withdrawal request and verify the record is created
2. Verify the withdrawable balance decreases after submission
3. Try to withdraw below the minimum amount â€” verify validation error
4. Try to withdraw above the daily maximum â€” verify validation error
5. Try to withdraw more than the withdrawable balance â€” verify validation error
6. Verify the confirmation dialog displays correct details
7. Verify the mobile money number validation works
8. Check the activity log for the withdrawal request entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook submits two withdrawal requests simultaneously | First succeeds; second sees updated (lower) balance |
| Mobile money number format is wrong | Validation error: "Invalid mobile money number format" |
| Cook changes mobile money number on the form | New number is used for this withdrawal only; does not update profile |
| Withdrawal amount has decimals | Amounts are in whole XAF; decimals are rounded or rejected |
| Platform settings change between form load and submission | Server re-validates at submission time |
| Cook has pending deduction (F-174) | Pending deductions do not affect withdrawable balance (deductions apply to future earnings) |

---

## UI/UX Notes
- Accessed from the "Withdraw" button on the cook wallet dashboard
- Form fields: withdrawal amount (number input), mobile money number (pre-filled, editable)
- Available balance displayed prominently above the amount field
- Real-time validation as the cook types the amount
- Confirmation dialog: modal with summary of amount, destination, and estimated arrival
- Success message: "Withdrawal request submitted. Funds will be sent to your mobile money account shortly."
- Back link to wallet dashboard
- Mobile-first layout
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-169 | Cook Wallet Dashboard | Withdrawal button lives here |
| F-173 | Flutterwave Transfer Execution | Processes the withdrawal request |
| F-063 | Platform Settings Management | Configures minimum/maximum amounts |
| F-170 | Cook Wallet Transaction History | Shows withdrawal transactions |
