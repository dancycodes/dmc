# F-118 — Meal Component Creation

> Module: Meal Component
> Priority: Must-have
> Precedence: F-108
> Type: functional

---

## What It Does
Allows a cook to create a meal component within a meal. Meal components are the sellable items (combos) within a meal. For example, within a "Ndole Meal" there could be components like "Ndole + Plantain" at 1000 XAF/plate and "Ndole + Rice" at 1200 XAF/plate. Each component has a name (English and French), a price in XAF, a selling unit (selected from standard units or cook-defined custom units), minimum quantity, maximum quantity, and available quantity. Components are created via Gale from the meal edit page.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Creates meal components (sellable combos) within a meal |
| Manager | Creates components if granted `manage-meals` permission |

---

## User Scenarios
### Scenario 1: Create a basic component
The cook opens the "Ndole Meal" edit page, navigates to the Components section, and clicks "Add Component." They enter: name_en: "Ndole + Plantain", name_fr: "Ndole + Plantain", price: 1000, unit: "plate", min qty: 0, max qty: unlimited, available qty: unlimited. The component is saved and appears in the component list.

### Scenario 2: Create a component with quantity limits
The cook creates "Special Pot" with: price 5000 XAF, unit "pot", min qty 1, max qty 3, available qty 10. Clients must order at least 1 and at most 3, and only 10 are available.

### Scenario 3: Create a component with custom unit
The cook selects a custom unit "calabash" (defined in F-121) for a component. The unit is stored and displayed on the client-facing pages.

### Scenario 4: Missing required fields
The cook tries to save a component without a name. Validation fails: "Name is required in both English and French."

### Scenario 5: First component enables going live
After creating the first component for a draft meal, the cook can now toggle the meal to "live" status (F-112).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-278 | Component name is required in both English and French |
| BR-279 | Component name max length: 150 characters per language |
| BR-280 | Price is required, stored as integer (XAF), minimum 1 XAF |
| BR-281 | Selling unit is required, selected from standard units + cook custom units |
| BR-282 | Standard units: plate, bowl, pot, cup, piece, portion, serving, pack |
| BR-283 | Minimum quantity defaults to 0 (no minimum enforced) |
| BR-284 | Maximum quantity defaults to unlimited (null) |
| BR-285 | Available quantity defaults to unlimited (null) |
| BR-286 | A meal must have at least 1 component to go live (validated in F-112) |
| BR-287 | Components are meal-scoped and tenant-scoped |
| BR-288 | Only users with `manage-meals` permission can create components |
| BR-289 | Component creation is logged via Spatie Activitylog |
| BR-290 | Component has a `position` field for display ordering |
| BR-291 | Default availability is true (is_available = true) |

---

## Data Involved
**Creates:**
- `MealComponent` model with fields: `id`, `meal_id`, `name_en`, `name_fr`, `price` (integer, XAF), `selling_unit_id` (foreign key to selling_units table), `min_quantity` (integer, default 0), `max_quantity` (nullable integer, null = unlimited), `available_quantity` (nullable integer, null = unlimited), `is_available` (boolean, default true), `position` (integer), `created_at`, `updated_at`
- Migration for `meal_components` table
- Factory and seeder for MealComponent
- Form Request class for component validation

**Reads:**
- Available selling units (standard + custom from F-121)
- Existing components for positioning
- Meal record for scoping

**Updates:**
- Nothing (creation only)

**Relationships:**
- MealComponent belongsTo Meal
- MealComponent belongsTo SellingUnit
- MealComponent hasMany ComponentRequirementRules (F-122)

---

## Acceptance Criteria
- **Given** a meal, **when** the cook creates a component with valid data, **then** it appears in the component list
- **Given** missing name fields, **when** submitted, **then** validation fails
- **Given** a price of 0, **when** submitted, **then** validation fails (minimum 1 XAF)
- **Given** a custom selling unit, **when** selected, **then** the component stores the unit reference
- **Given** the first component for a meal, **when** created, **then** the meal can now go live
- **Given** min/max/available as defaults, **when** saved, **then** min is 0 and max/available are null (unlimited)

---

## Verification Steps
1. Create a component with all fields — confirm it saves and appears
2. Create a component with default quantities — confirm defaults are applied
3. Create a component with a custom unit — confirm the unit is stored
4. Attempt creation without a name — confirm validation error
5. Attempt creation with price 0 — confirm validation error
6. Verify the meal can go live after adding the first component
7. Check activity log for the creation entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Very high price (e.g., 1,000,000 XAF) | Accepted; no practical maximum enforced |
| Component name with accents | Stored and displayed correctly |
| Min quantity > max quantity | Validation error |
| Available quantity is 0 | Component auto-toggles to unavailable (F-124) |
| Multiple components with the same name in the same meal | Allowed (not enforced unique) |

---

## UI/UX Notes
- Component section on the meal edit page
- "Add Component" button at the top of the section
- Form in a modal or expandable section
- Fields: name_en, name_fr, price (numeric input with "XAF" label), selling unit (dropdown), min qty, max qty, available qty
- Min/max/available default to "No limit" or "Unlimited" placeholder
- Price displayed with XAF formatting (e.g., "1,000 XAF")
- Form submission via Gale
- Toast on success
- Mobile-friendly stacked form

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-108 | Meal Creation Form | Creates the meal that components belong to |
| F-112 | Meal Status Toggle | Requires at least 1 component for live status |
| F-119 | Meal Component Edit | Edit components created here |
| F-120 | Meal Component Delete | Delete components created here |
| F-121 | Custom Selling Unit Definition | Provides custom units for selection |
| F-122 | Meal Component Requirement Rules | Dependency rules between components |
| F-125 | Meal Component List View | Lists components created here |
| F-138 | Meal Component Selection & Cart Add | Clients select components for ordering |
