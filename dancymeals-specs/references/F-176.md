# F-176 — Order Rating Prompt

> Module: Rating
> Priority: Must-have
> Precedence: F-161
> Type: functional

---

## What It Does
After an order is marked as Completed, prompts the client to rate their experience with a 1-5 star selector. The rating prompt appears on the order detail page (F-161) and also as a notification/banner encouraging the client to rate. Each order can be rated only once. Once submitted, the rating cannot be changed. The prompt shows whether the order has already been rated. The rating is associated with the order and contributes to the cook's overall rating (F-179) and the meal's rating display (F-178).

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Rates a completed order with 1-5 stars |

---

## User Scenarios
### Scenario 1: Rate after completion
The client views a recently completed order. A rating section appears: "How was your experience?" with 5 star icons. The client taps 4 stars. The stars fill to 4. The client can then add an optional review (F-177) and submit.

### Scenario 2: Rating notification
After order completion, the client receives a notification: "Rate your order from Chef Latifa!" Clicking the notification opens the order detail page with the rating prompt highlighted.

### Scenario 3: Already rated
The client revisits a completed order they already rated. Instead of the rating prompt, they see: "You rated this order: 4/5 stars" with the review text (if any). No option to change.

### Scenario 4: Skip rating
The client sees the rating prompt but chooses not to rate. The prompt remains on the order detail page for future visits. No reminder is sent more than once.

### Scenario 5: Rate with 1 star
The client had a poor experience. They select 1 star. The system accepts the rating without requiring additional justification (though the optional review field is available).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-388 | Rating is available only for orders with Completed status |
| BR-389 | Rating scale is 1-5 stars (integer only) |
| BR-390 | Each order can be rated exactly once |
| BR-391 | Once submitted, the rating cannot be edited or deleted by the client |
| BR-392 | The rating prompt appears on the order detail page for unrated completed orders |
| BR-393 | A notification is sent to the client after order completion to encourage rating |
| BR-394 | The rating is associated with the order, the client, and the meal(s) in the order |
| BR-395 | Submitting a rating triggers recalculation of the cook's overall rating (F-179) |
| BR-396 | The cook is notified of new ratings (push + DB) |
| BR-397 | Rating submission is logged via Spatie Activitylog |
| BR-398 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `orders` table for status and existing rating
- `ratings` table to check if the order has been rated

**Creates:**
- `ratings` record: order_id, user_id (client), stars (1-5), created_at
- Cook notification (push + DB)
- Activity log entry

**Updates:**
- Cook's overall rating (recalculated via F-179)
- Meal's average rating (for display via F-178)

**Relationships:**
- Rating belongsTo Order
- Rating belongsTo User (client)
- Order belongsTo Tenant (for cook association)
- Rating triggers F-179 (overall rating recalculation)

---

## Acceptance Criteria
- **Given** a completed order without a rating, **when** viewing the order detail, **then** the rating prompt is displayed
- **Given** the client selects stars, **when** submitting, **then** the rating is saved and the prompt is replaced by the submitted rating
- **Given** a rated order, **when** revisiting, **then** the submitted rating is displayed (no edit option)
- **Given** an order not yet completed, **when** viewing the detail, **then** no rating prompt is shown
- **Given** the rating is submitted, **when** checking the cook's notifications, **then** a rating notification was sent
- **Given** the rating is submitted, **when** checking the cook's overall rating, **then** it has been recalculated

---

## Verification Steps
1. Complete an order and verify the rating prompt appears on the detail page
2. Select a star rating and submit — verify it is saved
3. Revisit the order and verify the submitted rating is displayed (no edit)
4. Verify the cook receives a notification about the new rating
5. Verify the cook's overall rating is recalculated
6. View an in-progress order and verify no rating prompt appears
7. Verify the rating notification is sent to the client after completion

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Client tries to rate via API after already rating | Server rejects: "This order has already been rated" |
| Order is refunded after being rated | Rating remains; it reflects the client's experience |
| Client rates 0 stars (invalid) | Validation error: minimum 1 star |
| Multiple meals in one order | One rating per order (not per meal); rating covers the entire experience |
| Cook has no prior ratings | First rating sets the overall rating |

---

## UI/UX Notes
- Rating section appears prominently on the order detail page for completed, unrated orders
- 5 star icons in a row; tap/click to select (stars fill up to the selected one)
- Stars are interactive: hovering shows preview, clicking sets the value
- Below the stars: optional review text field (F-177)
- "Submit Rating" button below the review field
- After submission: stars become static, showing the submitted rating
- Rating notification as a banner or card on the client's order list
- Mobile: stars are large and easy to tap
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-161 | Client Order Detail & Status Tracking | Rating prompt appears on this page |
| F-177 | Order Review Text Submission | Optional text review submitted with the rating |
| F-178 | Rating & Review Display on Meal | Ratings displayed on meal pages |
| F-179 | Cook Overall Rating Calculation | Rating contributes to cook's overall score |
| F-130 | Ratings Summary Display | Summary on tenant landing page |
