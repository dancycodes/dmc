# F-061 — Admin Complaint Resolution

> Module: Admin
> Priority: Must-have
> Precedence: F-060
> Type: functional

---

## What It Does
Allows admins to review a complaint in full detail and take resolution action. The admin sees the client's original message, the cook's response (if any), full order details, and payment information. Resolution options include: dismiss (no action), partial refund to client wallet, full refund to client wallet, warning to cook, or temporarily suspend the cook. A resolution note is required. The resolution triggers notifications to both parties and is logged in the activity log.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Super-Admin | Reviews complaints and selects resolution actions |
| Admin | Reviews complaints and selects resolution actions |

---

## User Scenarios
### Scenario 1: Reviewing complaint details
An admin opens a complaint about a late delivery. They see: client "Marie Dupont" says "My food arrived 2 hours late and was cold." Cook "Chef Amara" responded "There was heavy traffic that day. I apologize." Order #1042 details show: 3 items totaling XAF 8,500, delivery address, order time, and estimated vs. actual delivery time.

### Scenario 2: Issuing a partial refund
The admin determines the complaint is valid but not severe enough for a full refund. They select "Partial Refund", enter XAF 3,000 (approximately 35% of the order), write a resolution note: "Partial refund issued for late delivery. Cook reminded about delivery expectations." They submit. XAF 3,000 is credited to Marie's wallet. Both parties receive notifications.

### Scenario 3: Dismissing a complaint
The admin reviews a complaint about "not enough pepper in the sauce." The admin determines this is subjective and not actionable. They select "Dismiss", write: "Taste preferences are subjective. We encourage the client to communicate spice level preferences in order notes." Both parties are notified.

### Scenario 4: Issuing a warning to the cook
The admin reviews a complaint about rude behavior from a cook. They select "Warning to Cook" and write: "Unprofessional communication with client. Further incidents may result in suspension." The cook receives a warning notification. The warning is recorded on the cook's profile.

### Scenario 5: Temporarily suspending a cook
After reviewing multiple complaints about a cook, the admin selects "Suspend Cook". They set a suspension duration (7 days) and write a resolution note. The cook's tenant is deactivated for the duration. The cook is notified. A scheduled job reactivates the tenant after the suspension period.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-165 | Resolution options: Dismiss, Partial Refund, Full Refund, Warning to Cook, Suspend Cook |
| BR-166 | A resolution note is required for all resolution types |
| BR-167 | Partial refund amount must be greater than 0 and less than or equal to the order total |
| BR-168 | Refunds are credited to the client's wallet, not reversed via Flutterwave |
| BR-169 | Full refund credits the entire order amount to the client's wallet |
| BR-170 | Warnings are recorded on the cook's profile and visible in their user detail |
| BR-171 | Cook suspension deactivates their tenant for the specified duration |
| BR-172 | Both client and cook receive notifications of the resolution decision |
| BR-173 | Resolution is logged in the activity log with the admin as causer |
| BR-174 | A complaint can only be resolved once; resolved complaints cannot be re-resolved |

---

## Data Involved
**Reads:**
- Complaint: all fields including messages, category, timeline
- Order: items, amounts, delivery details, status history
- Payment: transaction details for the associated order
- Cook profile: previous warnings, complaint history
- Client profile: wallet balance

**Creates:**
- Resolution record: resolution_type, amount (if refund), note, resolved_by, resolved_at
- Wallet transaction (if refund): credit to client wallet
- Warning record (if warning): linked to cook's profile
- Notifications: to client and cook
- Activity log entry

**Updates:**
- Complaint: status to "Resolved" or "Dismissed"
- Client wallet: balance increased (if refund)
- Tenant: status to "inactive" (if suspension)

**Relationships:**
- F-060: Complaint selected from the escalation queue
- F-051: Warning visible on cook's user detail
- F-048: Tenant deactivation on suspension

---

## Acceptance Criteria
- **Given** a complaint, **when** the admin opens it, **then** all complaint, order, and payment details are visible
- **Given** a "Partial Refund" selection, **when** submitted with amount and note, **then** the amount is credited to the client's wallet and both parties are notified
- **Given** a "Full Refund" selection, **when** submitted, **then** the full order amount is credited to the client's wallet
- **Given** a "Dismiss" selection, **when** submitted with a note, **then** the complaint is marked dismissed and both parties are notified
- **Given** a "Warning" selection, **when** submitted, **then** the warning is recorded on the cook's profile
- **Given** a "Suspend Cook" selection with duration, **when** submitted, **then** the cook's tenant is deactivated for the specified period
- **Given** a resolved complaint, **when** viewed again, **then** the resolution details are shown and no further action is possible

---

## Verification Steps
1. Open a complaint — confirm all details (messages, order, payment) are visible
2. Issue a partial refund — confirm wallet balance increases by the refund amount
3. Dismiss a complaint — confirm status changes and notifications are sent
4. Issue a warning — confirm warning appears on cook's user detail page
5. Suspend a cook — confirm tenant is deactivated and reactivates after the specified period
6. Attempt to re-resolve a resolved complaint — confirm it is not possible
7. Check activity log — confirm resolution is recorded

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Refund amount exceeds order total | Validation error: "Refund cannot exceed order amount" |
| Client's wallet feature disabled by admin | Refund still proceeds (wallet is always available for refunds, even if wallet payments are disabled) |
| Cook has been previously suspended | Previous suspensions shown on the resolution page as context |
| Complaint for an order that was already refunded | Warning shown: "This order has already been refunded" — admin can still dismiss |
| Suspension duration of 0 days | Validation error: "Suspension duration must be at least 1 day" |
| Cook already suspended when new suspension issued | New suspension replaces the existing one; longer duration takes precedence |

---

## UI/UX Notes
- Three-column layout on desktop: complaint thread (left), order/payment details (center), resolution form (right)
- Complaint thread shows messages in conversation style: client message, cook response (if any)
- Resolution form: radio buttons for resolution type, conditional fields (amount for refund, duration for suspension)
- Resolution note: required textarea with minimum 10 characters
- Cook's complaint history shown as a count: "This cook has 3 previous complaints (1 warning)"
- Submit button with confirmation dialog for destructive actions (suspend)
- Mobile: stacked layout with collapsible sections
- Resolution form sticky at bottom on mobile

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-060 | Complaint Escalation Queue | Source of complaints to resolve |
| F-048 | Tenant Edit & Status Toggle | Suspension deactivates tenant |
| F-051 | User Detail View | Warnings appear on cook's profile |
