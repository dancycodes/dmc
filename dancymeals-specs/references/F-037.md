# F-037 — Add Payment Method

> Module: User Settings
> Type: functional
> Priority: Must-have
> Precedence: F-030

---

## What It Does

Allows authenticated users to add a saved mobile money number for use during checkout.
Fields include a user-defined label (e.g., "MTN Main"), provider selection (MTN MoMo or
Orange Money), and phone number. Validates the phone number format based on the selected
provider. Users can save a maximum of 3 payment methods.

---

## Who Uses It

- **All authenticated users** who want to save payment methods for faster checkout.

---

## User Scenarios

### Happy Path
1. User navigates to their payment methods section (from profile, F-038).
2. User clicks "Add Payment Method."
3. A form appears with:
   - Label (text input, e.g., "MTN Main")
   - Provider (radio or dropdown: MTN MoMo, Orange Money)
   - Phone number (tel input)
4. User selects "MTN MoMo" as provider.
5. User enters their MTN phone number: +237 6XX XXX XXX.
6. User clicks "Save."
7. The payment method is saved. Toast: "Payment method saved."
8. The method appears in the payment method list (F-038).

### Alternate Path — First Method Becomes Default
1. User has no saved payment methods.
2. User adds their first method.
3. It is automatically set as the default payment method.

### Alternate Path — Orange Money Provider
1. User selects "Orange Money" as provider.
2. User enters an Orange Money number: +237 6XX XXX XXX (Orange-specific prefix).
3. Validation passes and the method is saved.

### Error Path — Maximum Methods Reached
1. User already has 3 saved payment methods.
2. User clicks "Add Payment Method."
3. A message appears: "You can save up to 3 payment methods. Please remove one to add a new one."

### Error Path — Invalid Phone for Provider
1. User selects "MTN MoMo" but enters an Orange Money number.
2. Validation error: "This phone number does not match the selected provider."

### Error Path — Invalid Phone Format
1. User enters a phone number that is not a valid Cameroon format.
2. Validation error: "Please enter a valid Cameroon phone number."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-147 | Maximum 3 saved payment methods per user. |
| BR-148 | Label is required and must be unique among the user's payment methods (max 50 characters). |
| BR-149 | Provider is required and must be either "mtn_momo" or "orange_money." |
| BR-150 | Phone number must be a valid Cameroon mobile number (+237 format). |
| BR-151 | Phone number prefix must match the selected provider (MTN numbers typically start with 67, 68, or 650-654; Orange numbers typically start with 69, 655-659). |
| BR-152 | The first payment method added by a user is automatically set as default. |
| BR-153 | Payment methods are user-scoped, not tenant-scoped. |
| BR-154 | Phone numbers are stored in normalized format (+237XXXXXXXXX). |
| BR-155 | All text and labels must be localized via `__()`. |

---

## Data Involved

### PaymentMethod Model (created)
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| user_id | FK | Yes | The owning user |
| label | string | Yes | User-defined label, unique per user |
| provider | enum | Yes | "mtn_momo" or "orange_money" |
| phone | string | Yes | Stored as +237XXXXXXXXX |
| is_default | boolean | No | Default: false (first is auto-set to true) |

---

## Acceptance Criteria

```
Given I have fewer than 3 payment methods
When I click "Add Payment Method"
Then I see a form with label, provider, and phone number fields

Given I select MTN MoMo and enter a valid MTN number
When I click save
Then the payment method is saved and appears in my list

Given I select Orange Money and enter a valid Orange number
When I click save
Then the payment method is saved

Given I have no payment methods and add my first one
When it is saved
Then it is automatically set as the default

Given I already have 3 saved payment methods
When I try to add another
Then I see a message about the maximum limit

Given I select MTN MoMo but enter an Orange Money number
When I click save
Then I see a validation error about provider-number mismatch
```

---

## Verification Steps

1. Add an MTN MoMo payment method — confirm it saves and appears in the list.
2. Add an Orange Money payment method — confirm it saves.
3. Add a first method and confirm it is set as default.
4. Add 3 methods, then try adding a 4th — confirm the limit message.
5. Select MTN and enter an Orange number — confirm the validation error.
6. Enter an invalid phone format — confirm the validation error.

---

## Edge Cases

- User enters a phone number with spaces, dashes, or parentheses — normalize to +237XXXXXXXXX before validation.
- Cameroon telecom providers reassign number prefixes — the prefix validation should be configurable or based on a maintained list.
- User saves the same phone number with different labels — allow it (same number, different labels for organization).
- User saves the same phone number under different providers — reject (a number belongs to one provider).

---

## UI/UX Notes

- Form can be a modal or inline section within the payment methods page.
- Provider selection uses radio buttons with provider logos/icons (MTN yellow, Orange orange).
- Phone number input shows +237 prefix indicator.
- Phone number input mask to guide entry format.
- Save via Gale without page reload.
- Light/dark mode support.
- Mobile-first layout.

---

## Related Features

- **F-030** — Profile View (links to payment methods management)
- **F-038** — Payment Method List (displays saved methods)
- **F-039** — Edit Payment Method (edit an existing method)
- **F-040** — Delete Payment Method (delete an existing method)
- **F-149** — Payment Method Selection (uses saved methods at checkout)
