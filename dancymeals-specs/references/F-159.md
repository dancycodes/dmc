# F-159 — Order Status Transition Validation

> Module: Order Mgmt
> Priority: Must-have
> Precedence: F-157
> Type: edge-case

---

## What It Does
Enforces the valid order status transition rules across the entire platform. Defines which status transitions are allowed, prevents skipping states, prevents backward transitions (except admin override for dispute resolution), and controls when Cancelled and Refunded statuses can be applied. This feature is a server-side validation layer consumed by F-157 (single update), F-158 (mass update), and any other feature that changes order status.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Validates all status transitions automatically |
| Cook / Manager | Indirectly, through status update actions — only valid transitions are offered |
| Admin | Can override backward transitions for dispute resolution |

---

## User Scenarios
### Scenario 1: Valid forward transition
A Paid order is updated to Confirmed. The transition validator checks: Paid > Confirmed is a valid forward transition. The update proceeds.

### Scenario 2: Attempted state skip
A request tries to move an order from Paid directly to Preparing, skipping Confirmed. The validator rejects: "Cannot transition from Paid to Preparing. Next valid status: Confirmed."

### Scenario 3: Attempted backward transition
A request tries to move an order from Preparing back to Confirmed. The validator rejects: "Cannot move order backward from Preparing to Confirmed."

### Scenario 4: Admin override for dispute
An admin resolves a dispute and needs to move an order from Completed back to Preparing (rare). The admin override flag bypasses the forward-only rule. The override is logged with a reason.

### Scenario 5: Cancellation from valid state
A client cancels an order in Paid status. The validator checks: Cancellation is allowed from Paid. The order moves to Cancelled.

### Scenario 6: Cancellation from invalid state
A request tries to cancel an order in Preparing status. The validator rejects: "Orders cannot be cancelled after Confirmed status" (assuming the cook's cancellation window policy).

### Scenario 7: Refunded status
An order is in Cancelled status and the refund is processed. The validator checks: Cancelled > Refunded is valid. The order moves to Refunded.

### Scenario 8: Delivery vs. pickup path
A delivery order at Ready status can transition to "Out for Delivery" but not "Ready for Pickup." A pickup order at Ready status can transition to "Ready for Pickup" but not "Out for Delivery."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-200 | The valid forward transition chain is: Pending Payment > Paid > Confirmed > Preparing > Ready > (Out for Delivery OR Ready for Pickup) > (Delivered OR Picked Up) > Completed |
| BR-201 | Orders cannot skip states in the forward chain |
| BR-202 | Orders cannot move backward in the chain (except via admin override) |
| BR-203 | Admin override for backward transitions requires a reason and is logged with elevated audit trail |
| BR-204 | Cancellation is allowed only from Pending Payment, Paid, or Confirmed statuses (before cook starts preparing) |
| BR-205 | The Refunded status can only be reached from Cancelled or via admin complaint resolution |
| BR-206 | Delivery orders must follow the delivery path: Ready > Out for Delivery > Delivered |
| BR-207 | Pickup orders must follow the pickup path: Ready > Ready for Pickup > Picked Up |
| BR-208 | A delivery order cannot use pickup transitions and vice versa |
| BR-209 | Terminal states (Completed, Cancelled, Refunded) cannot transition to any other status (except admin override) |
| BR-210 | Validation errors return the current status, attempted status, and the next valid status |
| BR-211 | All transition validation is server-side; client-side button visibility is a convenience, not a security measure |

---

## Data Involved
**Reads:**
- `orders.status` (current status)
- `orders.delivery_type` (delivery or pickup) to determine the correct path
- Admin role check for override capability

**Creates:**
- Validation error responses when transitions are invalid
- Audit log entries for admin overrides

**Updates:**
- Nothing directly (this feature validates; the calling feature performs the update)

---

## Acceptance Criteria
- **Given** a Paid order, **when** transitioning to Confirmed, **then** the transition is allowed
- **Given** a Paid order, **when** attempting to transition to Preparing, **then** the transition is rejected with "Next valid status: Confirmed"
- **Given** a Preparing order, **when** attempting to transition to Confirmed, **then** the transition is rejected as a backward transition
- **Given** a delivery order at Ready, **when** transitioning to Out for Delivery, **then** it is allowed
- **Given** a pickup order at Ready, **when** transitioning to Out for Delivery, **then** it is rejected
- **Given** a Paid order, **when** cancelling, **then** the transition to Cancelled is allowed
- **Given** a Preparing order, **when** cancelling without admin override, **then** the cancellation is rejected
- **Given** an admin with override, **when** moving a Completed order backward, **then** the transition is allowed and logged

---

## Verification Steps
1. Test each valid forward transition in the chain and confirm all succeed
2. Attempt to skip a state (e.g., Paid > Preparing) and confirm rejection
3. Attempt a backward transition (e.g., Preparing > Confirmed) and confirm rejection
4. Test cancellation from Pending Payment, Paid, and Confirmed — confirm all allowed
5. Test cancellation from Preparing, Ready, and later — confirm all rejected
6. Test Refunded from Cancelled — confirm allowed
7. Test Refunded from any non-Cancelled state — confirm rejected
8. Test delivery path transitions on a delivery order — confirm correct
9. Test pickup path transitions on a pickup order — confirm correct
10. Test cross-path transitions (delivery order to pickup path) — confirm rejected
11. Test admin override backward transition — confirm allowed and logged
12. Test transition from terminal states without admin override — confirm rejected

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Order status is null or invalid | Validation error: "Invalid order status" |
| Concurrent status update requests | First request wins; second validated against the new status |
| Admin override without providing a reason | Override rejected: "A reason is required for admin overrides" |
| Order type changes from delivery to pickup mid-flow | Not allowed; delivery type is set at order creation and is immutable |
| Pending Payment order (payment not yet completed) | Can only transition to Paid (via webhook) or Cancelled |
| Refund requested on a non-cancelled order | Must go through complaint resolution (F-061) which can set Refunded via admin |

---

## UI/UX Notes
- This feature has no direct UI; it is a server-side validation layer
- The status update button in F-156/F-157 uses these rules to display only valid next statuses
- Validation error messages are returned as structured responses for display in toast notifications
- Admin override is accessed through the admin panel's order management section, not the cook dashboard

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-157 | Single Order Status Update | Primary consumer of these validation rules |
| F-158 | Mass Order Status Update | Validates each order individually using these rules |
| F-061 | Admin Complaint Resolution | Admin can set Refunded status through complaint resolution |
| F-162 | Order Cancellation | Cancellation transitions validated by these rules |
| F-163 | Order Cancellation Refund Processing | Refunded transition validated by these rules |
