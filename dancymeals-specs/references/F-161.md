# F-161 â€” Client Order Detail & Status Tracking

> Module: Order Tracking
> Priority: Must-have
> Precedence: F-160
> Type: functional

---

## What It Does
Displays the full detail of a client's order with real-time status tracking. Shows ordered items with prices, delivery or pickup information, payment details, and a visual timeline of the order's status progression. Status updates from the cook appear in real-time via Gale SSE. Provides links to cancel the order (F-162), file a complaint (F-183), rate/review the order (F-176), and message the cook (F-188). Displays the cook's WhatsApp number for urgent contact. Estimated times are shown when available.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Views order details and tracks status in real-time |

---

## User Scenarios
### Scenario 1: View order details
The client clicks an order from their order list. The detail page shows all order information: items with prices, delivery address, payment method and status, and the current status with a visual timeline.

### Scenario 2: Real-time status tracking
The client is viewing their order (status: Preparing). The cook marks it as Ready. Without refreshing, the status badge updates, the timeline adds a new entry, and a toast notification appears: "Your order is now Ready!"

### Scenario 3: View estimated times
The order shows estimated preparation time and estimated delivery/pickup time based on the cook's configuration. A simple progress indicator shows how the order is progressing.

### Scenario 4: Cancel order
The order is in Paid status and within the cancellation window. The client sees a "Cancel Order" button with a countdown timer showing remaining cancellation time. They click it to initiate cancellation (F-162).

### Scenario 5: File a complaint
The client sees an issue with their delivered order. They click "Report a Problem" to open the complaint submission form (F-183).

### Scenario 6: Rate and review
The order is Completed. A rating prompt appears on the detail page inviting the client to rate their experience (F-176).

### Scenario 7: Contact cook via WhatsApp
The client needs urgent help. They click the WhatsApp button to open a chat with the cook in WhatsApp.

### Scenario 8: Message cook in-app
The client clicks "Message Cook" to open the in-app order message thread (F-188).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-222 | The client can only view their own orders |
| BR-223 | Status updates from the cook are pushed to the client's view in real-time via Gale SSE |
| BR-224 | The visual timeline shows all status transitions with timestamps |
| BR-225 | The "Cancel Order" button is visible only when: order is in Paid or Confirmed status AND within the cook's cancellation window |
| BR-226 | A countdown timer shows remaining time in the cancellation window |
| BR-227 | The "Report a Problem" link is available for orders in Delivered, Picked Up, or Completed status |
| BR-228 | The rating prompt appears for Completed orders that have not yet been rated |
| BR-229 | Cook's WhatsApp number is displayed for urgent contact |
| BR-230 | Payment details show: method, amount, reference, status |
| BR-231 | Items section shows meal name, selected components, quantities, unit prices, and line totals |
| BR-232 | Delivery orders show: town, quarter, landmark, delivery fee |
| BR-233 | Pickup orders show: pickup location name and address |
| BR-234 | All amounts are displayed in XAF format |
| BR-235 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `orders` table for order data
- `order_items` table with component selections
- `meals` and `meal_components` for names and details
- `users` table for cook info and WhatsApp number
- `tenants` table for cook's tenant info
- Payment transaction data
- Status transition history
- Cancellation window configuration from cook settings

**Creates:**
- Nothing (display only; actions delegate to other features)

**Updates:**
- Nothing

---

## Acceptance Criteria
- **Given** a client clicks an order, **when** the detail page loads, **then** all order sections display correctly
- **Given** the cook updates the order status, **when** the client is viewing the order, **then** the status updates in real-time without page reload
- **Given** the order is within the cancellation window, **when** viewing the detail, **then** a cancel button with countdown timer is visible
- **Given** the cancellation window has expired, **when** viewing the detail, **then** the cancel button is not visible
- **Given** the order is Completed and not yet rated, **when** viewing the detail, **then** a rating prompt is displayed
- **Given** the cook has a WhatsApp number, **when** viewing the detail, **then** a WhatsApp contact button is visible
- **Given** the client tries to view another user's order, **when** accessing the URL, **then** they receive a 403 response

---

## Verification Steps
1. View an order detail page and confirm all sections are displayed
2. Have the cook update the order status and confirm real-time update on the client's view
3. Verify the cancel button appears with countdown for eligible orders
4. Verify the cancel button disappears after the window expires
5. Verify the rating prompt appears for completed, unrated orders
6. Click WhatsApp button and confirm it opens WhatsApp with the cook's number
7. Click "Message Cook" and confirm navigation to the message thread
8. Verify the "Report a Problem" link appears for appropriate statuses
9. Try to access another client's order and confirm 403

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook's WhatsApp number not set | WhatsApp button hidden |
| Order in Pending Payment status | Shows "Awaiting payment" with link to retry payment |
| Cancellation window expires while client is viewing the page | Cancel button disappears dynamically via countdown timer |
| Order has been cancelled | Shows Cancelled status badge; no action buttons except "Report a Problem" |
| Cook's tenant is deactivated | Order detail still accessible; cook info shown but marked as inactive |
| Multiple rapid status updates | Timeline updates for each, in correct chronological order |

---

## UI/UX Notes
- Back navigation to order list at the top
- Order ID and current status badge in the header
- Visual timeline: vertical step indicator with colored dots for each status, current step highlighted
- Sections as cards: Items, Delivery/Pickup, Payment, Timeline
- Cancel button: red outline, with countdown timer text (e.g., "Cancel (12:34 remaining)")
- Rating prompt: star selector inline on the page for completed orders
- "Message Cook" and "WhatsApp" buttons grouped together
- "Report a Problem" as a subtle text link
- Estimated time display near the status timeline
- Mobile-first layout with stacked cards
- All interactions via Gale (no page reloads)
- Real-time SSE updates for status changes

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-160 | Client Order List | Navigates here when clicking an order |
| F-162 | Order Cancellation | Cancel button triggers this feature |
| F-176 | Order Rating Prompt | Rating UI appears on this page |
| F-183 | Client Complaint Submission | "Report a Problem" links to this |
| F-188 | Order Message Thread View | "Message Cook" links to this |
| F-134 | WhatsApp Contact & Social Links | WhatsApp button uses cook's contact info |
| F-212 | Cancellation Window Configuration | Determines cancel button visibility and countdown |
