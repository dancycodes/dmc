# F-122 — Meal Component Requirement Rules

> Module: Meal Component
> Priority: Must-have
> Precedence: F-118
> Type: functional

---

## What It Does
Allows a cook to define dependency rules between meal components within the same meal. These rules govern which components a client must (or must not) have in their order to add a specific component. For example, "Extra Plantain" may require at least one of "Ndole + Plantain" or "Ndole + Rice" in the order. Three rule types are supported: "requires any of" (must have at least one of the listed components), "requires all of" (must have all listed components), and "incompatible with" (cannot have any of the listed components). Rules are validated during the ordering process. Configured via a rule builder UI on the component edit page via Gale.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Defines dependency rules between components |
| Manager | Configures rules if granted `manage-meals` permission |
| Client | Experiences rule enforcement during ordering (cannot add incompatible or missing-dependency components) |

---

## User Scenarios
### Scenario 1: "Requires any of" rule
The cook creates a rule on "Extra Plantain": requires any of ["Ndole + Plantain", "Ndole + Rice"]. During ordering, a client must have at least one of those in their cart before adding "Extra Plantain."

### Scenario 2: "Requires all of" rule
The cook creates a rule on "Combo Upgrade": requires all of ["Main Plate", "Side Dish"]. Both components must be in the client's cart to add "Combo Upgrade."

### Scenario 3: "Incompatible with" rule
The cook creates a rule on "Spicy Sauce": incompatible with ["Mild Sauce"]. If "Mild Sauce" is in the cart, "Spicy Sauce" cannot be added, and vice versa.

### Scenario 4: Client attempts to add restricted component
A client tries to add "Extra Plantain" without having "Ndole + Plantain" or "Ndole + Rice." The system shows: "Requires at least one of: Ndole + Plantain, Ndole + Rice."

### Scenario 5: Multiple rules on one component
A component has both a "requires any of" and an "incompatible with" rule. Both are evaluated during ordering.

### Scenario 6: Delete a rule
The cook removes the dependency rule from "Extra Plantain." It can now be ordered independently.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-316 | Three rule types: "requires_any_of", "requires_all_of", "incompatible_with" |
| BR-317 | Rules reference other components within the same meal only |
| BR-318 | A component can have multiple rules (all are evaluated during ordering) |
| BR-319 | Rules are enforced during the ordering process (F-138) — clients cannot add a component that violates rules |
| BR-320 | Circular dependencies are detected and prevented (e.g., A requires B and B requires A) |
| BR-321 | If a referenced component is deleted (F-120), the rule referencing it is automatically removed |
| BR-322 | Rules do not affect the component's availability — only its orderability in combination |
| BR-323 | Only users with `manage-meals` permission can manage rules |
| BR-324 | Rule changes are logged via Spatie Activitylog |
| BR-325 | Each rule must reference at least one target component |

---

## Data Involved
**Creates:**
- `ComponentRequirementRule` model with fields: `id`, `meal_component_id` (the component this rule is on), `rule_type` (enum: requires_any_of, requires_all_of, incompatible_with), `created_at`, `updated_at`
- `component_requirement_rule_targets` pivot table with: `rule_id`, `target_component_id`
- Migration for both tables
- Factory for ComponentRequirementRule

**Reads:**
- Available components within the same meal (for target selection)
- Existing rules for display and circular dependency detection

**Updates:**
- ComponentRequirementRule and its target pivot records on edit

**Deletes:**
- ComponentRequirementRule and its pivot records on delete
- Cascade when referenced component is deleted

**Relationships:**
- ComponentRequirementRule belongsTo MealComponent (the component the rule is defined on)
- ComponentRequirementRule belongsToMany MealComponents (target components, via pivot)

---

## Acceptance Criteria
- **Given** a component, **when** the cook adds a "requires any of" rule with 2 targets, **then** the rule is saved
- **Given** a "requires any of" rule, **when** a client has one of the targets in their cart, **then** the component can be added
- **Given** a "requires any of" rule, **when** a client has none of the targets, **then** the component is blocked with a message
- **Given** an "incompatible with" rule, **when** a client has the incompatible component, **then** the restricted component is blocked
- **Given** a circular dependency attempt (A requires B, B requires A), **when** submitted, **then** validation rejects
- **Given** a target component is deleted, **when** checking rules, **then** rules referencing it are cleaned up

---

## Verification Steps
1. Create a "requires any of" rule and test ordering with and without the target
2. Create a "requires all of" rule and test ordering with partial and full targets
3. Create an "incompatible with" rule and test mutual exclusion
4. Attempt to create a circular dependency — confirm rejection
5. Delete a target component — confirm associated rules are cleaned up
6. Add multiple rules to one component — confirm all are evaluated
7. Delete a rule — confirm the component can be ordered independently
8. Check activity log for rule changes

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Rule references itself (component requires itself) | Validation error |
| All target components deleted | Rule is automatically removed |
| Component with rules is toggled unavailable | Rules are irrelevant when unavailable; rules still exist for when re-enabled |
| Very deep dependency chain (A requires B, B requires C) | Evaluated transitively; each component checks its own rules only |
| Client removes a required component after adding dependent | Dependent component is flagged or removed from cart |

---

## UI/UX Notes
- "Requirement Rules" section within the component edit view
- Rule builder: dropdown for rule type, multi-select for target components
- Existing rules displayed as chips/cards: "Requires any of: [Comp A] [Comp B]"
- Add Rule button to create new rules
- Delete (X) button on each rule
- During ordering: disabled components show tooltip explaining the requirement
- All interactions via Gale
- Mobile-friendly layout

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-118 | Meal Component Creation | Creates components that rules reference |
| F-119 | Meal Component Edit | Rule section is part of component edit |
| F-120 | Meal Component Delete | Triggers rule cleanup on component deletion |
| F-138 | Meal Component Selection & Cart Add | Enforces rules during ordering |
