# F-065 — Manual Payout Task Queue

> Module: Admin
> Priority: Must-have
> Precedence: F-043
> Type: functional

---

## What It Does
Displays a task queue of failed automatic Flutterwave transfers that require manual admin intervention. When a cook's withdrawal request fails via the Flutterwave Transfers API (network error, invalid mobile money number, insufficient Flutterwave balance, etc.), it appears in this queue. Admins can either manually send the money outside the platform and mark it as "manually completed," or retry the automatic transfer. All actions are logged.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Super-Admin | Processes failed payout tasks |
| Admin | Processes failed payout tasks |

---

## User Scenarios
### Scenario 1: Viewing the payout queue
An admin navigates to Payouts in the sidebar. A list shows failed transfers: Cook "Chef Amara", Amount XAF 45,000, Mobile Money Number "+237 6XX XXX XXX" (MTN), Failure Reason "Transfer failed: insufficient balance", Requested Date "Feb 10, 2026".

### Scenario 2: Marking as manually completed
The admin sends XAF 45,000 to Chef Amara's mobile money number manually (via bank app or mobile money portal). They return to the admin panel, click "Mark as Manually Completed" on the task, enter a reference number from the manual transfer, and confirm. The task is removed from the active queue and the cook's withdrawal is marked as complete.

### Scenario 3: Retrying automatic transfer
A transfer failed due to a temporary Flutterwave outage. The admin clicks "Retry Transfer". The system re-initiates the Flutterwave transfer. If successful, the task is resolved. If it fails again, the task remains with the updated failure reason.

### Scenario 4: Investigating failure details
The admin clicks on a failed task to see full details: cook name, tenant, mobile money number, payment method, amount, original withdrawal request date, number of previous retry attempts, detailed Flutterwave error response, and cook's withdrawal history.

### Scenario 5: Contacting the cook
The admin sees a failure reason of "Invalid mobile money number." They check the cook's profile and notice the phone number may be incorrect. They contact the cook via the displayed phone number to verify the correct number before retrying.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-199 | Only failed Flutterwave transfers appear in this queue |
| BR-200 | "Manually completed" requires a reference number or note as proof of manual payment |
| BR-201 | Retry initiates a new Flutterwave transfer with the same parameters |
| BR-202 | Maximum 3 automatic retry attempts per transfer; after that, only manual completion is available |
| BR-203 | The cook's wallet balance is not re-credited on failure (it was already debited at withdrawal request) |
| BR-204 | All queue actions (mark complete, retry) are logged in the activity log |
| BR-205 | Completed/resolved tasks move to a "Completed" tab and are retained for audit purposes |
| BR-206 | The queue shows a badge count on the sidebar indicating pending tasks |

---

## Data Involved
**Reads:**
- Failed transfer records: cook_id, amount, mobile_money_number, payment_method, failure_reason, requested_at, retry_count
- Cook profile: name, phone, tenant association
- Flutterwave transfer responses: error details

**Creates:**
- Activity log entries for each action
- New Flutterwave transfer request (on retry)
- Manual completion record: reference_number, completed_by, completed_at

**Updates:**
- Transfer record: status (resolved/completed), retry_count, resolution details
- Cook wallet: withdrawal marked as complete (if manually completed)

**Relationships:**
- F-043: Displayed within admin panel
- F-058: Failed payments data appears in financial reports
- F-059: Payment monitoring shows the original transaction

---

## Acceptance Criteria
- **Given** failed Flutterwave transfers exist, **when** navigating to the payout queue, **then** they are listed with all relevant details
- **Given** a failed task, **when** clicking "Mark as Manually Completed" with a reference number, **then** the task is resolved and the cook's withdrawal is marked complete
- **Given** a failed task, **when** clicking "Retry Transfer" and the transfer succeeds, **then** the task is resolved
- **Given** a failed task retried 3 times, **when** viewing the task, **then** the "Retry" button is disabled and only "Mark as Manually Completed" is available
- **Given** any action on a task, **when** completed, **then** an activity log entry is created
- **Given** resolved tasks, **when** switching to the "Completed" tab, **then** they are listed for audit

---

## Verification Steps
1. Navigate to payout queue — confirm failed transfers are listed
2. Mark a task as manually completed with a reference number — confirm it moves to Completed tab
3. Retry a transfer — confirm Flutterwave transfer is re-initiated
4. Retry a task 3 times and fail — confirm retry button is disabled on 4th attempt
5. Check activity log — confirm all actions are recorded
6. Verify sidebar badge shows correct pending count

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| No failed transfers | Empty state: "No pending payout tasks. All transfers are up to date." |
| Flutterwave API is down during retry | Retry fails with updated error reason; task stays in queue |
| Cook changed their phone number after withdrawal request | Task shows the number from the original request; admin should verify current number |
| Amount discrepancy on manual completion | Admin enters the actual amount sent; system logs the discrepancy |
| Multiple failed transfers for the same cook | Each listed separately; admin can process them in any order |
| Transfer fails with "duplicate transfer" error on retry | Error displayed; admin should check if the original transfer actually succeeded |

---

## UI/UX Notes
- Task list with clear priority: oldest failed transfers at the top
- Each task card shows: cook avatar, cook name, amount (large), mobile money number, failure reason (red text), requested date, retry count
- Two action buttons per task: "Retry Transfer" (primary) and "Mark as Manually Completed" (secondary)
- "Mark as Manually Completed" opens a modal for reference number input
- Tabs: Active (pending) / Completed (resolved)
- Sidebar badge: red dot with count of active tasks
- Amount formatted prominently: "45,000 XAF"
- Failure reason shown in a highlighted warning box
- Mobile: card layout, full-width action buttons
- Breadcrumb: Admin > Payouts

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-043 | Admin Panel Layout | Parent layout |
| F-058 | Financial Reports | Failed payouts appear in financial reports |
| F-059 | Payment Monitoring | Original transactions viewable in payment monitoring |
