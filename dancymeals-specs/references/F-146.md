# F-146 â€” Order Total Calculation & Summary

> Module: Ordering
> Priority: Must-have
> Precedence: F-139
> Type: functional

---

## What It Does
Displays a comprehensive order summary showing an itemized list of all selected components (grouped by meal), their quantities and prices, the food subtotal, delivery fee (or "Pickup - Free"), promo discount (if applicable), and the grand total. All amounts are in XAF. The summary updates reactively as cart contents, delivery choice, or promo codes change. This is the final review step before proceeding to payment.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Reviews the complete order summary before proceeding to payment |

---

## User Scenarios
### Scenario 1: Full order summary
The client sees:
- Ndole Platter: Ndole x2 = 4,000 XAF, Plantains x1 = 500 XAF
- Eru Soup: Eru x1 = 1,500 XAF
- Subtotal: 6,000 XAF
- Delivery to Akwa: 500 XAF
- Total: 6,500 XAF

### Scenario 2: Pickup order
- Same items as above
- Subtotal: 6,000 XAF
- Pickup - Free
- Total: 6,000 XAF

### Scenario 3: Order with promo discount
- Subtotal: 6,000 XAF
- Delivery: 500 XAF
- Promo "WELCOME10" (-10%): -600 XAF
- Total: 5,900 XAF

### Scenario 4: Cart modification from summary
The client realizes they want to change quantities. They click "Edit Cart" and return to the cart management view. After changes, the summary updates automatically.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-316 | Itemized list shows: meal name, component name, quantity, unit price, line subtotal |
| BR-317 | Items are grouped by meal |
| BR-318 | Subtotal is the sum of all food item line subtotals |
| BR-319 | Delivery fee is shown as a separate line item; pickup shows "Pickup - Free" |
| BR-320 | Promo discount (if applicable) is shown as a negative line item with code name |
| BR-321 | Grand total = subtotal + delivery fee - promo discount |
| BR-322 | All amounts displayed in XAF (integer, formatted with thousand separators) |
| BR-323 | Summary updates reactively via Gale when any input changes |
| BR-324 | An "Edit Cart" link allows returning to the cart without losing checkout progress |
| BR-325 | "Proceed to Payment" button leads to F-149 (Payment Method Selection) |
| BR-326 | All text must be localized via `__()` |

---

## Data Involved
**Reads:**
- Cart session data (items, quantities, prices)
- Delivery method and fee
- Promo code discount (if applied)

**Creates:**
- Nothing (display only)

**Updates:**
- Nothing directly; serves as summary of existing session data

**Relationships:**
- Aggregates data from F-139 (Cart), F-145 (Delivery Fee)
- Promo codes from F-215 (Promo Code system) if applicable
- Leads to F-149 (Payment Method Selection)

---

## Acceptance Criteria
- **Given** a cart with items from 2 meals, **when** viewing the summary, **then** items are grouped by meal with correct line totals
- **Given** a delivery order with a 500 XAF fee, **when** viewing the summary, **then** the delivery fee line shows 500 XAF
- **Given** a pickup order, **when** viewing the summary, **then** "Pickup - Free" is displayed
- **Given** a promo code applied, **when** viewing the summary, **then** the discount is shown as a negative line item
- **Given** the total calculation, **when** verified, **then** it equals subtotal + delivery fee - promo discount
- **Given** the client clicks "Edit Cart", **when** returning, **then** the cart view opens with current items

---

## Verification Steps
1. Review the order summary and verify all items, quantities, and prices are correct
2. Verify the subtotal calculation matches the sum of line items
3. Verify the delivery fee is shown correctly for a delivery order
4. Verify "Pickup - Free" for a pickup order
5. Apply a promo code and verify the discount appears
6. Verify the grand total calculation
7. Click "Edit Cart" and verify return to cart management

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Promo discount exceeds subtotal | Total set to delivery fee only (food portion is free); total never goes negative |
| Cart is empty when reaching summary | Redirect back to cart with empty state message |
| Component price changed since cart add | Show updated price with a notification about the change |
| Very large order (many items) | Summary scrolls; total always visible (sticky) |
| XAF amounts with thousands | Formatted with thousand separators (e.g., 10,000 XAF) |

---

## UI/UX Notes
- Clean, receipt-style layout with clear line items
- Meal group headers in bold
- Each line: component name, quantity x unit price = subtotal (right-aligned)
- Subtotal, delivery fee, discount, and total in a summary box at the bottom
- Total in large, bold typography
- "Edit Cart" as a text link next to item list header
- "Proceed to Payment" as a prominent CTA button
- Mobile: sticky total bar at bottom with "Proceed to Payment" button
- Step indicator showing this is the review/summary step

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-139 | Order Cart Management | Source of cart items |
| F-145 | Delivery Fee Calculation | Source of delivery fee |
| F-149 | Payment Method Selection | Next step |
| F-215 | Promo Code System | Source of promo discount (if applicable) |
