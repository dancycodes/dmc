# F-141 â€” Delivery Location Selection

> Module: Ordering
> Priority: Must-have
> Precedence: F-140, F-097
> Type: functional

---

## What It Does
For delivery orders, allows the client to select their delivery location. The client selects a town (dropdown populated from the cook's available delivery towns), a quarter (dropdown filtered by the selected town), and enters a neighbourhood (text input with OpenStreetMap Nominatim autocomplete). If the client has saved addresses that match the cook's available areas, those are offered as quick-select options. If the user has a saved address in an available area, it is pre-selected.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Selects their delivery location during checkout |

---

## User Scenarios
### Scenario 1: Selecting town and quarter
The client selects "Douala" from the town dropdown. The quarter dropdown populates with "Akwa", "Bonanjo", "Bonaberi", etc. The client selects "Akwa." A neighbourhood text field appears with OpenStreetMap autocomplete.

### Scenario 2: Using a saved address
The client has a saved address "Home - Akwa, Rue de la Joie, Douala" in their profile. Since Akwa is in the cook's delivery areas, this address appears as a quick-select option at the top. The client clicks it and all fields auto-populate.

### Scenario 3: OpenStreetMap autocomplete
The client starts typing "Rue des Man..." in the neighbourhood field. Autocomplete suggestions from OpenStreetMap Nominatim appear: "Rue des Manguiers, Akwa, Douala." The client selects the suggestion.

### Scenario 4: Quarter not available
The client's quarter is not listed in the cook's delivery areas. This scenario is handled by F-147 (Location Not Available Flow).

### Scenario 5: No saved addresses match
The client has saved addresses but none are in the cook's delivery areas. No quick-select options appear; the client must manually select from dropdowns.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-274 | Town dropdown shows only towns where the cook has delivery areas configured |
| BR-275 | Quarter dropdown is filtered by the selected town |
| BR-276 | Neighbourhood is a free-text field with OpenStreetMap Nominatim autocomplete |
| BR-277 | Nominatim autocomplete is scoped to the selected town in Cameroon |
| BR-278 | Saved addresses matching the cook's delivery areas are offered as quick-select options |
| BR-279 | If the client has a saved address in an available area, it is pre-selected by default |
| BR-280 | The selected quarter determines the delivery fee (F-145) |
| BR-281 | All fields (town, quarter, neighbourhood) are required for delivery orders |
| BR-282 | All form labels and text must be localized via `__()` |
| BR-283 | Town and quarter names displayed in the user's current language |

---

## Data Involved
**Reads:**
- Cook's delivery areas: towns and quarters with fees
- Client's saved addresses (if authenticated)
- OpenStreetMap Nominatim API for neighbourhood autocomplete

**Creates:**
- Delivery location in checkout session/order draft (town_id, quarter_id, neighbourhood text)

**Updates:**
- Checkout session with delivery location

**Relationships:**
- Follows F-140 (Delivery/Pickup Choice Selection)
- Uses location hierarchy from F-097 (Location hierarchy system)
- Triggers F-145 (Delivery Fee Calculation) when quarter is selected
- If quarter unavailable, triggers F-147 (Location Not Available Flow)

---

## Acceptance Criteria
- **Given** the client selected delivery, **when** this step loads, **then** the town dropdown shows the cook's delivery towns
- **Given** a town is selected, **when** the quarter dropdown loads, **then** only quarters in that town are shown
- **Given** a quarter is selected, **when** typing a neighbourhood, **then** OpenStreetMap autocomplete suggestions appear
- **Given** a saved address matches an available area, **when** this step loads, **then** the saved address appears as a quick-select option
- **Given** a saved address in an available area exists, **when** this step loads, **then** it is pre-selected
- **Given** all fields are filled, **when** proceeding, **then** the delivery location is saved and the next step loads

---

## Verification Steps
1. Select delivery and verify the town dropdown populates with cook's delivery towns
2. Select a town and verify the quarter dropdown filters correctly
3. Type in the neighbourhood field and verify OpenStreetMap autocomplete works
4. Test with a saved address in an available area; verify quick-select and pre-selection
5. Test with no matching saved addresses; verify manual selection is required
6. Verify all fields are required before proceeding

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook delivers to only 1 town | Town dropdown pre-selects the single option |
| Town has only 1 quarter | Quarter pre-selected automatically |
| OpenStreetMap API is down | Neighbourhood field works as plain text input without autocomplete |
| Client types neighbourhood without using autocomplete | Input accepted as-is (free text) |
| Saved address has a quarter the cook no longer delivers to | Address not shown in quick-select |

---

## UI/UX Notes
- Step indicator showing progress (e.g., Step 2 of 5)
- Saved addresses displayed as selectable cards at the top
- Town and quarter as styled select dropdowns
- Neighbourhood as text input with dropdown autocomplete
- "Back" button to return to delivery/pickup choice
- "Continue" button to proceed to next step
- Form validation messages shown inline
- All interactions via Gale (no page reload)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-140 | Delivery/Pickup Choice Selection | Previous step |
| F-097 | Location Hierarchy System | Source of town/quarter data |
| F-145 | Delivery Fee Calculation | Triggered when quarter selected |
| F-147 | Location Not Available Flow | Triggered when quarter not available |
| F-143 | Order Phone Number | Next step after location |
