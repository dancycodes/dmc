# F-189 — Message Send

> Module: Messaging
> Priority: Should-have
> Precedence: F-188
> Type: functional

---

## What It Does
Allows a client or cook/manager to send a text message in the order message thread. The user types a message into the input field and clicks send (or presses Enter). The message is saved and appears instantly in the thread for the sender via Gale. The recipient sees the new message in real-time via Gale SSE if they are viewing the thread, or receives a notification (F-190). Messages are limited to 500 characters. The messaging feature is available while the order is active and up to 7 days after completion.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Sends messages to the cook/manager about their order |
| Cook | Sends messages to the client about the order |
| Manager | Sends messages to the client if granted `manage-orders` permission |

---

## User Scenarios
### Scenario 1: Client sends a message
The client opens the order message thread, types "What time will my order be ready?" in the input field, and clicks Send. The message appears instantly in the thread. The cook receives a notification.

### Scenario 2: Cook replies
The cook opens the order's message thread, reads the client's message, types "Your order will be ready by 12:30 PM. Thank you for your patience!" and sends. The message appears instantly and the client is notified.

### Scenario 3: Either party initiates
No prior messages exist. The client sends the first message. The thread is created and the cook receives a notification.

### Scenario 4: Message after order completion
The order was completed 3 days ago. The client sends a message asking about a recipe ingredient. The message sends successfully since it is within the 7-day window.

### Scenario 5: Message after 7-day window
The order was completed 8 days ago. The client tries to type a message but the input field is disabled with a message: "Messaging is no longer available for this order."

### Scenario 6: Message exceeds character limit
The client types a message exceeding 500 characters. The character counter turns red and the send button is disabled until the message is shortened.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-248 | Messages are text-only; no file or image attachments in the message thread |
| BR-249 | Maximum message length is 500 characters |
| BR-250 | Either party (client or cook/manager) can initiate the conversation |
| BR-251 | Messages are sent via Gale and appear instantly for the sender |
| BR-252 | If the recipient is viewing the thread, the new message appears in real-time via Gale SSE |
| BR-253 | Messaging is available while the order status is active (Paid through Completed) and for 7 days after Completed/Delivered |
| BR-254 | Messaging is disabled immediately if the order is Cancelled or Refunded |
| BR-255 | Empty messages (whitespace only) cannot be sent |
| BR-256 | Messages are sanitized to prevent XSS (HTML entities escaped) |
| BR-257 | Sending a message is rate-limited to prevent spam (max 10 messages per minute per user) |
| BR-258 | All user-facing text must use `__()` localization |

---

## Data Involved
**Creates:**
- `order_messages` table record: `id`, `order_id`, `user_id` (sender), `message` (text), `created_at`

**Reads:**
- `orders` table to verify order status and messaging availability
- `users` table for authorization check

**Updates:**
- Nothing

**Relationships:**
- OrderMessage belongsTo Order
- OrderMessage belongsTo User (sender)

---

## Acceptance Criteria
- **Given** an active order, **when** the client types a message and clicks send, **then** the message is saved and displayed instantly
- **Given** the cook is viewing the thread, **when** the client sends a message, **then** it appears in real-time without refresh
- **Given** a message exceeding 500 characters, **when** typed, **then** the send button is disabled and a character limit warning is shown
- **Given** an order completed 8 days ago, **when** the user tries to send a message, **then** the input is disabled
- **Given** a cancelled order, **when** the user tries to send a message, **then** the input is disabled
- **Given** an empty input, **when** the user clicks send, **then** nothing happens (send is disabled)

---

## Verification Steps
1. Send a message as a client and confirm it appears instantly in the thread
2. Send a message as a cook and confirm it appears instantly
3. Have both client and cook viewing the thread; send a message and confirm real-time delivery
4. Type 501 characters and confirm the send button is disabled
5. Attempt to send a message on a completed order within 7 days; confirm success
6. Attempt to send a message on a completed order after 7 days; confirm disabled
7. Attempt to send on a cancelled order; confirm disabled
8. Send a message with only whitespace; confirm it is not sent
9. Send 11 messages in rapid succession; confirm rate limit kicks in

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Network failure during send | Error toast: "Message failed to send. Please try again." Message stays in input |
| Both parties send at the exact same time | Both messages saved and appear in order of database insertion |
| Cook has multiple tabs open | Message appears in all tabs viewing the same thread |
| Message with special characters (emoji, unicode) | Accepted and displayed correctly |
| Order transitions from active to completed while messaging | Messaging remains available for 7 more days from completion |

---

## UI/UX Notes
- Text input field at the bottom of the message thread with a send button (arrow icon)
- Character counter below the input: "0/500" — turns red when approaching limit
- Send button disabled when input is empty or over limit
- Enter key sends the message; Shift+Enter for new line
- Loading spinner on send button during submission
- Error state: input border turns red with error message below
- Disabled state: input replaced with informational message when messaging is unavailable
- Mobile: input field fixed at bottom of screen with keyboard push
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-188 | Order Message Thread View | Displays messages sent here |
| F-190 | Message Notification | Triggers notification to recipient |
| F-161 | Order Status Flow | Determines messaging availability window |
