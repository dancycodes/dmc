# F-009 â€” Theme System (Light/Dark Mode)

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Establishes the theming infrastructure for DancyMeals using Tailwind CSS v4. Configures CSS custom properties (variables) for light and dark color schemes. Implements system-level dark mode detection via `prefers-color-scheme`, stores the user's preference in `localStorage` (for immediate application) and optionally in the database (for authenticated users). All UI components across the platform respect the active theme.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Views the platform in their preferred theme (light, dark, or system) |
| Cook | Manages their dashboard in their preferred theme |
| Admin | Uses the admin panel in their preferred theme |
| Guest | Sees theme based on system preference or manual choice |

---

## User Scenarios
### Scenario 1: System preference detection
A user with their OS set to dark mode visits DancyMeals for the first time. The site automatically renders in dark mode, matching their system preference.

### Scenario 2: Manual theme override
A user with a light-mode OS preference manually selects dark mode via the theme switcher (F-010). Their choice overrides the system preference and persists across sessions via `localStorage`.

### Scenario 3: Authenticated user theme persistence
A logged-in user selects dark mode. The preference is saved to both `localStorage` (for instant application on page load) and their user profile. When they log in on a new device, their theme preference is restored from the database.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-062 | Three theme modes are supported: light, dark, and system (follows OS preference) |
| BR-063 | "System" is the default mode for new/unauthenticated users |
| BR-064 | Theme preference is stored in `localStorage` for instant, flash-free application |
| BR-065 | For authenticated users, theme preference is also stored in the database |
| BR-066 | CSS custom properties define all theme-dependent colors, backgrounds, borders, and shadows |
| BR-067 | Tailwind CSS v4 dark mode must use the `class` strategy (not `media`) for manual override support |
| BR-068 | Theme must apply consistently across all pages, components, and layouts |
| BR-069 | No flash of incorrect theme on page load (FOIT prevention via inline script) |

---

## Data Involved
**Creates:**
- CSS custom properties file/layer for light and dark theme tokens
- Inline script in `<head>` for flash-prevention (reads `localStorage` before render)
- Theme-related Tailwind CSS v4 configuration

**Reads:**
- `localStorage` for saved theme preference
- User `theme_preference` field (if authenticated)
- OS `prefers-color-scheme` media query

**Updates:**
- Tailwind CSS configuration for dark mode strategy
- Base CSS file with custom properties for both themes
- User model to include `theme_preference` field (nullable, default null = system)

**Relationships:**
- F-010 (Theme Switcher) provides the UI to change themes
- F-011 (Tenant Theme Customization) extends this system with per-tenant color palettes

---

## Acceptance Criteria
- **Given** a user with OS dark mode enabled and no saved preference, **when** visiting the site, **then** dark mode is applied automatically
- **Given** a user who has selected "light" mode, **when** their OS switches to dark mode, **then** the site remains in light mode (manual override)
- **Given** a user who selected "system" mode, **when** their OS toggles between light and dark, **then** the site follows the OS change in real-time
- **Given** any theme, **when** navigating between pages, **then** no flash of the wrong theme occurs
- **Given** CSS custom properties, **when** inspecting any themed element, **then** it uses CSS variables (not hardcoded colors)
- **Given** the base Tailwind configuration, **when** building CSS, **then** dark mode utilities (e.g., `dark:bg-gray-900`) work correctly

---

## Verification Steps
1. Set OS to dark mode, clear `localStorage`, and visit the site -- confirm dark theme applies
2. Set OS to light mode, visit the site, and confirm light theme applies
3. Manually select dark mode, refresh the page, and confirm no flash of light mode
4. Toggle OS dark mode while "system" is selected and confirm the site theme changes reactively
5. Inspect a themed element and confirm CSS custom properties are used

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| `localStorage` not available (private browsing in some browsers) | Falls back to system preference with no persistence |
| User clears browser data | Theme resets to system default; authenticated users restore from DB on next login |
| Multiple tabs open, theme changed in one | Other tabs may not update until refreshed (acceptable limitation) |
| Prefers-color-scheme not supported (older browser) | Defaults to light mode |
| Print view | Always uses light theme colors for readability |

---

## UI/UX Notes
- No theme switcher UI in this feature (that is F-010). This feature establishes the infrastructure.
- Define CSS variables for: primary color, background, surface, text, muted text, border, shadow, accent, error, success, warning, info.
- Both themes must meet WCAG AA contrast requirements.
- Dark mode should use true dark backgrounds (not just inverted colors) with appropriate text contrast.
- Transitions between themes should be smooth (CSS transition on color/background-color).

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; Tailwind CSS v4 must be installed |
| F-010 | Theme Switcher Component | Provides UI for users to change their theme |
| F-011 | Tenant Theme Customization | Extends this system with per-tenant palettes |
| F-016 | Base Layout & Responsive Navigation | Layout must support both themes |
