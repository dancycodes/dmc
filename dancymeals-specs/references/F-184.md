# F-184 â€” Cook/Manager Complaint Response

> Module: Complaint
> Priority: Must-have
> Precedence: F-183, F-076
> Type: functional

---

## What It Does
Allows the cook or an authorized manager to view and respond to complaints filed against their tenant's orders. The complaint detail view shows client information, order details, complaint category, description, and any attached photo. The cook/manager writes a required text response and can offer a resolution: apology only, partial refund offer, or full refund offer. Submitting a response changes the complaint status from "open" to "in_review," notifies the client, and resets the 24-hour auto-escalation clock (preventing escalation as long as the cook has responded).

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Views complaint details and submits a response with an optional resolution offer |
| Manager | Views and responds to complaints if granted `manage-complaints` permission |
| Client | Receives notification of the cook's response |

---

## User Scenarios
### Scenario 1: Cook responds with apology only
The cook sees a new complaint notification. They navigate to the complaint detail in their dashboard. They read the client's complaint about food quality, write "We sincerely apologize for the inconvenience. We will improve our quality control," select "Apology Only" as the resolution, and submit. The client is notified.

### Scenario 2: Cook offers a partial refund
The cook reads a complaint about a missing item. They respond with an explanation and select "Partial Refund Offer" with an amount of 2000 XAF. The client is notified of the response and the refund offer.

### Scenario 3: Cook offers a full refund
The cook reads a complaint about receiving the wrong order entirely. They respond apologetically and select "Full Refund Offer." The client is notified.

### Scenario 4: Manager responds to a complaint
A manager with `manage-complaints` permission accesses the complaints section. They view a complaint, write a response, and select a resolution. The process is identical to the cook's workflow.

### Scenario 5: Cook responds before 24-hour deadline
The complaint was filed 20 hours ago. The cook responds with 4 hours to spare. The auto-escalation timer is cancelled for this complaint since the cook has now responded.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-195 | Only the cook or a manager with `manage-complaints` permission can respond to a complaint |
| BR-196 | Response text is required, minimum 10 characters, maximum 2000 characters |
| BR-197 | Resolution options: apology_only, partial_refund_offer, full_refund_offer |
| BR-198 | For partial refund offers, the cook must specify an amount in XAF (must be > 0 and <= order total) |
| BR-199 | Full refund offer amount is automatically set to the order total |
| BR-200 | Submitting a response changes complaint status from "open" to "in_review" |
| BR-201 | Responding resets (cancels) the 24-hour auto-escalation clock |
| BR-202 | Client receives push + DB notification when cook responds |
| BR-203 | A cook can respond multiple times (additional messages) but only the first response changes status and cancels escalation |
| BR-204 | Resolution offers are informational only at this stage; actual refund processing requires admin resolution (or client acceptance if implemented) |
| BR-205 | All user-facing text must use `__()` localization |
| BR-206 | Response submission is logged via Spatie Activitylog |

---

## Data Involved
**Creates:**
- `complaint_responses` table record: `id`, `complaint_id`, `user_id` (responder), `message` (text), `resolution_type` (nullable enum), `refund_amount` (nullable integer, XAF), `created_at`

**Reads:**
- `complaints` table with related order, client user, and photo
- `orders` table for order details (items, total, status)
- `order_items` with meals for order summary
- `users` table for client info (name, email)

**Updates:**
- `complaints.status` from "open" to "in_review" on first response
- Auto-escalation scheduled job cancelled or marked as responded

**Relationships:**
- ComplaintResponse belongsTo Complaint
- ComplaintResponse belongsTo User (responder)
- Complaint hasMany ComplaintResponse

---

## Acceptance Criteria
- **Given** an open complaint, **when** the cook views it, **then** client info, order details, category, description, and photo are displayed
- **Given** the response form, **when** the cook writes a response and selects a resolution, **then** the response is saved and complaint status changes to "in_review"
- **Given** a partial refund offer, **when** the cook enters an amount exceeding the order total, **then** validation fails
- **Given** a response is submitted, **when** the client checks notifications, **then** they see a push and DB notification about the response
- **Given** a response submitted within 24 hours, **when** the escalation job runs, **then** this complaint is not escalated
- **Given** a manager without `manage-complaints` permission, **when** they try to access complaints, **then** they receive a 403 response

---

## Verification Steps
1. Navigate to the complaints section in the cook dashboard and confirm complaint list is displayed
2. Open a complaint and verify client info, order details, category, description, and photo are shown
3. Submit a response with "Apology Only" and confirm status changes to "in_review"
4. Submit a response with "Partial Refund Offer" and a valid amount; confirm it saves
5. Attempt a partial refund with amount exceeding order total; confirm validation error
6. Submit a response without text; confirm validation error
7. Verify client receives push and DB notification after cook responds
8. Verify the 24-hour escalation does not trigger after cook response
9. Test with a manager account with and without `manage-complaints` permission

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook responds at exactly 24 hours | If response is saved before the escalation job runs, escalation is cancelled |
| Complaint already escalated | Cook can still respond; status remains "escalated" (admin handles resolution) |
| Cook writes multiple responses | All responses saved; only first changes status and cancels escalation |
| Partial refund amount of 0 XAF | Validation error; must be greater than 0 |
| Complaint photo was deleted from storage | Placeholder shown with "Image unavailable" message |
| Order has been refunded through other means | Resolution offer is still allowed; admin handles final decision |

---

## UI/UX Notes
- Complaints section accessible from cook dashboard sidebar under "Complaints"
- Complaint list shows: order ID, client name, category badge, status badge, date filed
- Complaint detail page split into two sections: complaint info (left/top) and response form (right/bottom)
- Client photo displayed as a thumbnail with click-to-enlarge
- Resolution type as radio buttons: Apology Only, Partial Refund, Full Refund
- Partial refund shows an amount input field (conditionally visible)
- Response textarea with character counter
- Submit button with loading state
- All interactions via Gale (no page reload)
- Mobile: stacked layout with complaint info above response form

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-183 | Client Complaint Submission | Creates the complaints that appear here |
| F-076 | Cook Dashboard Layout & Navigation | Provides the dashboard shell for complaint management |
| F-185 | Complaint Auto-Escalation | Cancelled when cook responds within 24 hours |
| F-187 | Complaint Status Tracking | Status updates from response are reflected here |
| F-193 | Complaint Notifications | Notification details for complaint response events |
