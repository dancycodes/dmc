# F-031 — Profile Photo Upload

> Module: Auth
> Type: functional
> Priority: Should-have
> Precedence: F-030

---

## What It Does

Allows authenticated users to upload or change their profile photo. Accepts JPG, PNG, and
WebP formats with a maximum size of 2MB. The image is cropped/resized to standard dimensions.
A preview is shown before saving. Users can also remove their existing photo to revert to the
default avatar. The photo is stored using the project's image management package and displayed
in navigation and profile.

---

## Who Uses It

- **All authenticated users** who want to set or change their profile photo.

---

## User Scenarios

### Happy Path
1. User navigates to their profile page (F-030) and clicks "Change Photo."
2. A photo upload interface appears (modal or inline section).
3. User selects a JPG file (1.5MB) from their device.
4. A preview of the selected image is shown.
5. User confirms by clicking "Save Photo."
6. The image is uploaded, resized to standard dimensions, and stored.
7. The profile page updates to show the new photo via Gale (no page reload).
8. A toast notification confirms: "Profile photo updated."
9. The navigation avatar also updates to reflect the new photo.

### Alternate Path — Replace Existing Photo
1. User already has a profile photo.
2. User clicks "Change Photo" and selects a new image.
3. Preview shows the new image.
4. On save, the old photo is replaced with the new one.
5. The old image file is deleted from storage.

### Alternate Path — Remove Photo
1. User clicks "Remove Photo."
2. A confirmation dialog asks: "Remove your profile photo?"
3. User confirms. The photo is deleted.
4. The profile and navigation revert to the default avatar placeholder.
5. Toast: "Profile photo removed."

### Error Path — File Too Large
1. User selects a 5MB image.
2. Validation error appears: "The photo must be smaller than 2MB."
3. No upload occurs. User is prompted to select a smaller file.

### Error Path — Invalid File Type
1. User selects a GIF or PDF file.
2. Validation error: "The photo must be a JPG, PNG, or WebP image."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-103 | Accepted file formats: JPG (JPEG), PNG, WebP only. |
| BR-104 | Maximum file size: 2MB. |
| BR-105 | Uploaded images are resized/cropped to standard dimensions (e.g., 256x256 pixels, square). |
| BR-106 | A preview of the selected image must be shown before the user confirms the upload. |
| BR-107 | When a new photo replaces an old one, the old file must be deleted from storage. |
| BR-108 | Removing a photo reverts the display to a default avatar (initials or generic icon). |
| BR-109 | The photo is stored via the project's image management package (Intervention Image or Spatie Media Library). |
| BR-110 | Photo updates are reflected in the navigation avatar without a full page reload (via Gale). |
| BR-111 | Activity is logged when photo is uploaded or removed. |

---

## Data Involved

### User Model (updated)
| Field | Change |
|-------|--------|
| photo | Path/URL to the stored image, or null if removed |

### Image Storage
| Attribute | Value |
|-----------|-------|
| Storage disk | Public or configured disk |
| Dimensions | 256x256 (square, cropped/resized) |
| Formats accepted | jpg, jpeg, png, webp |
| Max size | 2MB (2048 KB) |

---

## Acceptance Criteria

```
Given I am on my profile page
When I click "Change Photo"
Then an upload interface appears

Given I select a valid image file under 2MB
When the file is selected
Then a preview of the image is shown before saving

Given I confirm the upload
When the server processes the image
Then my profile photo is updated and a toast confirms success

Given I select a file larger than 2MB
When I try to upload
Then I see "The photo must be smaller than 2MB"

Given I select a GIF file
When I try to upload
Then I see "The photo must be a JPG, PNG, or WebP image"

Given I have an existing photo
When I click "Remove Photo" and confirm
Then my photo is deleted and the default avatar is shown

Given I upload a new photo
When I look at the navigation bar
Then my new photo is shown as the avatar
```

---

## Verification Steps

1. Upload a valid JPG under 2MB — confirm the photo is saved and displayed.
2. Upload a PNG and a WebP — confirm both formats are accepted.
3. Try to upload a 5MB file — confirm the size validation error.
4. Try to upload a GIF — confirm the format validation error.
5. Replace an existing photo and verify the old file is deleted from storage.
6. Remove the photo and confirm the default avatar is displayed.
7. After uploading, check the navigation avatar reflects the new photo.

---

## Edge Cases

- User uploads a very small image (e.g., 10x10 pixels) — resize/crop should still produce a 256x256 image (upscaled or padded).
- User uploads a non-square image — crop to center square before resizing.
- Concurrent uploads (e.g., user clicks save twice) — handle gracefully, do not create orphaned files.
- Image with EXIF orientation data — the resize process should normalize orientation.
- User on slow mobile connection — show upload progress indicator.

---

## UI/UX Notes

- The photo upload can be a modal overlay or an inline section on the profile page.
- Preview is shown in a circular crop (matching the avatar display shape).
- "Change Photo" button is visible when hovering over the current photo area (desktop) or as a button below it (mobile).
- "Remove Photo" is a secondary/danger action, not prominent.
- Upload progress indicator for slow connections.
- Light/dark mode support.

---

## Related Features

- **F-030** — Profile View (displays the photo and links to this feature)
- **F-032** — Profile Basic Info Edit (separate from photo upload)
- **F-016** — Base Layout & Responsive Navigation (displays avatar in nav)
