# F-186 — Complaint-Triggered Payment Block

> Module: Complaint
> Priority: Must-have
> Precedence: F-183, F-169
> Type: functional

---

## What It Does
When a complaint is filed on an order, the system checks the cook's payment status for that order. If the payment is still in the "unwithdrawable" state (the timer that converts unwithdrawable funds to withdrawable has not yet completed), the timer is paused. The payment remains blocked until the complaint is resolved. If the payment has already moved to "withdrawable" status, the system flags it for potential admin-managed deduction. This prevents cooks from withdrawing disputed funds before a complaint is resolved.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Automatically blocks/pauses payment timer when complaint is filed |
| Cook | Sees the payment block status on their wallet/order view |
| Admin | Can see blocked payments and resolve them during complaint resolution |

---

## User Scenarios
### Scenario 1: Payment blocked on active unwithdrawable period
A client files a complaint on an order delivered 2 hours ago. The cook's payment for this order is in "unwithdrawable" state with 46 hours remaining on the 48-hour timer. The system pauses the timer. The cook sees a "Payment Blocked - Complaint Pending" indicator on this order's payment entry.

### Scenario 2: Complaint resolved — payment unblocked
The admin resolves the complaint by dismissing it (no refund). The system resumes the unwithdrawable timer from where it was paused. The remaining 46 hours begin counting down again.

### Scenario 3: Complaint resolved with refund — payment adjusted
The admin resolves the complaint with a full refund. The blocked payment is reversed: the cook's unwithdrawable balance is reduced by the order amount (minus platform commission).

### Scenario 4: Payment already withdrawable when complaint is filed
A client files a complaint on an order delivered 3 days ago. The cook's payment has already moved to "withdrawable" status. The system flags this payment for potential deduction if the complaint results in a refund. The cook can still withdraw other funds, but this specific amount is flagged.

### Scenario 5: Cook checks wallet and sees blocked payment
The cook opens their wallet dashboard. They see one payment entry marked as "Blocked" with a tooltip explaining "Payment held pending complaint resolution on Order #1234."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-217 | When a complaint is filed, the system checks the cook's payment record for the associated order |
| BR-218 | If the payment is in "unwithdrawable" state, the withdrawable timer is paused immediately |
| BR-219 | The paused timer retains the remaining duration (e.g., 46 hours remaining) for resumption |
| BR-220 | Payment block is lifted only when the complaint status changes to "resolved" |
| BR-221 | If the complaint is resolved with "dismiss" (no refund), the timer resumes from where it paused |
| BR-222 | If the complaint is resolved with a refund (partial or full), the payment amount is adjusted accordingly |
| BR-223 | If the payment has already transitioned to "withdrawable" when the complaint is filed, the payment is flagged but not withdrawn back |
| BR-224 | Flagged withdrawable payments are subject to admin-managed deduction during complaint resolution |
| BR-225 | The cook cannot withdraw the specific blocked/flagged payment amount (other withdrawable funds remain accessible) |
| BR-226 | Payment block status is visible to the cook on their wallet and order detail views |
| BR-227 | Payment block and unblock events are logged via Spatie Activitylog |
| BR-228 | If a complaint is auto-escalated, the payment block remains in effect |

---

## Data Involved
**Creates:**
- Payment block record or flag on the cook's payment entry for the order

**Reads:**
- `cook_payments` or wallet transactions for the specific order
- `complaints` table to determine complaint status
- Timer/schedule data for the unwithdrawable period

**Updates:**
- Payment record: `is_blocked` flag, `blocked_at` timestamp, `remaining_timer_seconds`
- On resolution: `is_blocked` cleared, timer resumed or payment adjusted

**Relationships:**
- Payment block is tied to a specific Order and Complaint
- CookPayment belongsTo Order
- CookPayment belongsTo Tenant

---

## Acceptance Criteria
- **Given** a complaint is filed on an order with unwithdrawable payment, **when** the complaint is created, **then** the payment timer is paused
- **Given** a blocked payment, **when** the complaint is resolved with "dismiss," **then** the timer resumes from where it paused
- **Given** a blocked payment, **when** the complaint is resolved with a refund, **then** the payment amount is adjusted
- **Given** a complaint on an order with already-withdrawable payment, **when** the complaint is filed, **then** the payment is flagged (not blocked)
- **Given** a blocked payment, **when** the cook views their wallet, **then** the blocked payment is clearly indicated
- **Given** a blocked payment, **when** the cook attempts to withdraw, **then** the blocked amount is excluded from available withdrawal balance

---

## Verification Steps
1. File a complaint on an order with an active unwithdrawable timer and verify the timer pauses
2. Resolve the complaint with "dismiss" and verify the timer resumes
3. Resolve a complaint with a full refund and verify the payment is adjusted
4. File a complaint on an order where payment is already withdrawable and verify the flag is set
5. Check the cook's wallet view and confirm blocked payments are clearly indicated
6. Attempt a withdrawal and confirm blocked amounts are excluded
7. Verify activity log entries for block and unblock events

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Multiple complaints on related orders | Each payment is blocked independently per complaint |
| Timer was about to expire when complaint was filed | Timer pauses at remaining seconds (even if < 1 minute) |
| Complaint resolved and then another complaint filed on same order | Not possible (one complaint per order, BR-184) |
| Cook has no other withdrawable funds | Withdrawal button disabled entirely; message explains why |
| Payment block applied but admin resolves complaint instantly | Block removed immediately; minimal impact on timer |
| System downtime during timer pause | Timer is stored as remaining seconds, not as a future timestamp, so downtime does not affect it |

---

## UI/UX Notes
- Blocked payments show a lock icon and "Blocked" badge in the cook's wallet
- Tooltip or info text explains: "Payment held pending complaint resolution"
- Order detail view shows a notice: "Payment for this order is on hold due to an active complaint"
- Flagged (already withdrawable) payments show a warning badge: "Under Review"
- No direct cook action to unblock — only complaint resolution unblocks
- All status changes reflected in real-time via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-183 | Client Complaint Submission | Triggers the payment block |
| F-169 | Cook Wallet & Withdrawable Balance | Payment timer and withdrawal system affected by blocks |
| F-185 | Complaint Auto-Escalation | Payment block persists through escalation |
| F-187 | Complaint Status Tracking | Resolution status drives unblock |
