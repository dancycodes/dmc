# F-202 â€” Cook Customer Retention Analytics

> Module: Analytics
> Priority: Could-have
> Precedence: F-200
> Type: functional

---

## What It Does
Provides customer insight metrics for cooks within the analytics section. Displays unique customer count, repeat customer rate, new vs returning customer breakdown, and customer lifetime value distribution. A table lists the top customers ranked by order count or total spend. This helps cooks understand their customer loyalty, identify their best customers, and make informed decisions about promotions and menu adjustments.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Views customer retention analytics in the cook dashboard |
| Manager | Views if granted `view-analytics` permission |

---

## User Scenarios
### Scenario 1: View retention overview
The cook navigates to Customer Analytics. Summary cards show: "Unique Customers: 234," "Repeat Rate: 42%," "New This Month: 18," "Returning This Month: 31."

### Scenario 2: New vs returning chart
A stacked bar chart shows new vs returning customers per month over the last 6 months. The cook notices the returning customer ratio is growing, indicating improving loyalty.

### Scenario 3: Top customers table
A table lists the top 20 customers sorted by total spend. Columns: customer name, order count, total spent, last order date. The cook recognizes their regulars.

### Scenario 4: Customer lifetime value
A distribution chart shows CLV buckets: "0-5,000 XAF: 120 customers," "5,001-20,000 XAF: 80 customers," "20,001+: 34 customers." Helps the cook understand revenue concentration.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-390 | Customer data is tenant-scoped; only customers who ordered from this cook |
| BR-391 | Unique customers counted by distinct `user_id` on completed orders |
| BR-392 | Repeat customer: a customer with 2+ completed orders from this tenant |
| BR-393 | Repeat rate = (repeat customers / unique customers) * 100 |
| BR-394 | New vs returning is calculated per month |
| BR-395 | Customer lifetime value = total amount spent by a customer at this tenant (completed orders) |
| BR-396 | Top customers table sortable by order count or total spend |
| BR-397 | Customer names are shown but contact details (email/phone) are not exposed |
| BR-398 | Date range selector applies to summary cards and charts |
| BR-399 | All amounts in XAF format |
| BR-400 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `orders` table filtered by `tenant_id` and status Completed/Delivered
- `users` table for customer names
- Aggregated order data for metrics

**Creates:**
- Nothing

**Updates:**
- Nothing

---

## Acceptance Criteria
- **Given** a cook with customers, **when** viewing customer analytics, **then** summary cards show correct metrics
- **Given** the new vs returning chart, **when** viewed, **then** it accurately categorizes customers
- **Given** the top customers table, **when** sorted by spend, **then** the highest-spending customer is first
- **Given** no orders, **when** viewed, **then** empty state is shown

---

## Verification Steps
1. Verify unique customer count matches distinct order clients
2. Verify repeat rate calculation is correct
3. Verify new vs returning chart shows accurate monthly breakdown
4. Verify top customers table is sortable and data is correct
5. Verify CLV distribution chart buckets are accurate
6. Test date range filter and verify updates

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Customer ordered but all orders were cancelled | Not counted as a customer |
| Customer ordered from multiple tenants | Only their orders for this tenant are counted |
| Only one customer ever | Repeat rate is 0% or 100% depending on order count |
| Customer account deleted | Shown as "Former Customer" in the table |

---

## UI/UX Notes
- Sub-section within the Analytics page or a separate tab
- Summary cards in a 4-column grid
- New vs returning as a stacked bar chart
- CLV distribution as a histogram
- Top customers as a sortable data table with pagination
- Responsive: cards and charts stack on mobile
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-200 | Cook Revenue Analytics | Prerequisite analytics infrastructure |
| F-208 | Analytics CSV/PDF Export | Export customer data |
