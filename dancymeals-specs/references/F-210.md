# F-210 â€” Manager Permission Configuration

> Module: Manager
> Priority: Must-have
> Precedence: F-209
> Type: functional

---

## What It Does
Allows a cook to configure which permissions each manager has within their tenant. Permissions are a defined subset of cook-level capabilities: manage orders, manage meals, manage schedule, manage locations, view analytics, manage complaints, and manage messages. The cook toggles each permission on or off per manager. Changes take effect immediately -- the manager's next request will reflect the updated permissions. The manager only sees dashboard sections and actions corresponding to their granted permissions. All permission changes are logged via Spatie Activitylog.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Configures permissions for each manager via toggle switches |
| Manager | Receives permissions that control their dashboard access |
| Admin | Can view permission configurations in the admin panel |

---

## User Scenarios
### Scenario 1: Cook grants specific permissions
The cook clicks "Configure" next to a manager's name in the Team section. A panel opens showing seven permission toggles, all off by default. The cook enables "Manage Orders" and "Manage Meals." The manager can now access the Orders and Meals sections of the dashboard.

### Scenario 2: Cook revokes a permission
The cook disables "Manage Orders" for a manager who previously had it. The manager immediately loses access to the Orders section on their next request. Navigation items for Orders are hidden.

### Scenario 3: Cook grants all permissions
The cook enables all seven permissions for a trusted manager. The manager can now access every section of the cook dashboard except settings that are reserved for the cook (wallet withdrawals, theme selection, manager management).

### Scenario 4: Manager attempts unpermitted action
A manager with only "Manage Meals" permission tries to navigate to `/dashboard/orders`. The system returns a 403 Forbidden response.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-473 | Configurable manager permissions: manage-orders, manage-meals, manage-schedule, manage-locations, view-analytics, manage-complaints, manage-messages |
| BR-474 | Permissions are toggled on/off per manager per tenant |
| BR-475 | New managers start with all permissions off (no access) |
| BR-476 | Permission changes take effect immediately on the manager's next request |
| BR-477 | Only the cook (not other managers) can configure manager permissions |
| BR-478 | Cook-reserved actions that cannot be delegated: manage wallet/withdrawals, manage theme, manage managers, manage promo codes, manage cook profile, manage cook settings |
| BR-479 | Permissions are stored as Spatie permissions scoped to the tenant |
| BR-480 | All permission changes are logged via Spatie Activitylog with before/after values |
| BR-481 | All user-facing text must use `__()` localization |
| BR-482 | Gale handles all toggle interactions without page reloads |

---

## Data Involved
**Creates:**
- Permission assignments in Spatie's `model_has_permissions` pivot (tenant-scoped)
- Activity log entries for each permission change

**Reads:**
- Manager's current permissions for this tenant
- Permission definitions from Spatie
- Manager list from F-209

**Updates:**
- `model_has_permissions` pivot table (grant/revoke)

**Relationships:**
- Manager (User) belongsToMany Permissions (Spatie, tenant-scoped)
- Each permission maps to specific dashboard sections and routes

---

## Acceptance Criteria
- **Given** a manager with no permissions, **when** the cook enables "Manage Orders," **then** the manager can access the Orders section
- **Given** a manager with "Manage Meals" enabled, **when** the cook disables it, **then** the manager can no longer access Meals
- **Given** a manager, **when** they attempt to access a section they lack permission for, **then** a 403 response is returned
- **Given** a permission change, **when** viewed in the activity log, **then** the before/after state is recorded
- **Given** a new manager, **when** viewing their permissions, **then** all seven toggles are off
- **Given** permission changes, **when** the manager refreshes their dashboard, **then** the sidebar reflects the updated permissions immediately

---

## Verification Steps
1. Add a manager and verify all permissions start as off
2. Enable "Manage Orders" and log in as the manager -- confirm Orders section is accessible
3. Disable "Manage Orders" and refresh as the manager -- confirm Orders is no longer in the sidebar
4. As the manager, attempt to access `/dashboard/orders` directly -- confirm 403 response
5. Enable all seven permissions -- confirm the manager sees all delegated sections
6. Verify cook-reserved sections (Wallet, Theme, Managers, Promo, Profile, Settings) are never shown to managers
7. Check activity log for permission change entries with before/after values
8. Test all interactions via Gale without page reloads

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook removes a manager while configuring permissions | Permission panel closes; manager is removed |
| Manager has active session when permissions change | Next request re-evaluates; stale permissions are not cached |
| All permissions disabled for a manager | Manager can log in but sees an empty dashboard with a message: "No permissions have been assigned to you yet" |
| Cook tries to give a permission that does not exist | Not possible; toggles are predefined |
| Two cooks configure the same manager simultaneously | Last write wins; Spatie handles concurrency |

---

## UI/UX Notes
- Permission configuration accessible via a "Configure" button or gear icon next to each manager in the Team list
- Opens an inline panel or modal with seven toggle switches
- Each toggle has a label and a brief description of what it controls
- Toggle states: on (accent color) / off (muted)
- Changes save automatically as toggles are flipped (no separate save button)
- Toast notification on each change: "Permission updated"
- Visual grouping of permissions by category:
  - Business Operations: Manage Orders, Manage Meals
  - Coverage: Manage Schedule, Manage Locations
  - Insights: View Analytics
  - Engagement: Manage Complaints, Manage Messages
- Mobile: toggles stack vertically in a full-width panel

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-209 | Cook Creates Manager Role | Prerequisite; manager must exist to configure |
| F-211 | Manager Dashboard Access | Consumes permissions to control dashboard visibility |
| F-006 | Role & Permission Seed Setup | Defines the base permission structure |
| F-076 | Cook Dashboard Layout & Navigation | Sidebar respects manager permissions |
