# F-024 — User Login

> Module: Auth
> Type: functional
> Priority: Must-have
> Precedence: F-005, F-016, F-018

---

## What It Does

Displays a login form with email and password fields, honeypot protection, and a "remember me"
checkbox. Works on any domain (main or tenant). On tenant domains, shows tenant branding while
clarifying it is a DancyMeals account login. Successful login redirects the user to their
intended page or the appropriate dashboard. Failed attempts show errors. Login attempts are
rate-limited.

---

## Who Uses It

- **Registered users** (any role) wanting to authenticate on any domain.

---

## User Scenarios

### Happy Path
1. User navigates to the login page on the main domain.
2. The form displays email and password fields, a "remember me" checkbox, and a honeypot.
3. User enters valid credentials and clicks "Log In."
4. Authentication succeeds. User is redirected to the intended page or home/dashboard.
5. A toast notification welcomes the user.

### Alternate Path — Tenant Domain Login
1. User visits a cook's tenant site and clicks "Log In."
2. The login page shows the tenant's branding (logo, colors, theme).
3. A notice reads: "Log in with your DancyMeals account."
4. User enters credentials and logs in.
5. User is redirected to the tenant's home page or their intended page on that tenant.

### Alternate Path — Remember Me
1. User checks the "Remember me" checkbox before logging in.
2. After successful login, a long-lived session cookie is created.
3. The user remains authenticated across browser restarts.

### Alternate Path — Redirect After Login
1. User tries to access a protected page (e.g., /orders) while unauthenticated.
2. User is redirected to the login page with the intended URL stored.
3. After successful login, user is redirected to the originally intended page (/orders).

### Error Path — Invalid Credentials
1. User enters an incorrect email or password.
2. The form shows a generic error: "These credentials do not match our records."
3. The email field retains the entered value; the password field is cleared.

### Error Path — Rate Limited
1. User has made too many failed login attempts (5 within 1 minute).
2. The form shows: "Too many login attempts. Please try again in X seconds."
3. The form is temporarily disabled for the lockout duration.

### Error Path — Inactive Account
1. User enters valid credentials but their account has `is_active = false`.
2. Authentication is rejected with the message: "Your account has been deactivated."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-047 | Login form must be accessible on every domain (main and all tenants). |
| BR-048 | Spatie Honeypot must be included on the login form. |
| BR-049 | Login attempts are rate-limited: maximum 5 attempts per minute per email/IP combination. |
| BR-050 | After successful login, redirect to the intended URL or the home page of the current domain. |
| BR-051 | Failed login shows a generic "credentials do not match" message — never reveal whether the email exists. |
| BR-052 | "Remember me" extends the session cookie duration (e.g., 30 days). |
| BR-053 | Users with `is_active = false` cannot log in, even with correct credentials. |
| BR-054 | On tenant domains, tenant branding is shown but the login clarifies it is a DancyMeals account. |
| BR-055 | A link to the registration page and "Forgot password" must be visible. |
| BR-056 | All user-facing text on the login page must be localized via `__()`. |
| BR-057 | Successful login activity is logged via Spatie Activitylog. |

---

## Data Involved

### Login Credentials
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| email | email input | Yes | User's registered email |
| password | password input | Yes | User's password |
| remember | checkbox | No | Extends session duration |
| honeypot fields | hidden | Yes (auto) | Spatie Honeypot |

---

## Acceptance Criteria

```
Given I am an unauthenticated user on the main domain
When I navigate to the login page
Then I see email and password fields, a remember me checkbox, and links to register and forgot password

Given I am on a tenant domain login page
When I view the page
Then I see the tenant's branding and a notice about DancyMeals account login

Given I enter valid credentials and click log in
When authentication succeeds
Then I am redirected to my intended page or the home page

Given I enter invalid credentials
When the form submits
Then I see "These credentials do not match our records" and the email is preserved

Given I have failed to log in 5 times in one minute
When I try again
Then I see a rate limit message with a countdown

Given my account is deactivated (is_active = false)
When I enter my correct credentials
Then I see "Your account has been deactivated" and I am not logged in

Given I check "Remember me" and log in
When I close and reopen the browser
Then I am still authenticated
```

---

## Verification Steps

1. Open the login page on the main domain; confirm all fields, links, and honeypot are present.
2. Open the login page on a tenant domain; confirm tenant branding and DancyMeals account notice.
3. Log in with valid credentials; confirm redirect to home/dashboard.
4. Log in with invalid credentials; confirm the generic error message appears.
5. Fail login 5 times rapidly; confirm the rate limit message and lockout.
6. Attempt login with a deactivated account; confirm the deactivation error message.

---

## Edge Cases

- User logs in on a tenant domain that is inactive — login should still work (auth is platform-level), but access to tenant content may be restricted elsewhere.
- Email entered with different casing — treat email as case-insensitive (lowercase comparison).
- User is already logged in and visits the login page — redirect to home/dashboard.
- Multiple browser tabs open — login in one tab should reflect across tabs on next navigation.
- Rate limit applies per email/IP to prevent lockout attacks on other users' accounts.

---

## UI/UX Notes

- Mobile-first: single column, full-width inputs, large "Log In" button.
- Light/dark mode support.
- Password field has a show/hide toggle.
- "Forgot password?" link is positioned below the password field.
- "Don't have an account? Register" link is below the form.
- Loading state on the submit button while authenticating.
- On tenant domains, the tenant logo appears above the form.

---

## Related Features

- **F-005** — Authentication Scaffolding (provides auth controllers and routes)
- **F-016** — Base Layout & Responsive Navigation (provides the page layout)
- **F-018** — Honeypot Protection Setup (provides honeypot fields)
- **F-019** — Rate Limiting Setup (provides rate limiting infrastructure)
- **F-021** — User Registration Form (linked from login page)
- **F-025** — User Logout (the reverse of this feature)
- **F-026** — Password Reset Request (linked from login page)
- **F-028** — Cross-Domain Session Sharing (ensures login works across domains)
- **F-029** — Active Status Enforcement (checks is_active on login)
