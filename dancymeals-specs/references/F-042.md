# F-042 — Language Preference Setting

> Module: User Settings
> Type: functional
> Priority: Must-have
> Precedence: F-030, F-008

---

## What It Does

Allows authenticated users to set their preferred language (English or French) from their
profile settings. The preference is persisted to the user's database record. The new language
is applied on the next page load and for all future sessions. The application locale is updated
to match the user's preference, affecting all localized text throughout the platform.

---

## Who Uses It

- **All authenticated users** who want to change the language of the application interface.

---

## User Scenarios

### Happy Path
1. User navigates to their profile settings or language preference section.
2. The current preferred language is shown (e.g., "English").
3. User selects "French" from the language options.
4. User clicks "Save" (or the change auto-saves).
5. The preference is persisted to the user's `preferred_language` field.
6. Toast: "Language preference updated. The change will apply on the next page."
7. On the next page load (or after a Gale navigation), all text is displayed in French.
8. All future sessions for this user use French as the locale.

### Alternate Path — Via Language Switcher Component
1. The language switcher component (F-008) is available in the navigation.
2. When an authenticated user uses the switcher, it updates their `preferred_language` in the database.
3. When a guest uses the switcher, it stores the preference in a session/cookie.

### Alternate Path — New User Registration
1. A new user registers while the interface is in French (they used the language switcher as a guest).
2. Their `preferred_language` is set to "fr" at registration time.
3. All future sessions default to French.

---

## Business Rules

| Code | Rule |
|------|------|
| BR-184 | Supported languages: "en" (English) and "fr" (French). |
| BR-185 | The preference is stored in the user's `preferred_language` field in the database. |
| BR-186 | The application locale is set based on the user's `preferred_language` on each request (via middleware). |
| BR-187 | For unauthenticated users, the language is determined by session/cookie (set via the language switcher F-008). |
| BR-188 | The language change affects all `__()` translations, date formatting, and any locale-dependent display. |
| BR-189 | Translatable database columns (e.g., `name_en`, `name_fr`) are read based on the user's preferred language. |
| BR-190 | If the preferred language is not set, default to English ("en"). |
| BR-191 | The setting in the profile and the language switcher component (F-008) must stay in sync. |

---

## Data Involved

### User Model (updated)
| Field | Change |
|-------|--------|
| preferred_language | Updated to "en" or "fr" |

### Application Behavior
| Aspect | Before | After |
|--------|--------|-------|
| `__()` translations | Returns text in previous language | Returns text in new language |
| Date formatting | Previous locale | New locale |
| DB translatable columns | Previous language column | New language column |

---

## Acceptance Criteria

```
Given I am on my profile settings
When I see the language preference option
Then my current language is shown as selected

Given I change my language to French
When the preference is saved
Then my preferred_language field is "fr" in the database

Given my preferred_language is "fr"
When I load any page
Then all __() translations are in French

Given my preferred_language is "fr"
When I view translatable database content (e.g., town names)
Then the French column (name_fr) is displayed

Given I am not logged in
When I use the language switcher
Then the language is stored in a session/cookie and applied to the current session

Given I log in after using the guest language switcher
When my session starts
Then my stored preferred_language takes precedence over the session/cookie
```

---

## Verification Steps

1. Change language preference to French — confirm it is saved in the database.
2. Navigate to any page — confirm all `__()` text is in French.
3. Check translatable content (e.g., town names) — confirm French versions are displayed.
4. Log out and back in — confirm French is still the language.
5. Change back to English — confirm all text reverts to English.
6. Verify the language switcher component and profile setting are in sync.

---

## Edge Cases

- User's preferred language is set to a value other than "en" or "fr" (data corruption) — fall back to "en".
- A translation is missing for the user's preferred language — fall back to English (Laravel default behavior).
- A translatable database field (e.g., `name_fr`) is null — fall back to the English version (`name_en`).
- Middleware that sets the locale must run early enough to affect all other middleware and controllers.
- Language change while a form is being filled — submitted form labels may differ from the current display; server-side validation messages should use the new language.

---

## UI/UX Notes

- The language preference can be a simple radio button group or a dropdown with two options.
- Flag icons (Cameroon flag or language-specific icons) next to each option add visual clarity.
- If the change is immediate (auto-save), no explicit save button is needed — just a toast.
- If part of the profile edit form (F-032), it saves with the rest of the form.
- The language switcher in the navigation (F-008) should reflect the authenticated user's preference.
- Light/dark mode support.

---

## Related Features

- **F-030** — Profile View (links to this setting)
- **F-032** — Profile Basic Info Edit (may include language preference in the same form)
- **F-008** — Language Switcher Component (navigation-level language toggle, must stay in sync)
- **F-007** — Localization System Setup (provides the translation infrastructure)
