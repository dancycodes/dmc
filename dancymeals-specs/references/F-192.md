# F-192 â€” Order Status Update Notifications

> Module: Notification
> Priority: Must-have
> Precedence: F-014, F-015, F-157
> Type: functional

---

## What It Does
When the cook updates an order's status, the client receives a push notification and a database notification. For key status transitions (Confirmed, Ready for Pickup/Out for Delivery, Delivered/Completed), the client also receives an email. The notification content varies by status and includes relevant details such as estimated delivery time. This keeps the client informed about their order's progress in real-time.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Receives push, DB, and (for key statuses) email notification on status changes |
| Cook | Triggers notifications by updating order status |
| Manager | Triggers notifications by updating order status if permitted |

---

## User Scenarios
### Scenario 1: Order confirmed
The cook confirms the order. The client receives a push notification: "Order #1234 Confirmed! Your order is being prepared." and a DB notification. An email is also sent with confirmation details.

### Scenario 2: Order ready for pickup
The cook marks the order as "Ready for Pickup." The client receives push + DB: "Order #1234 is ready for pickup! Head to [location]." Email includes pickup location details.

### Scenario 3: Order out for delivery
The cook marks the order as "Out for Delivery." The client receives push + DB: "Order #1234 is on its way!" No email for this status (not a key status).

### Scenario 4: Order preparing
The cook marks the order as "Preparing." The client receives push + DB: "Order #1234 is being prepared." No email for this status.

### Scenario 5: Order delivered
The cook marks the order as "Delivered." The client receives push + DB + email: "Order #1234 has been delivered. Enjoy your meal!"

---

## Business Rules
| Code | Rule |
|------|------|
| BR-278 | Push + DB notifications are sent for every order status change |
| BR-279 | Email notifications are sent only for key statuses: Confirmed, Ready for Pickup, Out for Delivery, Delivered, Completed |
| BR-280 | Notification content is customized per status with relevant details |
| BR-281 | Confirmed status notification includes: order ID and confirmation message |
| BR-282 | Ready status notification includes: order ID and pickup location (if pickup) or delivery ETA (if delivery) |
| BR-283 | Delivered/Completed notification includes: order ID and a prompt to rate/review |
| BR-284 | Cancelled status notification includes: order ID and cancellation reason if available |
| BR-285 | Push and DB notifications link to the client's order detail page |
| BR-286 | Email includes a "View Order" button linking to the client's order detail |
| BR-287 | Notifications are queued to not block the status update response |
| BR-288 | All notification text must use `__()` localization |

---

## Data Involved
**Creates:**
- Push notification to client
- DB notification record
- Email (for key statuses only)

**Reads:**
- `orders` table for order details and new status
- `users` table for client contact info
- Tenant/cook info for branding in emails

**Updates:**
- Nothing

**Relationships:**
- Notification references Order
- Order belongsTo User (client)

---

## Acceptance Criteria
- **Given** a status change to "Confirmed," **when** processed, **then** client receives push + DB + email
- **Given** a status change to "Preparing," **when** processed, **then** client receives push + DB only (no email)
- **Given** a status change to "Delivered," **when** processed, **then** client receives push + DB + email
- **Given** the push notification, **when** tapped, **then** it navigates to the client's order detail page
- **Given** the email for "Delivered" status, **when** opened, **then** it includes a prompt to leave a review

---

## Verification Steps
1. Update an order to "Confirmed"; verify client gets push, DB, and email
2. Update to "Preparing"; verify client gets push and DB but no email
3. Update to "Ready for Pickup"; verify client gets push, DB, and email with location
4. Update to "Delivered"; verify client gets push, DB, and email
5. Tap push notification and verify navigation to order detail
6. Check email content for each key status and verify appropriate details
7. Verify notifications are queued and do not block the status update

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Rapid status changes (cook skips statuses) | Each change generates its own notification; no debouncing |
| Client has unsubscribed from email | Push and DB still sent; email skipped per preferences |
| Status reverted (e.g., back to Confirmed) | Notification sent for the new status; may confuse client but is accurate |
| Order cancelled by system (not cook) | Cancellation notification still sent to client |
| Client's push subscription expired | DB and email still delivered; push fails silently |

---

## UI/UX Notes
- Push notification uses status-appropriate icons or colors
- DB notification in notification center shows order status badge and summary
- Email follows branded template with status-specific header color (green for Confirmed, blue for Ready, etc.)
- Email subject varies: "Order #[ID] Confirmed," "Order #[ID] Ready for Pickup," etc.
- Delivered email includes a "Rate Your Order" call-to-action button

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-014 | PWA & Push Notification Infrastructure | Push delivery mechanism |
| F-015 | Notification Center | Displays DB notifications |
| F-157 | Cook Order Status Update | Triggers these notifications on status change |
| F-160 | Client Order Detail View | Destination when notification is tapped |
