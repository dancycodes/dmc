# F-173 — Flutterwave Transfer Execution

> Module: Wallet
> Priority: Must-have
> Precedence: F-172
> Type: functional

---

## What It Does
Executes a cook's withdrawal by sending funds to their mobile money account via the Flutterwave Transfer API. Processes pending withdrawal requests created by F-172. On success: marks the withdrawal as completed, creates a wallet transaction record, and notifies the cook. On failure: marks the withdrawal as failed, restores the withdrawable balance, notifies the cook and admin, and adds the failed transfer to the admin's manual payout queue (F-065). All transfer attempts are logged for audit purposes.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Executes the transfer via Flutterwave API |
| Cook | Receives success or failure notification |
| Admin | Handles failed transfers via the manual payout queue |

---

## User Scenarios
### Scenario 1: Successful transfer
A pending withdrawal request for 20,000 XAF to MTN MoMo 670-123-456. The system calls the Flutterwave Transfer API. The transfer succeeds. The withdrawal record is marked "completed." A wallet transaction is created: "Withdrawal — -20,000 XAF — Completed." The cook receives a notification: "20,000 XAF has been sent to your MTN MoMo account."

### Scenario 2: Failed transfer
The Flutterwave Transfer API returns an error (e.g., invalid recipient). The withdrawal record is marked "failed." The 20,000 XAF is restored to the cook's withdrawable balance. The cook is notified: "Withdrawal of 20,000 XAF failed. The amount has been returned to your wallet." An admin is notified. The failed transfer is added to the manual payout queue.

### Scenario 3: Transfer timeout
The Flutterwave API does not respond within the timeout period. The transfer is marked as "pending_verification." A follow-up job checks the transfer status with Flutterwave after a delay. If confirmed: marked as completed. If failed: handled as a failure.

### Scenario 4: Multiple withdrawals processing
Three withdrawal requests are pending. The system processes them sequentially. Each is handled independently: some may succeed and others may fail.

### Scenario 5: Admin manual payout
A failed transfer appears in the admin's manual payout queue (F-065). The admin manually sends the money to the cook via alternative means and marks the task as completed.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-356 | Withdrawals are executed via the Flutterwave Transfer API to mobile money |
| BR-357 | Supported mobile money: MTN Mobile Money and Orange Money (Cameroon) |
| BR-358 | On success: withdrawal marked completed, wallet transaction created, cook notified (push + DB + email) |
| BR-359 | On failure: withdrawal marked failed, withdrawable balance restored, cook + admin notified, added to manual payout queue |
| BR-360 | Transfer timeout: marked as pending_verification, follow-up job re-checks status |
| BR-361 | All transfer attempts are logged (request, response, status) for audit |
| BR-362 | Flutterwave transfer reference is stored on the withdrawal record |
| BR-363 | Failed transfers create a task in the admin manual payout queue (F-065) |
| BR-364 | Transfer processing is idempotent: duplicate processing of the same request does not create duplicate transfers |
| BR-365 | Cook notification includes: amount, destination, status |

---

## Data Involved
**Reads:**
- `withdrawal_requests` table for pending requests
- Cook's mobile money details
- Flutterwave API credentials from config

**Creates:**
- Wallet transaction record (type: withdrawal, completed or failed)
- Manual payout task (for failed transfers)
- Notifications (push + DB + email)
- Transfer audit log entries

**Updates:**
- `withdrawal_requests.status` to completed, failed, or pending_verification
- `withdrawal_requests.flutterwave_reference` on API response
- `cook_wallets.withdrawable_amount` restored on failure
- `withdrawal_requests.completed_at` or `failed_at` timestamps

**Relationships:**
- WithdrawalRequest belongsTo CookWallet
- Failed transfers create ManualPayoutTask (F-065)
- Uses Flutterwave Transfer API (external)

---

## Acceptance Criteria
- **Given** a pending withdrawal, **when** the Flutterwave transfer succeeds, **then** the withdrawal is marked completed and the cook is notified
- **Given** a pending withdrawal, **when** the Flutterwave transfer fails, **then** the withdrawable balance is restored and a manual payout task is created
- **Given** a transfer timeout, **when** the follow-up job checks, **then** the status is resolved based on Flutterwave's response
- **Given** a successful transfer, **when** checking the wallet transactions, **then** a withdrawal transaction record exists
- **Given** a failed transfer, **when** checking the admin panel, **then** a manual payout task appears in the queue

---

## Verification Steps
1. Submit a withdrawal request and verify the Flutterwave API is called
2. Simulate a successful transfer response and verify completion flow
3. Simulate a failed transfer response and verify failure flow (balance restored, admin notified)
4. Verify the wallet transaction record is created
5. Verify the cook receives the appropriate notification
6. Verify failed transfers appear in the admin manual payout queue
7. Simulate a timeout and verify the pending_verification flow
8. Check the transfer audit log for request/response details
9. Attempt to reprocess an already-completed withdrawal and verify idempotency

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Flutterwave API is completely down | All transfers fail; admin alerted; all added to manual queue |
| Transfer succeeds but notification fails | Transfer is still marked completed; notification retry mechanism |
| Partial amount sent by Flutterwave | Should not happen; if it does, log discrepancy and alert admin |
| Cook's mobile money account is inactive | Flutterwave returns error; handled as a failure |
| Duplicate API call for same withdrawal | Idempotency key prevents duplicate transfer |
| Very large withdrawal amount | Flutterwave may have per-transfer limits; validated before API call |

---

## UI/UX Notes
- No direct UI for this feature; it is a background process
- Cook sees results via:
  - Notifications: success or failure notification
  - Wallet dashboard (F-169): updated balance
  - Wallet transactions (F-170): withdrawal entry
- Admin sees results via:
  - Manual payout queue (F-065) for failed transfers
  - Activity log for all transfer attempts

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-172 | Cook Withdrawal Request | Creates the withdrawal request processed here |
| F-065 | Manual Payout Task Queue | Failed transfers are added here |
| F-169 | Cook Wallet Dashboard | Reflects updated balances |
| F-170 | Cook Wallet Transaction History | Shows withdrawal transactions |
