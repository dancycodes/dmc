# F-121 — Custom Selling Unit Definition

> Module: Meal Component
> Priority: Must-have
> Precedence: F-076
> Type: functional

---

## What It Does
Allows a cook to define custom selling units for their tenant beyond the standard pre-seeded units. Standard units (plate, bowl, pot, cup, piece, portion, serving, pack) are available to all tenants. Cooks can add tenant-specific units like "calabash," "bucket," "wrap," or any custom measurement relevant to their cuisine. Full CRUD operations are supported. Custom units are tenant-scoped and used when creating meal components (F-118). Managed via Gale from the cook dashboard.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Defines and manages custom selling units |
| Manager | Manages units if granted `manage-meals` permission |

---

## User Scenarios
### Scenario 1: View standard and custom units
The cook navigates to the Selling Units section. They see 8 standard units (plate, bowl, etc.) marked as "Standard" and 2 custom units they created ("calabash", "wrap").

### Scenario 2: Create a custom unit
The cook clicks "Add Unit" and enters name_en: "Calabash" and name_fr: "Calebasse." The custom unit is saved and becomes available for selection when creating meal components.

### Scenario 3: Edit a custom unit
The cook renames "Calabash" to "Large Calabash." The change reflects everywhere the unit is used.

### Scenario 4: Delete an unused custom unit
The cook deletes "Wrap" which is not used by any component. The unit is removed.

### Scenario 5: Attempt to delete a unit in use
The cook tries to delete "Calabash" which is assigned to 2 meal components. The action is blocked: "Cannot delete — this unit is used by 2 components."

### Scenario 6: Attempt to delete a standard unit
Standard units do not have delete buttons. They are system-managed and cannot be modified or deleted.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-306 | Standard units are pre-seeded: plate, bowl, pot, cup, piece, portion, serving, pack |
| BR-307 | Standard units cannot be edited or deleted by cooks |
| BR-308 | Custom units are tenant-scoped |
| BR-309 | Custom unit name is required in both English and French |
| BR-310 | Custom unit name must be unique within the tenant (per language), and unique against standard unit names |
| BR-311 | Custom units cannot be deleted if used by any meal component |
| BR-312 | Only users with `manage-meals` permission can manage custom units |
| BR-313 | Custom unit CRUD is logged via Spatie Activitylog |
| BR-314 | Custom unit name max length: 50 characters per language |
| BR-315 | Standard units have pre-defined translations for English and French |

---

## Data Involved
**Creates:**
- `SellingUnit` model with fields: `id`, `tenant_id` (nullable — null for standard units), `name_en`, `name_fr`, `is_standard` (boolean), `created_at`, `updated_at`
- Migration for `selling_units` table
- Seeder for the 8 standard units
- Factory for SellingUnit

**Reads:**
- All selling units (standard + tenant custom) for listing and selection
- MealComponent references to check usage before deletion

**Updates:**
- SellingUnit record on edit (custom only)

**Deletes:**
- SellingUnit record on delete (custom only, if not in use)

**Relationships:**
- SellingUnit belongsTo Tenant (nullable — standard units have null tenant_id)
- SellingUnit hasMany MealComponents

---

## Acceptance Criteria
- **Given** a new tenant, **when** viewing selling units, **then** 8 standard units are available
- **Given** a cook, **when** they create a custom unit with valid EN/FR names, **then** it appears in the unit list
- **Given** a custom unit in use, **when** the cook tries to delete it, **then** deletion is blocked
- **Given** an unused custom unit, **when** deleted, **then** it is removed
- **Given** a standard unit, **when** the cook tries to edit or delete it, **then** the action is unavailable
- **Given** a duplicate name matching a standard unit, **when** submitted, **then** validation fails

---

## Verification Steps
1. Verify 8 standard units are pre-seeded and available
2. Create a custom unit — confirm it appears in the list and in component creation dropdown
3. Edit a custom unit — confirm the name updates
4. Attempt to delete a custom unit in use — confirm blocked
5. Delete an unused custom unit — confirm removal
6. Verify standard units cannot be edited or deleted
7. Attempt to create a custom unit with a standard unit name — confirm validation error
8. Check activity log for custom unit operations

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Custom unit name matches a standard unit (e.g., "Plate") | Validation error: duplicates standard unit |
| Standard unit seeder run multiple times | Idempotent — does not create duplicates |
| Cook has many custom units (20+) | Scrollable list; consider search |
| Custom unit name with special characters | Accepted and stored correctly |
| Language mismatch (EN filled, FR empty) | Validation error — both required |

---

## UI/UX Notes
- Accessible from cook dashboard under "Settings" > "Selling Units" or within the meal component section
- List shows standard units (non-editable, marked with "Standard" badge) and custom units (editable)
- "Add Unit" button for creating custom units
- Inline edit or modal form for create/edit
- Standard units listed first, then custom units
- Delete button hidden or disabled on standard units and in-use custom units
- All interactions via Gale
- Mobile-friendly card layout

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-076 | Cook Dashboard Layout & Navigation | Provides the dashboard shell |
| F-118 | Meal Component Creation | Uses selling units in the unit dropdown |
| F-119 | Meal Component Edit | Unit can be changed during component edit |
| F-129 | Meal Detail View | Displays the unit name to clients |
