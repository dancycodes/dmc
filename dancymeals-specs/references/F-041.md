# F-041 — Notification Preferences Management

> Module: User Settings
> Type: functional
> Priority: Should-have
> Precedence: F-030, F-014

---

## What It Does

Allows authenticated users to manage their notification preferences. For each notification
type (orders, payments, complaints, promotions, system announcements), the user can toggle
push and email channels on or off. Database notifications are always on and cannot be disabled.
Preferences are saved and applied to all future notifications.

---

## Who Uses It

- **All authenticated users** who want to control which notifications they receive and through
  which channels.

---

## User Scenarios

### Happy Path
1. User navigates to Notification Preferences from their profile page (F-030).
2. The preferences page displays a table/grid of notification types vs. channels:
   - Rows: Orders, Payments, Complaints, Promotions, System
   - Columns: Push, Email, Database (always on, no toggle)
3. Current preferences are reflected in the toggle states.
4. User turns off email notifications for "Promotions."
5. User turns off push notifications for "System."
6. User clicks "Save Preferences."
7. Preferences are saved via Gale without page reload.
8. Toast: "Notification preferences updated."

### Alternate Path — First Visit (Defaults)
1. User has never set preferences.
2. All notification channels default to ON for all types.
3. User can then customize as desired.

### Alternate Path — Database Channel
1. User sees the "Database" column for each notification type.
2. The database toggle is always ON and grayed out (not interactive).
3. A tooltip or note explains: "In-app notifications are always active."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-175 | Notification types: orders, payments, complaints, promotions, system. |
| BR-176 | Toggleable channels: push and email. |
| BR-177 | Database (in-app) notifications are always enabled and cannot be turned off. |
| BR-178 | Default state for all toggleable channels is ON (enabled) for all types. |
| BR-179 | Preferences are stored per user and apply globally (not tenant-scoped). |
| BR-180 | When a notification is generated, the system checks the user's preferences before sending via push or email. |
| BR-181 | Preferences changes take effect immediately for future notifications. |
| BR-182 | Push notifications can only be toggled if the user has granted push permission in their browser. If not, the push column shows "Permission required" with a prompt to enable. |
| BR-183 | All text must be localized via `__()`. |

---

## Data Involved

### NotificationPreference Model (created/updated)
| Field | Type | Notes |
|-------|------|-------|
| user_id | FK | The owning user |
| notification_type | enum | orders, payments, complaints, promotions, system |
| push_enabled | boolean | Default: true |
| email_enabled | boolean | Default: true |

### Preference Matrix Display
| Notification Type | Push | Email | Database |
|-------------------|------|-------|----------|
| Orders | Toggle | Toggle | Always ON |
| Payments | Toggle | Toggle | Always ON |
| Complaints | Toggle | Toggle | Always ON |
| Promotions | Toggle | Toggle | Always ON |
| System | Toggle | Toggle | Always ON |

---

## Acceptance Criteria

```
Given I navigate to notification preferences
When the page loads
Then I see a matrix of notification types and channels with current toggle states

Given I have never set preferences
When the page loads
Then all push and email toggles default to ON

Given I toggle off email for "Promotions" and save
When the preference is saved
Then future promotion emails are not sent to me

Given I view the database column
When I look at the toggles
Then they are always on and not interactive

Given I have not granted push notification permission
When I view the push column
Then I see a "Permission required" indicator instead of toggles

Given I save my preferences
When the save completes
Then a toast confirms "Notification preferences updated"
```

---

## Verification Steps

1. Navigate to notification preferences — confirm the matrix of types and channels is displayed.
2. Toggle a preference and save — confirm it persists on page reload.
3. Verify database notifications show as always ON and cannot be toggled.
4. Turn off email for a type, trigger that notification — confirm no email is sent but database notification is created.
5. Verify default state for a new user is all channels ON.

---

## Edge Cases

- User disables all push and email for all types — the system only sends database notifications. This is valid.
- A new notification type is added to the system — it should default to ON for all users who have not explicitly configured it.
- User revokes push notification permission in browser settings — the push toggle should reflect this (disabled or "Permission required").
- Concurrent updates from two tabs — last save wins.

---

## UI/UX Notes

- Table/grid layout with clear rows (types) and columns (channels).
- Toggles are switch-style (not checkboxes) for a modern feel.
- Database column has muted/grayed toggles that are always on — indicating they cannot be changed.
- On mobile, the grid may need to stack or use a card-per-type layout.
- Save button at the bottom of the form; loading state during save.
- A brief description of each notification type is shown (e.g., "Orders: New orders, status updates, cancellations").
- Light/dark mode support.

---

## Related Features

- **F-030** — Profile View (links to this page)
- **F-014** — Push Notification Infrastructure (provides push channel)
- **F-015** — Email Notification Infrastructure (provides email channel)
- **F-191** through **F-195** — Notification features that check these preferences
