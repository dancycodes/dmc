# F-145 â€” Delivery Fee Calculation

> Module: Ordering
> Priority: Must-have
> Precedence: F-141
> Type: functional

---

## What It Does
Calculates and displays the delivery fee based on the client's selected delivery quarter. When the client selects a quarter during the delivery location step, the system looks up the delivery fee for that quarter. If the quarter belongs to a fee group, the group fee is used. Otherwise, the individual quarter fee is used. The fee is displayed clearly and added to the order total. A fee of 0 is displayed as "Free delivery."

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Sees the delivery fee for their selected location during checkout |

---

## User Scenarios
### Scenario 1: Standard delivery fee
The client selects "Bonaberi" quarter. The fee for Bonaberi is 1,000 XAF. The display shows: "Delivery to Bonaberi: 1,000 XAF."

### Scenario 2: Group fee
"Akwa" and "Bonanjo" are in the same fee group with a fee of 500 XAF. The client selects "Akwa." The display shows: "Delivery to Akwa: 500 XAF."

### Scenario 3: Free delivery
The cook has set 0 XAF as the fee for "Deido." The client selects "Deido." The display shows: "Delivery to Deido: Free delivery."

### Scenario 4: Fee changes on quarter change
The client initially selects "Akwa" (500 XAF), then switches to "Bonaberi" (1,000 XAF). The displayed fee updates reactively to 1,000 XAF and the order total adjusts.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-307 | Delivery fee is determined by the selected quarter |
| BR-308 | If the quarter belongs to a fee group, the group fee is used |
| BR-309 | If the quarter has an individual fee (no group), the individual fee is used |
| BR-310 | A fee of 0 XAF is displayed as "Free delivery" |
| BR-311 | The fee is displayed in the format: "Delivery to {quarter}: {fee} XAF" |
| BR-312 | The fee updates reactively when the quarter selection changes (via Gale) |
| BR-313 | The delivery fee is added to the order total (F-146) |
| BR-314 | Pickup orders have no delivery fee (always 0) |
| BR-315 | All text must be localized via `__()` |

---

## Data Involved
**Reads:**
- Quarter delivery fee configuration
- Fee group associations
- Selected quarter from checkout session

**Creates:**
- Delivery fee entry in checkout session/order draft

**Updates:**
- Checkout session with calculated delivery fee
- Order total calculation

**Relationships:**
- Triggered by F-141 (Delivery Location Selection) when quarter is selected
- Fee data from F-091 (Delivery Area Management)
- Feeds into F-146 (Order Total Calculation & Summary)

---

## Acceptance Criteria
- **Given** a quarter with a 1,000 XAF fee, **when** selected, **then** "Delivery to {quarter}: 1,000 XAF" is displayed
- **Given** a quarter in a group with 500 XAF fee, **when** selected, **then** the group fee (500 XAF) is used
- **Given** a quarter with 0 XAF fee, **when** selected, **then** "Free delivery" is displayed
- **Given** the client changes quarter, **when** the new quarter loads, **then** the fee updates reactively
- **Given** a pickup order, **when** calculating fees, **then** delivery fee is 0

---

## Verification Steps
1. Select a quarter with a known fee; verify the correct fee displays
2. Select a quarter in a fee group; verify the group fee is used
3. Select a quarter with 0 fee; verify "Free delivery" displays
4. Change the quarter selection; verify the fee updates
5. Verify the fee is added to the order total on the summary page

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Quarter has no fee configured | Should not happen (validation in delivery area setup); show error if it occurs |
| Fee group is deleted after order starts | Use the fee that was valid at selection time |
| Very high delivery fee | Displayed normally; no cap |
| Client switches from delivery to pickup | Delivery fee becomes 0 |

---

## UI/UX Notes
- Fee displayed inline below the quarter selection during the location step
- Clear, prominent display with the quarter name and fee amount
- "Free delivery" shown in green
- Fee also reflected in the order summary (F-146)
- Fee changes animate smoothly when quarter changes

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-141 | Delivery Location Selection | Triggers fee calculation on quarter selection |
| F-091 | Delivery Area Management | Source of fee data |
| F-146 | Order Total Calculation & Summary | Includes delivery fee in total |
