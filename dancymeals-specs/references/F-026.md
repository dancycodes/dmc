# F-026 — Password Reset Request

> Module: Auth
> Type: functional
> Priority: Must-have
> Precedence: F-005, F-015

---

## What It Does

Provides a "Forgot password" page linked from the login form. The user enters their email
address and submits. If the email exists, a password reset link is sent. Regardless of
whether the email exists, a success message is shown to prevent email enumeration. The
request is rate-limited. Works on any domain.

---

## Who Uses It

- **Registered users** who have forgotten their password.

---

## User Scenarios

### Happy Path
1. User clicks "Forgot password?" on the login page.
2. The password reset request page loads with an email input field.
3. User enters their registered email address and clicks "Send Reset Link."
4. The system finds the user, generates a password reset token, and sends a reset email.
5. A success message displays: "If an account with that email exists, we've sent a reset link."
6. User checks their email for the reset link.

### Alternate Path — Email Does Not Exist
1. User enters an email that is not registered.
2. The system does not send any email (no account found).
3. The same success message displays: "If an account with that email exists, we've sent a reset link."
4. No information is leaked about whether the email is registered.

### Alternate Path — On Tenant Domain
1. User is on a cook's tenant site and clicks "Forgot password?"
2. The reset request page shows tenant branding.
3. The flow works identically — password reset is platform-level.

### Error Path — Rate Limited
1. User has submitted too many reset requests in a short time.
2. The form shows: "Too many requests. Please try again in X minutes."

### Error Path — Invalid Email Format
1. User enters text that is not a valid email format.
2. The form shows a validation error: "Please enter a valid email address."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-064 | The success message must be identical whether or not the email exists in the system (prevent email enumeration). |
| BR-065 | Password reset requests are rate-limited: maximum 3 requests per 15 minutes per email. |
| BR-066 | The password reset token expires after 60 minutes. |
| BR-067 | The reset email contains a signed URL pointing to the password reset execution page (F-027). |
| BR-068 | The password reset request page must be accessible on any domain. |
| BR-069 | Honeypot protection is not required on this form (user is already known to have an account). |
| BR-070 | All text on this page must be localized via `__()`. |
| BR-071 | A link back to the login page must be visible. |

---

## Data Involved

### Password Reset Token (created if email exists)
| Field | Details |
|-------|---------|
| email | The submitted email address |
| token | Hashed token stored in password_resets/password_reset_tokens table |
| created_at | Timestamp for expiration calculation |

### Reset Email Content
| Element | Details |
|---------|---------|
| Subject | "Reset your DancyMeals password" (localized) |
| Body | Greeting, reset button/link, expiration notice (60 minutes), security note |

---

## Acceptance Criteria

```
Given I am on the login page
When I click "Forgot password?"
Then I am taken to the password reset request page with an email field

Given I enter a registered email and submit
When the server processes the request
Then a reset email is sent and I see the generic success message

Given I enter an unregistered email and submit
When the server processes the request
Then no email is sent but I see the same generic success message

Given I submit the form 3 times in 15 minutes
When I try a 4th time
Then I see a rate limit error message

Given I am on a tenant domain
When I access the password reset request page
Then the tenant branding is displayed

Given I view the reset request page
When I look for navigation links
Then I see a link back to the login page
```

---

## Verification Steps

1. Click "Forgot password?" on the login page and confirm the reset request page loads.
2. Submit with a registered email and verify the reset email is sent.
3. Submit with an unregistered email and confirm the same success message appears (no email sent).
4. Submit 4 times rapidly for the same email and confirm rate limiting activates.
5. Verify the reset request page has a "Back to login" link.

---

## Edge Cases

- User submits the same email multiple times within the token validity window — a new token is generated, invalidating the previous one.
- User's account is deactivated — a reset email is still sent (they may need to contact support, but the token itself works).
- Email delivery failure — the system has no way to know; the user can try resending.
- Very long email address — validate maximum length.

---

## UI/UX Notes

- Simple, clean page with a single email input and submit button.
- Light/dark mode support.
- The success message is shown as a prominent alert/notice (not a toast — user needs to see it).
- "Back to login" link is clearly visible below the form.
- Submit button shows a loading state during processing.
- On tenant domains, the tenant logo appears above the form.

---

## Related Features

- **F-005** — Authentication Scaffolding (provides reset routes)
- **F-015** — Email Notification Infrastructure (sends the reset email)
- **F-024** — User Login (links to this page)
- **F-027** — Password Reset Execution (processes the reset link sent from here)
