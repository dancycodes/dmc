# F-138 â€” Meal Component Selection & Cart Add

> Module: Ordering
> Priority: Must-have
> Precedence: F-129, F-118
> Type: functional

---

## What It Does
Handles the interactive selection of meal components and addition to the cart from the meal detail view. The client selects components, adjusts quantities using a quantity selector that respects minimum, maximum, and available stock limits, and clicks "Add to Cart." Component requirement rules are enforced: dependent components cannot be added without their required counterpart. The cart updates reactively via Gale, showing a running total. This is the bridge between browsing meals and building an order.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (guest or authenticated) | Selects meal components and quantities to add to their cart |

---

## User Scenarios
### Scenario 1: Simple component selection
The client views "Ndole Platter" and selects 2 plates of "Ndole (main)" at 2,000 XAF each. They click "Add to Cart." The cart icon updates showing 1 item and 4,000 XAF total.

### Scenario 2: Multiple components from one meal
The client adds 2 plates of Ndole, 1 portion of Plantains (500 XAF), and 1 Miondo (300 XAF). Total for this addition: 4,800 XAF. All items are added to the cart in a single action.

### Scenario 3: Requirement rule enforcement
The client tries to add "Plantains (side)" without selecting "Ndole (main)" first. The system shows a validation message: "Plantains requires Ndole (main dish) to be selected." The Plantains add button remains disabled until Ndole is selected.

### Scenario 4: Stock limit enforcement
"Special Pepper Sauce" has only 3 units left. The client tries to set quantity to 5. The quantity selector caps at 3 with a message: "Only 3 available."

### Scenario 5: Adding from multiple meals
The client adds components from "Ndole Platter" then navigates to "Eru Soup" and adds components from that meal. The cart accumulates items from both meals.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-243 | Quantity selector minimum is 1, maximum is the lesser of available stock or cook-defined max |
| BR-244 | Component requirement rules are enforced: a dependent component cannot be added without its required component |
| BR-245 | The running total updates reactively as components are selected and quantities adjusted |
| BR-246 | Cart state is maintained in the session (server-side) and accessible across the tenant site |
| BR-247 | Adding to cart does not require authentication; guest carts work via session |
| BR-248 | Adding the same component again from the same meal updates the existing quantity (does not create duplicate entries) |
| BR-249 | Cart items are grouped by meal for display purposes |
| BR-250 | All price amounts are in XAF (integer, no decimals) |
| BR-251 | Cart updates use Gale (no page reload) |
| BR-252 | All text (buttons, messages, totals) must be localized via `__()` |

---

## Data Involved
**Reads:**
- Meal components: name, price, unit, stock, requirement rules
- Existing cart session data

**Creates:**
- Cart session entries (meal_id, component_id, quantity, unit_price)

**Updates:**
- Cart session on add/update
- Cart icon badge in navigation (item count, running total)

**Relationships:**
- Triggered from F-129 (Meal Detail View)
- Uses component data from F-118 (Meal Component Management)
- Cart data feeds into F-139 (Order Cart Management)

---

## Acceptance Criteria
- **Given** the client selects 2 of a component, **when** clicking "Add to Cart", **then** the cart updates with 2 units and the correct subtotal
- **Given** a component with a requirement rule, **when** the required component is not selected, **then** the dependent component's add button is disabled
- **Given** a component with 3 units in stock, **when** the client tries to set quantity to 5, **then** the quantity is capped at 3
- **Given** a guest user, **when** adding to cart, **then** the cart works via session without requiring login
- **Given** the same component is added again, **when** processing, **then** the existing cart entry's quantity is updated
- **Given** items from 2 meals in the cart, **when** viewing the cart, **then** items are grouped by meal

---

## Verification Steps
1. Select a component with quantity 2 and add to cart; verify cart icon updates
2. Try to add a dependent component without its required one; verify it is blocked
3. Set quantity beyond stock limit; verify it is capped
4. Add items from two different meals; verify cart groups them correctly
5. Add the same component twice; verify quantity updates rather than duplicates
6. Verify guest cart works without authentication
7. Verify running total calculation is correct

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Component price changes after adding to cart | Cart uses the price at time of addition; final price recalculated at checkout |
| Component becomes sold out after adding to cart | Cart shows warning; quantity adjusted at checkout |
| Session expires while building cart | Cart is lost; user must re-add items |
| Browser back button after adding to cart | Cart state persists via session |
| Maximum cart size | No hard limit but practical maximum enforced at checkout (e.g., 50 items) |

---

## UI/UX Notes
- Quantity selector: minus (-) button, number display, plus (+) button
- Plus button disabled at max; minus button disabled at 1
- "Add to Cart" button with cart icon; shows price total for selected components
- Disabled state clearly visible (greyed out) for components blocked by requirements
- Requirement message displayed as inline hint below the dependent component
- Cart icon in navigation shows badge with item count and running total
- Success toast on add: "Added to cart" with a link to "View Cart"

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-129 | Meal Detail View | UI context where selection happens |
| F-118 | Meal Component Management | Source of component data and rules |
| F-139 | Order Cart Management | Manages the cart built by this feature |
