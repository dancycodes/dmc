# F-149 â€” Payment Method Selection

> Module: Payment
> Priority: Must-have
> Precedence: F-146
> Type: functional

---

## What It Does
Presents the payment method selection step during checkout. The client chooses from available payment options: MTN Mobile Money, Orange Money, or Wallet Balance (if enabled by admin and sufficient funds). For mobile money options, the client can enter a new mobile money number or select a previously saved payment method. Displays the total amount to pay. This step leads directly to payment initiation (F-150) or wallet deduction (F-153).

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Selects their payment method and enters/confirms payment details |

---

## User Scenarios
### Scenario 1: Paying with MTN Mobile Money
The client selects "MTN Mobile Money." They enter their MoMo number (pre-filled from profile if available). They see "Total to pay: 6,500 XAF." They click "Pay Now" to initiate the payment.

### Scenario 2: Paying with Orange Money
The client selects "Orange Money" and enters their Orange Money number. The flow is identical to MTN except the payment provider channel differs.

### Scenario 3: Paying with Wallet Balance
The client has 10,000 XAF in their wallet from a previous refund. Wallet payment is enabled by admin. The "Wallet Balance" option shows "Available: 10,000 XAF" and is selectable. The client chooses it; payment is instant (no Flutterwave redirect).

### Scenario 4: Wallet balance insufficient
The client has 3,000 XAF in their wallet but the order total is 6,500 XAF. The "Wallet Balance" option is greyed out with: "Insufficient balance (3,000 XAF available)."

### Scenario 5: Saved payment method
The client has used "MTN 655 123 456" before. This appears as a saved option. They select it and click "Pay Now" without re-entering the number.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-345 | Available payment methods: MTN Mobile Money, Orange Money, Wallet Balance |
| BR-346 | Wallet Balance is only available if: (a) admin has enabled wallet payments AND (b) wallet balance >= order total |
| BR-347 | If wallet balance < order total, the wallet option is visible but disabled with balance shown |
| BR-348 | Mobile money options require a phone number (pre-filled from profile or saved methods) |
| BR-349 | Previously used payment methods are offered as saved options |
| BR-350 | The total to pay is displayed prominently |
| BR-351 | Phone number for mobile money must match Cameroon format |
| BR-352 | "Pay Now" triggers F-150 (Flutterwave) for mobile money or F-153 for wallet |
| BR-353 | All text must be localized via `__()` |

---

## Data Involved
**Reads:**
- Order total from F-146
- Client's wallet balance
- Admin setting: wallet payments enabled/disabled
- Client's saved payment methods (phone numbers used previously)
- Client's profile phone number

**Creates:**
- Payment method selection in checkout session

**Updates:**
- Checkout session with selected payment method and details

**Relationships:**
- Follows F-146 (Order Total Calculation & Summary)
- Leads to F-150 (Flutterwave Payment Initiation) for mobile money
- Leads to F-153 (Wallet Balance Payment) for wallet
- Wallet data from F-166 (Client Wallet)

---

## Acceptance Criteria
- **Given** the checkout reaches payment, **when** the step loads, **then** MTN MoMo and Orange Money options are displayed
- **Given** wallet payments are enabled and balance >= total, **when** viewing options, **then** Wallet Balance is selectable
- **Given** wallet balance < total, **when** viewing options, **then** Wallet Balance is disabled with balance shown
- **Given** a saved payment method exists, **when** viewing options, **then** the saved method appears as a quick-select
- **Given** the client selects MTN MoMo and enters a number, **when** clicking "Pay Now", **then** payment initiation (F-150) is triggered
- **Given** the client selects Wallet Balance, **when** clicking "Pay Now", **then** wallet deduction (F-153) is triggered

---

## Verification Steps
1. Reach the payment step and verify all available payment methods are shown
2. Select MTN MoMo and enter a phone number; verify "Pay Now" is enabled
3. Select Orange Money and verify same flow
4. Test with wallet enabled and sufficient balance; verify wallet is selectable
5. Test with wallet insufficient balance; verify wallet is disabled
6. Test with wallet payments disabled by admin; verify wallet option is hidden
7. Verify saved payment methods appear

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Client has no saved payment methods | Only manual entry available |
| Admin disables wallet while client is on payment step | Next interaction refreshes options; wallet option disappears |
| All payment methods unavailable | Should not happen; at minimum mobile money is always available |
| Client changes payment method after selecting | Previous selection is cleared; new selection stored |
| Phone number entered with wrong format | Inline validation error |

---

## UI/UX Notes
- Payment methods as large, selectable cards with provider logos (MTN yellow, Orange orange)
- Wallet option with balance amount displayed
- Saved methods as compact pills/chips within each payment type
- Phone number input with +237 prefix
- Total displayed prominently at the top: "Pay 6,500 XAF"
- "Pay Now" as a prominent, colored CTA button
- Step indicator showing this is the payment step
- Back button to return to order summary

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-146 | Order Total Calculation & Summary | Source of the total amount |
| F-150 | Flutterwave Payment Initiation | Next step for mobile money payments |
| F-153 | Wallet Balance Payment | Next step for wallet payments |
| F-166 | Client Wallet | Source of wallet balance data |
