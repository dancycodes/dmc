# F-111 — Meal Delete

> Module: Meal
> Priority: Must-have
> Precedence: F-108
> Type: functional

---

## What It Does
Allows a cook to delete a meal. Deletion is soft-delete to preserve order history and data integrity. A meal cannot be deleted if there are pending or active orders referencing it. Deleting a meal immediately removes it from public view (tenant landing page). A confirmation dialog with appropriate warnings is shown before deletion. The action is performed via Gale and logged.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Deletes meals they no longer wish to offer |
| Manager | Deletes meals if granted `manage-meals` permission |

---

## User Scenarios
### Scenario 1: Delete a draft meal with no orders
The cook clicks delete on a draft meal "Test Meal" that has no orders. Confirmation dialog: "Delete 'Test Meal'? This will remove it from your menu." The cook confirms. The meal is soft-deleted and removed from the meal list and public view.

### Scenario 2: Delete a live meal with completed orders only
The cook deletes "Old Special" which has 15 completed orders but no pending ones. Confirmation dialog includes: "This meal has 15 past orders. Order history will be preserved." Deletion succeeds.

### Scenario 3: Attempt to delete a meal with pending orders
The cook tries to delete "Jollof Rice" which has 3 pending orders. The delete button is disabled or clicking it shows: "Cannot delete — 3 pending orders exist. Complete or cancel them first."

### Scenario 4: Cancel deletion
The cook clicks delete, sees the confirmation dialog, and clicks Cancel. No deletion occurs.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-218 | Meals are soft-deleted (preserved in database with `deleted_at` timestamp) |
| BR-219 | Cannot delete a meal with pending or active orders (status: pending payment, paid, confirmed, preparing, ready, out for delivery, ready for pickup) |
| BR-220 | Soft-deleted meals are immediately hidden from the tenant landing page |
| BR-221 | Soft-deleted meals are removed from the cook's meal list (unless filtered to show deleted) |
| BR-222 | Order history references to deleted meals remain intact |
| BR-223 | Associated images, components, tags, and schedule overrides are also soft-deleted or retained |
| BR-224 | A confirmation dialog must be shown before deletion |
| BR-225 | Meal deletion is logged via Spatie Activitylog |
| BR-226 | Only users with `manage-meals` permission can delete meals |

---

## Data Involved
**Creates:**
- Nothing

**Reads:**
- Meal record
- Related orders to check for pending/active status

**Updates:**
- Meal `deleted_at` timestamp (soft delete)

**Deletes:**
- Nothing permanently (soft delete only)

**Relationships:**
- Meal hasMany Orders — checked for pending status
- Meal hasMany MealComponents — retained (soft-deleted or cascading soft delete)
- Meal hasMany MealImages — retained
- Meal belongsToMany Tags — pivot records retained

---

## Acceptance Criteria
- **Given** a meal with no pending orders, **when** the cook confirms deletion, **then** the meal is soft-deleted and hidden from public view
- **Given** a meal with pending orders, **when** the cook tries to delete, **then** the action is blocked with a clear message
- **Given** a deleted meal, **when** viewing order history, **then** the meal name still appears in past orders
- **Given** the confirmation dialog, **when** Cancel is clicked, **then** no deletion occurs
- **Given** a successful deletion, **when** checking the activity log, **then** the deletion is recorded

---

## Verification Steps
1. Delete a draft meal with no orders — confirm soft deletion
2. Attempt to delete a meal with pending orders — confirm it is blocked
3. Delete a meal with only completed orders — confirm it succeeds
4. Verify order history still references the deleted meal
5. Verify the meal is hidden from the tenant landing page
6. Verify the meal is removed from the cook's meal list
7. Cancel a deletion and verify the meal remains
8. Check activity log for the deletion entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Meal deleted while a client is viewing it | Client sees a "meal no longer available" message on next action |
| Meal with active schedule override | Schedule override data retained but inactive |
| Multiple rapid delete clicks | Only one deletion processed |
| Restoring a soft-deleted meal | Future feature consideration; not in current scope |
| Meal is the only live meal for the cook | Deletion succeeds; cook has no live meals (landing page shows empty state) |

---

## UI/UX Notes
- Delete button (trash icon) on meal list and meal edit page
- Button disabled or hidden if pending orders exist, with tooltip explaining why
- Confirmation dialog (modal) with meal name and order count information
- Dialog buttons: "Delete" (destructive, red) and "Cancel" (neutral)
- After deletion, meal list refreshes via Gale
- Success toast: "Meal deleted"
- No page reload

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-108 | Meal Creation Form | Creates the meals that can be deleted |
| F-110 | Meal Edit | Edit page has delete button |
| F-116 | Meal List View (Cook Dashboard) | List updates after deletion |
| F-128 | Available Meals Grid Display | Deleted meals removed from public grid |
