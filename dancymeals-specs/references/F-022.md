# F-022 — User Registration Submission

> Module: Auth
> Type: functional
> Priority: Must-have
> Precedence: F-021, F-006

---

## What It Does

Processes the registration form submission. Validates all fields including unique email,
valid Cameroon phone format (+237), and password strength requirements. Creates the user
with the default "client" role. Sends an email verification link. Logs the registration
activity. Automatically logs the user in after successful registration.

---

## Who Uses It

- **Visitors** submitting the registration form (F-021).

---

## User Scenarios

### Happy Path
1. Visitor submits the registration form with valid data.
2. Server validates: name present, email unique, phone valid (+237 format), password meets
   strength requirements, password confirmation matches.
3. A new user record is created with `is_active = true`.
4. The user is assigned the "client" role via Spatie Permission.
5. An email verification link is sent to the provided email address.
6. The registration activity is logged via Spatie Activitylog.
7. The user is automatically logged in.
8. The user is redirected to the intended page or the home page of the current domain.
9. A toast notification confirms successful registration.

### Alternate Path — Registration on Tenant Domain
1. Visitor registers on a tenant domain (e.g., latifa.dancymeals.com).
2. All validation and creation steps are identical (user is global, not tenant-scoped).
3. After auto-login, user is redirected to the tenant's home page.

### Error Path — Validation Failures
1. Visitor submits with an already-taken email address.
2. Server returns validation error: "This email is already registered."
3. Form re-displays with errors shown inline next to the relevant fields.
4. Previously entered data (except passwords) is preserved.

### Error Path — Invalid Phone Number
1. Visitor enters a phone number that does not match Cameroon format.
2. Server returns validation error: "Please enter a valid Cameroon phone number."

### Error Path — Weak Password
1. Visitor enters a password that does not meet strength requirements.
2. Server returns validation error detailing what is required.

### Error Path — Honeypot Triggered
1. A bot submission includes honeypot field data.
2. The request is silently rejected by Spatie Honeypot middleware before reaching validation.

---

## Business Rules

| Code | Rule |
|------|------|
| BR-028 | Email must be unique across all users in the system. |
| BR-029 | Phone number must match Cameroon format: starts with +237, followed by 9 digits (6, 7, or 2 as first digit after prefix). |
| BR-030 | Password must be at least 8 characters with at least one uppercase letter, one lowercase letter, and one number. |
| BR-031 | Password confirmation must match the password field exactly. |
| BR-032 | New users are assigned the "client" role by default. No other role can be assigned during registration. |
| BR-033 | Email verification is sent immediately after user creation. |
| BR-034 | The user is auto-logged in immediately after successful registration. |
| BR-035 | Registration activity must be logged with Spatie Activitylog (event: "registered", subject: the new user). |
| BR-036 | New users are created with `is_active = true` by default. |
| BR-037 | All validation error messages must be localized via `__()`. |

---

## Data Involved

### User Model (created)
| Field | Value |
|-------|-------|
| name | From form input |
| email | From form input (stored lowercase) |
| phone | From form input (stored in +237XXXXXXXXX format) |
| password | Hashed (bcrypt) |
| is_active | true |
| preferred_language | Detected from current locale or default "en" |
| email_verified_at | null (pending verification) |

### Related Records
| Record | Details |
|--------|---------|
| Role assignment | "client" role via Spatie Permission |
| Activity log | "registered" event on the user model |
| Verification email | Queued email with verification link |

---

## Acceptance Criteria

```
Given I submit the registration form with valid data
When the server processes the request
Then a new user is created with the provided name, email, and phone

Given a new user is created
When the creation completes
Then the user has the "client" role assigned

Given I register successfully
When the registration completes
Then I am automatically logged in and redirected to the intended page

Given I register successfully
When I check my email inbox
Then I have received an email verification link

Given I submit with an email that already exists
When the server validates
Then I see an error message next to the email field

Given I submit with phone number "12345"
When the server validates
Then I see an error about invalid Cameroon phone format

Given I submit with a password shorter than 8 characters
When the server validates
Then I see an error about password requirements
```

---

## Verification Steps

1. Register with valid data and confirm the user is created in the database with correct fields.
2. After registration, verify the user is automatically logged in (check navigation shows authenticated state).
3. Check that the user has the "client" role in the database.
4. Verify a verification email was sent (check email or logs).
5. Submit with a duplicate email and confirm the validation error appears.
6. Submit with an invalid phone number (e.g., +33612345678) and confirm the error.
7. Check the activity log for the "registered" event.

---

## Edge Cases

- Simultaneous registration with the same email by two users — the unique constraint should prevent duplicates; the second submission gets a validation error.
- Phone number with spaces or dashes — normalize to +237XXXXXXXXX format before validation and storage.
- Registration during database downtime — show a generic error and do not partially create the user.
- Extremely long name field — enforce a maximum length (255 characters).
- Email with mixed casing — store as lowercase for consistency.

---

## UI/UX Notes

- Validation errors appear inline next to the relevant field, not as a generic error block.
- The submit button shows a loading state while the form is processing.
- On success, a toast notification says something like "Welcome to DancyMeals!" (localized).
- Previously entered values (except passwords) are preserved on validation failure.

---

## Related Features

- **F-021** — User Registration Form (provides the form that submits here)
- **F-006** — Role & Permission Seed Setup (provides the "client" role)
- **F-023** — Email Verification Flow (triggered after registration)
- **F-017** — Activity Logging Setup (used to log the registration event)
- **F-015** — Email Notification Infrastructure (used to send verification email)
