# F-036 — Delete Delivery Address

> Module: User Settings
> Type: functional
> Priority: Must-have
> Precedence: F-034

---

## What It Does

Allows an authenticated user to delete a saved delivery address. A confirmation dialog is
shown before deletion. The address cannot be deleted if it is the user's only address and
there are pending orders that reference it. On successful deletion, a toast notification
confirms the action.

---

## Who Uses It

- **All authenticated users** removing a saved delivery address they no longer need.

---

## User Scenarios

### Happy Path
1. User clicks "Delete" on an address in the address list (F-034).
2. A confirmation dialog appears: "Delete this address? This cannot be undone."
3. User confirms the deletion.
4. The address is removed from the database.
5. The address disappears from the list via Gale (no page reload).
6. Toast: "Address deleted."

### Alternate Path — Delete the Default Address
1. User deletes the address that is currently set as default.
2. After deletion, if other addresses remain, the first remaining address becomes the new default.
3. If no addresses remain, there is no default.

### Alternate Path — Cancel Deletion
1. User clicks "Delete" on an address.
2. Confirmation dialog appears.
3. User clicks "Cancel."
4. The address remains unchanged.

### Error Path — Only Address with Pending Orders
1. User has one saved address.
2. There are pending orders (not yet completed/cancelled) that reference this address.
3. User clicks "Delete."
4. The system blocks deletion: "This address is used by pending orders and cannot be deleted. You can edit it instead."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-141 | A confirmation dialog must be shown before deleting an address. |
| BR-142 | An address cannot be deleted if it is the user's only address AND there are pending orders referencing it. |
| BR-143 | If the deleted address was the default, the first remaining address becomes the new default. |
| BR-144 | Users can only delete their own addresses. |
| BR-145 | Deletion is permanent (hard delete, not soft delete). |
| BR-146 | If the user has multiple addresses, any address can be deleted regardless of pending orders (orders store address data at order creation time). |

---

## Data Involved

### Address Model (deleted)
| Action | Details |
|--------|---------|
| Hard delete | Address record removed from database |
| Default reassignment | If deleted address was default, next address becomes default |

### Validation Check
| Check | Details |
|-------|---------|
| Pending orders | Count of user's orders with status in [pending_payment, paid, confirmed, preparing, ready, out_for_delivery] that reference this address |
| Address count | Total number of user's saved addresses |

---

## Acceptance Criteria

```
Given I click "Delete" on an address
When the confirmation dialog appears and I confirm
Then the address is deleted and removed from the list

Given I click "Delete" and then "Cancel" in the dialog
When I return to the list
Then the address is still there

Given I delete my default address and I have other addresses
When the deletion completes
Then another address becomes the new default

Given I have only one address and pending orders reference it
When I try to delete it
Then I see an error message and the address is not deleted

Given I have multiple addresses and pending orders reference the one I want to delete
When I delete it
Then the deletion succeeds (orders store a copy of the address data)
```

---

## Verification Steps

1. Delete an address and confirm it is removed from the list and database.
2. Cancel a deletion and confirm the address remains.
3. Delete the default address — confirm another address becomes default.
4. With one address and a pending order referencing it, try to delete — confirm it is blocked.
5. With multiple addresses and a pending order, delete one — confirm it succeeds.

---

## Edge Cases

- User deletes all their addresses — the address list shows an empty state.
- Rapid double-click on delete — should not cause errors; handle idempotently.
- Address deleted while user is on the checkout page selecting this address — the checkout should refresh the available addresses.
- User tries to delete via URL manipulation for another user's address — denied (403).

---

## UI/UX Notes

- Confirmation dialog is a modal with "Delete" (red/danger) and "Cancel" buttons.
- The dialog clearly states which address is being deleted (shows the label).
- Deletion animation: the card fades out or slides away from the list.
- No page reload — Gale handles the update.
- Light/dark mode support.

---

## Related Features

- **F-034** — Delivery Address List (delete action originates here)
- **F-033** — Add Delivery Address (user may add new address after deleting)
- **F-035** — Edit Delivery Address (alternative to deletion)
