# F-123 — Meal Component Availability Toggle

> Module: Meal Component
> Priority: Must-have
> Precedence: F-118
> Type: functional

---

## What It Does
Allows a cook to toggle individual meal component availability on and off. This is a quick toggle available on the component list within the meal edit page. An unavailable component cannot be ordered by clients and shows a "Sold Out" badge. The cook can re-enable availability at any time. This is independent of the meal-level availability toggle (F-113) — a meal can be available while some of its components are not. The toggle is performed via Gale.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Quickly toggles component availability |
| Manager | Toggles availability if granted `manage-meals` permission |
| Client | Sees "Sold Out" badge on unavailable components |

---

## User Scenarios
### Scenario 1: Mark a component as unavailable
The cook's "Ndole + Plantain" component has run out for the day. They toggle it to unavailable on the component list. Clients see a "Sold Out" badge and cannot add it to their cart.

### Scenario 2: Re-enable availability
The next day, the cook has restocked. They toggle "Ndole + Plantain" back to available. Clients can order it again.

### Scenario 3: Quick toggle from component list
On the component list within the meal edit page, the cook clicks the availability toggle on a component. It updates inline via Gale without leaving the page.

### Scenario 4: All components unavailable
All components of a live meal are toggled to unavailable. The meal is technically live but effectively unorderable. Clients see the meal with all components showing "Sold Out."

### Scenario 5: Component auto-unavailable from quantity
A component's available quantity reaches 0 (from orders). It is automatically toggled to unavailable (F-124). The cook can re-enable it by increasing the available quantity.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-326 | Component availability is independent of meal availability (F-113) |
| BR-327 | Unavailable components display a "Sold Out" badge to clients |
| BR-328 | Unavailable components cannot be added to the cart |
| BR-329 | Toggling availability does not affect pending orders containing this component |
| BR-330 | Availability toggle has immediate effect |
| BR-331 | Availability changes are logged via Spatie Activitylog |
| BR-332 | Only users with `manage-meals` permission can toggle availability |
| BR-333 | If the component has available quantity = 0, it auto-toggles to unavailable (see F-124) |

---

## Data Involved
**Creates:**
- Nothing

**Reads:**
- MealComponent record (current availability state)

**Updates:**
- MealComponent `is_available` boolean field

**Relationships:**
- None new; uses existing MealComponent model

---

## Acceptance Criteria
- **Given** an available component, **when** toggled to unavailable, **then** clients see "Sold Out" badge
- **Given** an unavailable component, **when** toggled to available, **then** the badge disappears and clients can order it
- **Given** an unavailable component, **when** a client tries to add it to their cart, **then** the action is blocked
- **Given** pending orders with this component, **when** toggled to unavailable, **then** orders are unaffected
- **Given** the toggle action, **when** completed, **then** the change is logged

---

## Verification Steps
1. Toggle a component to unavailable — confirm "Sold Out" badge on client view
2. Toggle back to available — confirm badge disappears
3. Attempt to add an unavailable component to cart — confirm blocked
4. Quick toggle from component list — confirm inline update
5. Check activity log for the availability change
6. Verify pending orders are unaffected

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| All components of a meal unavailable | Meal shows but no components can be ordered |
| Component with requirement rules toggled unavailable | Components depending on it (via "requires") may also become unorderable |
| Rapid toggle on/off | Final state persists correctly |
| Meal-level unavailable overrides component availability | If meal is unavailable, component availability is irrelevant |
| Component auto-toggled by quantity depletion | Manual re-enable possible only if available quantity is also increased |

---

## UI/UX Notes
- Toggle switch on each component in the component list
- Green = available, Red/Grey = unavailable ("Sold Out")
- Quick toggle with immediate visual feedback
- Toast: "Component is now unavailable" / "Component is now available"
- On client-facing pages: "Sold Out" badge overlaid on the component card
- Component still visible but greyed out with disabled "Add" button
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-113 | Meal Availability Toggle | Meal-level availability is separate |
| F-118 | Meal Component Creation | Creates components with default availability = true |
| F-124 | Meal Component Quantity Settings | Available quantity depletion triggers auto-unavailable |
| F-125 | Meal Component List View | Shows availability toggle on each component |
| F-138 | Meal Component Selection & Cart Add | Enforces availability during ordering |
