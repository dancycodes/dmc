# F-218 â€” Promo Code Application at Checkout

> Module: Promo
> Priority: Should-have
> Precedence: F-215, F-146
> Type: functional

---

## What It Does
Adds a promo code input field to the checkout flow. During checkout, the client enters a promo code in a text field. The system validates the code using the rules defined in F-219. If valid, the discount is applied to the order total and shown as a line item in the order summary. Only one promo code can be applied per order. The client can remove an applied code to revert the discount. The final total after discount must still meet the tenant's minimum order amount (F-213). The order summary updates in real-time via Gale as codes are applied or removed.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Enters and applies a promo code during checkout; can remove it |
| Cook | Benefits from promo-driven orders; sees promo details on the order |
| Manager | Can see promo code usage on orders if they have "manage-orders" permission |

---

## User Scenarios
### Scenario 1: Client applies a valid promo code
The client enters "WELCOME10" in the promo code field and clicks "Apply." The system validates the code (F-219), finds it valid, and applies a 10% discount. The order summary updates: "Promo WELCOME10 (-10%): -600 XAF." The total decreases from 6,000 XAF to 5,400 XAF.

### Scenario 2: Client applies a fixed discount code
The client enters "LAUNCH500." The system applies a 500 XAF discount. The summary shows: "Promo LAUNCH500: -500 XAF."

### Scenario 3: Client enters an invalid code
The client enters "FAKECODE" and clicks "Apply." The system returns an error: "This promo code is not valid." The order summary is unchanged.

### Scenario 4: Client removes an applied code
The client has "WELCOME10" applied. They click the "X" button next to the applied code. The discount is removed and the total reverts to the original amount via Gale.

### Scenario 5: Discount brings total below minimum order
The client's cart subtotal is 2,500 XAF. The tenant minimum is 2,000 XAF. The client applies a code for 600 XAF off, bringing the subtotal to 1,900 XAF. The checkout button is disabled with a message: "Add 100 XAF more to meet the minimum order of 2,000 XAF."

### Scenario 6: Client tries to apply a second code
The client already has "WELCOME10" applied and enters "LAUNCH500." An error appears: "Only one promo code can be applied per order. Remove the current code first."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-572 | Only one promo code can be applied per order |
| BR-573 | Promo code input is case-insensitive (normalized to uppercase before validation) |
| BR-574 | Validation follows all rules in F-219 |
| BR-575 | Percentage discount is applied to the food subtotal (before delivery fee) |
| BR-576 | Fixed discount is subtracted from the food subtotal (before delivery fee) |
| BR-577 | Discount cannot exceed the food subtotal (minimum discount result is 0 XAF for food) |
| BR-578 | The discount is displayed as a negative line item in the order summary with the code name |
| BR-579 | The client can remove an applied code; the discount is immediately reversed |
| BR-580 | The final total after discount must still meet the tenant's minimum order amount |
| BR-581 | The minimum order check uses post-discount food subtotal, excluding delivery fee |
| BR-582 | Promo code usage is recorded only when the order is successfully placed (not at application time) |
| BR-583 | If the promo becomes invalid between application and order placement (e.g., max uses reached), the order fails with an error |
| BR-584 | Order summary updates reactively via Gale when a code is applied or removed |
| BR-585 | All user-facing text must use `__()` localization |

---

## Data Involved
**Creates:**
- `promo_code_usages` record (upon successful order placement, not at checkout)

**Reads:**
- PromoCode record for validation (F-219)
- Cart session data for subtotal calculation
- Tenant minimum order amount setting
- Client's prior usage count for this code

**Updates:**
- Order record: `promo_code_id`, `promo_discount_amount` (upon order creation)

**Relationships:**
- Order belongsTo PromoCode (nullable)
- PromoCode hasMany PromoCodeUsages
- PromoCodeUsage belongsTo Order, belongsTo PromoCode, belongsTo User (client)

---

## Acceptance Criteria
- **Given** a valid promo code, **when** applied, **then** the discount appears as a line item and the total decreases
- **Given** an invalid code, **when** applied, **then** a specific error message is shown (from F-219)
- **Given** an applied code, **when** removed, **then** the total reverts to the pre-discount amount
- **Given** an already-applied code, **when** a second code is entered, **then** an error states only one code is allowed
- **Given** a percentage code, **when** applied, **then** the discount is calculated on the food subtotal only
- **Given** a discount that exceeds the food subtotal, **when** applied, **then** the food portion becomes 0 (not negative)
- **Given** a post-discount total below the minimum, **when** applied, **then** the checkout button is disabled with a message
- **Given** the order summary, **when** a code is applied or removed, **then** the summary updates via Gale in real-time

---

## Verification Steps
1. Enter a valid percentage code -- confirm discount line item and updated total
2. Enter a valid fixed code -- confirm discount line item and updated total
3. Enter an invalid code -- confirm error message
4. Remove an applied code -- confirm total reverts
5. Apply one code, then attempt a second -- confirm "one code only" error
6. Apply a code that would bring total below minimum -- confirm checkout is blocked
7. Apply a 100% discount code -- confirm food subtotal becomes 0, total equals delivery fee only
8. Verify promo usage is recorded only after successful order placement
9. Verify case-insensitive input ("welcome10" works like "WELCOME10")
10. Verify Gale reactivity for all summary updates

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| 100% discount on food | Food portion is 0 XAF; total = delivery fee only; "Pickup - Free" would make order free |
| Fixed discount larger than food subtotal | Discount capped at food subtotal; no negative food total |
| Promo code reaches max uses between apply and order submit | Order submission fails: "This promo code has reached its maximum uses. Please remove it and try again." |
| Code expires between apply and order submit | Order submission fails: "This promo code has expired. Please remove it and try again." |
| Client modifies cart after applying code | Discount recalculates on updated subtotal; percentage stays the same; fixed stays the same unless cart goes below code minimum |
| Cart total goes below promo minimum after cart edit | Code is automatically removed with a notice: "Promo code removed: your order no longer meets the minimum requirement" |
| Network error during code validation | Error toast: "Could not validate promo code. Please try again." |
| Free order (0 XAF total with pickup) | Allowed; order placed without payment step |

---

## UI/UX Notes
- Promo code field located in the order summary section during checkout (below items, above totals)
- Input field with "Enter promo code" placeholder and an "Apply" button
- Applied code: displayed as a tag/chip with the code name and an "X" remove button
- Discount line item: "Promo [CODE] (-X%): -Y XAF" or "Promo [CODE]: -Y XAF"
- Error messages appear inline below the promo input field (red text)
- Success state: green checkmark next to the applied code
- When code is applied, the input field is replaced with the tag/chip (hidden until removed)
- Checkout button disabled state with minimum order message below it
- All amount formatting: XAF with thousand separators
- Mobile: promo input spans full width; tag/chip below the input area
- Loading state on the "Apply" button during validation
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-215 | Cook Promo Code Creation | Creates codes that clients apply here |
| F-219 | Promo Code Validation Rules | Validation logic used when applying a code |
| F-146 | Order Total Calculation & Summary | Summary that displays the discount |
| F-213 | Minimum Order Amount Configuration | Post-discount total must meet minimum |
| F-139 | Order Cart Management | Cart provides the subtotal for discount calculation |
| F-148 | Order Creation | Records promo usage upon order placement |
