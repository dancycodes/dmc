# F-106 — Meal Schedule Override

> Module: Schedule
> Priority: Must-have
> Precedence: F-098, F-108
> Type: functional

---

## What It Does
Allows a cook to optionally create meal-specific schedules that override the cook's default tenant-level schedule for a particular meal. By default, every meal inherits the cook's schedule. When a meal-specific override is enabled, the meal follows its own schedule independently, ignoring the cook's default schedule. The override uses the same schedule creation UI (day selection, order/delivery/pickup intervals) but is scoped to the individual meal. Managed via Gale from the meal edit interface.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Enables and configures meal-specific schedule overrides |
| Manager | Configures overrides if granted `manage-meals` and `manage-schedules` permissions |

---

## User Scenarios
### Scenario 1: Enable custom schedule for a meal
The cook opens the "Jollof Rice" meal edit page and navigates to the Schedule section. The default is "Use cook's schedule." The cook toggles to "Use custom schedule." A schedule configuration UI appears (same as F-098/F-099/F-100 but scoped to this meal). The cook configures Monday and Wednesday availability only.

### Scenario 2: Meal with custom schedule operates independently
"Jollof Rice" has a custom schedule for Monday only. The cook's default schedule is Monday through Friday. On Tuesday, "Jollof Rice" is not available, even though the cook is open. On Monday, "Jollof Rice" follows its own time intervals, not the cook's defaults.

### Scenario 3: Revert to cook's schedule
The cook toggles "Jollof Rice" back to "Use cook's schedule." A confirmation dialog warns: "Switching back will delete the custom schedule for this meal." The cook confirms. The meal now follows the cook's default schedule again.

### Scenario 4: Default behavior — no override
A meal "Ndole" has no schedule override. It inherits the cook's default schedule entirely. Changes to the cook's schedule automatically apply to "Ndole."

### Scenario 5: Custom schedule with different intervals
The cook configures "Weekend Special" to be available only on Saturday with delivery from 12 PM to 4 PM, while the cook's default Saturday delivery is 11 AM to 2 PM. The meal uses its own delivery window.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-162 | By default, all meals inherit the cook's tenant-level schedule |
| BR-163 | A meal can optionally have its own schedule that completely overrides the cook's schedule for that meal |
| BR-164 | The toggle is binary: "Use cook's schedule" or "Use custom schedule" — no partial override |
| BR-165 | When custom schedule is active, the meal ignores all cook-level schedule entries |
| BR-166 | The custom schedule UI follows the same rules as cook schedule (F-098, F-099, F-100) |
| BR-167 | Reverting to cook's schedule deletes all meal-specific schedule entries |
| BR-168 | A confirmation dialog must be shown before reverting to cook's schedule |
| BR-169 | Meal schedules are tenant-scoped and meal-scoped |
| BR-170 | Schedule override changes are logged via Spatie Activitylog |
| BR-171 | Only users with both `manage-meals` and `manage-schedules` permissions can configure meal schedule overrides |

---

## Data Involved
**Creates:**
- `MealSchedule` model with same structure as `CookSchedule` plus a `meal_id` foreign key
- Migration for `meal_schedules` table
- Factory for MealSchedule

**Reads:**
- Meal record to scope the schedule
- CookSchedule entries (for display when "Use cook's schedule" is selected)
- Existing MealSchedule entries for the meal

**Updates:**
- Meal model with a flag or presence check indicating custom schedule is active

**Deletes:**
- MealSchedule entries when reverting to cook's schedule

**Relationships:**
- MealSchedule belongsTo Meal
- MealSchedule belongsTo Tenant
- Meal hasMany MealSchedules

---

## Acceptance Criteria
- **Given** a meal with no override, **when** viewing its schedule, **then** the cook's schedule is shown as inherited
- **Given** the cook toggles to "Use custom schedule," **when** the UI updates, **then** the schedule configuration form appears
- **Given** a custom schedule is configured, **when** viewing the meal's availability, **then** it follows the custom schedule, not the cook's
- **Given** the cook toggles back to "Use cook's schedule," **when** confirming, **then** custom schedule entries are deleted
- **Given** a meal with custom schedule for Monday only, **when** checking Tuesday, **then** the meal is not available even if the cook is open

---

## Verification Steps
1. Create a meal and verify it inherits the cook's schedule by default
2. Toggle to custom schedule and configure availability for specific days
3. Verify the meal follows its custom schedule, not the cook's
4. Revert to cook's schedule and confirm custom entries are deleted
5. Cancel the revert dialog and confirm custom schedule is retained
6. Verify only authorized users can configure overrides
7. Check activity log for override changes

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook changes their default schedule | Meals with custom overrides are unaffected; meals using cook's schedule update automatically |
| Meal with custom schedule and no days configured | Meal has custom schedule but is effectively unavailable every day |
| Custom schedule toggle while meal is live | Immediate effect on availability — clients see updated schedule |
| Meal is draft | Custom schedule can still be configured; takes effect when meal goes live |

---

## UI/UX Notes
- Schedule section within the meal edit page
- Toggle switch: "Use cook's schedule" (default, shows read-only cook schedule summary) vs "Use custom schedule" (shows editable schedule form)
- When using cook's schedule, display a read-only summary of the cook's schedule
- When using custom schedule, same UI as F-098/F-099/F-100 but scoped to this meal
- Confirmation dialog on revert with destructive action warning
- All interactions via Gale
- Mobile-friendly layout

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-098 | Cook Day Schedule Creation | Default schedule that meals inherit; same UI reused |
| F-099 | Order Time Interval Configuration | Same interval rules apply to meal schedules |
| F-100 | Delivery/Pickup Time Interval Config | Same interval rules apply to meal schedules |
| F-108 | Meal Creation Form | Creates meals that can have schedule overrides |
| F-132 | Schedule & Availability Display | Shows effective schedule to clients (cook's or meal's) |
