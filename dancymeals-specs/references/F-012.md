# F-012 â€” PWA Configuration

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Configures DancyMeals as a Progressive Web App (PWA). Creates the web app manifest with DancyMeals branding (app name, icons, theme color, background color, display mode). Creates a service worker that provides an offline fallback page when the user has no internet connection. Builds the offline page with a user-friendly message and retry functionality. Registers the service worker from the main application layout.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Can install the app to their home screen; sees offline page when disconnected |
| Cook | Can install the app; sees offline page when disconnected |
| Guest | Prompted to install (F-013); sees offline page when disconnected |

---

## User Scenarios
### Scenario 1: User installs PWA
A user visits DancyMeals on their mobile browser. The browser recognizes the valid manifest and service worker, enabling the "Add to Home Screen" capability. The user installs the app and it launches with the DancyMeals splash screen and icon.

### Scenario 2: User goes offline
A user is browsing DancyMeals and loses internet connectivity. Instead of the browser's default "No internet" page, they see a branded DancyMeals offline page with a friendly message and a "Try Again" button that attempts to reload.

### Scenario 3: Service worker registration
On first visit, the service worker is registered and begins caching the offline fallback page. Subsequent visits leverage the service worker for offline fallback capabilities.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-088 | The web app manifest must include: `name` ("DancyMeals"), `short_name` ("DancyMeals"), `start_url`, `display` ("standalone"), `theme_color`, `background_color`, and icons |
| BR-089 | Manifest icons must include at least 192x192 and 512x512 PNG sizes |
| BR-090 | The service worker handles only the offline fallback; no data caching or sync |
| BR-091 | The offline page must be pre-cached during service worker installation |
| BR-092 | The service worker must be registered on all pages (main domain and tenant domains) |
| BR-093 | The manifest must be linked in the `<head>` of all pages |
| BR-094 | On tenant domains, the PWA still identifies as "DancyMeals" (not the cook's brand name) |
| BR-095 | The offline page must be localized (show English or French based on last known locale) |

---

## Data Involved
**Creates:**
- `public/manifest.json` (web app manifest)
- `public/service-worker.js` (service worker for offline fallback)
- `public/offline.html` (standalone offline fallback page)
- PWA icon files in `public/icons/` (192x192, 512x512, maskable variants)

**Reads:**
- Request network status (service worker intercepts failed requests)

**Updates:**
- Base layout `<head>` to include manifest link and meta tags
- Base layout to include service worker registration script

**Relationships:**
- F-013 (PWA Install Prompt) builds on the manifest and service worker
- F-014 (Push Notifications) extends the service worker with push handlers

---

## Acceptance Criteria
- **Given** a browser that supports PWA, **when** visiting DancyMeals, **then** the manifest is loaded and the app is installable
- **Given** the PWA is installed, **when** launching from the home screen, **then** it opens in standalone mode with the DancyMeals icon and splash screen
- **Given** the user is online, **when** the service worker is registered, **then** the offline page is pre-cached
- **Given** the user loses internet, **when** navigating to any page, **then** the offline fallback page is displayed
- **Given** the offline page, **when** clicking "Try Again", **then** the page attempts to reload and returns to the app if connectivity is restored
- **Given** a tenant domain, **when** viewing the manifest, **then** the app name is "DancyMeals"

---

## Verification Steps
1. Open DevTools > Application > Manifest and verify all required fields are present
2. Check the Service Workers panel and confirm the service worker is registered and active
3. Simulate offline mode in DevTools and navigate to confirm the offline page appears
4. Verify the offline page has a "Try Again" button that reloads when clicked
5. Install the PWA and verify it launches in standalone mode with correct icon
6. Verify manifest icons are accessible at their defined paths

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Service worker update available | Browser handles update lifecycle; new SW activates on next visit |
| HTTPS not configured (local dev HTTP) | Service workers require HTTPS in production; localhost is exempt for development |
| Browser does not support service workers | App works normally without offline fallback; no errors thrown |
| User is on the offline page and connectivity returns | "Try Again" button navigates back to the last attempted URL |
| Multiple tabs open when going offline | Each tab independently shows the offline page |

---

## UI/UX Notes
- The offline page should be visually branded with DancyMeals colors and logo.
- Message should be warm and helpful: "You appear to be offline. Check your connection and try again."
- Include a simple illustration or icon indicating no connectivity.
- The "Try Again" button should be prominent and mobile-friendly (large tap target).
- The offline page must work without any network requests (fully self-contained HTML/CSS).
- Support both light and dark mode on the offline page (inline CSS based on `prefers-color-scheme`).

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; base project must exist |
| F-013 | PWA Install Prompt | Uses the manifest and service worker to prompt installation |
| F-014 | Push Notification Infrastructure | Extends the service worker with push event handling |
