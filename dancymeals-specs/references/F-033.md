# F-033 — Add Delivery Address

> Module: User Settings
> Type: functional
> Priority: Must-have
> Precedence: F-030

---

## What It Does

Allows authenticated users to add a saved delivery address to their address book. Fields
include a label (e.g., "Home", "Office"), town (select from available towns), quarter (select,
filtered by the chosen town), neighbourhood (text input with OpenStreetMap autocomplete),
and additional directions (textarea). Validates required fields. Saves to the user's address
book. Users can have a maximum of 5 saved addresses.

---

## Who Uses It

- **All authenticated users** who want to save delivery addresses for faster checkout.

---

## User Scenarios

### Happy Path
1. User navigates to their delivery addresses section (from profile, F-034).
2. User clicks "Add Address."
3. An address form appears with:
   - Label (text input, e.g., "Home")
   - Town (dropdown select with available towns)
   - Quarter (dropdown select, populated after town is selected)
   - Neighbourhood (text input with OpenStreetMap autocomplete suggestions)
   - Additional directions (textarea, optional)
4. User selects town "Douala" — the quarter dropdown populates with Douala's quarters.
5. User selects quarter "Bonamoussadi."
6. User starts typing in neighbourhood — autocomplete suggestions appear from OpenStreetMap.
7. User selects a suggestion or types freely.
8. User adds directions: "Behind the blue pharmacy, 2nd floor."
9. User clicks "Save Address."
10. The address is saved. Toast: "Address saved successfully."
11. The address appears in the address list (F-034).

### Alternate Path — First Address Becomes Default
1. User has no saved addresses.
2. User adds their first address.
3. It is automatically set as the default delivery address.

### Error Path — Maximum Addresses Reached
1. User already has 5 saved addresses.
2. User clicks "Add Address."
3. A message appears: "You can save up to 5 addresses. Please remove one to add a new one."
4. The add form is not shown.

### Error Path — Missing Required Fields
1. User tries to save without selecting a town or quarter.
2. Validation errors appear inline: "Town is required," "Quarter is required."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-119 | Maximum 5 saved addresses per user. |
| BR-120 | Label is required and must be unique among the user's addresses (max 50 characters). |
| BR-121 | Town is required and must be selected from available towns in the system. |
| BR-122 | Quarter is required and must belong to the selected town. |
| BR-123 | Neighbourhood is optional. If provided, OpenStreetMap autocomplete assists entry. |
| BR-124 | Additional directions are optional (max 500 characters). |
| BR-125 | The first address added by a user is automatically set as default. |
| BR-126 | The address is associated with the user (not tenant-scoped — user can use addresses across tenants). |
| BR-127 | All text and labels must be localized via `__()`. |

---

## Data Involved

### Address Model (created)
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| user_id | FK | Yes | The owning user |
| label | string | Yes | User-defined label, unique per user |
| town_id | FK | Yes | References towns table |
| quarter_id | FK | Yes | References quarters table, filtered by town |
| neighbourhood | string | No | Free text or from OpenStreetMap |
| additional_directions | text | No | Extra delivery instructions |
| is_default | boolean | No | Default: false (first address is auto-set to true) |
| latitude | decimal | No | From OpenStreetMap selection |
| longitude | decimal | No | From OpenStreetMap selection |

---

## Acceptance Criteria

```
Given I have fewer than 5 addresses
When I click "Add Address"
Then I see a form with label, town, quarter, neighbourhood, and directions fields

Given I select a town
When the town is selected
Then the quarter dropdown populates with quarters belonging to that town

Given I start typing in the neighbourhood field
When I type at least 3 characters
Then autocomplete suggestions from OpenStreetMap appear

Given I fill in all required fields and click save
When the server processes the request
Then the address is saved and appears in my address list

Given I have no addresses and add my first one
When it is saved
Then it is automatically set as the default address

Given I already have 5 saved addresses
When I try to add another
Then I see a message about the maximum limit
```

---

## Verification Steps

1. Add an address with all fields filled — confirm it saves and appears in the list.
2. Select a town and verify the quarter dropdown populates correctly.
3. Type in the neighbourhood field and verify autocomplete suggestions appear.
4. Add a first address and confirm it is set as default.
5. Add 5 addresses, then try to add a 6th — confirm the limit message appears.
6. Try to save without required fields — confirm validation errors.
7. Verify the saved address label is unique (try saving two addresses with the same label).

---

## Edge Cases

- User types a neighbourhood that does not match any OpenStreetMap results — allow free text entry.
- Two towns have quarters with the same name — the quarter dropdown must be filtered by the selected town.
- A town or quarter is deleted after the user saved an address referencing it — the address should still display (soft references or cascade handling).
- OpenStreetMap API is unavailable — neighbourhood field should still work as free text without autocomplete.
- User adds an address while on a tenant domain — the address is saved globally, not scoped to the tenant.

---

## UI/UX Notes

- The form can be a modal or an inline section within the address list page.
- Town and quarter dropdowns should be searchable if the list is long.
- Quarter dropdown is initially disabled/empty until a town is selected.
- Neighbourhood autocomplete shows a dropdown list of suggestions as the user types.
- Additional directions textarea has a character counter showing remaining characters.
- Save via Gale without page reload. Toast on success.
- Light/dark mode support.
- Mobile-first layout with full-width inputs.

---

## Related Features

- **F-030** — Profile View (links to address management)
- **F-034** — Delivery Address List (displays saved addresses)
- **F-035** — Edit Delivery Address (edit an existing address)
- **F-097** — OpenStreetMap Neighbourhood Search (provides autocomplete)
- **F-082** — Add Town (manages available towns)
- **F-086** — Add Quarter (manages available quarters)
