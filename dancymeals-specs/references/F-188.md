# F-188 â€” Order Message Thread View

> Module: Messaging
> Priority: Should-have
> Precedence: F-161
> Type: functional

---

## What It Does
Displays a chronological message thread for a specific order, visible to both the client and the cook/manager. Messages are shown in a chat-like interface accessible from the order detail page. Each message displays the sender's name, role, and timestamp. Older messages are loaded by scrolling up (lazy loading). The thread provides a communication channel between the client and the cook/manager for order-related questions, updates, and coordination.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Views the message thread from their order detail page |
| Cook | Views the message thread from the cook dashboard order detail |
| Manager | Views the message thread if granted `manage-orders` permission |

---

## User Scenarios
### Scenario 1: Client views message thread
The client opens their order detail page and clicks "Messages" or scrolls to the message section. A chat-like interface shows all messages exchanged with the cook, ordered chronologically. The client's messages appear on the right, the cook's on the left.

### Scenario 2: Cook views message thread
The cook opens an order in their dashboard and navigates to the messages tab. They see the same thread as the client, but with their messages on the right and the client's on the left.

### Scenario 3: Empty thread
A new order has no messages yet. The thread shows an empty state: "No messages yet. Start a conversation about this order." with the message input field below.

### Scenario 4: Loading older messages
The thread initially loads the most recent 20 messages. The user scrolls to the top and a "Load older messages" indicator appears. Older messages load above the current ones without losing scroll position.

### Scenario 5: Manager views thread
A manager with `manage-orders` permission opens an order's message thread. They see all messages and can also send messages on behalf of the tenant (shown as from the cook's business).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-239 | Each order has exactly one message thread shared between client and cook/manager |
| BR-240 | Messages are displayed in chronological order (oldest first) |
| BR-241 | Initial load shows the most recent 20 messages, scrolled to the bottom |
| BR-242 | Older messages load in batches of 20 when scrolling to the top |
| BR-243 | Each message displays: sender name, sender role (Client/Cook/Manager), timestamp, and message text |
| BR-244 | The thread is accessible only by the order's client, the tenant's cook, and authorized managers |
| BR-245 | Message thread is read-only after the order is Completed + 7 days or Cancelled |
| BR-246 | All user-facing text must use `__()` localization |
| BR-247 | Timestamps are displayed in relative format (e.g., "2 hours ago") with full date on hover |

---

## Data Involved
**Creates:**
- Nothing (read-only view)

**Reads:**
- `order_messages` table filtered by `order_id`, ordered by `created_at`
- `users` table for sender names and roles
- `orders` table for order status and ownership verification

**Updates:**
- Nothing

**Relationships:**
- OrderMessage belongsTo Order
- OrderMessage belongsTo User (sender)
- Order hasMany OrderMessage

---

## Acceptance Criteria
- **Given** an order with messages, **when** the client opens the thread, **then** messages are displayed chronologically
- **Given** an order with no messages, **when** the thread is opened, **then** an empty state is shown
- **Given** more than 20 messages, **when** the user scrolls to the top, **then** older messages load without losing scroll position
- **Given** a message from the cook, **when** viewed by the client, **then** it shows the cook's name, role "Cook," and timestamp
- **Given** an order that is Completed + 8 days, **when** the thread is opened, **then** messages are visible but the input is disabled
- **Given** a user who is not the client or cook/manager, **when** they try to access the thread, **then** they receive a 403 response

---

## Verification Steps
1. Open an order with messages and confirm chronological display
2. Open an order with no messages and confirm empty state
3. Create more than 20 messages and verify pagination on scroll
4. Verify sender name, role badge, and timestamp on each message
5. Check that the thread is read-only for orders Completed + 7 days
6. Verify unauthorized users cannot access the thread
7. Test on mobile to confirm responsive chat layout

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Sender account deleted | Message still shows with "Deleted User" as name |
| Hundreds of messages | Lazy loading prevents performance issues; only 20 loaded at a time |
| Order cancelled | Thread remains visible but becomes read-only immediately |
| Message contains very long text | Text wraps within the message bubble; no horizontal overflow |
| Concurrent viewing by both parties | Both see the same messages; new messages appear via Gale SSE |

---

## UI/UX Notes
- Chat-like bubble interface: client messages right-aligned, cook messages left-aligned
- Sender name and role badge above each message bubble
- Timestamp below or beside each bubble in muted text
- Scroll-to-bottom button appears when scrolled up in a long thread
- "Load older messages" spinner at the top when more messages exist
- Message input field and send button at the bottom (F-189)
- Thread accessible via a "Messages" tab or section on the order detail page
- Mobile: full-width chat layout with fixed input at bottom
- All interactions via Gale (no page reload)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-161 | Order Status Flow | Determines order status for read-only rules |
| F-189 | Message Send | Adds messages to this thread |
| F-190 | Message Notification | Sends notifications when new messages arrive |
| F-156 | Cook Order Detail View | Thread accessible from cook's order detail |
| F-160 | Client Order Detail View | Thread accessible from client's order detail |
