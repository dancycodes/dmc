# F-139 â€” Order Cart Management

> Module: Ordering
> Priority: Must-have
> Precedence: F-138
> Type: functional

---

## What It Does
Provides a full cart view where clients can review, modify, and manage their selected meal components before proceeding to checkout. Displays all cart items grouped by meal, with each item showing the meal name, component name, quantity, unit price, and subtotal. Clients can adjust quantities (increment/decrement), remove individual items, or clear the entire cart. The cart persists in the server-side session. Shows a running subtotal and a "Proceed to Checkout" button.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (guest or authenticated) | Reviews and manages their cart before checking out |

---

## User Scenarios
### Scenario 1: Viewing the cart
The client clicks the cart icon in the navigation. The cart page/panel opens showing 2 meal groups: "Ndole Platter" (2x Ndole at 2,000 XAF = 4,000 XAF, 1x Plantains at 500 XAF = 500 XAF) and "Eru Soup" (1x Eru at 1,500 XAF = 1,500 XAF). Subtotal: 6,000 XAF.

### Scenario 2: Adjusting quantity
The client clicks the "+" button on Ndole, changing quantity from 2 to 3. The subtotal for that line updates to 6,000 XAF and the cart subtotal updates to 8,000 XAF. All updates happen reactively via Gale.

### Scenario 3: Removing an item
The client clicks the remove (trash) icon on Plantains. The item is removed from the cart. The cart subtotal updates to 7,500 XAF.

### Scenario 4: Clearing the cart
The client clicks "Clear Cart." A confirmation prompt appears. On confirm, all items are removed and the cart shows an empty state: "Your cart is empty. Browse meals to get started!" with a link back to the meals section.

### Scenario 5: Proceeding to checkout
The client clicks "Proceed to Checkout." If not authenticated, they are prompted to login/register first. If authenticated, they proceed to the delivery/pickup selection step (F-140).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-253 | Cart items are displayed grouped by meal |
| BR-254 | Each item shows: meal name, component name, quantity, unit price, line subtotal |
| BR-255 | Quantity adjustment respects component stock limits and minimum of 1 |
| BR-256 | Removing the last item from a meal group removes the meal group header |
| BR-257 | Cart subtotal is the sum of all line subtotals |
| BR-258 | "Clear Cart" requires confirmation before executing |
| BR-259 | Cart persists in server-side session across page navigations |
| BR-260 | "Proceed to Checkout" requires authentication; guests are redirected to login |
| BR-261 | Cart cannot proceed to checkout if empty |
| BR-262 | All cart interactions use Gale (no page reload) |
| BR-263 | All text must be localized via `__()` |

---

## Data Involved
**Reads:**
- Cart session data (meal_id, component_id, quantity, unit_price)
- Component current availability (to validate stock)

**Creates:**
- Nothing (cart is session-based)

**Updates:**
- Cart session on quantity change, item removal, or clear

**Relationships:**
- Receives items from F-138 (Meal Component Selection & Cart Add)
- Feeds into F-140 (Delivery/Pickup Choice Selection) on checkout
- Subtotal used by F-144 (Minimum Order Amount Validation) and F-146 (Order Total Calculation)

---

## Acceptance Criteria
- **Given** a cart with items from 2 meals, **when** viewing the cart, **then** items are grouped by meal with correct totals
- **Given** the client increments a quantity, **when** the update processes, **then** line subtotal and cart subtotal update reactively
- **Given** the client removes an item, **when** the removal processes, **then** the item disappears and totals update
- **Given** the client clicks "Clear Cart" and confirms, **when** clearing, **then** all items are removed and empty state is shown
- **Given** a guest user clicks "Proceed to Checkout", **when** the action fires, **then** they are redirected to login
- **Given** an empty cart, **when** viewing the cart, **then** the checkout button is disabled

---

## Verification Steps
1. Add items to cart and open the cart view; verify grouped display
2. Increment and decrement quantities; verify totals update
3. Remove an item and verify it disappears with updated total
4. Clear the cart and verify empty state
5. As a guest, click checkout and verify login redirect
6. As an authenticated user, click checkout and verify navigation to next step
7. Navigate away and return to cart; verify items persist

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Component sold out since adding to cart | Show warning badge on item: "Limited availability" |
| Session expires | Cart is lost; show empty state with message |
| Decrementing quantity to 0 | Item is removed (same as remove action) |
| Cart has items from a meal that was deactivated | Show warning; item remains but flagged as unavailable |
| Very large quantities in cart | Practical limit enforced (max 50 per component) |

---

## UI/UX Notes
- Cart accessible as a slide-over panel or dedicated page
- Cart icon in navigation with badge showing item count
- Each item as a compact row: image thumbnail, meal/component name, quantity controls, price
- Quantity controls: minus (-), number, plus (+) inline
- Remove button as a trash icon
- Subtotal displayed prominently at the bottom
- "Continue Shopping" link and "Proceed to Checkout" button
- Empty state with illustration and "Browse Meals" CTA
- Mobile: full-screen cart with sticky checkout bar at bottom

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-138 | Meal Component Selection & Cart Add | Adds items to this cart |
| F-140 | Delivery/Pickup Choice Selection | Next step after cart checkout |
| F-144 | Minimum Order Amount Validation | Validates cart subtotal |
| F-146 | Order Total Calculation | Calculates final total from cart |
