# F-056 — Permission Assignment to Roles

> Module: Admin
> Priority: Must-have
> Precedence: F-052
> Type: functional

---

## What It Does
Provides an interface for assigning and revoking permissions for a role. Permissions are displayed in a grouped, categorized view organized by module (meals, orders, users, tenants, etc.). Each permission has a checkbox to grant or revoke it. The super-admin role always retains all permissions and cannot be modified. Admins can only assign permissions they themselves possess (prevents privilege escalation). Changes save without full page reload.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Super-Admin | Assigns any permission to any role |
| Admin | Assigns permissions they hold to roles (cannot escalate) |

---

## User Scenarios
### Scenario 1: Assigning permissions to a new custom role
A super-admin navigates to the "Kitchen Assistant" role's permission page. They see all permissions grouped by module: Meals (view-meals, create-meal, edit-meal, delete-meal), Orders (view-orders, manage-orders), etc. They check "view-meals", "create-meal", and "view-orders". Each change saves immediately via Gale.

### Scenario 2: Bulk selecting a module
The super-admin clicks the "Select All" checkbox for the Meals module. All meal-related permissions (view, create, edit, delete) are checked at once.

### Scenario 3: Admin with limited permissions assigning
An admin who has "view-meals" and "create-meal" but not "delete-meal" opens the permission page for a custom role. "delete-meal" is shown but disabled with a tooltip: "You cannot assign permissions you do not have."

### Scenario 4: Viewing super-admin permissions
An admin opens the super-admin role's permission page. All permissions are checked and the entire form is read-only with a note: "Super-admin always has all permissions. This cannot be modified."

### Scenario 5: Revoking a permission
A super-admin unchecks "delete-meal" from the "Kitchen Assistant" role. The change saves immediately. Users with this role can no longer delete meals.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-128 | Super-admin role always has ALL permissions; its permissions cannot be modified |
| BR-129 | An admin can only assign permissions they themselves possess |
| BR-130 | Permissions the admin does not have are visible but disabled (no privilege escalation) |
| BR-131 | Changes save immediately without full page reload (via Gale) |
| BR-132 | Permission changes take effect on the user's next request (no session invalidation needed) |
| BR-133 | Permission changes are logged in the activity log (which permissions were added/removed) |
| BR-134 | Permissions are grouped by module for organized display |

---

## Data Involved
**Reads:**
- All platform permissions (via Spatie)
- Current role's assigned permissions
- Current admin's own permissions (for escalation prevention)

**Creates:**
- Activity log entries for permission changes

**Updates:**
- Role-permission pivot table: adds or removes permission assignments

**Relationships:**
- F-052: Role must exist before permissions can be assigned
- F-006: Uses Spatie Permission infrastructure

---

## Acceptance Criteria
- **Given** a role, **when** checking a permission checkbox, **then** the permission is immediately assigned to the role
- **Given** a role, **when** unchecking a permission checkbox, **then** the permission is immediately revoked
- **Given** a module "Select All" checkbox, **when** checked, **then** all permissions in that module are assigned
- **Given** an admin without "delete-meal" permission, **when** viewing the permission page, **then** "delete-meal" is disabled
- **Given** the super-admin role, **when** viewing its permissions, **then** all are checked and the form is read-only
- **Given** any permission change, **when** saved, **then** an activity log entry records the change

---

## Verification Steps
1. Assign a permission to a custom role — confirm the user with that role can now perform the action
2. Revoke a permission — confirm the user can no longer perform the action
3. Use "Select All" for a module — confirm all permissions in the module are checked
4. Log in as an admin without a specific permission — confirm that permission's checkbox is disabled
5. View super-admin permissions — confirm all checked and read-only
6. Check activity log — confirm permission changes are recorded
7. Change permission and test immediately (no logout needed) — confirm it takes effect on next request

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Revoking a permission a user is currently using | Their next action that requires this permission is denied |
| Admin revokes their own permissions via the admin role | They lose those permissions on their next request; could lock themselves out of permissions page |
| All permissions removed from a role | Role exists but is effectively powerless |
| Network failure during save | Checkbox reverts to previous state; error toast shown |
| Two admins modifying same role's permissions simultaneously | Last change wins per-permission |

---

## UI/UX Notes
- Permissions grouped in collapsible sections by module (Meals, Orders, Users, Tenants, Finance, etc.)
- Each section has a "Select All / Deselect All" toggle
- Individual checkboxes with permission name and short description
- Disabled checkboxes for permissions the admin doesn't have (grayed out with tooltip)
- Visual feedback on save: brief green flash on changed checkbox
- Count indicator per section: "Meals (3/4 selected)"
- Sticky header with role name and total permissions count
- Breadcrumb: Admin > Roles > Kitchen Assistant > Permissions

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-052 | Create Role | Role created here; permissions assigned after |
| F-054 | Edit Role | Linked from edit page |
| F-006 | Spatie Permission Setup | Underlying permission infrastructure |
