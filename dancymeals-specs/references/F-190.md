# F-190 — Message Notification

> Module: Messaging
> Priority: Should-have
> Precedence: F-189, F-014
> Type: functional

---

## What It Does
When a message is sent in an order thread, the recipient receives a push notification and a database notification. Email is intentionally excluded for messages because they can be frequent and would overwhelm the user's inbox. The notification includes the sender's name, a preview of the message text, and a direct link to the order message thread. If the recipient is already viewing the thread, the notification is still recorded in the database but the push notification is suppressed (the message already appeared via SSE).

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Receives push + DB notification when cook/manager sends a message |
| Cook | Receives push + DB notification when client sends a message |
| Manager | Receives push + DB notification if granted `manage-orders` permission and is associated with the tenant |

---

## User Scenarios
### Scenario 1: Client receives notification of cook's message
The cook sends "Your order is being prepared. Estimated ready time: 1:00 PM." The client receives a push notification: "New message from Chef Latifa: Your order is being prepared..." Tapping the notification opens the order message thread directly.

### Scenario 2: Cook receives notification of client's message
The client sends "Can I add extra pepper to my order?" The cook receives a push notification: "New message from Amara on Order #1234: Can I add extra pepper..." Tapping opens the order in the cook dashboard with the message thread visible.

### Scenario 3: Recipient is already viewing the thread
The cook is viewing the message thread when the client sends a message. The message appears via SSE in real-time. The push notification is suppressed, but the DB notification is still recorded for the notification history.

### Scenario 4: Manager receives notification
A client sends a message on an order. The cook and all managers with `manage-orders` permission for the tenant receive the notification.

### Scenario 5: Multiple messages in quick succession
The client sends 3 messages in 30 seconds. Each message generates its own push and DB notification. No batching or debouncing — each message is an independent notification.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-259 | Message notifications use push + DB channels only (no email) |
| BR-260 | Notification includes: sender name, message preview (first 100 characters), order ID |
| BR-261 | Notification links directly to the order message thread |
| BR-262 | If the recipient is currently viewing the thread (active SSE connection), push notification is suppressed |
| BR-263 | DB notification is always recorded regardless of SSE connection status |
| BR-264 | When client sends a message, all of the tenant's cook and managers with `manage-orders` permission are notified |
| BR-265 | When cook or manager sends a message, only the client is notified |
| BR-266 | Notifications are marked as read when the user opens the message thread |
| BR-267 | All notification text must use `__()` localization |

---

## Data Involved
**Creates:**
- Push notification to recipient(s)
- DB notification record in `notifications` table

**Reads:**
- `order_messages` for the sent message content
- `orders` table for order context and tenant
- `users` table for sender name and recipient(s)
- Active SSE connections to determine push suppression

**Updates:**
- `notifications` table: `read_at` set when user opens the thread

**Relationships:**
- Notification references Order and OrderMessage

---

## Acceptance Criteria
- **Given** the cook sends a message, **when** the client is not viewing the thread, **then** the client receives a push + DB notification
- **Given** the client sends a message, **when** the cook is not viewing the thread, **then** the cook receives a push + DB notification
- **Given** the recipient is viewing the thread, **when** a message is sent, **then** no push notification is sent but a DB notification is recorded
- **Given** the notification, **when** tapped, **then** it navigates directly to the order message thread
- **Given** the user opens the message thread, **when** unread message notifications exist, **then** they are marked as read
- **Given** a message sent, **when** checking notification channels, **then** no email notification is sent

---

## Verification Steps
1. Send a message as client; verify cook receives push and DB notification
2. Send a message as cook; verify client receives push and DB notification
3. Open the thread on the recipient's side first, then send a message; verify no push but DB notification exists
4. Tap the push notification and verify it navigates to the correct thread
5. Open the thread and verify related notifications are marked as read
6. Confirm no email is sent for any message notification
7. Send a message to a tenant with a manager; verify manager receives notification

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| User has push notifications disabled | DB notification still recorded; push delivery fails silently |
| Recipient has no active device/browser for push | DB notification recorded; push queued by webpush provider |
| Multiple managers on the tenant | Each manager with `manage-orders` permission receives the notification |
| Sender sends message to themselves (edge case) | No notification generated for the sender |
| User dismisses push notification without reading | DB notification remains unread until thread is opened |

---

## UI/UX Notes
- Push notification format: "[Sender Name]: [Message preview...]" with app icon
- DB notification appears in the user's notification center with a message icon
- Notification preview truncates message at 100 characters with "..."
- Unread message notifications have a distinct visual indicator in the notification center
- Clicking the notification center entry navigates to the message thread
- No sound distinction between message notifications and other notifications

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-189 | Message Send | Triggers these notifications |
| F-188 | Order Message Thread View | Destination when notification is tapped |
| F-014 | PWA & Push Notification Infrastructure | Provides push notification delivery |
| F-015 | Notification Center | Displays DB notifications |
