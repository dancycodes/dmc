# F-208 — Analytics CSV/PDF Export

> Module: Analytics
> Priority: Should-have
> Precedence: F-200
> Type: functional

---

## What It Does
Adds an export button to every analytics page (cook analytics, client stats, admin analytics) that allows the user to download the current view's data as a CSV or PDF file. CSV exports contain raw tabular data suitable for spreadsheet analysis. PDF exports contain a formatted report with charts, summary cards, and date range context. The date range currently applied to the analytics view is reflected in the export. For large exports, the file is generated in the background and a download link is emailed to the user.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Exports their revenue, order, customer, or delivery analytics |
| Manager | Exports analytics if granted `view-analytics` permission |
| Client | Exports their spending stats |
| Admin | Exports platform revenue, cook performance, or growth metrics |

---

## User Scenarios
### Scenario 1: CSV export of revenue data
The cook is viewing their revenue analytics for "Last 3 Months." They click the export button and select "Download CSV." A CSV file downloads with columns: Date, Revenue (XAF), Order Count. The data covers the last 3 months.

### Scenario 2: PDF export of revenue data
The cook clicks "Download PDF." A formatted PDF generates with the DancyMeals header, date range, summary cards, and a chart image. The cook can share this with their accountant.

### Scenario 3: Admin exports cook performance
The admin is viewing the cook performance table filtered to "Douala" cooks. They export as CSV. The CSV contains: Cook Name, Region, Orders, Revenue, Rating, Complaints, Response Time — only for Douala cooks.

### Scenario 4: Large export via email
The admin exports "All Time" platform revenue data (100,000+ records). The system shows a message: "Your export is being prepared. A download link will be sent to your email." The email arrives in a few minutes with a time-limited download link.

### Scenario 5: Client exports spending stats
The client clicks export on their "My Stats" page. A simple PDF downloads with their spending summary and order history.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-449 | Export formats: CSV and PDF |
| BR-450 | Exports respect the currently applied date range and filters |
| BR-451 | CSV contains raw tabular data with column headers |
| BR-452 | PDF contains a formatted report with branding, charts, and summary |
| BR-453 | For datasets smaller than 5,000 rows, export is immediate (browser download) |
| BR-454 | For datasets larger than 5,000 rows, export is queued and a download link is emailed |
| BR-455 | Email download links expire after 24 hours |
| BR-456 | Export filename format: `dancymeals-{analytics-type}-{date-range}-{timestamp}.{csv|pdf}` |
| BR-457 | CSV uses UTF-8 encoding with BOM for Excel compatibility |
| BR-458 | PDF includes the DancyMeals logo, generated date, and the user's name |
| BR-459 | Export data is permission-scoped: cooks see only their data, admins see platform data |
| BR-460 | All user-facing text must use `__()` localization |
| BR-461 | Export events are logged via Spatie Activitylog |

---

## Data Involved
**Creates:**
- CSV or PDF file in temporary storage
- Email with download link for large exports
- Activity log entry

**Reads:**
- Same data sources as the analytics page being exported
- User info for PDF header and email delivery

**Updates:**
- Nothing

**Relationships:**
- Export is contextual to the analytics page it is triggered from

---

## Acceptance Criteria
- **Given** an analytics page, **when** the user clicks "Export CSV," **then** a CSV file downloads with the correct data
- **Given** an analytics page, **when** the user clicks "Export PDF," **then** a PDF file downloads with formatted content
- **Given** filters applied, **when** exporting, **then** the export reflects the filtered data
- **Given** a large dataset, **when** exporting, **then** the export is queued and a download link is emailed
- **Given** an email download link, **when** clicked after 24 hours, **then** it is expired
- **Given** a cook, **when** exporting, **then** only their tenant's data is included

---

## Verification Steps
1. Export CSV from cook revenue analytics; verify correct columns and data
2. Export PDF from cook revenue analytics; verify formatting and chart inclusion
3. Apply a date range filter and export; verify the data matches the filter
4. Simulate a large export; verify the email is sent with a working download link
5. Wait 24 hours and verify the download link expires
6. Verify export filenames follow the naming convention
7. Check activity log for export events
8. Export from admin analytics; verify platform-wide data

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| No data in selected range | CSV has headers only; PDF shows "No data available for the selected period" |
| PDF chart rendering fails | PDF generates without charts; includes a note "Charts could not be generated" |
| User's email is invalid | Toast error: "Export could not be emailed. Please check your email address." |
| Export triggered during high server load | Queued; may take longer but will complete |
| Concurrent exports by the same user | Each export runs independently |
| Very wide table (many columns) | CSV includes all columns; PDF uses landscape orientation |

---

## UI/UX Notes
- Export button in the top-right corner of each analytics page
- Dropdown: "Export as CSV" and "Export as PDF"
- Loading indicator during export generation
- For immediate downloads: file saves directly
- For queued exports: toast message "Export is being prepared. Check your email shortly."
- Email includes: subject "Your DancyMeals export is ready," download button, expiry notice
- Export button respects the same permissions as the analytics page
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-200 | Cook Revenue Analytics | Export source |
| F-201 | Cook Order Analytics | Export source |
| F-202 | Cook Customer Retention Analytics | Export source |
| F-203 | Cook Delivery Performance Analytics | Export source |
| F-204 | Client Spending & Order Stats | Export source |
| F-205 | Admin Platform Revenue Analytics | Export source |
| F-206 | Admin Cook Performance Metrics | Export source |
| F-207 | Admin Growth Metrics | Export source |
