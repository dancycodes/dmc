# F-023 — Email Verification Flow

> Module: Auth
> Type: functional
> Priority: Must-have
> Precedence: F-022, F-015

---

## What It Does

After registration, the user receives an email with a verification link. Until verified,
the user sees a "verify your email" notice on protected pages. A resend button is available.
Clicking the verification link marks the email as verified and redirects the user to the
appropriate page. Unverified users have limited access to certain features.

---

## Who Uses It

- **Newly registered users** who need to verify their email address.

---

## User Scenarios

### Happy Path
1. User registers and is auto-logged in (via F-022).
2. User sees a "Please verify your email address" banner/notice on the page.
3. User opens their email and finds the verification email from DancyMeals.
4. User clicks the verification link in the email.
5. The link verifies the email (sets `email_verified_at` timestamp).
6. User is redirected to the page they were on or the home/dashboard page.
7. The verification banner disappears. A toast confirms "Email verified successfully."

### Alternate Path — Resend Verification Email
1. User did not receive the verification email (or it expired).
2. User clicks the "Resend verification email" button on the verification notice.
3. A new verification email is sent.
4. A toast notification confirms: "Verification email sent."
5. The resend button is temporarily disabled to prevent spam (cooldown).

### Alternate Path — Already Verified User
1. A verified user clicks an old verification link from their email.
2. The system recognizes the email is already verified.
3. User is redirected to the home/dashboard with no error.

### Error Path — Invalid or Expired Token
1. User clicks a verification link with an invalid or expired token.
2. The system shows an error message: "This verification link is invalid or has expired."
3. A "Resend verification email" button is provided.

### Error Path — Verification Link for Different User
1. User A is logged in and clicks User B's verification link.
2. The system rejects the request — the link does not match the logged-in user.
3. An error is shown: "This verification link does not belong to your account."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-038 | Verification email is sent immediately after registration (queued job). |
| BR-039 | The verification link contains a signed URL with expiration (default: 60 minutes). |
| BR-040 | Unverified users can browse and view content but cannot place orders or submit reviews. |
| BR-041 | The resend button has a cooldown of 60 seconds between requests. |
| BR-042 | Resend requests are rate-limited to prevent abuse (max 5 per hour per user). |
| BR-043 | Clicking the verification link sets `email_verified_at` to the current timestamp. |
| BR-044 | The verification notice banner must appear on all pages until the email is verified. |
| BR-045 | Verification links are single-use — once verified, the link cannot be reused for any purpose. |
| BR-046 | All verification-related text must be localized via `__()`. |

---

## Data Involved

### User Model (updated)
| Field | Before | After |
|-------|--------|-------|
| email_verified_at | null | Current timestamp |

### Verification Email Content
| Element | Details |
|---------|---------|
| Subject | "Verify your DancyMeals email address" (localized) |
| Body | Greeting with user name, verification button/link, expiration notice |
| Link | Signed URL pointing to the verification endpoint |

---

## Acceptance Criteria

```
Given I just registered and am logged in
When I view any page
Then I see a "verify your email" banner with a resend button

Given I received the verification email
When I click the verification link
Then my email is marked as verified and the banner disappears

Given I click the resend button
When the system processes the request
Then a new verification email is sent and I see a confirmation toast

Given I click the resend button
When I try to click it again within 60 seconds
Then the button is disabled with a countdown timer

Given my verification link has expired
When I click it
Then I see an error with an option to request a new link

Given I am an unverified user
When I try to place an order
Then I am prompted to verify my email first
```

---

## Verification Steps

1. Register a new user and confirm the verification email is received.
2. Before verifying, navigate to a page and confirm the verification banner is visible.
3. Click the verification link and confirm `email_verified_at` is set in the database.
4. After verification, confirm the banner no longer appears.
5. Click the resend button and verify a new email is sent; confirm the cooldown timer activates.
6. As an unverified user, attempt to place an order and confirm the restriction message appears.

---

## Edge Cases

- User changes email (if supported later) — `email_verified_at` should be reset to null.
- Multiple rapid clicks on the verification link — should not cause errors; idempotent.
- Verification email lands in spam — the resend button allows the user to request again.
- User registers and immediately closes the browser — the verification email is still sent.
- Signed URL tampered with — Laravel's signed URL validation rejects it.

---

## UI/UX Notes

- The verification banner is a dismissible but persistent bar at the top of the page (reappears on next page load if still unverified).
- The banner includes the user's email address so they know which inbox to check.
- Resend button shows a countdown timer during cooldown (e.g., "Resend in 45s").
- On mobile, the banner should not obstruct navigation.
- The verification email should be clean, branded with DancyMeals logo, and have a large "Verify Email" button.

---

## Related Features

- **F-022** — User Registration Submission (triggers the verification email)
- **F-015** — Email Notification Infrastructure (provides email sending capability)
- **F-024** — User Login (login works for unverified users but with limited access)
