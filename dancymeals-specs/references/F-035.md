# F-035 — Edit Delivery Address

> Module: User Settings
> Type: functional
> Priority: Must-have
> Precedence: F-034

---

## What It Does

Allows an authenticated user to edit an existing saved delivery address. The form is
pre-populated with the current address data. Same fields as the add form: label, town,
quarter (filtered by town), neighbourhood (with OpenStreetMap autocomplete), and additional
directions. Validates input. Saves without page reload via Gale. Shows a toast on success.

---

## Who Uses It

- **All authenticated users** editing one of their saved delivery addresses.

---

## User Scenarios

### Happy Path
1. User clicks "Edit" on an address in the address list (F-034).
2. The edit form opens, pre-populated with the current values:
   - Label: "Home"
   - Town: "Douala"
   - Quarter: "Bonamoussadi"
   - Neighbourhood: "Rue des Manguiers"
   - Additional directions: "Behind the blue pharmacy"
3. User changes the neighbourhood to "Rue de la Paix" and updates directions.
4. User clicks "Save."
5. The address is updated via Gale without page reload.
6. Toast: "Address updated successfully."
7. The address list reflects the changes.

### Alternate Path — Change Town
1. User changes the town from "Douala" to "Yaoundé."
2. The quarter dropdown resets and populates with Yaoundé's quarters.
3. User selects a new quarter and continues.

### Error Path — Duplicate Label
1. User changes the label to one that already exists on another address.
2. Validation error: "You already have an address with this label."

### Error Path — Invalid Data
1. User clears the required town field.
2. Validation error: "Town is required."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-135 | All fields from F-033 (Add Delivery Address) apply here with the same validation rules. |
| BR-136 | The form must be pre-populated with the address's current values. |
| BR-137 | Label uniqueness is validated among the user's other addresses (excluding the current one). |
| BR-138 | When town changes, the quarter dropdown must reset and repopulate. |
| BR-139 | Users can only edit their own addresses. |
| BR-140 | Save must happen via Gale without page reload. |

---

## Data Involved

### Address Model (updated)
| Field | Editable | Notes |
|-------|----------|-------|
| label | Yes | Same validation as add (BR-120) |
| town_id | Yes | Quarter resets on change |
| quarter_id | Yes | Must belong to selected town |
| neighbourhood | Yes | OpenStreetMap autocomplete |
| additional_directions | Yes | Optional, max 500 characters |
| latitude | Yes | Updated if neighbourhood changes via autocomplete |
| longitude | Yes | Updated if neighbourhood changes via autocomplete |

---

## Acceptance Criteria

```
Given I click "Edit" on a saved address
When the form opens
Then all fields are pre-populated with the current address data

Given I change the town
When a new town is selected
Then the quarter dropdown resets and shows quarters for the new town

Given I update valid fields and click save
When the server processes the update
Then the address is updated and a toast confirms success

Given I change the label to one already used by another address
When I click save
Then I see a validation error about the duplicate label

Given I try to edit another user's address (by URL manipulation)
When the server processes the request
Then access is denied (403)
```

---

## Verification Steps

1. Click edit on an address — confirm all fields are pre-populated correctly.
2. Change the town — confirm the quarter dropdown resets and repopulates.
3. Update a field and save — confirm the change persists and toast appears.
4. Try saving with a duplicate label — confirm validation error.
5. Verify the update happens without page reload (Gale).

---

## Edge Cases

- User edits an address while that address is being used in a pending order — the edit should succeed (orders reference the address at the time of order creation, not the live address record).
- The originally selected town or quarter has been deleted — the form should handle gracefully (show the current data if available, or prompt re-selection).
- OpenStreetMap API is unavailable during edit — neighbourhood field works as free text.

---

## UI/UX Notes

- Edit form can be a modal overlay or inline expansion of the address card.
- Same layout and UX patterns as the add form (F-033).
- "Cancel" button dismisses the form without saving.
- Save button shows loading state during submission.
- Light/dark mode support.

---

## Related Features

- **F-033** — Add Delivery Address (same form fields and validation)
- **F-034** — Delivery Address List (edit is triggered from here)
- **F-097** — OpenStreetMap Neighbourhood Search (autocomplete for neighbourhood)
