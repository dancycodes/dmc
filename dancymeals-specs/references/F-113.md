# F-113 — Meal Availability Toggle

> Module: Meal
> Priority: Must-have
> Precedence: F-108
> Type: functional

---

## What It Does
Provides a separate availability toggle for meals, independent of the draft/live status. A live meal can be temporarily marked as unavailable (e.g., sold out for today, missing ingredients). Unavailable meals show an "unavailable" badge to clients on the tenant landing page but remain visible. The cook can re-enable availability at any time. This is a quick toggle accessible from both the meal list and the meal edit page, performed via Gale.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Quickly toggles meal availability on and off |
| Manager | Toggles availability if granted `manage-meals` permission |
| Client | Sees "unavailable" badge on meals that are temporarily unavailable |

---

## User Scenarios
### Scenario 1: Mark a meal as unavailable
The cook's "Jollof Rice" has sold out for the day. They toggle the availability to "Unavailable" from the meal list. The meal now shows an "Unavailable" badge on the tenant landing page. Clients cannot order it.

### Scenario 2: Re-enable availability
The next day, the cook has prepared more "Jollof Rice." They toggle availability back to "Available." The badge disappears and clients can order again.

### Scenario 3: Quick toggle from meal list
On the meal list, the cook clicks the availability toggle on "Ndole" without opening the edit page. The toggle updates inline via Gale.

### Scenario 4: Unavailable meal still visible
A client browsing the tenant landing page sees "Jollof Rice" with an "Unavailable" badge. They can view the meal details but cannot add it to their cart.

### Scenario 5: Draft meal availability toggle
A draft meal can also have its availability toggled, but since it is not visible to clients regardless, the effect is only relevant when the meal goes live.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-235 | Availability is separate from status (draft/live) |
| BR-236 | A live + unavailable meal is visible to clients but cannot be ordered |
| BR-237 | A live + available meal is fully orderable (subject to schedule) |
| BR-238 | A draft meal's availability setting takes effect only when the meal goes live |
| BR-239 | Unavailable meals display an "Unavailable" badge to clients |
| BR-240 | Availability toggle has immediate effect |
| BR-241 | Availability changes are logged via Spatie Activitylog |
| BR-242 | Only users with `manage-meals` permission can toggle availability |
| BR-243 | Toggling availability does not affect pending or active orders |

---

## Data Involved
**Creates:**
- Nothing

**Reads:**
- Meal record (current availability state)

**Updates:**
- Meal `is_available` boolean field

**Relationships:**
- None new; uses existing Meal model

---

## Acceptance Criteria
- **Given** a live available meal, **when** toggled to unavailable, **then** an "Unavailable" badge appears on the landing page
- **Given** a live unavailable meal, **when** toggled to available, **then** the badge disappears and the meal is orderable
- **Given** an unavailable meal, **when** a client views its detail page, **then** the "Add to Cart" functionality is disabled
- **Given** a draft meal toggled to unavailable, **when** the meal goes live, **then** it shows as live + unavailable
- **Given** the toggle action, **when** completed, **then** the change is logged
- **Given** pending orders for an unavailable meal, **when** checking, **then** orders are unaffected

---

## Verification Steps
1. Toggle a live meal to unavailable — confirm badge appears on landing page
2. Toggle it back to available — confirm badge disappears
3. Attempt to order an unavailable meal as a client — confirm it is blocked
4. Quick toggle from meal list — confirm inline update
5. Toggle availability on a draft meal, then go live — confirm it respects the availability setting
6. Check activity log for the availability change

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| All meals toggled to unavailable | Landing page shows all meals with "Unavailable" badges; no orderable meals |
| Availability toggled while client is viewing the meal | Client sees updated state on next Gale refresh or action |
| Rapid toggle on/off | Final state persists correctly |
| Component availability (F-123) vs meal availability | Both are independent; meal unavailable overrides component availability for ordering |

---

## UI/UX Notes
- Toggle switch on meal list and meal edit page
- Visual indicator: green dot or "Available" label vs red/grey "Unavailable" badge
- On tenant landing page: "Unavailable" badge overlaid on the meal card
- Quick toggle: single click/tap with immediate visual feedback
- Toast notification: "Jollof Rice is now unavailable" / "Jollof Rice is now available"
- All interactions via Gale
- Mobile-friendly toggle

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-108 | Meal Creation Form | Creates meals with default availability = true |
| F-112 | Meal Status Toggle (Draft/Live) | Status and availability are independent toggles |
| F-116 | Meal List View (Cook Dashboard) | Shows availability and provides quick toggle |
| F-123 | Meal Component Availability Toggle | Component-level availability is separate |
| F-128 | Available Meals Grid Display | Shows availability status to clients |
