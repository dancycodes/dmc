# F-197 â€” Favorite Meal Toggle

> Module: Favorites
> Priority: Should-have
> Precedence: F-024, F-129
> Type: functional

---

## What It Does
Adds a heart/star toggle button on meal cards and the meal detail view that allows authenticated users to add or remove a meal from their favorites. The toggle works identically to the cook favorite toggle: instant visual feedback via Gale, authentication required, and persistent state. Favorites are stored per user per meal, allowing users to build a personal collection of preferred dishes across different cooks.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Toggles a meal as a favorite from meal cards or meal detail |
| Client (guest) | Clicks the button and is prompted to log in |

---

## User Scenarios
### Scenario 1: Favorite a meal from a meal card
An authenticated client browses a cook's menu. They see a meal card for "Ndole" and click the heart icon. The icon fills with a brief animation. Ndole is now in their favorites.

### Scenario 2: Favorite from meal detail view
The client opens the meal detail page for "Jollof Rice." They click the heart icon next to the meal name. The meal is added to their favorites.

### Scenario 3: Unfavorite a meal
The client sees a filled heart on "Ndole." They click it. The heart returns to outline. Ndole is removed from favorites.

### Scenario 4: Guest clicks favorite
A guest user clicks the heart on a meal card. A login prompt appears. After logging in, they are returned to the same page.

### Scenario 5: Same meal from different views
The client favorites "Ndole" from the meal card on the cook's menu. They then navigate to the meal detail view. The heart icon is already filled, reflecting the consistent state.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-333 | Favoriting requires authentication; guests are prompted to log in |
| BR-334 | A user can favorite any active meal from any active tenant |
| BR-335 | The toggle is idempotent: clicking toggles the state |
| BR-336 | Favorite state is stored as a user-meal relationship (pivot table) |
| BR-337 | The heart icon reflects current state on page load |
| BR-338 | Toggle happens via Gale without page reload |
| BR-339 | Visual feedback is immediate with a brief animation |
| BR-340 | A user can favorite unlimited meals |
| BR-341 | Favoriting an inactive or unavailable meal is not possible (not shown in UI) |
| BR-342 | If a favorited meal is later deactivated, it remains in favorites but is marked as "unavailable" in the list |
| BR-343 | All user-facing text must use `__()` localization |

---

## Data Involved
**Creates:**
- Record in `favorite_meals` pivot table: `user_id`, `meal_id`, `created_at`

**Reads:**
- `favorite_meals` table to determine current state
- `meals` table for meal identity and availability

**Updates:**
- Toggle: insert or delete from `favorite_meals` pivot table

**Relationships:**
- User belongsToMany Meal via `favorite_meals` pivot
- Meal belongsTo Tenant (via cook)

---

## Acceptance Criteria
- **Given** an authenticated user, **when** they click the heart on an unfavorited meal, **then** the meal is added to favorites
- **Given** an authenticated user, **when** they click the heart on a favorited meal, **then** the meal is removed from favorites
- **Given** a guest user, **when** they click the heart, **then** a login prompt appears
- **Given** a favorited meal, **when** the page reloads, **then** the heart icon is filled
- **Given** a meal favorited on the card, **when** viewing the meal detail, **then** the heart is also filled

---

## Verification Steps
1. Log in and favorite a meal from a meal card; verify record is created
2. Unfavorite the same meal; verify record is deleted
3. Favorite from meal detail view; verify it works
4. As a guest, click the heart; verify login prompt
5. Favorite a meal, then check it from a different view; verify consistent state
6. Verify toggle works via Gale without page reload

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Double-clicking rapidly | Debounced; only one toggle processed |
| Network failure during toggle | Revert visual state; show error toast |
| Meal deleted after being favorited | Removed from favorites list; or shown as "This meal is no longer available" |
| Meal price changed after favoriting | Favorites list shows the current price |
| Meal belongs to a different tenant than current domain | Still works; favorites are cross-tenant |

---

## UI/UX Notes
- Heart icon on meal cards: top-right corner, same style as cook favorite
- Heart icon on meal detail: next to the meal name or in the action bar
- Icon: outlined heart (unfavorited) / filled heart (favorited)
- Color: muted gray (outline) / red or primary color (filled)
- Brief scale animation on toggle
- Tooltip: "Add to favorites" / "Remove from favorites"
- Accessible: aria-label for screen readers
- Touch-friendly tap target

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-024 | User Authentication | Required for favoriting |
| F-129 | Meal Card Component | Meal cards where heart icons appear |
| F-198 | Favorites List View | Displays all favorited meals |
| F-130 | Meal Detail View | Heart icon also appears on detail page |
