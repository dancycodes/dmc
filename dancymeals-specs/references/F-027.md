# F-027 — Password Reset Execution

> Module: Auth
> Type: functional
> Priority: Must-have
> Precedence: F-026

---

## What It Does

Handles the password reset link clicked from the user's email. Displays a form to enter
a new password and confirmation. Validates the reset token. Enforces password strength
requirements. On success, updates the user's password, invalidates the token, and redirects
to the login page. On failure (expired/invalid token), shows an error with an option to
request a new reset link.

---

## Who Uses It

- **Registered users** who received a password reset email and clicked the link.

---

## User Scenarios

### Happy Path
1. User clicks the password reset link in their email.
2. The reset form loads, displaying the user's email (read-only) and fields for new password
   and password confirmation.
3. User enters a strong new password and confirms it.
4. User clicks "Reset Password."
5. The password is updated, the reset token is invalidated.
6. User is redirected to the login page with a success message: "Password reset successfully. Please log in."
7. Activity is logged.

### Error Path — Expired Token
1. User clicks a reset link older than 60 minutes.
2. The system detects the token has expired.
3. An error page displays: "This password reset link has expired."
4. A "Request new reset link" button is provided, linking to F-026.

### Error Path — Invalid Token
1. User clicks a tampered or already-used reset link.
2. The system cannot validate the token.
3. An error page displays: "This password reset link is invalid."
4. A "Request new reset link" button is provided.

### Error Path — Weak Password
1. User enters a password that does not meet strength requirements.
2. Validation error shows the specific requirements not met.

### Error Path — Password Mismatch
1. User enters mismatched password and confirmation.
2. Validation error: "The password confirmation does not match."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-072 | The reset token must be valid and not expired (60-minute window from F-026). |
| BR-073 | The new password must meet the same strength requirements as registration (BR-030). |
| BR-074 | Password confirmation must match exactly. |
| BR-075 | After successful reset, the token is invalidated (cannot be reused). |
| BR-076 | After successful reset, the user is redirected to the login page (not auto-logged in). |
| BR-077 | All existing sessions for the user are invalidated after password reset. |
| BR-078 | Password reset activity is logged via Spatie Activitylog (event: "password_reset"). |
| BR-079 | Invalid or expired tokens show an error with a clear call-to-action to request a new link. |
| BR-080 | All text on this page must be localized via `__()`. |

---

## Data Involved

### User Model (updated)
| Field | Change |
|-------|--------|
| password | Updated to new hashed password |
| remember_token | Regenerated |

### Password Reset Token (consumed)
| Action | Details |
|--------|---------|
| Validated | Token checked against stored hash and expiration |
| Deleted | Token record removed from password_reset_tokens table after successful reset |

---

## Acceptance Criteria

```
Given I click a valid, non-expired reset link
When the page loads
Then I see a form with my email (read-only), new password, and confirmation fields

Given I enter a strong new password and matching confirmation
When I click "Reset Password"
Then my password is updated and I am redirected to the login page with a success message

Given I click an expired reset link (older than 60 minutes)
When the page loads
Then I see an error message with a link to request a new reset

Given I click an invalid or already-used reset link
When the page loads
Then I see an error message with a link to request a new reset

Given I enter a password that does not meet strength requirements
When I submit the form
Then I see validation errors describing the requirements

Given my password was reset successfully
When I try to log in with my old password
Then authentication fails
```

---

## Verification Steps

1. Click a valid reset link and confirm the form loads with the email pre-filled.
2. Submit a strong new password and confirm redirect to login with success message.
3. Log in with the new password and confirm it works.
4. Try to use the same reset link again and confirm it is invalid.
5. Wait for a token to expire and confirm the expiration error is shown.
6. Submit a weak password and confirm validation errors appear.

---

## Edge Cases

- User resets password while logged in on another device — the other session should be invalidated (BR-077).
- User has multiple unused reset tokens — only the most recent should work.
- Password same as current password — allow it (no restriction on reusing passwords).
- Browser auto-fills old password in the new password field — the show/hide toggle helps users verify.
- Token URL manually modified — signed URL validation rejects it.

---

## UI/UX Notes

- Clean form with email shown as a disabled/read-only field for context.
- Password fields have show/hide toggles.
- Submit button shows loading state during processing.
- Success redirects to login with a green success alert at the top.
- Error pages for invalid/expired tokens are friendly, not generic 404s.
- Light/dark mode support.
- "Request new reset link" button is prominent on error pages.

---

## Related Features

- **F-026** — Password Reset Request (sends the link that leads here)
- **F-024** — User Login (user is redirected here after successful reset)
- **F-017** — Activity Logging Setup (logs the password reset event)
