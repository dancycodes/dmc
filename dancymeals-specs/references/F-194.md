# F-194 — Payment Notifications

> Module: Notification
> Priority: Must-have
> Precedence: F-014, F-015, F-151
> Type: functional

---

## What It Does
Sends notifications for all payment-related events across the platform. Payment success sends push + DB + email to the client (acts as a receipt). Payment failure sends push + DB to the client with a retry prompt. Refund processed sends push + DB + email to the client. Withdrawal success or failure sends push + DB + email to the cook. This ensures financial transparency and immediate awareness of all monetary transactions.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Receives payment success (receipt), failure (retry), and refund notifications |
| Cook | Receives withdrawal success/failure notifications |

---

## User Scenarios
### Scenario 1: Payment success — client receipt
A client pays for an order via MTN Mobile Money. Payment is confirmed. The client receives push + DB + email. Email is a receipt: order details, amount paid, payment method, transaction reference.

### Scenario 2: Payment failure — retry prompt
A client's payment attempt fails (insufficient funds). The client receives push + DB: "Payment failed for Order #1234. Please try again." The notification links to the order with a retry option.

### Scenario 3: Refund processed
An admin approves a refund for a complaint. The client receives push + DB + email: "Refund of 3,000 XAF processed for Order #1234. Amount credited to your DancyMeals wallet."

### Scenario 4: Withdrawal success
A cook requests a withdrawal of 50,000 XAF to MTN Mobile Money. The transfer succeeds. The cook receives push + DB + email: "Withdrawal of 50,000 XAF successful. Sent to MTN 67XXXXXXX."

### Scenario 5: Withdrawal failure
A cook's withdrawal transfer fails. The cook receives push + DB + email: "Withdrawal of 50,000 XAF failed. Our team has been notified and will process it manually." The amount is returned to the cook's withdrawable balance.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-299 | Payment success: client receives push + DB + email (receipt) |
| BR-300 | Payment failure: client receives push + DB (no email) with retry prompt |
| BR-301 | Refund processed: client receives push + DB + email |
| BR-302 | Withdrawal success: cook receives push + DB + email |
| BR-303 | Withdrawal failure: cook receives push + DB + email |
| BR-304 | Receipt email includes: order ID, items, amounts, payment method, transaction reference, date/time |
| BR-305 | Refund email includes: order ID, refund amount, refund destination (wallet), date/time |
| BR-306 | Withdrawal email includes: amount, destination (mobile money number, partially masked), status, date/time |
| BR-307 | Payment failure notification includes a "Retry Payment" link valid for 15 minutes |
| BR-308 | All payment amounts are formatted in XAF |
| BR-309 | Notifications are queued to not block the payment processing |
| BR-310 | All notification text must use `__()` localization |

---

## Data Involved
**Creates:**
- Push notifications per event per recipient
- DB notification records per event per recipient
- Email per event where specified

**Reads:**
- `orders` table for order context
- `payments` or `transactions` table for payment details
- `users` table for recipient contact info
- Withdrawal request details for cook notifications

**Updates:**
- Nothing

**Relationships:**
- Notification references Order and/or Payment/Transaction

---

## Acceptance Criteria
- **Given** a successful payment, **when** webhook confirms, **then** client receives push + DB + email receipt
- **Given** a failed payment, **when** processed, **then** client receives push + DB with retry link (no email)
- **Given** a refund, **when** processed, **then** client receives push + DB + email
- **Given** a successful withdrawal, **when** transfer completes, **then** cook receives push + DB + email
- **Given** a failed withdrawal, **when** transfer fails, **then** cook receives push + DB + email
- **Given** the receipt email, **when** opened, **then** it contains full transaction details

---

## Verification Steps
1. Complete a payment and verify client receives push + DB + email receipt
2. Simulate a payment failure and verify client receives push + DB with retry link
3. Process a refund and verify client receives push + DB + email
4. Complete a withdrawal and verify cook receives push + DB + email
5. Simulate a withdrawal failure and verify cook receives push + DB + email
6. Verify receipt email contains order details, amount, payment method, and transaction ref
7. Verify retry link in payment failure notification is functional

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Payment success but email delivery fails | Push and DB still delivered; email failure logged |
| Retry link clicked after 15 minutes | Link expired message; user directed to order page to retry manually |
| Multiple payment attempts on same order | Each attempt generates its own success/failure notification |
| Partial refund vs full refund | Email amount reflects the actual refund amount |
| Withdrawal to invalid mobile number | Failure notification sent; admin alerted for manual processing |

---

## UI/UX Notes
- Payment success push: green checkmark icon
- Payment failure push: red alert icon with "Retry" action button
- Receipt email: clean table layout with order items, subtotal, commission (if shown), total
- Refund email: simple card with refund amount and wallet balance
- Withdrawal emails: amount, destination (masked number), status badge
- All emails follow DancyMeals branded template
- DB notifications in notification center use money/wallet icons with color coding

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-014 | PWA & Push Notification Infrastructure | Push delivery mechanism |
| F-015 | Notification Center | Displays DB notifications |
| F-151 | Payment Webhook Handling | Triggers payment success/failure notifications |
| F-169 | Cook Wallet & Withdrawable Balance | Triggers withdrawal notifications |
