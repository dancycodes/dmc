# F-120 — Meal Component Delete

> Module: Meal Component
> Priority: Must-have
> Precedence: F-118
> Type: functional

---

## What It Does
Allows a cook to delete a meal component. Deletion is restricted in two cases: (1) the component cannot be deleted if it is the only component and the meal is live (a live meal must have at least one component), and (2) the component cannot be deleted if pending orders include it. A confirmation dialog is shown before deletion. The action is performed via Gale and logged.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Deletes meal components they no longer wish to offer |
| Manager | Deletes components if granted `manage-meals` permission |

---

## User Scenarios
### Scenario 1: Delete a component from a meal with multiple components
The cook deletes "Extra Plantain" from "Ndole Meal" which has 3 components. Confirmation dialog: "Delete 'Extra Plantain'?" The cook confirms. The component is removed.

### Scenario 2: Attempt to delete the only component of a live meal
"Special Plate" is the only component of a live meal "Today's Special." The cook tries to delete it. The action is blocked: "Cannot delete the only component of a live meal. Add another component first, or switch the meal to draft."

### Scenario 3: Attempt to delete a component with pending orders
"Ndole + Plantain" has 2 pending orders. The cook tries to delete it. The action is blocked: "Cannot delete — 2 pending orders include this component."

### Scenario 4: Delete the only component of a draft meal
The cook deletes the only component of a draft meal. Deletion succeeds. The meal now has 0 components and cannot go live until one is added.

### Scenario 5: Cancel deletion
The cook clicks delete, sees the confirmation dialog, and clicks Cancel. No deletion occurs.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-298 | Cannot delete the last component of a live meal (meal must have >= 1 component to remain live) |
| BR-299 | Cannot delete a component if pending orders include it |
| BR-300 | Components are hard-deleted (not soft-deleted) since order line items store a snapshot of component data |
| BR-301 | A confirmation dialog must be shown before deletion |
| BR-302 | Component deletion is logged via Spatie Activitylog |
| BR-303 | Only users with `manage-meals` permission can delete components |
| BR-304 | Remaining components' positions are recalculated after deletion |
| BR-305 | Requirement rules (F-122) referencing the deleted component are also removed |

---

## Data Involved
**Creates:**
- Nothing

**Reads:**
- MealComponent record
- Component count for the meal
- Meal status (draft/live)
- Pending orders referencing this component

**Updates:**
- Remaining components' positions

**Deletes:**
- MealComponent record
- Associated requirement rules referencing this component

**Relationships:**
- MealComponent belongsTo Meal
- MealComponent hasMany ComponentRequirementRules (cascade deleted)
- Order line items store snapshot data (no foreign key concern)

---

## Acceptance Criteria
- **Given** a meal with 3 components, **when** the cook deletes one, **then** the component is removed and 2 remain
- **Given** the last component of a live meal, **when** the cook tries to delete, **then** the action is blocked
- **Given** the last component of a draft meal, **when** deleted, **then** it succeeds
- **Given** a component with pending orders, **when** the cook tries to delete, **then** the action is blocked
- **Given** deletion confirmed, **when** the component had requirement rules, **then** those rules are also deleted

---

## Verification Steps
1. Delete a component from a meal with multiple components — confirm removal
2. Attempt to delete the only component of a live meal — confirm blocked
3. Delete the only component of a draft meal — confirm it succeeds
4. Attempt to delete a component with pending orders — confirm blocked
5. Cancel deletion — confirm component remains
6. Verify requirement rules are cleaned up after deletion
7. Check activity log for the deletion entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Rapid double-click on delete | Only one deletion processed |
| Component referenced in requirement rules of other components | Those rules are updated or removed |
| All components deleted from a draft meal | Meal has 0 components; cannot go live |
| Component deleted while client is viewing the meal | Client sees updated component list on next action |

---

## UI/UX Notes
- Delete button (trash icon) on each component in the list
- Button disabled with tooltip if deletion is blocked
- Confirmation dialog with component name
- Dialog includes reason if blocked (order count, only component)
- Dialog buttons: "Delete" (destructive, red) and "Cancel" (neutral)
- Component list refreshes via Gale after deletion
- Toast on success
- No page reload

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-118 | Meal Component Creation | Creates components that can be deleted |
| F-112 | Meal Status Toggle | Live meals require at least 1 component |
| F-119 | Meal Component Edit | Alternative to deletion |
| F-122 | Meal Component Requirement Rules | Rules referencing deleted component are cleaned up |
| F-125 | Meal Component List View | List updates after deletion |
