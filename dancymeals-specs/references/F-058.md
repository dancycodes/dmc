# F-058 — Financial Reports & Export

> Module: Admin
> Priority: Should-have
> Precedence: F-057
> Type: functional

---

## What It Does
Provides detailed financial reporting with multiple views: revenue by time period, revenue by cook, commission earned by the platform, pending payouts to cooks, and failed payments. Reports are filterable by date range, cook, and payment status. Data can be exported to CSV and PDF formats. Summary cards at the top provide quick financial snapshot.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Super-Admin | Generates and exports financial reports |
| Admin | Generates and exports financial reports |

---

## User Scenarios
### Scenario 1: Monthly revenue report
An admin navigates to Finance > Reports. They select "This Month" and view the revenue breakdown: total gross revenue (XAF 2,500,000), platform commission (XAF 250,000), cook payouts (XAF 2,250,000). A table shows daily revenue figures.

### Scenario 2: Revenue by cook
The admin switches to the "By Cook" tab. A table lists each cook with columns: cook name, tenant, gross revenue, commission rate, commission earned, net payout, order count. Sorted by gross revenue descending.

### Scenario 3: Filtering by specific cook
The admin selects "Chef Amara" from the cook filter dropdown. All report data filters to show only Amara's financial data for the selected period.

### Scenario 4: Exporting to CSV
The admin clicks "Export CSV". A CSV file downloads containing all currently visible report data with appropriate column headers and formatting. Amounts are in XAF.

### Scenario 5: Exporting to PDF
The admin clicks "Export PDF". A formatted PDF is generated with the DancyMeals header, report title, date range, summary totals, and the detailed table. Suitable for printing or sharing.

### Scenario 6: Viewing failed payments
The admin switches to the "Failed Payments" tab. A list shows failed Flutterwave transactions with: order ID, client name, amount, payment method, failure reason, timestamp. Helps identify payment issues.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-143 | Revenue reports include only orders with status completed or delivered |
| BR-144 | Commission is calculated per order based on the cook's commission rate at the time of the order |
| BR-145 | Pending payouts = cook wallet balances that have not been withdrawn |
| BR-146 | Failed payments include all Flutterwave transactions with failed status |
| BR-147 | Export CSV includes all rows matching current filters (not just current page) |
| BR-148 | Export PDF includes a summary header and the first 500 rows; beyond that, CSV is recommended |
| BR-149 | All monetary values displayed and exported in XAF |
| BR-150 | Date range filter defaults to current month |

---

## Data Involved
**Reads:**
- Orders: amounts, commission amounts, statuses, timestamps, tenant/cook associations
- Payment transactions: status, method, failure reasons
- Cook wallets: current balances
- Tenants: names for cook association display

**Creates:**
- CSV export files (temporary, served as download)
- PDF export files (temporary, served as download)

**Updates:**
- Nothing

**Relationships:**
- F-057: Extends the overview analytics with detailed financial data
- F-062: Commission configuration affects report calculations
- F-065: Failed payments may appear in manual payout queue

---

## Acceptance Criteria
- **Given** the financial reports page, **when** loaded, **then** summary cards show gross revenue, commission, and net payouts for the default period
- **Given** the "By Cook" view, **when** displayed, **then** each cook's revenue and commission are listed accurately
- **Given** a cook filter, **when** applied, **then** all report data filters to that cook only
- **Given** the "Export CSV" button, **when** clicked, **then** a CSV file downloads with all filtered data
- **Given** the "Export PDF" button, **when** clicked, **then** a formatted PDF downloads with report data
- **Given** the "Failed Payments" tab, **when** viewed, **then** failed transactions are listed with failure details

---

## Verification Steps
1. Load financial reports — confirm summary cards show accurate data
2. View "By Cook" tab — cross-reference revenue figures with database
3. Filter by a specific cook — confirm data narrows correctly
4. Export CSV — open file and verify data matches the on-screen report
5. Export PDF — verify formatting, header, and data accuracy
6. View Failed Payments — confirm all failed transactions are listed

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| No orders in selected period | Summary cards show XAF 0; table shows "No data for this period" |
| Cook with 0% commission | Commission column shows XAF 0; net payout equals gross revenue |
| Very large export (10,000+ rows) | CSV export works; PDF shows first 500 with note "Full data available in CSV" |
| Concurrent exports by multiple admins | Each export generates independently |
| Cook was deleted (soft delete) | Their data still appears in historical reports with "(Deleted)" label |

---

## UI/UX Notes
- Summary cards at top: Gross Revenue, Platform Commission, Net Payouts, Pending Payouts, Failed Payments Count
- Tab navigation: Overview, By Cook, Pending Payouts, Failed Payments
- Date range selector and cook filter above the table
- Export buttons (CSV, PDF) in the top-right area
- Table rows are striped for readability
- Amounts formatted with thousands separator: "2,500,000 XAF"
- Mobile: summary cards stack, table scrolls horizontally
- Loading indicator during report generation and export

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-057 | Platform Analytics Dashboard | Overview that this feature extends |
| F-059 | Payment Monitoring | Detailed payment transaction data |
| F-062 | Commission Configuration | Commission rates used in calculations |
| F-065 | Manual Payout Queue | Failed transfers appear here too |
