# F-017 â€” Activity Logging Setup

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Installs and configures Spatie Activitylog to automatically track significant user and system actions across the DancyMeals platform. Sets up model event logging (created, updated, deleted) on key models, configures which properties are tracked, and establishes a log cleanup schedule to prevent unbounded growth. The activity log serves as an audit trail for dispute resolution, compliance, and admin oversight.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Admin | Views activity logs in the admin panel (F-064) to audit actions and resolve disputes |
| Super-Admin | Has full access to all activity logs |
| System | Automatically records model changes and user actions |
| Developer | Adds `LogsActivity` trait to models that need auditing |

---

## User Scenarios
### Scenario 1: Automatic model change logging
A cook updates a meal's price from 500 XAF to 750 XAF. The activity log automatically records: who made the change, when, which model and record, and the old/new values of the changed fields.

### Scenario 2: Admin reviews activity for dispute
A client claims they were charged incorrectly. The admin opens the activity log viewer (F-064) and filters by the order ID. They can see the complete history of changes to that order, including status transitions, payment events, and any modifications.

### Scenario 3: Log cleanup
The scheduled cleanup job runs weekly, removing activity log entries older than 90 days. This prevents the activity_log table from growing indefinitely while retaining enough history for operational needs.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-135 | Activity logging must automatically capture `created`, `updated`, and `deleted` events on configured models |
| BR-136 | Logged properties include: old values, new values, changed attributes |
| BR-137 | Each log entry records: causer (user who performed action), subject (model affected), description, properties, timestamp |
| BR-138 | Sensitive fields (passwords, tokens) must be excluded from logged properties |
| BR-139 | Activity logs are retained for 90 days by default (configurable) |
| BR-140 | A scheduled cleanup job removes entries older than the retention period |
| BR-141 | Activity logging must not significantly impact request performance |
| BR-142 | Batch operations should log a summary rather than individual entries where possible |

---

## Data Involved
**Creates:**
- Published `activitylog.php` config with DancyMeals-specific settings
- Scheduled cleanup command registration
- Trait usage documentation for developers

**Reads:**
- Model events (created, updated, deleted) via Eloquent observers
- Authenticated user as the "causer" of each activity

**Updates:**
- `activity_log` table (Spatie migration from F-003)
- `config/activitylog.php` with custom settings (retention, excluded attributes)
- `routes/console.php` or scheduler with cleanup command

**Relationships:**
- Applied to all significant models (Users, Tenants, Meals, Orders, Payments, Complaints, etc.)
- F-064 (Activity Log Viewer) provides the admin UI for viewing logs

---

## Acceptance Criteria
- **Given** a model with `LogsActivity` trait, **when** a record is created, **then** an activity log entry is recorded with the creator and new values
- **Given** a model update, **when** specific fields change, **then** the log captures both old and new values for those fields
- **Given** a model deletion, **when** the record is deleted, **then** the log records the deletion with the deleter's identity
- **Given** a model with a password field, **when** the password is updated, **then** the password value is NOT included in the log
- **Given** activity log entries older than 90 days, **when** the cleanup schedule runs, **then** those entries are deleted
- **Given** a logged activity, **when** inspecting the entry, **then** it contains: causer_type, causer_id, subject_type, subject_id, description, properties, created_at

---

## Verification Steps
1. Add `LogsActivity` to the User model, update a user, and confirm the change is logged
2. Create a new record and verify the activity log entry includes the causer and new values
3. Delete a record and verify the deletion is logged
4. Update a user's password and confirm the password value is excluded from the log
5. Run the cleanup command and verify old entries are removed
6. Check that the scheduled cleanup is registered in the scheduler

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Unauthenticated action (system/CLI) | Causer is null; activity is still logged |
| Mass update via query builder | Not automatically logged by Eloquent events; manual logging needed if required |
| Very large property changes (long text fields) | Truncated or summarized to prevent excessive storage |
| Database transaction rollback | Activity log entry is also rolled back (same transaction) |
| Concurrent updates to same model | Each update generates its own log entry with correct timestamps |

---

## UI/UX Notes
No user-facing UI in this feature. The admin activity log viewer is F-064. This feature establishes the infrastructure and automatic logging configuration.

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; spatie/laravel-activitylog must be installed and migrated |
| F-064 | Activity Log Viewer | Admin UI for viewing and filtering activity logs |
