# F-107 — Schedule Validation Rules

> Module: Schedule
> Priority: Must-have
> Precedence: F-098
> Type: edge-case

---

## What It Does
Defines and enforces the comprehensive validation rules for all schedule configurations across the platform. This includes constraints on time formats, interval ordering, overlapping entries, day-before limits, and consistency between order, delivery, and pickup intervals. These rules apply to cook schedules, meal schedule overrides, and schedule templates. This feature ensures data integrity and prevents impossible or conflicting schedule configurations.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Encounters validation errors when entering invalid schedule configurations |
| Manager | Same validation applies to managers configuring schedules |
| System | Enforces rules on every schedule-related save operation |

---

## User Scenarios
### Scenario 1: Order interval end before delivery start
The cook configures order end at 11:00 AM and delivery start at 10:00 AM. Validation fails: "Delivery must start at or after the order window closes (11:00 AM)."

### Scenario 2: Overlapping schedule entries on same day
The cook has a Monday entry with delivery from 11:00 AM to 2:00 PM. They create another Monday entry with delivery from 1:00 PM to 4:00 PM (overlapping from 1 PM to 2 PM). Validation fails: "Delivery window overlaps with an existing Monday schedule (11:00 AM - 2:00 PM)."

### Scenario 3: Invalid time format
The cook enters "25:00" as a time. Validation fails: "Invalid time format. Use 24-hour format (00:00 - 23:59)."

### Scenario 4: Day-before ordering exceeds limit
The cook sets the order start to 8 days before. Validation fails: "Order window cannot start more than 7 days before the open day."

### Scenario 5: Delivery/pickup not on open day
The system verifies that delivery and pickup intervals have day offset 0 (same day as the open day). Any other value is rejected.

### Scenario 6: No schedule but cook wants to be available
The cook tries to set their status to "available" without any schedule entries. Validation warns: "At least one schedule entry with availability must be configured to accept orders."

### Scenario 7: Cook schedule has no delivery or pickup
An available schedule entry has order interval configured but neither delivery nor pickup enabled. Validation fails: "At least one of delivery or pickup must be enabled."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-172 | Time format must be 24-hour (HH:MM), values from 00:00 to 23:59 |
| BR-173 | Order interval start must be chronologically before order interval end (accounting for day offsets) |
| BR-174 | Order interval end must be chronologically before or equal to delivery start time |
| BR-175 | Order interval end must be chronologically before or equal to pickup start time |
| BR-176 | Delivery start must be before delivery end (both on the open day) |
| BR-177 | Pickup start must be before pickup end (both on the open day) |
| BR-178 | Delivery and pickup intervals must be on the open day (day offset = 0) |
| BR-179 | No overlapping schedule entries for the same day — delivery windows must not overlap, pickup windows must not overlap, and order windows must not overlap across entries for the same day |
| BR-180 | Order start day offset cannot exceed 7 (maximum 7 days before the open day) |
| BR-181 | Order end day offset can be 0 (same day) or 1 (day before) only |
| BR-182 | At least one schedule entry with is_available = true is required if the cook wants to accept orders |
| BR-183 | At least one of delivery or pickup must be enabled per available schedule entry |
| BR-184 | All validation rules apply equally to cook schedules, meal schedules, and schedule templates |
| BR-185 | Validation error messages must be specific, mentioning the conflicting values and fields |
| BR-186 | Validation is enforced both in Form Request classes and as database-level constraints where possible |

---

## Data Involved
**Creates:**
- Form Request validation classes for schedule operations
- Custom validation rules (e.g., `TimeIntervalOrder`, `NoOverlappingSchedules`)

**Reads:**
- Existing schedule entries to check for overlaps
- Related interval data for cross-field validation

**Updates:**
- Nothing (validation-only feature)

**Relationships:**
- Applies to CookSchedule, MealSchedule, and ScheduleTemplate models

---

## Acceptance Criteria
- **Given** an order end time after delivery start, **when** submitted, **then** validation fails with a specific message
- **Given** overlapping delivery windows on the same day, **when** submitting the second entry, **then** validation fails
- **Given** a time value of "25:00", **when** submitted, **then** validation fails with time format error
- **Given** an order start offset of 8, **when** submitted, **then** validation fails with max offset error
- **Given** delivery/pickup with day offset > 0, **when** submitted, **then** validation fails
- **Given** an available entry with no delivery or pickup, **when** submitted, **then** validation fails
- **Given** a cook with no schedule entries, **when** attempting to accept orders, **then** a warning is shown
- **Given** two non-overlapping entries for the same day, **when** submitted, **then** both save successfully

---

## Verification Steps
1. Submit order end after delivery start — confirm rejection
2. Submit overlapping entries for the same day — confirm rejection
3. Submit invalid time format — confirm rejection
4. Submit order offset > 7 — confirm rejection
5. Submit end offset > 1 — confirm rejection
6. Submit available entry with no delivery/pickup — confirm rejection
7. Submit two valid non-overlapping entries — confirm success
8. Apply same validation to a schedule template — confirm consistency
9. Apply same validation to a meal schedule override — confirm consistency

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Exactly adjacent time windows (entry 1 ends 2:00 PM, entry 2 starts 2:00 PM) | Valid — no overlap |
| Midnight boundary (23:59 end, 00:00 start) | Handled via day offsets; validated correctly |
| Order interval spans midnight (start 10 PM day before, end 2 AM same day) | Valid via day offsets |
| Template validation vs schedule validation | Identical rules apply; same Form Request logic reused |
| Editing an existing entry to create overlap | Validation checks against all other entries for that day, excluding itself |
| Concurrent edits creating overlaps | Database-level constraint prevents overlap at storage layer |

---

## UI/UX Notes
- Validation errors displayed inline below the relevant field
- Cross-field errors (e.g., overlap, interval ordering) shown as a summary at the top of the form
- Error messages in user's preferred language via `__()`
- Real-time validation feedback via Gale where possible (before form submission)
- Clear error states with red borders on invalid fields

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-098 | Cook Day Schedule Creation | Validation applies to schedule entry creation |
| F-099 | Order Time Interval Configuration | Validates order interval rules |
| F-100 | Delivery/Pickup Time Interval Config | Validates delivery/pickup interval rules |
| F-101 | Create Schedule Template | Validation applies to template creation/editing |
| F-106 | Meal Schedule Override | Validation applies to meal-specific schedules |
