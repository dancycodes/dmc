# F-191 — Order Creation Notifications

> Module: Notification
> Priority: Must-have
> Precedence: F-014, F-015, F-151
> Type: functional

---

## What It Does
When a new order is placed and payment is confirmed (webhook processed), the system sends notifications to the cook and all managers of the tenant via push, database, and email channels. The notification contains the order ID, client name, items summary, total amount, and delivery/pickup choice. The email includes the full order detail. This ensures the cook is immediately aware of new orders and can begin preparing.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Receives push, DB, and email notification when a new paid order arrives |
| Manager | Receives push, DB, and email notification if associated with the tenant |
| Client | Does not receive this notification (they already see the order confirmation) |

---

## User Scenarios
### Scenario 1: Cook receives new order notification
A client places and pays for an order. The cook receives a push notification: "New Order #1234 — 3 items, 5,500 XAF (Delivery)." They also receive an email with the full order breakdown and a database notification in their notification center.

### Scenario 2: Manager receives notification
A manager associated with the tenant receives the same push and DB notifications. They also receive the email. Tapping the push notification opens the order detail in the cook dashboard.

### Scenario 3: Cook has push notifications disabled
The cook has disabled push notifications in their browser. They still receive the DB notification (visible in the notification center) and the email. No push delivery attempt fails silently.

### Scenario 4: Multiple managers
The tenant has 2 managers. Both managers and the cook (3 people total) each receive their own push, DB, and email notification for the new order.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-268 | Notification is triggered after successful payment webhook processing (F-151) |
| BR-269 | All three channels are used: push + DB + email |
| BR-270 | Recipients: the tenant's cook and all managers associated with the tenant |
| BR-271 | Push notification content: "New Order #[ID] — [item count] items, [total] XAF ([Delivery/Pickup])" |
| BR-272 | DB notification content: order ID, client name, items summary, total, delivery/pickup |
| BR-273 | Email content: full order detail including client name, all items with quantities and prices, total, delivery/pickup choice, delivery address if applicable, order timestamp |
| BR-274 | Push and DB notifications link to the order detail in the cook dashboard |
| BR-275 | Email includes a "View Order" button linking to the cook dashboard order detail |
| BR-276 | Notifications are queued (dispatched via queue) to not block the webhook response |
| BR-277 | All notification text must use `__()` localization |

---

## Data Involved
**Creates:**
- Push notifications to cook and managers
- DB notification records in `notifications` table
- Email messages to cook and managers

**Reads:**
- `orders` table with related items and client info
- `order_items` table for items summary
- `users` table for cook and manager contact info
- `tenants` table for tenant association

**Updates:**
- Nothing

**Relationships:**
- Notification references Order
- Order belongsTo Tenant
- Tenant hasOne Cook (User) and hasMany Managers

---

## Acceptance Criteria
- **Given** a paid order, **when** the payment webhook is processed, **then** the cook receives push, DB, and email notifications
- **Given** a tenant with managers, **when** a new order arrives, **then** all managers also receive push, DB, and email notifications
- **Given** the push notification, **when** tapped, **then** it navigates to the order detail in the cook dashboard
- **Given** the email, **when** opened, **then** it contains the full order detail and a "View Order" link
- **Given** a queued notification, **when** the queue processes, **then** delivery does not block the webhook response

---

## Verification Steps
1. Place and pay for an order; verify cook receives push notification
2. Verify cook receives DB notification in the notification center
3. Verify cook receives email with full order details
4. Verify all managers receive the same three notification types
5. Tap the push notification and verify navigation to order detail
6. Click "View Order" in the email and verify it opens the correct order
7. Confirm notification is queued and does not delay webhook response

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook has no email address | Push and DB still sent; email delivery fails silently |
| Email delivery fails (SMTP issue) | Logged as failed; push and DB still delivered |
| Multiple orders placed simultaneously | Each order generates independent notifications |
| Cook's device is offline | Push queued by webpush provider; DB and email delivered normally |
| Order contains 20+ items | Email shows all items; push and DB show summary count |

---

## UI/UX Notes
- Push notification uses the DancyMeals app icon
- DB notification in the notification center shows an order icon, summary text, and relative timestamp
- Email follows the DancyMeals email template: branded header, order summary table, action button, footer
- Email subject: "New Order #[ID] — [total] XAF"
- Notification center entry is bold (unread) until clicked

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-014 | PWA & Push Notification Infrastructure | Provides push delivery mechanism |
| F-015 | Notification Center | Displays DB notifications |
| F-151 | Payment Webhook Handling | Triggers this notification after payment confirmation |
| F-155 | Cook Order List View | New order appears in the list alongside this notification |
| F-156 | Cook Order Detail View | Destination when notification is tapped |
