# F-091 â€” Delivery Fee Configuration

> Module: Location
> Priority: Must-have
> Precedence: F-086
> Type: functional

---

## What It Does

Provides a centralized view for configuring delivery fees across all quarters and groups for a cook's tenant. The cook can set individual quarter fees or group-level fees. Fees are in XAF with a minimum of 0 (free delivery). Fee changes apply to new orders only -- existing orders retain their original fee at the time of order placement. This feature provides an overview perspective complementing the per-quarter editing in F-088.

---

## Who Uses It

| Role | Interaction |
|------|-------------|
| Cook | Reviews and configures delivery fees across their service areas |
| Manager | Configures fees if granted location management permission |

---

## User Scenarios

### Scenario 1: Review all fees at a glance
A cook navigates to Locations and selects the "Delivery Fees" tab or section. They see a summary table: all towns, their quarters, each quarter's fee (or group fee), and which group (if any) each quarter belongs to.

### Scenario 2: Bulk update via group fee
A cook changes the "Central Douala" group fee from 300 XAF to 400 XAF. All 5 quarters in that group now show 400 XAF. The change applies to new orders.

### Scenario 3: Set individual quarter fee
A cook selects a quarter not in any group and changes its fee from 500 to 600 XAF. Only that quarter is affected.

### Scenario 4: Free delivery promotion
A cook temporarily sets all fees to 0 XAF for a promotion. They can do this by updating group fees to 0 and individual quarter fees to 0. All quarters show "Free delivery."

### Scenario 5: Verify existing orders unaffected
A cook changes the fee for "Bonaberi" from 500 to 700 XAF. They check an existing order to Bonaberi placed yesterday -- it still shows 500 XAF.

---

## Business Rules

| Code | Rule |
|------|------|
| BR-273 | Delivery fee must be >= 0 XAF for all quarters and groups |
| BR-274 | Fee of 0 XAF means free delivery to that quarter |
| BR-275 | Group fee overrides individual quarter fees for all quarters in the group |
| BR-276 | Fee changes apply to new orders only; existing orders retain their original fee |
| BR-277 | Fees are stored as integers in XAF |
| BR-278 | Fee configuration is accessible from the Locations section of the dashboard |
| BR-279 | Changes saved via Gale without page reload |
| BR-280 | Only users with location management permission can modify fees |

---

## Data Involved

**Reads:**
- All towns and quarters for this tenant
- All quarter groups and their fees
- Individual quarter fees

**Updates:**
- Quarter records: delivery_fee
- Quarter group records: delivery_fee

---

## Acceptance Criteria

- **Given** the fee configuration view, **when** the cook opens it, **then** all quarters are listed with their current fees and group assignments
- **Given** a group fee change, **when** saved, **then** all quarters in the group reflect the new fee
- **Given** an individual quarter fee change, **when** saved, **then** only that quarter's fee changes
- **Given** a fee set to 0, **when** viewing the quarter, **then** it shows "Free delivery"
- **Given** a fee change, **when** checking an existing order, **then** the order retains its original fee
- **Given** a negative fee entered, **when** submitting, **then** a validation error is shown

---

## Verification Steps

1. Open the fee configuration view and confirm all quarters and groups are listed
2. Change a group fee and confirm all member quarters update
3. Change an individual quarter fee and confirm only that quarter updates
4. Set a fee to 0 and confirm "Free delivery" label
5. Create an order, then change the fee, then verify the order retains the old fee
6. Attempt to enter a negative fee and confirm validation error

---

## Edge Cases & Exceptions

| Condition | Expected Behavior |
|-----------|-------------------|
| Quarter moves from group to no group | Individual fee must be set; prompted if empty |
| Cook has no quarters | Fee configuration view shows empty state with link to add quarters |
| All quarters in groups | Individual fee column shows "Group: [fee]" for clarity |
| Very large fee amount | Accepted; no upper limit enforced (soft warning for >10,000 XAF) |
| Fee change during client checkout | Client sees the fee that was active when they started checkout |

---

## UI/UX Notes

- Table or list format showing: Town, Quarter, Fee (XAF), Group, Actions
- Inline editing: click fee to edit directly in the table
- Group fees shown in a separate section above or alongside
- "Free delivery" highlighted with green badge
- Group members visually connected (same color coding or indent)
- Save happens per-row (inline save) or via a "Save All Changes" button
- Breadcrumb: Dashboard > Locations > Delivery Fees

---

## Related Features

| Code | Feature | Relationship |
|------|---------|-------------|
| F-086 | Add Quarter | Individual fee set at creation |
| F-088 | Edit Quarter | Per-quarter fee editing |
| F-090 | Quarter Group Creation | Group-level fee management |
| F-096 | Meal-Specific Location Override | Meal-level overrides can affect which fees apply |
