# F-014 â€” Push Notification Infrastructure

> Module: Foundation
> Priority: Must-have
> Precedence: F-012
> Type: foundation

---

## What It Does
Sets up the Web Push notification infrastructure for DancyMeals. Installs and configures the `laravel-notification-channels/webpush` package, generates VAPID keys, extends the service worker to handle push events, and builds a permission request prompt that asks users for notification permission on their first meaningful interaction. Push subscriptions are stored in the database and linked to user accounts. Creates a base notification class that other features extend to send push notifications.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Receives push notifications for order updates, payment confirmations, etc. |
| Cook | Receives push notifications for new orders, complaints, ratings |
| Admin | Receives push notifications for escalated complaints, system events |
| Developer | Extends the base notification class for specific notification types |

---

## User Scenarios
### Scenario 1: Permission request on first interaction
A new user logs in for the first time. After a brief moment, a UI prompt appears asking "Allow notifications to stay updated on your orders?" with "Allow" and "Maybe Later" buttons. Clicking "Allow" triggers the browser's native permission dialog.

### Scenario 2: Push subscription stored
After granting permission, the browser generates a push subscription (endpoint, keys). This subscription is sent to the server and stored in the `push_subscriptions` table, linked to the user's account.

### Scenario 3: Push notification received
When a cook confirms an order, the system sends a push notification to the client. The service worker receives the push event and displays a notification with the order details, even if the browser tab is not active.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-104 | VAPID keys must be generated and stored in `.env` (`VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY`) |
| BR-105 | Push permission must be requested through a custom UI prompt, not the raw browser dialog |
| BR-106 | The custom prompt should appear on the user's first meaningful interaction (e.g., after login, after first order) |
| BR-107 | Users who decline can be prompted again after a configurable period (not immediately) |
| BR-108 | Each user can have multiple push subscriptions (multiple devices/browsers) |
| BR-109 | Push subscriptions must be cleaned up when they expire or become invalid |
| BR-110 | The service worker must handle `push` and `notificationclick` events |
| BR-111 | Clicking a push notification should open or focus the relevant page in the app |
| BR-112 | Push notifications must work on both main domain and tenant domains |
| BR-113 | The base notification class must support title, body, icon, action URL, and data payload |

---

## Data Involved
**Creates:**
- VAPID key pair in `.env`
- `push_subscriptions` table migration (from webpush package)
- Service worker push event handler (extends F-012's service worker)
- Permission request Alpine.js component
- Base push notification class (Laravel Notification with WebPush channel)
- Controller endpoint for storing push subscriptions

**Reads:**
- User's push subscriptions from the database
- Push event payload in the service worker

**Updates:**
- Service worker with push and notification click handlers
- User model with `HasPushSubscriptions` trait (from webpush package)
- `.env` with VAPID keys

**Relationships:**
- Depends on F-012 for the service worker foundation
- Extended by F-191 through F-195 for specific notification types
- F-041 (Notification Preferences) allows users to manage their push settings

---

## Acceptance Criteria
- **Given** a logged-in user without push permission, **when** they perform a meaningful action, **then** the custom permission prompt appears
- **Given** the custom prompt, **when** clicking "Allow", **then** the browser's native permission dialog appears
- **Given** the user grants permission, **when** the subscription is generated, **then** it is stored in the database linked to their user account
- **Given** a stored subscription, **when** a push notification is dispatched, **then** the user receives it on their device
- **Given** a push notification is clicked, **when** the user taps it, **then** the app opens to the relevant page
- **Given** a user declines permission, **when** they click "Maybe Later", **then** the prompt disappears and does not return for the configured period
- **Given** VAPID keys, **when** inspecting `.env`, **then** `VAPID_PUBLIC_KEY` and `VAPID_PRIVATE_KEY` are present

---

## Verification Steps
1. Generate VAPID keys and confirm they are in `.env`
2. Log in and confirm the push permission prompt appears after a meaningful action
3. Grant permission and verify a subscription record is created in the database
4. Send a test push notification and confirm it arrives on the device
5. Click the notification and confirm it navigates to the correct page
6. Decline permission and verify the prompt does not reappear in the same session
7. Check the service worker in DevTools for push event handlers

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Browser does not support push notifications | Custom prompt is not shown; no errors |
| User revokes permission via browser settings | Subscription becomes invalid; cleaned up on next failed push |
| Push endpoint expires | Webpush package handles expired subscriptions gracefully |
| User logged in on multiple devices | Each device has its own subscription; notifications sent to all |
| Service worker not yet active | Push subscription deferred until service worker is ready |
| Notification permission previously denied via browser | Custom prompt not shown; respect browser-level denial |

---

## UI/UX Notes
- The custom permission prompt should be a non-blocking banner or card, not a modal.
- Include a bell icon, a clear message about the benefit ("Get real-time order updates"), and two buttons.
- "Allow" button should be primary; "Maybe Later" should be secondary/subtle.
- The prompt should not appear immediately on page load; wait for a meaningful user action.
- The prompt must be localized (English and French).
- On mobile, the prompt should not obstruct the main content area.

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-012 | PWA Configuration | Prerequisite; provides the base service worker |
| F-015 | Email Notification Infrastructure | Sibling notification channel |
| F-041 | Notification Preferences Management | User controls which push notifications they receive |
| F-191 | Order Creation Notifications | Extends base push notification |
| F-192 | Order Status Update Notifications | Extends base push notification |
| F-193 | Complaint Notifications | Extends base push notification |
| F-194 | Payment Notifications | Extends base push notification |
