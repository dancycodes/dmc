# F-028 — Cross-Domain Session Sharing

> Module: Auth
> Type: functional
> Priority: Must-have
> Precedence: F-004, F-024

---

## What It Does

Ensures that once a user authenticates on any domain (main or tenant), they are authenticated
across ALL domains simultaneously. The user does not need to log in again when visiting a
different tenant domain. Implements session sharing via shared cookie domain or a token-based
synchronization approach.

---

## Who Uses It

- **All authenticated users** navigating between the main domain and tenant domains.

---

## User Scenarios

### Happy Path
1. User logs in on the main domain (dm.test / dancymeals.com).
2. User navigates to a cook's tenant domain (e.g., latifa.dancymeals.com).
3. The user is already authenticated on the tenant domain — no login required.
4. Navigation shows the user's authenticated state (name, avatar, user menu).

### Alternate Path — Login on Tenant, Visit Main
1. User logs in on a tenant domain (e.g., powels.dancymeals.com).
2. User navigates to the main domain.
3. The user is already authenticated — no login required.

### Alternate Path — Visit Multiple Tenants
1. User is authenticated (logged in on any domain).
2. User visits tenant A, then tenant B, then tenant C.
3. On each tenant, the user is authenticated without re-logging in.

### Alternate Path — Logout Propagation
1. User is authenticated across multiple domains.
2. User logs out on one domain.
3. On the next request to any other domain, the user is no longer authenticated.

### Error Path — Cookie/Token Corruption
1. The shared session cookie or token is corrupted or tampered with.
2. The user is treated as unauthenticated on the affected domain.
3. The user can log in again normally.

---

## Business Rules

| Code | Rule |
|------|------|
| BR-081 | Authentication on any domain must be valid across ALL domains simultaneously. |
| BR-082 | Session sharing must work between the main domain and all tenant subdomains. |
| BR-083 | Session sharing must work between the main domain and custom tenant domains (e.g., latifa.cm). |
| BR-084 | Logout on any domain must invalidate the session across all domains. |
| BR-085 | Session sharing must not expose any user data to tenant owners or other users. |
| BR-086 | The implementation must handle both subdomain-based tenants (*.dancymeals.com) and custom domain tenants. |
| BR-087 | Session sharing must not introduce security vulnerabilities (CSRF, session fixation, etc.). |
| BR-088 | For local development, session sharing must work with *.test domains via Herd. |

---

## Data Involved

### Session Configuration
| Aspect | Details |
|--------|---------|
| Cookie domain | Set to `.dancymeals.com` for subdomain sharing (production) |
| Cookie domain (local) | Set to `.dm.test` for local dev |
| Custom domains | Token-based approach or redirect-based cookie setting |
| Session driver | Database or Redis for shared session storage |

### Approach Options
| Approach | Subdomain Support | Custom Domain Support |
|----------|-------------------|----------------------|
| Shared cookie domain | Yes (`.dancymeals.com`) | No (different TLD) |
| Token-based redirect | Yes | Yes |
| Hybrid | Cookie for subdomains, token redirect for custom domains | Yes |

---

## Acceptance Criteria

```
Given I am logged in on the main domain
When I navigate to a subdomain tenant (e.g., latifa.dancymeals.com)
Then I am authenticated without logging in again

Given I am logged in on a tenant subdomain
When I navigate to the main domain
Then I am authenticated without logging in again

Given I am logged in on one tenant domain
When I navigate to a different tenant domain
Then I am authenticated without logging in again

Given I log out on any domain
When I navigate to another domain
Then I am not authenticated (shown as logged out)

Given I am logged in and visit a custom domain tenant (e.g., latifa.cm)
When the page loads
Then I am authenticated on the custom domain
```

---

## Verification Steps

1. Log in on the main domain, then visit a tenant subdomain — confirm authenticated state.
2. Log in on a tenant subdomain, then visit the main domain — confirm authenticated state.
3. While logged in, visit multiple tenant domains — confirm authenticated on each.
4. Log out on one domain, then visit another — confirm unauthenticated state.
5. If custom domains are configured, log in on the main domain and visit the custom domain — confirm authenticated state.

---

## Edge Cases

- User's session expires while browsing a different domain — they should be gracefully redirected to login, not shown an error.
- Cookie domain misconfiguration — ensure proper dot-prefix for subdomain sharing (`.dancymeals.com`).
- Mixed HTTP/HTTPS — session cookies should be configured for the appropriate protocol.
- Browser privacy settings blocking third-party cookies — custom domain auth may require explicit redirect-based token exchange.
- Two different users in the same browser (e.g., incognito vs. normal) — sessions should be independent.
- Local development with multiple *.test subdomains — session sharing must work with `.dm.test` cookie domain.

---

## UI/UX Notes

- This feature is invisible to the user — they simply remain logged in across domains.
- No login prompts should appear when navigating between domains.
- If token-based redirect is used for custom domains, the redirect should be fast enough to be imperceptible (flash of loading is acceptable).
- The user's name, avatar, and role should display consistently across all domains.

---

## Related Features

- **F-004** — Multi-Tenant Domain Resolution (provides the domain/tenant mapping)
- **F-024** — User Login (the entry point for authentication)
- **F-025** — User Logout (must propagate across domains)
