# F-005 â€” Authentication Scaffolding

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Sets up the Laravel authentication system for DancyMeals with Gale-based (SSE + Alpine.js) login, registration, and password reset pages. Authentication works on any domain -- whether the user is on the main DancyMeals site or a cook's tenant domain. When on a tenant domain, the auth pages show the tenant's branding while making it clear the user is logging into their DancyMeals account. The User model is extended with DancyMeals-specific fields.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Registers, logs in, and resets password from any domain |
| Cook | Logs in from the main domain or their own tenant domain |
| Manager | Logs in from the tenant domain they manage |
| Admin | Logs in from the main domain to access the admin panel |

---

## User Scenarios
### Scenario 1: Registration on main domain
A new user visits `dm.test/register`, fills in their name, email, phone number, and password, and submits. Their account is created, they receive a verification email, and they are redirected to the dashboard.

### Scenario 2: Login on tenant domain
A returning user visits `latifa.dm.test/login`. The login form shows Latifa's branding (logo, colors) but is clearly a DancyMeals login. After entering valid credentials, the user is authenticated and can browse Latifa's menu.

### Scenario 3: Invalid credentials
A user enters an incorrect email/password combination. The form shows a localized error message ("These credentials do not match our records") without revealing whether the email exists.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-028 | Authentication is a single system across all domains; users have one DancyMeals account |
| BR-029 | Registration requires: name, email (unique), phone (required), password (min 8 chars) |
| BR-030 | Phone number must be validated as a Cameroonian format (9 digits, starting with 6) |
| BR-031 | Email must be unique across the entire platform |
| BR-032 | Login accepts email + password combination |
| BR-033 | Auth pages on tenant domains display tenant branding but DancyMeals auth system |
| BR-034 | All auth forms must use Gale for reactivity (no full page reloads on submission) |
| BR-035 | Failed login attempts must not reveal whether the email exists in the system |
| BR-036 | New users default to `is_active = true` |
| BR-037 | The `preferred_language` field defaults to English (`en`) |

---

## Data Involved
**Creates:**
- Extended User model with fields: `name`, `email`, `phone`, `password`, `is_active` (boolean, default true), `profile_photo_path` (nullable), `preferred_language` (default 'en'), plus standard Laravel fields
- Migration to add custom fields to users table
- Auth controllers (LoginController, RegisterController, PasswordResetController)
- Blade views for login, register, password reset (Gale-powered)
- Form Request classes for registration and login validation

**Reads:**
- Users table for authentication
- Tenant context for branding on tenant domains

**Updates:**
- User model with additional fillable fields and casts
- User factory with realistic Cameroonian data

**Relationships:**
- User belongsToMany Roles (via Spatie, set up in F-006)
- User belongsToMany Tenants (through pivot, established later)

---

## Acceptance Criteria
- **Given** a new user, **when** they complete the registration form with valid data, **then** their account is created and they are authenticated
- **Given** a registered user, **when** they submit valid login credentials, **then** they are authenticated and redirected appropriately
- **Given** a user on a tenant domain, **when** they view the login page, **then** tenant branding is displayed alongside DancyMeals auth
- **Given** invalid credentials, **when** submitted, **then** a generic error appears without revealing account existence
- **Given** a phone number in invalid format, **when** submitted during registration, **then** a validation error is shown
- **Given** the User model, **when** inspecting its fields, **then** `phone`, `is_active`, `profile_photo_path`, and `preferred_language` are present

---

## Verification Steps
1. Visit `/register` on the main domain, fill in valid data, and confirm account creation
2. Visit `/login` on a tenant domain and confirm tenant branding appears on the form
3. Log in with valid credentials and confirm authentication succeeds
4. Attempt login with wrong password and confirm generic error message
5. Register with a duplicate email and confirm validation error
6. Register with an invalid phone number and confirm validation error
7. Confirm User model has all required custom fields via migration

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| User registers with email that has different casing | Email is normalized to lowercase before storage |
| Phone number with country code prefix (+237) | Accepted and normalized to 9-digit format |
| Browser back button after login | Redirected to dashboard, not back to login form |
| Session expired during form fill | Form submission redirects to login with a flash message |
| Registration with spaces in name fields | Spaces trimmed; at least one character required |

---

## UI/UX Notes
- Auth forms must be mobile-first responsive (90%+ users on mobile).
- Use Gale for form submission: no full page reload, inline validation errors, loading state on submit button.
- On tenant domains: show tenant logo above the form, with "Powered by DancyMeals" or similar branding.
- On main domain: show DancyMeals logo and branding.
- Password visibility toggle (eye icon) on password fields.
- All text must use `__()` for localization.

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; base project must be set up |
| F-004 | Multi-Tenant Domain Resolution | Auth pages adapt based on resolved tenant |
| F-006 | Role & Permission Seed Setup | Assigns default role to new users |
| F-016 | Base Layout & Responsive Navigation | Auth pages use the base layout |
| F-018 | Honeypot Protection Setup | Auth forms include honeypot fields |
| F-021 | User Registration Form | Extends registration with full validation and UX |
| F-024 | User Login | Extends login with full validation and UX |
| F-028 | Cross-Domain Session Sharing | Authentication sessions work across domains |
