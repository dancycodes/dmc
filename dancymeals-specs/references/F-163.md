# F-163 — Order Cancellation Refund Processing

> Module: Order Tracking
> Priority: Must-have
> Precedence: F-162, F-167
> Type: functional

---

## What It Does
Processes the refund when an order is cancelled by the client. The full order amount (including delivery fee) is credited to the client's wallet (not refunded back to mobile money). The cook's unwithdrawable wallet amount for that order is decremented. Any commission that would have been charged is cancelled. Transaction records are created for both the client and the cook. The client is notified that the refund has been credited to their wallet. The order status transitions from Cancelled to Refunded.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Automatically processes the refund after cancellation |
| Client | Receives the refund in their wallet and is notified |
| Cook | Sees the reversal in their wallet transactions |

---

## User Scenarios
### Scenario 1: Standard refund after cancellation
The client cancels a 5,000 XAF order (4,500 XAF subtotal + 500 XAF delivery fee). The system credits 5,000 XAF to the client's wallet. The cook's unwithdrawable balance is reduced by 5,000 XAF. A commission record is not created (cancelled before completion). The order status moves to Refunded. The client sees a notification: "5,000 XAF has been refunded to your wallet."

### Scenario 2: Client checks wallet after refund
After the refund, the client navigates to their wallet page. The balance shows the refunded amount. The transaction list shows: "Refund for Order #ORD-1234 — +5,000 XAF."

### Scenario 3: Cook sees the reversal
The cook checks their wallet. The transaction list shows: "Order #ORD-1234 cancelled — -5,000 XAF (unwithdrawable)." The unwithdrawable balance has decreased.

### Scenario 4: Wallet-paid order refund
The client originally paid using their wallet balance. On cancellation, the amount returns to the wallet. The net effect is the wallet balance returning to its pre-order state.

### Scenario 5: Partial wallet + mobile money payment refund
The client paid 2,000 XAF from wallet and 3,000 XAF via mobile money. On cancellation, the full 5,000 XAF is credited to the wallet (not split back to original payment methods).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-248 | Full order amount (subtotal + delivery fee) is refunded to the client's wallet |
| BR-249 | Refunds always go to the client wallet, never back to mobile money |
| BR-250 | Cook's unwithdrawable wallet amount for the cancelled order is decremented |
| BR-251 | No commission is charged on cancelled orders |
| BR-252 | A client wallet transaction record is created (type: refund, credit) |
| BR-253 | A cook wallet transaction record is created (type: order_cancelled, debit from unwithdrawable) |
| BR-254 | The order status transitions from Cancelled to Refunded |
| BR-255 | The client is notified of the refund (push + DB + email) |
| BR-256 | Refund processing is automatic and immediate upon cancellation |
| BR-257 | Client wallet balance cannot go negative (refunds always add to balance) |
| BR-258 | All amounts are in XAF |
| BR-259 | Refund processing is logged via Spatie Activitylog |

---

## Data Involved
**Reads:**
- `orders` table for order amount, delivery fee, payment details
- `client_wallets` table for current balance
- `cook_wallets` table for unwithdrawable amount

**Creates:**
- Client wallet transaction (type: refund, amount: +order_total)
- Cook wallet transaction (type: order_cancelled, amount: -order_total from unwithdrawable)
- Activity log entry
- Client notification (push + DB + email)

**Updates:**
- `client_wallets.balance` incremented by order total
- `cook_wallets.unwithdrawable_amount` decremented by order total
- `orders.status` to Refunded
- `orders.refunded_at` timestamp

**Relationships:**
- Refund triggered by F-162 (cancellation)
- Client wallet credit uses F-167 (wallet refund credit mechanism)
- Order status transition validated by F-159

---

## Acceptance Criteria
- **Given** an order is cancelled, **when** refund processes, **then** the full amount is credited to the client's wallet
- **Given** the refund is processed, **when** checking the client's wallet, **then** the balance reflects the refund
- **Given** the refund is processed, **when** checking the cook's wallet, **then** the unwithdrawable amount is decremented
- **Given** a cancelled order, **when** the refund completes, **then** the order status is Refunded
- **Given** the refund is processed, **when** checking notifications, **then** the client received a refund notification via push, DB, and email
- **Given** a mixed-payment order (wallet + mobile money), **when** refunded, **then** the full amount goes to the wallet

---

## Verification Steps
1. Cancel an order and verify the refund is processed automatically
2. Check the client's wallet balance — verify it increased by the order total
3. Check the client's wallet transaction list — verify the refund entry
4. Check the cook's wallet — verify unwithdrawable amount decreased
5. Check the cook's wallet transaction list — verify the cancellation entry
6. Verify the order status is now Refunded
7. Verify the client received push, DB, and email notifications
8. Cancel a wallet-paid order and verify the wallet balance returns correctly
9. Check the activity log for the refund entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook's unwithdrawable balance is less than the order amount | Should not happen (money was added when order was paid); log error and alert admin if it occurs |
| Refund processing fails mid-way | Transaction wraps in a database transaction; all changes roll back on failure |
| Multiple cancellations for the same order (duplicate requests) | Idempotent: if order is already Refunded, no duplicate refund is created |
| Order was free (0 XAF, e.g., fully covered by promo code) | Refund of 0 XAF is processed; wallet balance unchanged; status still moves to Refunded |
| Client wallet did not exist before | Wallet is created (or already exists from F-166) and the refund is credited |

---

## UI/UX Notes
- No dedicated UI for this feature; refund processing is automatic and happens server-side
- Client sees the result on:
  - Order detail page: status changes to Refunded
  - Wallet dashboard: balance updates
  - Notifications: refund notification appears
- Cook sees the result on:
  - Wallet dashboard: unwithdrawable amount decreases
  - Wallet transaction history: cancellation entry appears

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-162 | Order Cancellation | Triggers this refund processing |
| F-166 | Client Wallet Dashboard | Shows the refunded balance |
| F-167 | Client Wallet Refund Credit | Mechanism used to credit the wallet |
| F-169 | Cook Wallet Dashboard | Shows the decremented unwithdrawable amount |
| F-170 | Cook Wallet Transaction History | Shows the cancellation transaction |
| F-159 | Order Status Transition Validation | Validates Cancelled > Refunded transition |
