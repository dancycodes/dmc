# F-019 â€” Rate Limiting Setup

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Configures Laravel's built-in rate limiting for the DancyMeals platform. Defines three tiers of rate limiters: strict limits for authentication endpoints to prevent brute-force attacks, moderate limits for API endpoints, and generous limits for public page browsing. Applies rate limiters via middleware to the appropriate route groups. Returns proper 429 (Too Many Requests) responses with `Retry-After` headers when limits are exceeded.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Subject to rate limits; rarely encounters them under normal usage |
| Cook | Subject to rate limits on API endpoints |
| Admin | Subject to rate limits but with higher thresholds where appropriate |
| Attacker | Blocked by strict rate limits on authentication and sensitive endpoints |

---

## User Scenarios
### Scenario 1: Normal user browsing
A client browses the discovery page, views several cook profiles, and checks menus. Their requests stay well within the generous 120 requests/minute limit for public pages. No rate limiting is triggered.

### Scenario 2: Brute-force login attempt
An attacker attempts to brute-force a user's password by submitting rapid login attempts. After 5 failed attempts within a minute, the rate limiter blocks further attempts and returns a 429 response with a `Retry-After` header indicating when they can try again.

### Scenario 3: API rate limit reached
A legitimate but aggressive client-side script makes 65 API requests within a minute (exceeding the 60/min limit). The 61st request receives a 429 response. The client-side code respects the `Retry-After` header and pauses before retrying.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-151 | Authentication endpoints: 5 requests per minute per IP (strict) |
| BR-152 | API endpoints: 60 requests per minute per authenticated user or IP (moderate) |
| BR-153 | Public page endpoints: 120 requests per minute per IP (generous) |
| BR-154 | Rate limit responses must return HTTP 429 with `Retry-After` header |
| BR-155 | Rate limiting is applied per IP for unauthenticated requests |
| BR-156 | Rate limiting is applied per user for authenticated requests |
| BR-157 | The 429 response page must be user-friendly and localized |
| BR-158 | Rate limit configuration must be centralized and easily adjustable |
| BR-159 | Password reset and email verification endpoints use the strict tier |

---

## Data Involved
**Creates:**
- Rate limiter definitions in `AppServiceProvider` (or `bootstrap/app.php` depending on Laravel 12 convention)
- Custom 429 error page (`resources/views/errors/429.blade.php`)

**Reads:**
- Request IP address for unauthenticated rate limiting
- Authenticated user ID for per-user rate limiting
- Request route to determine which rate limit tier applies

**Updates:**
- `bootstrap/app.php` to apply rate limit middleware to route groups
- Route files with rate limit middleware assignments

**Relationships:**
- Applied globally to all routes via appropriate tiers
- Works alongside F-018 (Honeypot) for layered security

---

## Acceptance Criteria
- **Given** an authentication endpoint, **when** 6 requests are made within 1 minute from the same IP, **then** the 6th request receives a 429 response
- **Given** the 429 response, **when** inspecting headers, **then** a `Retry-After` header is present with the correct delay
- **Given** a public page endpoint, **when** 120 requests are made within 1 minute, **then** all succeed; the 121st is rate-limited
- **Given** an API endpoint with an authenticated user, **when** 60 requests are made within 1 minute, **then** the 61st receives a 429 response
- **Given** the 429 error page, **when** displayed, **then** it shows a user-friendly message and respects the current locale
- **Given** rate limits are hit, **when** the retry period passes, **then** requests are accepted again

---

## Verification Steps
1. Make 6 rapid login attempts and confirm the 6th returns a 429 response
2. Inspect the 429 response headers and confirm `Retry-After` is present
3. View the 429 error page and confirm it is user-friendly with DancyMeals branding
4. Wait for the retry period and confirm requests are accepted again
5. Make 120 requests to a public page within a minute and confirm all succeed
6. Make the 121st public page request and confirm it is rate-limited
7. Verify rate limiter definitions exist in the service provider

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Shared IP (NAT, corporate network) | Rate limiting by IP may affect multiple users; consider combining with user ID where possible |
| Load balancer/proxy hides real IP | Configure trusted proxies in Laravel to extract the real client IP |
| Rate limit hit during Gale SPA navigation | Gale handles the 429 response gracefully; shows a user-friendly message without breaking the SPA |
| Admin with high-volume legitimate activity | Admin routes may use a separate, more generous rate limiter if needed |
| Rate limit cache driver fails | Defaults to no rate limiting (fail-open) rather than blocking all requests |

---

## UI/UX Notes
- The 429 error page should be branded with DancyMeals styling.
- Message should be friendly: "You're making requests a bit too quickly. Please wait a moment and try again."
- Include a countdown timer or "Retry-After" information so the user knows when to try again.
- The page should support both light and dark modes.
- On Gale SPA navigation, a 429 response should show an inline message, not navigate to the error page.

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; Laravel's rate limiting is built-in |
| F-005 | Authentication Scaffolding | Auth endpoints use strict rate limiting |
| F-018 | Honeypot Protection Setup | Complementary protection layer |
| F-019 | Rate Limiting Setup | This feature |
