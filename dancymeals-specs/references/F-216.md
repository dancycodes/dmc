# F-216 â€” Cook Promo Code Edit

> Module: Promo
> Priority: Should-have
> Precedence: F-215
> Type: functional

---

## What It Does
Allows a cook to edit an existing promo code's details. The cook can modify the discount value, minimum order amount, maximum total uses, maximum uses per client, start date, and end date. The code string itself cannot be changed after creation to prevent confusion with already-distributed codes. If the promo code has been used (redeemed at least once), a warning badge shows how many times it has been redeemed. All changes apply to future uses only -- orders that already used the promo code are unaffected. All edit actions are logged via Spatie Activitylog.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Edits promo code parameters |
| Manager | Cannot edit promo codes (cook-reserved action) |
| Client | Unaffected by edits on past orders; future uses reflect new values |
| Admin | Can view promo code edit history in admin tenant details |

---

## User Scenarios
### Scenario 1: Cook increases the discount value
The cook opens "WELCOME10" and changes the discount from 10% to 15%. A success toast confirms: "Promo code WELCOME10 updated." Future applications of this code give 15% off.

### Scenario 2: Cook extends the end date
The promo "LAUNCH500" was set to expire next Sunday. The cook extends it by another week. Clients can now use the code for the additional week.

### Scenario 3: Cook edits a used promo code
The cook opens "LOYALTY" which has been used 47 times. A warning badge shows: "This code has been redeemed 47 times." The cook adjusts the max total uses from unlimited to 100. The warning helps the cook make informed decisions.

### Scenario 4: Cook tries to change the code string
The code field is displayed as read-only. The cook sees the current code "WELCOME10" but cannot modify it. A tooltip explains: "The code cannot be changed after creation."

### Scenario 5: Cook reduces max uses below current usage
The cook sets max_uses to 30 for a code that has already been used 47 times. The system allows this -- the code becomes effectively exhausted and cannot be used again. A warning appears: "This code has already been used 47 times and will be immediately exhausted."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-549 | The promo code string cannot be changed after creation |
| BR-550 | Editable fields: discount_value, minimum_order_amount, max_uses, max_uses_per_client, starts_at, ends_at |
| BR-551 | The discount type (percentage/fixed) cannot be changed after creation |
| BR-552 | If the promo has been used, a usage count warning is displayed |
| BR-553 | Changes apply to future uses only; past orders retain original discount values |
| BR-554 | Validation rules for editable fields are the same as creation (F-215) |
| BR-555 | Setting max_uses below the current usage count is allowed; the code becomes exhausted |
| BR-556 | Only the cook can edit promo codes (cook-reserved action) |
| BR-557 | All edits are logged via Spatie Activitylog with before/after values |
| BR-558 | All user-facing text must use `__()` localization |
| BR-559 | Gale handles the edit form interactions without page reloads |

---

## Data Involved
**Creates:**
- Activity log entry for each edit

**Reads:**
- Current promo code record
- Usage count (count of promo_code_usages for this code)

**Updates:**
- `promo_codes` table: discount_value, minimum_order_amount, max_uses, max_uses_per_client, starts_at, ends_at, updated_at

**Relationships:**
- PromoCode hasMany PromoCodeUsages (for usage count)
- PromoCode belongsTo Tenant

---

## Acceptance Criteria
- **Given** a promo code, **when** the cook opens the edit form, **then** all editable fields are pre-populated with current values
- **Given** the code field, **when** viewing the edit form, **then** it is read-only and cannot be changed
- **Given** a discount type, **when** viewing the edit form, **then** it is displayed but not editable
- **Given** a used promo code, **when** opening the edit form, **then** a usage count warning is displayed
- **Given** valid edits, **when** saved, **then** the promo code record is updated and a success toast appears
- **Given** max_uses set below current usage, **when** saved, **then** a warning about exhaustion is shown and the change is saved
- **Given** an edit, **when** checked in the activity log, **then** before/after values are recorded

---

## Verification Steps
1. Open an existing promo code edit form -- confirm fields are pre-populated
2. Verify the code string field is read-only
3. Verify the discount type is displayed but not editable
4. Change the discount value and save -- confirm the update persists
5. Change the end date and save -- confirm the update
6. Open a used promo and verify the usage count warning
7. Set max_uses below current usage -- confirm the exhaustion warning and successful save
8. Place an order using the promo before and after edit -- confirm old order is unaffected
9. Check activity log for edit entries with before/after values

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Editing start date to a past date | Validation rejects: "Start date must be today or later" (unless the code is already active) |
| Editing start date of an already-active code | Allowed only if new start date is today or earlier (preserving active status) |
| End date set to today | Allowed; code expires at end of today |
| Concurrent edit by cook on two tabs | Last save wins; no data corruption |
| Editing a deactivated promo code | Allowed; editing does not reactivate it |
| Usage count changes between form load and save | Displayed count may be stale; save uses latest data |
| Cook submits form without changes | No activity log entry; no unnecessary write |

---

## UI/UX Notes
- Edit form opens in a modal or side panel (same layout as creation form from F-215)
- Code string shown in a prominent read-only field with a lock icon
- Discount type shown as a label (not an input) with the current type
- Usage count warning: amber badge showing "Used X times" near the top of the form
- Exhaustion warning: red inline message when max_uses is set below current usage
- "Save Changes" button at the bottom
- "Cancel" link to dismiss without saving
- Form pre-populated with current values
- Validation errors inline next to each field
- Mobile: full-screen modal with stacked fields
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-215 | Cook Promo Code Creation | Creates the code that this feature edits |
| F-217 | Cook Promo Code Deactivation | Separate toggle for active/inactive status |
| F-218 | Promo Code Application at Checkout | Uses the edited values for future applications |
| F-219 | Promo Code Validation Rules | Validation uses the edited parameters |
