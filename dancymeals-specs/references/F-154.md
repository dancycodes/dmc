# F-154 â€” Payment Receipt & Confirmation

> Module: Payment
> Priority: Must-have
> Precedence: F-151
> Type: functional

---

## What It Does
Displays a payment confirmation page after a successful payment (via Flutterwave or wallet). Shows the complete order details, payment amount, payment method, transaction reference, and order status. Provides options to download or share the receipt. Sends a push notification and email receipt to the client. Sets the order status to "Paid" and provides a link to the order tracking page. This is the final step of the ordering flow.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Views the confirmation page, downloads receipt, and proceeds to order tracking |
| Cook | Receives notification of new paid order |

---

## User Scenarios
### Scenario 1: Viewing the confirmation page
After successful payment, the client sees: "Payment Successful!" with a green checkmark animation. Below: order number (#DM-2024-0045), order items summary, payment amount (6,500 XAF), payment method (MTN Mobile Money), transaction reference (FLW-xxxx), and order status ("Paid"). Two buttons: "Download Receipt" and "Track Order."

### Scenario 2: Downloading the receipt
The client clicks "Download Receipt." A PDF receipt is generated and downloaded containing: order number, date, items, amounts, payment details, and cook information.

### Scenario 3: Email receipt
Simultaneously, an email is sent to the client's registered email with the receipt details: order summary, payment confirmation, transaction reference, and a link to track the order.

### Scenario 4: Push notification
A push notification is sent to the client: "Payment confirmed! Your order #DM-2024-0045 is now being processed by Chef Latifa." A separate push notification is sent to the cook: "New order #DM-2024-0045 received! 6,500 XAF."

### Scenario 5: Sharing the confirmation
The client clicks "Share" and can share the order confirmation via device sharing options (WhatsApp, SMS, etc.) with a formatted message including the order number and status.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-398 | Confirmation page displays: order number, item summary, total amount, payment method, transaction reference, order status |
| BR-399 | Order number follows the format: DM-{YEAR}-{SEQUENTIAL} (e.g., DM-2026-0045) |
| BR-400 | A push notification is sent to the client confirming payment |
| BR-401 | A push notification is sent to the cook about the new order |
| BR-402 | An email receipt is sent to the client's registered email |
| BR-403 | Receipt can be downloaded as PDF |
| BR-404 | "Track Order" links to the order tracking page (F-161 or equivalent) |
| BR-405 | Order status is "Paid" at this point |
| BR-406 | Confirmation page is accessible only to the order's owner |
| BR-407 | Notifications use all three channels: push, database (in-app), and email |
| BR-408 | All text must be localized via `__()` |

---

## Data Involved
**Reads:**
- Order record: number, items, total, payment method, reference, status
- Client profile: email, notification preferences
- Cook profile: name, push notification token

**Creates:**
- PDF receipt document
- Push notification (client)
- Push notification (cook)
- Database notification (client)
- Database notification (cook)
- Email notification (client)

**Updates:**
- Nothing (order already set to "Paid" by F-151 or F-153)

**Relationships:**
- Follows F-151 (Payment Webhook Handling) or F-153 (Wallet Balance Payment)
- Links to order tracking (F-161 or equivalent)
- Notifications use the notification system (F-190 or equivalent)

---

## Acceptance Criteria
- **Given** a successful payment, **when** the confirmation page loads, **then** all order and payment details are displayed
- **Given** the client clicks "Download Receipt", **when** the PDF generates, **then** a receipt with correct details is downloaded
- **Given** a successful payment, **when** processing, **then** a push notification is sent to the client
- **Given** a successful payment, **when** processing, **then** a push notification is sent to the cook
- **Given** a successful payment, **when** processing, **then** an email receipt is sent to the client
- **Given** the client clicks "Track Order", **when** navigating, **then** the order tracking page opens
- **Given** a different user tries to access the confirmation, **when** loading, **then** a 403 is returned

---

## Verification Steps
1. Complete a payment and verify the confirmation page displays correct order details
2. Verify the transaction reference matches the Flutterwave reference
3. Click "Download Receipt" and verify the PDF contains correct information
4. Check the client's email for the receipt
5. Check push notifications for both client and cook
6. Click "Track Order" and verify navigation to the tracking page
7. Try accessing the confirmation URL as a different user; verify access denied

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Email delivery fails | Order is still confirmed; email failure logged; receipt available on-page |
| Push notification fails | Order is still confirmed; notification failure logged; database notification serves as fallback |
| Client refreshes the confirmation page | Page reloads with same data (idempotent display) |
| PDF generation fails | Show error toast; offer to retry download |
| Very long order (many items) | Receipt PDF and confirmation page scroll/paginate correctly |
| Wallet payment (no Flutterwave reference) | Transaction reference shows internal reference instead |

---

## UI/UX Notes
- Large green checkmark animation on page load (success state)
- "Payment Successful!" heading in prominent typography
- Order details in a clean, receipt-style card layout
- "Download Receipt" and "Share" as secondary action buttons
- "Track Order" as the primary CTA button
- Confetti or subtle celebration animation (optional, light)
- Mobile: full-screen layout with sticky "Track Order" bar at bottom
- Page is bookmarkable (client can return to view the confirmation)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-151 | Payment Webhook Handling | Triggers this confirmation on successful payment |
| F-153 | Wallet Balance Payment | Alternative trigger for this confirmation |
| F-161 | Order Tracking | Destination of "Track Order" link |
| F-190 | Notification System | Sends push, email, and database notifications |
