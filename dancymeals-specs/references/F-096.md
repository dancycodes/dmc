# F-096 — Meal-Specific Location Override

> Module: Location
> Priority: Must-have
> Precedence: F-091, F-108
> Type: functional

---

## What It Does

Allows a cook to override the default delivery and pickup locations for a specific meal. By default, all meals inherit the cook's global location configuration (all towns, quarters, delivery fees, and pickup locations). With this feature, a cook can restrict a specific meal to only be available in certain locations or with different delivery fees. The override is configured on the meal edit page via a "Use custom locations" toggle. When enabled, the cook selects which towns, quarters, and pickup locations are available for that meal. Activity is logged for audit purposes.

---

## Who Uses It

| Role | Interaction |
|------|-------------|
| Cook | Configures location overrides for specific meals |
| Manager | Configures overrides if granted both meal and location management permissions |

---

## User Scenarios

### Scenario 1: Restrict meal to specific quarters
A cook has a fragile dessert that cannot travel far. On the meal edit page, they toggle "Use custom locations." They select only 3 nearby quarters for delivery (deselecting distant ones). Clients in other quarters cannot order this meal for delivery.

### Scenario 2: Meal-specific delivery fee
A cook has a large catering-style meal that costs more to deliver. They enable custom locations and set a higher delivery fee (e.g., 1000 XAF) for this meal's quarters, overriding the default fees.

### Scenario 3: Pickup-only meal
A cook's special soup must be picked up (cannot be delivered). They enable custom locations, deselect all delivery quarters, and keep only pickup locations. The meal appears as "Pickup only."

### Scenario 4: Revert to default
A cook previously set custom locations for a meal but now wants it available everywhere. They toggle off "Use custom locations." The meal reverts to using the cook's global location settings.

### Scenario 5: Default behavior (no override)
A cook's meal has "Use custom locations" toggled off (default). The meal is available in all the cook's configured delivery areas and pickup locations with the standard fees.

---

## Business Rules

| Code | Rule |
|------|------|
| BR-306 | By default, meals inherit the cook's global location settings |
| BR-307 | When "Use custom locations" is enabled, the meal uses only the selected locations |
| BR-308 | Custom locations can include a subset of the cook's delivery quarters and/or pickup locations |
| BR-309 | Custom delivery fees can be set per-quarter for this meal, overriding the global or group fee |
| BR-310 | A meal with custom locations must have at least one location (delivery or pickup) selected |
| BR-311 | Toggling off "Use custom locations" removes all overrides and reverts to global settings |
| BR-312 | Location override changes are logged via Spatie Activitylog |
| BR-313 | Override applies to new orders only; existing orders retain their original location data |
| BR-314 | The meal must still be within at least one of the cook's existing locations (cannot add new locations here) |

---

## Data Involved

**Creates:**
- Meal location override records: meal_id, quarter_id (nullable), pickup_location_id (nullable), custom_delivery_fee (nullable)

**Reads:**
- Cook's global locations (towns, quarters, groups, pickup locations)
- Current meal override configuration (if any)

**Updates:**
- Meal record: has_custom_locations (boolean flag)
- Meal location override records (on change)

**Deletes:**
- Override records when "Use custom locations" is toggled off

---

## Acceptance Criteria

- **Given** a meal with default locations, **when** "Use custom locations" is toggled on, **then** a location selection UI appears showing all of the cook's locations
- **Given** custom locations enabled, **when** the cook selects specific quarters and saves, **then** only those quarters are available for this meal
- **Given** custom delivery fees set, **when** a client orders this meal, **then** the custom fee is charged (not the global fee)
- **Given** custom locations toggled off, **when** saved, **then** all overrides are removed and global locations apply
- **Given** no locations selected with custom mode on, **when** saving, **then** a validation error requires at least one location
- **Given** a location override change, **when** checking the activity log, **then** the change is recorded

---

## Verification Steps

1. Enable custom locations on a meal and select specific quarters — confirm only those are available
2. Set a custom delivery fee and confirm it is used during ordering
3. Create a pickup-only meal by deselecting all delivery quarters
4. Toggle off custom locations and confirm global settings apply again
5. Attempt to save with no locations selected — confirm validation error
6. Check activity log for the override change entry
7. Verify existing orders are unaffected by the override change

---

## Edge Cases & Exceptions

| Condition | Expected Behavior |
|-----------|-------------------|
| Cook deletes a quarter that is in a meal override | Override for that quarter is removed; meal updates |
| Cook adds new quarters to their global settings | New quarters are NOT automatically added to existing overrides |
| Meal has custom locations but cook deletes all global locations | Meal becomes unorderable; cook warned |
| Custom fee higher than global fee | Allowed; cook decides pricing |
| Custom fee of 0 | Allowed; free delivery for this specific meal |

---

## UI/UX Notes

- Toggle switch: "Use custom locations" at the top of the locations section on the meal edit page
- When toggled on: expandable section showing all cook's locations as checkboxes
- Delivery quarters grouped by town with checkboxes and optional custom fee field per quarter
- Pickup locations as separate checkbox list
- Custom fee field only editable when the quarter is selected
- Visual indicator on meal list showing which meals have custom locations (small badge/icon)
- When toggled off: section collapses with message "Using default locations"
- Save happens as part of the meal edit form save

---

## Related Features

| Code | Feature | Relationship |
|------|---------|-------------|
| F-091 | Delivery Fee Configuration | Global fees that can be overridden |
| F-108 | Meal Edit | Parent page where this override is configured |
| F-086 | Add Quarter | Quarters available for override selection |
| F-092 | Add Pickup Location | Pickup locations available for override selection |
| F-017 | Activity Logging Setup | Logs override changes |
