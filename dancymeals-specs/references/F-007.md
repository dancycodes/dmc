# F-007 â€” Localization System Setup

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Configures Laravel's localization system to support English and French across the entire DancyMeals platform. Creates translation files using the `__('English text')` convention (full English text as keys, not dot-notation keys). Sets up middleware that detects the user's preferred language from their profile, session, or browser headers and applies it for the duration of the request. English is the default language.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Sees the platform in their preferred language (English or French) |
| Cook | Manages their dashboard and content in their preferred language |
| Admin | Uses the admin panel in their preferred language |
| Developer | Adds translatable strings using `__('English text')` convention |

---

## User Scenarios
### Scenario 1: French-speaking user visits for the first time
A user with a French browser locale visits DancyMeals for the first time. The middleware detects `Accept-Language: fr` and sets the application locale to French. All UI text appears in French.

### Scenario 2: Authenticated user with language preference
A logged-in user has `preferred_language = 'fr'` in their profile. Regardless of their browser locale, the application always renders in French for them.

### Scenario 3: Missing translation fallback
A new string is added to the codebase with `__('New feature text')` but has not yet been translated to French. When a French user encounters it, the English text is displayed as a fallback.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-048 | Supported languages are English (`en`) and French (`fr`) only |
| BR-049 | English is the default and fallback language |
| BR-050 | All user-facing strings must use `__('Full English text')` -- no hardcoded text in views |
| BR-051 | Translation files use JSON format: `lang/en.json` and `lang/fr.json` |
| BR-052 | Language detection priority: (1) authenticated user's `preferred_language`, (2) session value, (3) browser `Accept-Language` header, (4) default English |
| BR-053 | Translatable database columns use the `column_en` / `column_fr` pattern |
| BR-054 | Locale middleware must run on every request before any response is generated |

---

## Data Involved
**Creates:**
- `lang/en.json` with initial UI strings (auth, validation, navigation, common actions)
- `lang/fr.json` with French translations of the same strings
- `SetLocale` middleware
- Helper for retrieving localized database columns (e.g., `$meal->name` auto-resolves to `name_en` or `name_fr`)

**Reads:**
- User `preferred_language` field (if authenticated)
- Session `locale` value
- Request `Accept-Language` header

**Updates:**
- `bootstrap/app.php` to register locale middleware
- `config/app.php` with `locale`, `fallback_locale`, and `available_locales` settings

**Relationships:**
- Used by every feature that displays user-facing text
- F-008 (Language Switcher) provides the UI to change language

---

## Acceptance Criteria
- **Given** a user with browser locale set to French, **when** visiting the site unauthenticated, **then** all UI text appears in French
- **Given** an authenticated user with `preferred_language = 'en'` and French browser, **when** visiting, **then** UI text appears in English (user preference wins)
- **Given** a session with `locale = 'fr'`, **when** visiting unauthenticated with English browser, **then** UI text appears in French (session wins over browser)
- **Given** a string exists in `en.json` but not in `fr.json`, **when** a French user encounters it, **then** the English text is displayed
- **Given** a translatable model field, **when** accessing `$model->name` with locale set to `fr`, **then** the `name_fr` value is returned

---

## Verification Steps
1. Set browser language to French, visit the site unauthenticated, and confirm French text displays
2. Log in as a user with `preferred_language = 'en'` and confirm English overrides browser French
3. Check that `lang/en.json` contains initial strings for common UI elements
4. Check that `lang/fr.json` contains French translations for the same strings
5. Remove a key from `fr.json`, switch to French, and confirm English fallback displays

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Browser sends unsupported locale (e.g., `de`) | Falls back to English default |
| `Accept-Language` header missing entirely | Falls back to English default |
| Translation string contains HTML entities | Properly escaped in Blade using `{{ __('text') }}` |
| Pluralization differences between languages | Use Laravel's `trans_choice()` where needed |
| Empty string in translation file | Displays the English key as fallback |

---

## UI/UX Notes
- No language switcher UI in this feature (that is F-008). This feature establishes the infrastructure.
- All strings visible to users must go through `__()`. This includes: navigation items, button labels, form labels, error messages, flash messages, email subjects, notification text.
- Validation messages should also be translated (Laravel provides `lang/fr/validation.php`).

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; base project must be configured |
| F-008 | Language Switcher Component | Provides UI for users to change their language |
| F-016 | Base Layout & Responsive Navigation | Navigation text uses this localization system |
| F-042 | Language Preference Setting | User profile setting that persists language choice |
