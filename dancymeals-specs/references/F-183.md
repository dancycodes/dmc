# F-183 â€” Client Complaint Submission

> Module: Complaint
> Priority: Must-have
> Precedence: F-161
> Type: functional

---

## What It Does
Allows a client to submit a complaint on a completed or delivered order. The client selects a complaint category (food quality, delivery issue, missing item, wrong order, or other), writes a description (required, max 1000 characters), and optionally uploads one photo as evidence. A client can only file one complaint per order. When a complaint is filed, if the cook's payment for that order is still in "unwithdrawable" state, a payment block is triggered (F-186). The cook and any managers for the tenant are notified via push and database notifications.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Submits a complaint on a completed/delivered order |
| Cook | Receives notification of the complaint |
| Manager | Receives notification of the complaint if granted complaint permissions |

---

## User Scenarios
### Scenario 1: Submit a complaint about food quality
The client opens a completed order detail page. They click the "Report a Problem" button. A complaint form appears with a category dropdown, description textarea, and optional photo upload. The client selects "Food Quality," writes "The rice was undercooked and cold when it arrived," and submits. A success message confirms the complaint was filed.

### Scenario 2: Attempt to complain twice on the same order
The client has already filed a complaint on an order. They visit the order detail page again. The "Report a Problem" button is replaced with a "View Complaint" link that takes them to the complaint status view (F-187). They cannot submit another complaint.

### Scenario 3: Upload a photo with the complaint
The client selects "Missing Item" as the category, writes a description, and uploads a photo showing the incomplete order. The image uploads successfully (validated for file type and size) and is attached to the complaint.

### Scenario 4: Complaint on an order where payment is still unwithdrawable
The client files a complaint on a recently delivered order. The cook's payment for this order is still in the unwithdrawable period. The system automatically triggers a payment block (F-186), pausing the timer until the complaint is resolved.

### Scenario 5: Invalid submission
The client tries to submit a complaint without a description. Validation fails with a clear error message. The client adds a description and submits successfully.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-183 | Only orders with status Delivered or Completed can receive a complaint |
| BR-184 | A client can submit exactly one complaint per order |
| BR-185 | Complaint categories are: food_quality, delivery_issue, missing_item, wrong_order, other (stored as enum) |
| BR-186 | Description is required, minimum 10 characters, maximum 1000 characters |
| BR-187 | Photo upload is optional; maximum one image per complaint |
| BR-188 | Accepted image formats: JPEG, PNG, WebP; maximum file size: 5MB |
| BR-189 | Initial complaint status is "open" |
| BR-190 | Filing a complaint triggers a payment block on the order if the cook's payment is still unwithdrawable (F-186) |
| BR-191 | Cook and all managers of the tenant receive push + DB notifications on complaint submission |
| BR-192 | The 24-hour auto-escalation clock starts from the moment the complaint is submitted |
| BR-193 | All user-facing text must use `__()` localization |
| BR-194 | Complaint submission is logged via Spatie Activitylog |

---

## Data Involved
**Creates:**
- `complaints` table record: `id`, `order_id`, `user_id` (client), `tenant_id`, `category` (enum), `description` (text), `photo_path` (nullable string), `status` (enum: open, in_review, escalated, resolved), `created_at`, `updated_at`
- Uploaded photo stored in tenant-scoped storage directory

**Reads:**
- `orders` table to verify order status and ownership
- `complaints` table to check if complaint already exists for this order
- `cook_payments` or wallet transaction to check unwithdrawable status

**Updates:**
- Payment block status on the order's cook payment (via F-186 event)

**Relationships:**
- Complaint belongsTo Order
- Complaint belongsTo User (client who filed)
- Complaint belongsTo Tenant
- Order hasOne Complaint

---

## Acceptance Criteria
- **Given** a delivered order, **when** the client opens the order detail, **then** a "Report a Problem" button is visible
- **Given** the complaint form, **when** the client selects a category, writes a description, and submits, **then** the complaint is created with status "open"
- **Given** an order with an existing complaint, **when** the client views the order, **then** the complaint button is replaced with a "View Complaint" link
- **Given** a complaint submission, **when** the cook's payment is still unwithdrawable, **then** a payment block is triggered
- **Given** a complaint submission, **when** it succeeds, **then** the cook and managers receive push and DB notifications
- **Given** a description shorter than 10 characters, **when** submitted, **then** validation fails with an appropriate error

---

## Verification Steps
1. Navigate to a completed order and confirm the "Report a Problem" button is present
2. Submit a complaint with all required fields and confirm it is saved with status "open"
3. Attempt to submit a second complaint on the same order and confirm it is blocked
4. Submit a complaint with a photo and confirm the image is stored and associated
5. Submit without a description and confirm validation error
6. Submit with a description exceeding 1000 characters and confirm validation error
7. Verify cook receives push and DB notifications after complaint submission
8. Verify activity log entry is created for the complaint
9. Confirm payment block is triggered when the order's cook payment is unwithdrawable

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Order is still in "Preparing" status | "Report a Problem" button is not shown |
| Client tries to complain on another client's order | 403 Forbidden |
| Photo upload fails (network issue) | Complaint can still be submitted without the photo; error message shown for upload failure |
| Complaint filed after cook has already withdrawn funds | Payment block does not apply; flagged for admin review |
| Very long description at exactly 1000 characters | Accepted; character counter shown in UI |
| Order belongs to a deactivated tenant | Complaint still allowed; cook notification may not be seen but is recorded |

---

## UI/UX Notes
- "Report a Problem" button on order detail page, styled as a secondary/warning action
- Complaint form appears as a modal or inline expansion
- Category dropdown with localized labels
- Description textarea with character counter (0/1000)
- Photo upload with drag-and-drop or file picker, image preview before submit
- Submit button with loading state during submission
- Success toast notification after submission
- All interactions via Gale (no page reload)
- Mobile-friendly layout with stacked form fields

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-161 | Order Status Flow | Provides the order statuses that allow complaints |
| F-186 | Complaint-Triggered Payment Block | Triggered when complaint is filed on unwithdrawable payment |
| F-184 | Cook/Manager Complaint Response | Cook responds to the complaint filed here |
| F-185 | Complaint Auto-Escalation | 24h clock starts from complaint submission |
| F-187 | Complaint Status Tracking | Client tracks the complaint filed here |
| F-193 | Complaint Notifications | Notification details for complaint events |
