# F-004 â€” Multi-Tenant Domain Resolution

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Implements the core multi-tenancy infrastructure for DancyMeals. Creates middleware that inspects every incoming HTTP request, extracts the hostname, and resolves it to a specific tenant (cook's branded site) or the main DancyMeals domain. Supports both subdomains (cook.dancymeals.com) and custom domains (cook.cm). The resolved tenant is stored in the request context and available throughout the application lifecycle.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Visits a cook's branded subdomain or custom domain and sees that cook's content |
| Cook | Has a unique subdomain and optionally a custom domain pointing to their site |
| Admin | Accesses the main domain to reach the admin panel |
| Developer | Configures route groups and tenant resolution logic |

---

## User Scenarios
### Scenario 1: Subdomain resolution
A user visits `latifa.dancymeals.com` (or `latifa.dm.test` locally). The middleware extracts "latifa" as the subdomain, looks up the tenant with that slug, stores it in the request, and the application renders Latifa's branded content.

### Scenario 2: Custom domain resolution
A user visits `latifa.cm`. The middleware checks the full hostname against the `custom_domain` column in the tenants table, finds Latifa's tenant, and resolves it identically to the subdomain flow.

### Scenario 3: Main domain access
A user visits `dancymeals.com` (or `dm.test` locally). The middleware identifies this as the main domain (no tenant), and the request proceeds to the main site routes (discovery page, admin panel, etc.).

### Scenario 4: Unknown domain
A user visits `unknown.dancymeals.com`. The middleware finds no matching tenant and returns a 404 page with a message that the cook's site was not found.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-019 | Every request must pass through tenant resolution middleware |
| BR-020 | Tenant resolution checks subdomain first, then custom domain, then falls through to main domain |
| BR-021 | The main domain (dancymeals.com / dm.test) must never resolve to a tenant |
| BR-022 | Each tenant has a unique `slug` (used as subdomain) and an optional unique `custom_domain` |
| BR-023 | Only active tenants (`is_active = true`) should resolve; inactive tenants show a "site unavailable" page |
| BR-024 | The resolved tenant must be accessible via request macro, helper, or service throughout the request lifecycle |
| BR-025 | Route groups must separate main domain routes from tenant domain routes |
| BR-026 | Admin routes (`/vault-entry/*`) are only accessible on the main domain |
| BR-027 | Local development uses `herd link` to register subdomains (e.g., `latifa.dm.test`) |

---

## Data Involved
**Creates:**
- `Tenant` model with fields: `id`, `slug`, `name`, `custom_domain` (nullable, unique), `is_active`, `settings` (JSON), `created_at`, `updated_at`
- `tenants` migration
- `ResolveTenant` middleware
- Tenant factory and seeder

**Reads:**
- Request hostname on every incoming request
- `tenants` table for domain lookup

**Updates:**
- `bootstrap/app.php` with middleware registration
- Route files with domain-based route groups
- Trusted hosts configuration

**Relationships:**
- Tenant hasOne Cook (User with cook role)
- Tenant hasMany Orders, Meals, Locations, etc. (established by later features)

---

## Acceptance Criteria
- **Given** a tenant with slug "latifa" exists, **when** visiting `latifa.dm.test`, **then** the application resolves to Latifa's tenant context
- **Given** a tenant with custom_domain "latifa.cm", **when** visiting `latifa.cm`, **then** the same tenant context is resolved
- **Given** no tenant exists for "unknown", **when** visiting `unknown.dm.test`, **then** a 404 response is returned
- **Given** a tenant is inactive, **when** visiting its domain, **then** a "site unavailable" page is shown instead of 404
- **Given** a request on the main domain, **when** checking for tenant context, **then** it is null
- **Given** admin routes exist at `/vault-entry/*`, **when** accessing them on a tenant domain, **then** the request is rejected with 404

---

## Verification Steps
1. Create a tenant with slug "test-cook" and visit `test-cook.dm.test` to confirm resolution
2. Set the tenant as inactive and visit its domain to confirm "site unavailable" page
3. Visit `dm.test` and confirm no tenant is resolved (main domain)
4. Attempt to access `/vault-entry` on a tenant domain and confirm it returns 404
5. Create a tenant with a custom domain and verify it resolves correctly
6. Visit a non-existent subdomain and confirm 404 is returned

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Request with IP address instead of hostname | Treated as main domain (no tenant) |
| Subdomain matches a reserved word (www, api, mail) | Does not resolve as tenant; treated as main domain |
| Two tenants with overlapping domains | Prevented by unique constraints on `slug` and `custom_domain` |
| Tenant slug contains special characters | Slugs are validated to contain only lowercase alphanumeric and hyphens |
| Custom domain not yet DNS-configured | Resolves to nothing at DNS level; never reaches the app |

---

## UI/UX Notes
- The "site unavailable" page for inactive tenants should be branded with DancyMeals styling and provide a link back to the main site.
- The 404 page for unknown tenants should suggest visiting the main DancyMeals domain.
- No tenant-specific UI is built in this feature; that comes in F-126 (Tenant Landing Page).

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; project must have base packages |
| F-005 | Authentication Scaffolding | Auth must work across all resolved domains |
| F-011 | Tenant Theme Customization | Applies tenant-specific themes after resolution |
| F-016 | Base Layout & Responsive Navigation | Layout adapts based on whether a tenant is resolved |
| F-028 | Cross-Domain Session Sharing | Sessions must work across tenant and main domains |
| F-126 | Tenant Landing Page Layout | Renders the cook's branded page after tenant resolution |
