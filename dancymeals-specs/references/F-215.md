# F-215 â€” Cook Promo Code Creation

> Module: Promo
> Priority: Should-have
> Precedence: F-076
> Type: functional

---

## What It Does
Allows a cook to create promotional discount codes for their tenant. The cook navigates to the Promo section of the dashboard and creates a new promo code by specifying: a unique code string (alphanumeric), discount type (percentage or fixed XAF), discount value, minimum order amount to qualify, maximum total uses, maximum uses per client, start date, and end date. Promo codes are scoped to the tenant -- they only work on the cook's own site. Created promo codes appear in a list with their key details. All creation actions are logged via Spatie Activitylog.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Creates promo codes with all parameters |
| Manager | Cannot create promo codes (cook-reserved action) |
| Client | Will use the promo codes at checkout (F-218) |
| Admin | Can view promo codes in admin tenant details |

---

## User Scenarios
### Scenario 1: Cook creates a percentage discount
The cook creates a promo code "WELCOME10" with: type = percentage, value = 10%, minimum order = 2,000 XAF, max uses = 100, max per client = 1, start = today, end = 30 days from now. Success toast: "Promo code WELCOME10 created."

### Scenario 2: Cook creates a fixed amount discount
The cook creates "LAUNCH500" with: type = fixed, value = 500 XAF, minimum order = 1,500 XAF, max uses = 50, max per client = 2, start = next Monday, end = next Sunday. The code will only be usable during that week.

### Scenario 3: Cook creates an unlimited promo
The cook creates "LOYALTY" with no maximum total uses and no per-client limit (both set to 0 = unlimited). The promo has no end date. It will remain active indefinitely until manually deactivated.

### Scenario 4: Duplicate code error
The cook tries to create a code "WELCOME10" that already exists for this tenant. Validation error: "A promo code with this name already exists."

### Scenario 5: Invalid values
The cook enters a percentage value of 150%. Validation error: "Percentage discount must be between 1 and 100."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-533 | Promo code string: alphanumeric, 3-20 characters, case-insensitive storage (stored uppercase) |
| BR-534 | Code must be unique within the tenant (not globally) |
| BR-535 | Discount types: percentage or fixed (XAF amount) |
| BR-536 | Percentage discount range: 1% to 100% (integer only) |
| BR-537 | Fixed discount range: 1 to 100,000 XAF (integer only) |
| BR-538 | Minimum order amount: 0 (no minimum) to 100,000 XAF |
| BR-539 | Maximum total uses: 0 = unlimited, otherwise 1 to 100,000 |
| BR-540 | Maximum uses per client: 0 = unlimited, otherwise 1 to 100 |
| BR-541 | Start date: required, must be today or in the future |
| BR-542 | End date: optional; if provided, must be after start date |
| BR-543 | Promo codes are tenant-scoped and cannot be used on other tenants |
| BR-544 | New promo codes are created with status "active" |
| BR-545 | Only the cook can create promo codes (cook-reserved action) |
| BR-546 | All creation actions are logged via Spatie Activitylog |
| BR-547 | All user-facing text must use `__()` localization |
| BR-548 | Gale handles the form and list interactions without page reloads |

---

## Data Involved
**Creates:**
- `promo_codes` table record with: tenant_id, code, discount_type, discount_value, minimum_order_amount, max_uses, max_uses_per_client, starts_at, ends_at, status, created_by
- Activity log entry

**Reads:**
- Existing promo codes for this tenant (uniqueness check)

**Updates:**
- Nothing on creation

**Relationships:**
- PromoCode belongsTo Tenant
- PromoCode belongsTo User (created_by)
- PromoCode hasMany PromoCodeUsages (F-218)

---

## Acceptance Criteria
- **Given** a cook, **when** they fill in all required fields and submit, **then** the promo code is created and appears in the list
- **Given** a duplicate code, **when** submitted, **then** validation rejects with a uniqueness error
- **Given** a percentage of 150%, **when** submitted, **then** validation rejects with a range error
- **Given** an end date before the start date, **when** submitted, **then** validation rejects
- **Given** a valid promo code, **when** created, **then** its status is "active"
- **Given** a code with lowercase letters, **when** saved, **then** it is stored as uppercase
- **Given** a creation event, **when** checked in the activity log, **then** the code details are recorded

---

## Verification Steps
1. Create a percentage promo code -- confirm it appears in the promo list
2. Create a fixed amount promo code -- confirm correct details stored
3. Attempt to create a duplicate code -- confirm validation error
4. Attempt a percentage value > 100 -- confirm validation error
5. Attempt a fixed value of 0 -- confirm validation error
6. Set an end date before the start date -- confirm validation error
7. Create a code with max_uses = 0 -- confirm it is unlimited
8. Create a code without an end date -- confirm no end date stored
9. Verify the code is stored uppercase regardless of input casing
10. Check activity log for creation entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Code with special characters (e.g., "WELCOME-10") | Validation rejects: "Code must be alphanumeric only" |
| Code shorter than 3 characters | Validation rejects: "Code must be between 3 and 20 characters" |
| Start date in the past | Validation rejects: "Start date must be today or later" |
| End date same as start date | Allowed; promo is valid for that single day |
| Minimum order on promo is higher than any menu item | Allowed; client must order multiple items to qualify |
| Cook creates 100+ promo codes | Allowed; list view should handle pagination |
| 100% percentage discount | Allowed; effectively makes the food portion free |

---

## UI/UX Notes
- Located in Cook Dashboard > Promo section
- "Create Promo Code" button at the top of the promo list
- Form fields in a modal or side panel:
  - Code (text input, auto-uppercased as the cook types)
  - Discount Type (radio buttons or segmented control: Percentage / Fixed Amount)
  - Discount Value (number input with % or XAF unit label based on type)
  - Minimum Order Amount (number input with XAF label)
  - Maximum Total Uses (number input, 0 for unlimited, with helper text)
  - Maximum Uses Per Client (number input, 0 for unlimited)
  - Start Date (date picker, defaults to today)
  - End Date (date picker, optional, with "No end date" checkbox)
- Validation errors inline next to each field
- After creation: promo list updates via Gale with the new code at the top
- Promo list shows: code, type, value, status, uses/max, dates
- Mobile: full-screen form modal; stacked fields

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-076 | Cook Dashboard Layout & Navigation | Dashboard where promo section lives |
| F-216 | Cook Promo Code Edit | Editing existing promo codes |
| F-217 | Cook Promo Code Deactivation | Activating/deactivating promo codes |
| F-218 | Promo Code Application at Checkout | Client applies promo at checkout |
| F-219 | Promo Code Validation Rules | Validation logic for promo redemption |
