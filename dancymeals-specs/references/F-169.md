# F-169 â€” Cook Wallet Dashboard

> Module: Wallet
> Priority: Must-have
> Precedence: F-076, F-151
> Type: functional

---

## What It Does
Displays the cook's wallet page in the cook dashboard. Shows the total balance split into withdrawable and unwithdrawable amounts, recent transactions (last 10), a withdrawal button (active only when withdrawable balance is greater than zero), and an earnings summary. Unwithdrawable amounts are order payments still within the clearance period (F-171). Withdrawable amounts are cleared funds available for withdrawal to mobile money. Includes a chart showing earnings over time.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Views wallet balance, transactions, and initiates withdrawals |
| Manager | Views wallet dashboard if granted `manage-finances` permission (read-only) |

---

## User Scenarios
### Scenario 1: View wallet with both amounts
The cook navigates to "Wallet" in the dashboard. The page shows: Total Balance: 50,000 XAF, Withdrawable: 35,000 XAF, Unwithdrawable: 15,000 XAF (clearing soon). The "Withdraw" button is active.

### Scenario 2: No withdrawable balance
The cook's wallet shows: Total Balance: 15,000 XAF, Withdrawable: 0 XAF, Unwithdrawable: 15,000 XAF. The "Withdraw" button is grayed out with tooltip: "No funds available for withdrawal yet."

### Scenario 3: View recent transactions
Below the balance, the last 10 transactions are listed: order payments received, commission deductions, withdrawals, and auto-deductions. Each shows date, description, amount, and type.

### Scenario 4: View earnings summary
The summary section shows: Total Earned (all time), Total Withdrawn, Pending (unwithdrawable). A line chart shows monthly earnings over the past 6 months.

### Scenario 5: Initiate withdrawal
The cook clicks "Withdraw." They are taken to the withdrawal request form (F-172).

### Scenario 6: Manager views wallet
A manager with `manage-finances` permission views the wallet dashboard in read-only mode. The withdrawal button is not available (only cooks can withdraw).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-311 | Cook wallet shows total balance split into withdrawable and unwithdrawable |
| BR-312 | Withdrawable = funds cleared after the configurable hold period (F-171) |
| BR-313 | Unwithdrawable = funds still within the hold period or blocked by complaints |
| BR-314 | The "Withdraw" button is active only when withdrawable > 0 |
| BR-315 | Recent transactions show the last 10 entries |
| BR-316 | Earnings summary shows: total earned, total withdrawn, pending (unwithdrawable) |
| BR-317 | Earnings chart shows monthly totals for the past 6 months |
| BR-318 | All amounts are in XAF format |
| BR-319 | Only cook (or users with `manage-finances` permission) can access the wallet |
| BR-320 | Managers can view but not withdraw |
| BR-321 | Wallet data is tenant-scoped |
| BR-322 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `cook_wallets` table for withdrawable and unwithdrawable amounts
- `cook_wallet_transactions` for recent entries and historical data
- Aggregated earnings data for summary and chart

**Creates:**
- Cook wallet record if none exists (lazy creation)

**Updates:**
- Nothing (display only)

**Relationships:**
- CookWallet belongsTo Tenant
- CookWallet hasMany CookWalletTransactions

---

## Acceptance Criteria
- **Given** a cook with both withdrawable and unwithdrawable funds, **when** viewing the wallet, **then** both amounts are displayed correctly
- **Given** withdrawable balance > 0, **when** viewing the wallet, **then** the "Withdraw" button is active
- **Given** withdrawable balance = 0, **when** viewing the wallet, **then** the "Withdraw" button is disabled
- **Given** recent transactions exist, **when** viewing the wallet, **then** the last 10 are listed
- **Given** the cook clicks "Withdraw," **when** navigating, **then** they reach the withdrawal request form (F-172)
- **Given** a manager with `manage-finances` permission, **when** viewing the wallet, **then** it is read-only with no withdrawal button

---

## Verification Steps
1. Navigate to the wallet page and verify balance display with both amounts
2. Verify the withdraw button is active/disabled based on withdrawable balance
3. Verify recent transactions list with correct data
4. Verify the earnings summary with totals
5. Verify the earnings chart renders with monthly data
6. Click "Withdraw" and verify navigation to withdrawal form
7. Log in as manager and verify read-only access
8. Log in as manager without `manage-finances` permission and verify 403

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| New cook with no wallet | Wallet created with 0 balance on first visit |
| No transactions yet | Recent transactions section shows "No transactions yet" |
| No earnings history for chart | Chart shows empty state or "Not enough data" |
| Very large amounts | Formatted correctly with thousands separator (e.g., "1,500,000 XAF") |
| Pending deduction from F-174 | Shown in the summary as a deduction item |

---

## UI/UX Notes
- Accessible from cook dashboard sidebar under "Wallet" or "Finances"
- Top section: three cards showing Total, Withdrawable, Unwithdrawable amounts
- "Withdraw" button prominent, next to the withdrawable amount
- Disabled state: grayed out button with tooltip
- Earnings summary: simple stat cards below the balance
- Chart: line chart showing monthly earnings, responsive
- Recent transactions: compact list with transaction type icons
- "View all transactions" link to F-170
- Mobile-first layout
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-076 | Cook Dashboard Layout & Navigation | Dashboard shell and navigation |
| F-151 | Payment Webhook Handling | Creates order payments that appear in wallet |
| F-170 | Cook Wallet Transaction History | Full transaction list |
| F-171 | Withdrawable Timer Logic | Transitions funds from unwithdrawable to withdrawable |
| F-172 | Cook Withdrawal Request | Withdrawal form linked from here |
| F-174 | Cook Auto-Deduction for Refunds | Deductions shown in wallet |
| F-175 | Commission Deduction on Completion | Commission deducted from earnings |
