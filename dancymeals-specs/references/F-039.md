# F-039 — Edit Payment Method

> Module: User Settings
> Type: functional
> Priority: Must-have
> Precedence: F-038

---

## What It Does

Allows an authenticated user to edit the label and phone number of an existing saved payment
method. The provider cannot be changed (the user must delete and re-add to change providers).
The form is pre-populated with current values. Validates phone format per provider. Saves
without page reload via Gale.

---

## Who Uses It

- **All authenticated users** editing one of their saved payment methods.

---

## User Scenarios

### Happy Path
1. User clicks "Edit" on a payment method in the list (F-038).
2. The edit form opens with pre-populated values:
   - Label: "MTN Main" (editable)
   - Provider: "MTN MoMo" (displayed but not editable)
   - Phone number: +237 6XX XXX XXX (editable, shown unmasked for editing)
3. User changes the label to "MTN Secondary."
4. User clicks "Save."
5. The method is updated via Gale without page reload.
6. Toast: "Payment method updated."
7. The list reflects the updated label.

### Alternate Path — Change Phone Number
1. User changes the phone number to a different valid MTN number.
2. Validation passes (phone matches the MTN provider).
3. The phone number is updated.

### Error Path — Invalid Phone for Provider
1. User changes the phone number to one that does not match the provider's prefix.
2. Validation error: "This phone number does not match MTN MoMo."

### Error Path — Duplicate Label
1. User changes the label to one already used by another payment method.
2. Validation error: "You already have a payment method with this label."

---

## Business Rules

| Code | Rule |
|------|------|
| BR-163 | Only label and phone number are editable. Provider is read-only. |
| BR-164 | To change the provider, the user must delete this method and add a new one. |
| BR-165 | Phone number validation must match the existing provider (same rules as BR-151). |
| BR-166 | Label uniqueness is validated among the user's other methods (excluding the current one). |
| BR-167 | The form must show the current phone number unmasked for editing purposes. |
| BR-168 | Users can only edit their own payment methods. |
| BR-169 | Save via Gale without page reload. |

---

## Data Involved

### PaymentMethod Model (updated)
| Field | Editable | Notes |
|-------|----------|-------|
| label | Yes | Same validation as add (BR-148) |
| provider | No | Displayed as read-only |
| phone | Yes | Validated against the existing provider |

---

## Acceptance Criteria

```
Given I click "Edit" on a payment method
When the form opens
Then label and phone are editable, and provider is displayed as read-only

Given I update the label and click save
When the server processes the update
Then the label is updated and a toast confirms success

Given I change the phone to a valid number matching the provider
When I click save
Then the phone is updated

Given I change the phone to a number that does not match the provider
When I click save
Then I see a validation error

Given the provider field is shown
When I try to change it
Then it is not editable (read-only, no interaction)
```

---

## Verification Steps

1. Click edit on a method — confirm label and phone are editable, provider is read-only.
2. Update the label and save — confirm the change persists.
3. Update the phone number with a valid number — confirm it saves.
4. Try a phone number that does not match the provider — confirm validation error.
5. Try a duplicate label — confirm validation error.

---

## Edge Cases

- User's phone number for this payment method was saved in an older format — pre-populate with normalized format.
- Provider validation rules change (telecom assigns new prefixes) — the system should be flexible enough to update rules.
- User edits while on a checkout page in another tab — changes are saved independently.

---

## UI/UX Notes

- Edit form can be a modal or inline expansion.
- Provider field is visually grayed out or has a lock icon.
- A note explains: "To change provider, please delete this method and add a new one."
- Phone number is shown fully (unmasked) in the edit form for user convenience.
- Save button shows loading state.
- Light/dark mode support.

---

## Related Features

- **F-037** — Add Payment Method (similar form structure)
- **F-038** — Payment Method List (edit is triggered from here)
- **F-040** — Delete Payment Method (alternative to editing the provider)
