# F-170 — Cook Wallet Transaction History

> Module: Wallet
> Priority: Must-have
> Precedence: F-169
> Type: functional

---

## What It Does
Displays the complete paginated list of all financial transactions in the cook's wallet. Transaction types include: order payment received (initially unwithdrawable), became withdrawable (clearance completed), commission deducted, withdrawal processed, and auto-deduction for post-withdrawal refund. Each entry shows date, description, amount, transaction type, and order reference. The cook can filter by transaction type. All data is tenant-scoped.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Views complete wallet transaction history |
| Manager | Views transaction history if granted `manage-finances` permission (read-only) |

---

## User Scenarios
### Scenario 1: View all transactions
The cook clicks "View all transactions" from the wallet dashboard. A paginated list shows all wallet transactions sorted by date (newest first). Each entry includes date, description, amount, and type.

### Scenario 2: Filter by type
The cook selects "Commission Deducted" from the type filter. Only commission deduction transactions are shown. They switch to "Withdrawals" to see withdrawal history.

### Scenario 3: Order payment received
A transaction shows: "Payment received for Order #ORD-1234 — +4,500 XAF — Unwithdrawable." This was the order amount after commission.

### Scenario 4: Became withdrawable
A transaction shows: "Order #ORD-1234 cleared — 4,500 XAF now withdrawable." This was triggered when the hold period expired (F-171).

### Scenario 5: Commission deducted
A transaction shows: "Commission on Order #ORD-1234 — -500 XAF — 10%." This was deducted when the order was completed (F-175).

### Scenario 6: Withdrawal
A transaction shows: "Withdrawal to MTN MoMo — -20,000 XAF — Completed."

### Scenario 7: Auto-deduction for refund
A transaction shows: "Auto-deduction for refund on Order #ORD-5678 — -3,000 XAF — Pending deduction settled."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-323 | Transaction types: order_payment_received, became_withdrawable, commission_deducted, withdrawal, auto_deduction |
| BR-324 | Default sort is by date descending (newest first) |
| BR-325 | Transactions are paginated with 20 per page (configurable) |
| BR-326 | Each transaction shows: date, description, amount, type, order reference (if applicable) |
| BR-327 | Filter by type allows: All, Order Payments, Commissions, Withdrawals, Auto-Deductions, Clearances |
| BR-328 | All amounts are in XAF format |
| BR-329 | Credit transactions (incoming) in green; debit transactions (outgoing) in red |
| BR-330 | Transaction data is tenant-scoped |
| BR-331 | Only users with `manage-finances` permission can access |
| BR-332 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `cook_wallet_transactions` table filtered by tenant
- `orders` table for order references

**Creates:**
- Nothing

**Updates:**
- Nothing

---

## Acceptance Criteria
- **Given** a cook with transactions, **when** viewing the history, **then** all transactions are listed with correct details
- **Given** the cook selects a type filter, **when** applied, **then** only matching transactions are shown
- **Given** more than 20 transactions, **when** viewing the list, **then** pagination controls are available
- **Given** a transaction with an order reference, **when** viewing the entry, **then** the order reference is displayed and clickable

---

## Verification Steps
1. Navigate to full transaction history and verify list loads
2. Verify each transaction type displays correctly
3. Apply type filters and verify filtering works
4. Verify pagination with many transactions
5. Click an order reference and verify navigation to order detail
6. Verify credit/debit color coding

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| No transactions yet | Empty state: "No transactions yet" |
| Transaction references a deleted order | Order reference shown but link may show "unavailable" |
| Very many transactions (1000+) | Pagination handles efficiently |
| All filters active with no results | "No matching transactions" with clear filter option |

---

## UI/UX Notes
- Back navigation to wallet dashboard at the top
- Type filter as pills or dropdown above the list
- Table on desktop; cards on mobile
- Amount column: green for credits (+), red for debits (-)
- Order reference as clickable link
- Transaction type shown as a subtle label or icon
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-169 | Cook Wallet Dashboard | Links to this full history |
| F-171 | Withdrawable Timer Logic | Creates "became withdrawable" transactions |
| F-173 | Flutterwave Transfer Execution | Creates "withdrawal" transactions |
| F-174 | Cook Auto-Deduction for Refunds | Creates "auto-deduction" transactions |
| F-175 | Commission Deduction on Completion | Creates "commission deducted" transactions |
