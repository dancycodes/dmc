# F-187 — Complaint Status Tracking

> Module: Complaint
> Priority: Must-have
> Precedence: F-183
> Type: functional

---

## What It Does
Provides a unified view for both the client and the cook/manager to track the progress of a complaint through its lifecycle. The complaint moves through defined states: Open, In Review (cook responded), Escalated (auto-escalated to admin), and Resolved. A visual status timeline shows the progression. Both parties can see all messages exchanged. When a complaint is resolved, the resolution details (dismiss, partial refund, full refund, warn cook) are displayed. Complaints cannot be reopened after resolution.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Views complaint status, timeline, and resolution from order detail or dedicated complaints page |
| Cook | Views complaint status, timeline, and all messages from the complaints section |
| Manager | Views complaint tracking if granted `manage-complaints` permission |
| Admin | Views full complaint detail in the admin panel during resolution |

---

## User Scenarios
### Scenario 1: Client tracks an open complaint
The client filed a complaint 6 hours ago. They navigate to the complaint from their order detail page. The status timeline shows "Open" as active, with "In Review," "Escalated," and "Resolved" as upcoming steps. The complaint details and their original message are displayed.

### Scenario 2: Client sees cook's response
The cook has responded to the complaint. The client's view now shows status "In Review" as active. The timeline updates. Below the original complaint, the cook's response message and resolution offer are visible.

### Scenario 3: Client sees escalation
The complaint was auto-escalated. The client's view shows status "Escalated" as active. A message reads "Your complaint has been escalated to our support team." All previous messages remain visible.

### Scenario 4: Both parties see resolution
The admin resolves the complaint with a partial refund of 3000 XAF. Both the client and cook see the "Resolved" status as final. Resolution details show: "Resolved by admin — Partial refund of 3,000 XAF." The refund amount is reflected in the client's wallet.

### Scenario 5: Client attempts to reopen
The complaint has been resolved. The client returns to the complaint page. There is no option to reopen or file a new complaint on the same order. A message indicates the complaint has been resolved.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-229 | Complaint states follow this sequence: Open > In Review > Escalated > Resolved |
| BR-230 | A complaint can skip "In Review" and go directly from "Open" to "Escalated" (if cook never responds) |
| BR-231 | A complaint can skip "Escalated" and go from "In Review" to "Resolved" (if admin resolves before escalation) |
| BR-232 | The status timeline visually shows all four states with the current state highlighted |
| BR-233 | Both client and cook/manager can see all complaint messages (original + responses) |
| BR-234 | Resolution details include: resolution type (dismiss, partial_refund, full_refund, warn_cook), refund amount if applicable, admin notes |
| BR-235 | Complaints cannot be reopened after resolution; status "resolved" is terminal |
| BR-236 | Timestamps are shown for each state transition (filed at, responded at, escalated at, resolved at) |
| BR-237 | All user-facing text must use `__()` localization |
| BR-238 | Complaint detail page is accessible only by the filing client, the tenant cook, authorized managers, and admins |

---

## Data Involved
**Creates:**
- Nothing (read-only view)

**Reads:**
- `complaints` table with status, timestamps, photo
- `complaint_responses` table for all messages
- Resolution details (type, amount, admin notes)
- `orders` table for order context
- `users` table for participant names

**Updates:**
- Nothing (status changes happen in F-183, F-184, F-185, and admin resolution)

**Relationships:**
- Complaint belongsTo Order
- Complaint hasMany ComplaintResponse
- Complaint belongsTo User (client)
- ComplaintResponse belongsTo User (responder)

---

## Acceptance Criteria
- **Given** an open complaint, **when** the client views it, **then** the status timeline shows "Open" as active
- **Given** a complaint with a cook response, **when** viewed, **then** status shows "In Review" and the response message is visible
- **Given** an escalated complaint, **when** viewed, **then** status shows "Escalated" with the escalation timestamp
- **Given** a resolved complaint, **when** viewed, **then** resolution details are displayed and no reopen option exists
- **Given** a complaint, **when** the client and cook both view it, **then** both see identical message history
- **Given** a user who is not the client, cook, manager, or admin, **when** they try to access the complaint, **then** they receive a 403 response

---

## Verification Steps
1. File a complaint and verify the status timeline shows "Open"
2. Have the cook respond and verify the timeline updates to "In Review"
3. Trigger auto-escalation and verify the timeline updates to "Escalated"
4. Have the admin resolve the complaint and verify the timeline shows "Resolved" with details
5. Confirm both client and cook can see all messages in chronological order
6. Confirm no reopen option is available on a resolved complaint
7. Verify timestamps are displayed for each state transition
8. Attempt to access the complaint as an unrelated user and confirm 403

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Complaint jumps from Open to Escalated (no cook response) | Timeline shows Open and Escalated highlighted; "In Review" shown as skipped |
| Admin resolves immediately after cook response (no escalation) | Timeline shows Open, In Review, Resolved; "Escalated" shown as skipped |
| Very long message thread | Scrollable message area; most recent messages at the bottom |
| Complaint resolved with "warn cook" | Client sees "Resolved — Action taken" (no details about warning); cook sees they were warned |
| Complaint photo deleted from storage | "Image no longer available" placeholder |

---

## UI/UX Notes
- Status timeline as a horizontal stepper (desktop) or vertical stepper (mobile)
- Each step shows the state name and timestamp when reached
- Active state is highlighted with primary color; completed states have checkmarks; future states are grayed
- Skipped states show a dash or are visually minimized
- Message thread below the timeline: each message shows sender name, role badge, timestamp, and text
- Resolution card at the bottom when resolved: colored banner with resolution type and details
- "View Complaint" link accessible from the order detail page
- Client also has a "My Complaints" section in their profile/settings area
- All interactions via Gale (no page reload)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-183 | Client Complaint Submission | Creates the complaint tracked here |
| F-184 | Cook/Manager Complaint Response | Updates status to "In Review" |
| F-185 | Complaint Auto-Escalation | Updates status to "Escalated" |
| F-186 | Complaint-Triggered Payment Block | Payment block visible alongside complaint status |
| F-193 | Complaint Notifications | Notifications drive users to this tracking view |
