# F-212 â€” Cancellation Window Configuration

> Module: Cook Settings
> Priority: Must-have
> Precedence: F-076
> Type: functional

---

## What It Does
Allows a cook to configure the time window (in minutes) during which clients can cancel their orders for a full refund. The default is 15 minutes. The cook can set a value between 5 and 120 minutes. This setting applies to all new orders placed on the tenant from the moment it is saved. Existing orders retain the cancellation window that was active when they were placed (snapshot at order creation). The configured cancellation window is displayed on the tenant landing page so clients know the policy before ordering. All changes to this setting are logged via Spatie Activitylog.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Configures the cancellation window duration in tenant settings |
| Manager | Can view the setting if granted "manage-orders" permission, but cannot change cook settings |
| Client | Sees the cancellation policy on the landing page and during checkout; uses the window to cancel orders |
| Admin | Can view the setting in tenant details |

---

## User Scenarios
### Scenario 1: Cook sets a custom cancellation window
The cook navigates to Settings in the dashboard, finds the "Cancellation Window" field, and changes it from the default 15 minutes to 30 minutes. A success toast confirms the change. All new orders from this point allow cancellation within 30 minutes.

### Scenario 2: Client sees the cancellation policy
A client visits `latifa.dm.test` and sees on the landing page: "Free cancellation within 30 minutes of placing your order." During checkout, the same policy is shown as a reminder.

### Scenario 3: Existing order retains old window
The cook had a 15-minute window when a client placed an order. The cook then changes to 30 minutes. The existing order still uses the 15-minute window because it was snapshotted at order creation.

### Scenario 4: Cook sets minimum value
The cook tries to set the window to 3 minutes. Validation rejects the input: "Cancellation window must be between 5 and 120 minutes."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-494 | Default cancellation window is 15 minutes |
| BR-495 | Allowed range: 5 to 120 minutes (inclusive) |
| BR-496 | Value must be a whole number (integer minutes) |
| BR-497 | Setting applies to all new orders for this tenant from the moment it is saved |
| BR-498 | Existing orders retain the cancellation window that was active when they were placed |
| BR-499 | The cancellation window value is stored as `cancellation_window_minutes` in the tenant settings |
| BR-500 | The cancellation window is snapshotted on the order record at creation time |
| BR-501 | The cancellation policy is displayed on the tenant landing page |
| BR-502 | The cancellation policy is displayed during the checkout flow |
| BR-503 | Only the cook can modify this setting (not managers) |
| BR-504 | All changes are logged via Spatie Activitylog with the old and new values |
| BR-505 | All user-facing text must use `__()` localization |
| BR-506 | Gale handles the setting form interaction without page reloads |

---

## Data Involved
**Creates:**
- Activity log entry for setting changes

**Reads:**
- Current tenant's `cancellation_window_minutes` setting
- Tenant settings for landing page display

**Updates:**
- Tenant `settings` JSON column (`cancellation_window_minutes` key)

**Relationships:**
- Tenant hasMany Orders (each order snapshots the window at creation)
- Setting is read during order creation (F-148) and order cancellation (F-158)

---

## Acceptance Criteria
- **Given** a new tenant, **when** viewing the cancellation window setting, **then** the default value is 15 minutes
- **Given** a cook, **when** they set the window to 30 minutes, **then** new orders allow 30-minute cancellation
- **Given** a value below 5, **when** submitted, **then** validation rejects with a range error
- **Given** a value above 120, **when** submitted, **then** validation rejects with a range error
- **Given** an order placed with a 15-minute window, **when** the cook changes to 30, **then** the existing order still uses 15 minutes
- **Given** the landing page, **when** a client visits, **then** the cancellation window is displayed
- **Given** a setting change, **when** checked in the activity log, **then** the old and new values are recorded

---

## Verification Steps
1. Create a new tenant -- confirm default cancellation window is 15 minutes
2. Change to 45 minutes -- confirm success toast and persisted value
3. Attempt to set to 2 minutes -- confirm validation error
4. Attempt to set to 150 minutes -- confirm validation error
5. Attempt to set a decimal (10.5) -- confirm validation error
6. Place an order, then change the window -- confirm the order retains the original value
7. Visit the tenant landing page -- confirm cancellation policy is displayed
8. Check activity log for the setting change entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Non-numeric input | Validation rejects: "Cancellation window must be a number" |
| Negative number | Validation rejects: "Cancellation window must be between 5 and 120 minutes" |
| Setting changed during an active checkout | Orders placed after the save use the new value |
| Tenant settings JSON missing the key | Default of 15 minutes is used |
| Cook sets 5 minutes (minimum) | Allowed; clients have a very short cancellation window |
| Cook sets 120 minutes (maximum) | Allowed; clients have 2 hours to cancel |

---

## UI/UX Notes
- Located in the Cook Dashboard > Settings section
- Input field: number input with stepper controls (+ / -)
- Label: "Cancellation Window"
- Helper text: "How long after placing an order can a client cancel for a full refund?"
- Unit displayed next to the input: "minutes"
- Save happens on blur or explicit save button (follow existing settings pattern)
- Landing page display: a small info badge or text in the ordering section, e.g., "Free cancellation within X minutes"
- Checkout reminder: a note near the order confirmation step
- Mobile: full-width input with clear labels

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-076 | Cook Dashboard Layout & Navigation | Dashboard where settings live |
| F-148 | Order Creation | Snapshots the cancellation window onto the order |
| F-158 | Order Cancellation by Client | Uses the snapshotted window to determine eligibility |
| F-126 | Tenant Landing Page Layout | Displays the cancellation policy |
