# F-174 — Cook Auto-Deduction for Refunds

> Module: Wallet
> Priority: Must-have
> Precedence: F-169
> Type: functional

---

## What It Does
Handles the scenario where a refund is issued to a client after the cook has already withdrawn the funds for that order. Since the money has already left the platform, the system records a deduction against the cook's future earnings. When new order payments arrive for the cook, the owed amount is automatically deducted until the debt is fully settled. The cook sees "Pending deduction" in their wallet with full transparency of the outstanding amount and how it is being settled.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Automatically deducts from future earnings to cover the owed refund |
| Cook | Sees pending deduction balance and deduction transactions in wallet |
| Admin | Can view pending deductions for any cook |

---

## User Scenarios
### Scenario 1: Post-withdrawal refund creates a deduction
A complaint is resolved with a 5,000 XAF refund for an order whose payment was already withdrawn by the cook. The system creates a "pending deduction" of 5,000 XAF against the cook's wallet. The cook sees in their wallet: "Pending Deduction: 5,000 XAF."

### Scenario 2: Automatic deduction from next order
The cook has a 5,000 XAF pending deduction. A new order is completed for 8,000 XAF (after commission). Instead of receiving 8,000 XAF, the cook receives 3,000 XAF (8,000 - 5,000 deduction). A transaction shows: "Auto-deduction for refund on Order #ORD-1234 — -5,000 XAF." The pending deduction is now 0 XAF.

### Scenario 3: Partial deduction
The cook has a 5,000 XAF pending deduction. A new order payment is 3,000 XAF. The system deducts 3,000 XAF, reducing the pending deduction to 2,000 XAF. The cook receives 0 XAF from this order. A transaction shows the partial deduction. The remaining 2,000 XAF carries forward.

### Scenario 4: Multiple pending deductions
The cook has two pending deductions: 3,000 XAF and 2,000 XAF. New earnings are applied to the oldest deduction first (FIFO). The total pending deduction shows 5,000 XAF in the wallet.

### Scenario 5: Cook views deduction details
The cook navigates to their wallet and sees a "Pending Deductions" section showing the total owed amount, original orders that caused the deductions, and the settlement history.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-366 | When a refund is issued after the cook has withdrawn the order's payment, a pending deduction is created |
| BR-367 | Pending deductions are automatically applied against future order earnings |
| BR-368 | Deductions are applied from new order payments before the payment enters the cook's wallet |
| BR-369 | If a new order payment is less than the pending deduction, the full payment is deducted (partial settlement) |
| BR-370 | If a new order payment exceeds the pending deduction, only the owed amount is deducted; the remainder goes to the cook |
| BR-371 | Multiple deductions are settled in FIFO order (oldest first) |
| BR-372 | The cook's wallet shows the total pending deduction amount |
| BR-373 | Each deduction creates a wallet transaction (type: auto_deduction) |
| BR-374 | The deduction references the original order and refund reason |
| BR-375 | Deduction processing is transparent: cook can see every deduction and its settlement |
| BR-376 | Deductions are logged via Spatie Activitylog |

---

## Data Involved
**Reads:**
- `pending_deductions` table for outstanding amounts
- New order payment amounts for deduction application
- Original refund and order data for references

**Creates:**
- `pending_deductions` record (amount, order_reference, reason, created_at)
- Wallet transaction records for each auto-deduction
- Activity log entries

**Updates:**
- `pending_deductions.remaining_amount` decreased as deductions are applied
- `pending_deductions.settled_at` when fully settled
- `cook_wallets` balance adjusted for each new order payment (after deduction)

**Relationships:**
- PendingDeduction belongsTo CookWallet
- PendingDeduction references the original Order
- Auto-deductions appear in CookWalletTransactions

---

## Acceptance Criteria
- **Given** a refund is issued after withdrawal, **when** the refund processes, **then** a pending deduction is created
- **Given** a pending deduction exists, **when** a new order payment arrives, **then** the deduction is automatically applied
- **Given** the new payment exceeds the deduction, **when** deducting, **then** only the owed amount is taken and the remainder goes to the cook
- **Given** the new payment is less than the deduction, **when** deducting, **then** the full payment is taken and the remaining deduction carries forward
- **Given** multiple deductions exist, **when** a payment arrives, **then** the oldest deduction is settled first
- **Given** a deduction is fully settled, **when** checking the wallet, **then** the pending deduction amount decreases to 0

---

## Verification Steps
1. Trigger a post-withdrawal refund and verify a pending deduction is created
2. Complete a new order and verify the deduction is automatically applied
3. Verify partial deduction when the new payment is less than the owed amount
4. Verify the wallet transaction record for the auto-deduction
5. Verify FIFO order for multiple deductions
6. Verify the cook can see the pending deduction amount in their wallet
7. Verify the deduction is fully settled after enough payments
8. Check the activity log for deduction entries

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Cook has no future orders (inactive) | Deduction remains pending indefinitely; admin can view |
| Deduction amount exceeds several orders | Applied across multiple orders until settled |
| Cook withdraws while deduction is pending | Withdrawal is from withdrawable balance; deduction is separate |
| Refund reversal by admin | Pending deduction can be cancelled by admin if the refund was erroneous |
| Cook has both pending deduction and new orders from multiple tenants | Deductions apply to the specific tenant's cook wallet where the deduction originated |
| Deduction created for exactly 0 XAF | No deduction created; edge case handled silently |

---

## UI/UX Notes
- "Pending Deductions" section visible on the cook wallet dashboard (F-169) when deductions exist
- Shows: total pending amount, list of individual deductions with original order references
- Each deduction entry: order reference, original amount, remaining amount, settlement progress
- Settlement history expandable per deduction
- Clearly labeled as "This amount will be deducted from your future earnings"
- No action required from the cook; deductions are automatic
- All amounts in XAF format

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-169 | Cook Wallet Dashboard | Shows pending deduction amount |
| F-170 | Cook Wallet Transaction History | Shows auto-deduction transactions |
| F-061 | Admin Complaint Resolution | Can trigger post-withdrawal refunds |
| F-163 | Order Cancellation Refund Processing | Can trigger deductions if cook already withdrew |
| F-175 | Commission Deduction on Completion | Commission is separate from refund deductions |
