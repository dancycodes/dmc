# F-157 â€” Single Order Status Update

> Module: Order Mgmt
> Priority: Must-have
> Precedence: F-156
> Type: functional

---

## What It Does
Allows the cook or manager to advance a single order to the next valid status in the order lifecycle. The status update button on the order detail page shows the next available status based on the current state and delivery/pickup type. Before updating, a confirmation dialog is shown for irreversible transitions. The status change is validated server-side (see F-159), triggers notifications to the client, is logged in the activity log, and updates the status timeline. For delivery orders, the flow goes through "Out for Delivery" and "Delivered"; for pickup orders, through "Ready for Pickup" and "Picked Up."

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Updates order status from the order detail page |
| Manager | Updates order status if granted `manage-orders` permission |

---

## User Scenarios
### Scenario 1: Confirm a paid order
A new order has been paid (status: Paid). The cook views the order detail and clicks "Confirm Order." A confirmation dialog appears: "Confirm this order? The client will be notified." The cook confirms. The status updates to Confirmed, the timeline reflects the change, and the client receives a notification.

### Scenario 2: Mark as Preparing
The cook clicks "Start Preparing" on a Confirmed order. No confirmation dialog for this transition (reversible in practice). Status updates to Preparing. Client notified.

### Scenario 3: Mark as Ready
The cook clicks "Mark as Ready" on a Preparing order. Status updates to Ready. Client is notified that their order is ready.

### Scenario 4: Mark delivery order as Out for Delivery
The cook clicks "Out for Delivery" on a Ready delivery order. Status updates. Client notified with delivery tracking info.

### Scenario 5: Mark pickup order as Ready for Pickup
The cook clicks "Ready for Pickup" on a Ready pickup order. Status updates. Client notified to come pick up their order.

### Scenario 6: Mark as Delivered / Picked Up
The cook confirms delivery or pickup. Status updates to Delivered or Picked Up. Client notified.

### Scenario 7: Mark as Completed
The cook clicks "Mark as Completed" on a Delivered/Picked Up order. Confirmation dialog: "Completing this order will start the payment clearance timer. Continue?" Status updates to Completed. Commission deduction triggers (F-175). Withdrawable timer starts (F-171).

### Scenario 8: Invalid transition attempt
A malicious request attempts to skip from Paid directly to Ready. The server validates the transition (F-159) and rejects it with an error message.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-178 | The status update button shows only the next valid status for the current order state |
| BR-179 | For delivery orders: Ready transitions to "Out for Delivery," then "Delivered" |
| BR-180 | For pickup orders: Ready transitions to "Ready for Pickup," then "Picked Up" |
| BR-181 | Confirmation dialog is required for: Confirmed, Completed, and Cancelled transitions |
| BR-182 | All status transitions are validated server-side via F-159 rules |
| BR-183 | Each status change triggers a notification to the client (push + DB) |
| BR-184 | Each status change is logged via Spatie Activitylog with the user who triggered it |
| BR-185 | The status timeline on the order detail page updates immediately after a successful transition |
| BR-186 | Completing an order triggers commission deduction (F-175) and withdrawable timer (F-171) |
| BR-187 | Only users with `manage-orders` permission can update order status |
| BR-188 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `orders` table for current status and delivery/pickup type
- F-159 transition rules for validation

**Creates:**
- Status transition record (timestamp, previous status, new status, triggered_by user)
- Activity log entry
- Client notification (push + DB)

**Updates:**
- `orders.status` to the new status
- `orders.confirmed_at`, `orders.completed_at`, etc. timestamp fields as applicable

**Relationships:**
- Order belongsTo Tenant
- StatusTransition belongsTo Order
- Notification sent to Order's client User

---

## Acceptance Criteria
- **Given** a Paid order, **when** the cook clicks "Confirm Order" and confirms, **then** the status updates to Confirmed and the client is notified
- **Given** a Confirmed order, **when** the cook clicks "Start Preparing," **then** the status updates to Preparing
- **Given** a delivery order at Ready status, **when** the cook clicks next status, **then** the button shows "Out for Delivery"
- **Given** a pickup order at Ready status, **when** the cook clicks next status, **then** the button shows "Ready for Pickup"
- **Given** an invalid transition attempt, **when** submitted, **then** the server rejects with a validation error
- **Given** any successful status update, **when** checking the timeline, **then** the new transition appears with timestamp and user

---

## Verification Steps
1. Update a Paid order to Confirmed and verify status change and notification
2. Walk through the full delivery flow: Confirmed > Preparing > Ready > Out for Delivery > Delivered > Completed
3. Walk through the full pickup flow: Confirmed > Preparing > Ready > Ready for Pickup > Picked Up > Completed
4. Verify confirmation dialogs appear for Confirmed and Completed transitions
5. Verify the status timeline updates after each transition
6. Verify the client receives a notification for each status change
7. Check the activity log for each transition entry
8. Attempt an invalid transition via API and verify rejection

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Two cooks/managers try to update the same order simultaneously | First update succeeds; second sees a conflict error and refreshed status |
| Order has an active complaint | Status can still be updated; complaint does not block status changes |
| Cook updates status while client is viewing the order | Client's view updates in real-time via Gale SSE |
| Network failure during status update | Error toast shown; status remains unchanged; cook can retry |
| Order is already in the target status (duplicate request) | No-op; return current status without error |

---

## UI/UX Notes
- Status update button is a prominent primary-colored CTA on the order detail page
- Button label dynamically reflects the next status (e.g., "Confirm Order", "Start Preparing", "Mark as Ready")
- Confirmation dialog is a modal with clear messaging about the consequence
- Loading state on the button while the update processes
- Success toast after update: "Order status updated to {status}"
- Timeline refreshes smoothly via Gale after update
- Button hidden for terminal states (Completed, Cancelled, Refunded)
- Mobile: button is sticky at the bottom of the screen
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-156 | Cook Order Detail View | Status update button lives on this page |
| F-158 | Mass Order Status Update | Bulk version of this feature |
| F-159 | Order Status Transition Validation | Validates all transitions |
| F-171 | Withdrawable Timer Logic | Timer starts on Completed status |
| F-175 | Commission Deduction on Completion | Commission deducted on Completed status |
| F-192 | Order Status Update Notifications | Notifications triggered by status changes |
