# F-158 — Mass Order Status Update

> Module: Order Mgmt
> Priority: Must-have
> Precedence: F-155
> Type: functional

---

## What It Does
Allows the cook or manager to select multiple orders from the order list (F-155) and advance them all to the next status in a single bulk action. Only orders at the same current status can be bulk-updated together. A confirmation dialog shows the number of selected orders and the target status. Each order is validated individually against transition rules (F-159). Successes and failures are reported per-order so the cook knows exactly which orders were updated and which failed.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Selects multiple orders and applies a bulk status update |
| Manager | Performs bulk updates if granted `manage-orders` permission |

---

## User Scenarios
### Scenario 1: Bulk confirm paid orders
The cook filters orders by "Paid" status. They select 5 orders using checkboxes and click "Confirm Selected." A confirmation dialog shows: "Confirm 5 orders? They will move to Confirmed status." The cook confirms. All 5 orders update successfully. A success toast shows "5 orders confirmed."

### Scenario 2: Mixed statuses selected
The cook selects 3 orders: 2 are Paid and 1 is Preparing. The bulk action button is disabled with a tooltip: "Selected orders must be at the same status." The cook deselects the Preparing order, and the button becomes active.

### Scenario 3: Partial failure
The cook selects 4 Confirmed orders and clicks "Start Preparing." 3 succeed, but 1 fails because it was cancelled by the client just before the bulk update. A result dialog shows: "3 orders updated to Preparing. 1 failed:" with the reason for the failed order.

### Scenario 4: Select all on page
The cook clicks the "Select All" checkbox in the table header. All orders on the current page are selected. The mass action toolbar shows the count and available action.

### Scenario 5: Bulk mark as ready
The cook filters by "Preparing" status, selects all, and clicks "Mark as Ready." All selected orders are updated. Clients receive individual notifications.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-189 | Only orders at the same current status can be bulk-updated together |
| BR-190 | The bulk action button is disabled if selected orders have mixed statuses |
| BR-191 | Each order is validated individually against F-159 transition rules |
| BR-192 | Failed orders do not prevent successful orders from being updated |
| BR-193 | Results are reported per-order: success count and individual failure reasons |
| BR-194 | Each successful status change triggers a client notification (same as single update) |
| BR-195 | Each status change is logged individually via Spatie Activitylog |
| BR-196 | A confirmation dialog is shown before executing the bulk action |
| BR-197 | Only users with `manage-orders` permission can perform mass updates |
| BR-198 | Mass completion triggers commission deduction and withdrawable timer for each order individually |
| BR-199 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- Selected order IDs and their current statuses
- F-159 transition rules for validation

**Creates:**
- Status transition records for each successfully updated order
- Activity log entries for each update
- Client notifications for each updated order

**Updates:**
- `orders.status` for each successfully updated order
- Relevant timestamp fields per order

---

## Acceptance Criteria
- **Given** multiple orders selected at the same status, **when** the cook clicks the bulk action, **then** a confirmation dialog shows order count and target status
- **Given** orders at mixed statuses selected, **when** the cook attempts bulk action, **then** the button is disabled with an explanatory tooltip
- **Given** a bulk action is confirmed, **when** all orders are valid, **then** all update successfully with a success message
- **Given** a bulk action is confirmed, **when** some orders fail validation, **then** successes proceed and failures are listed individually
- **Given** successful bulk update, **when** checking notifications, **then** each client received an individual notification
- **Given** successful bulk update, **when** checking the activity log, **then** each update is logged individually

---

## Verification Steps
1. Select multiple Paid orders and bulk confirm them — verify all update
2. Select orders with mixed statuses and verify the bulk action button is disabled
3. Trigger a partial failure scenario and verify the result dialog lists successes and failures separately
4. Use "Select All" and verify all page orders are selected
5. Bulk update and verify each client receives a notification
6. Check the activity log for individual entries per order
7. Bulk complete orders and verify commission and timer triggers for each

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| One selected order is cancelled during processing | That order fails; others succeed; failure reason shown |
| All selected orders fail | Error dialog with all failure reasons; no orders updated |
| Very large selection (50+ orders) | Processing indicator shown; updates happen in batches server-side |
| Cook deselects all orders | Mass action toolbar hides; no action available |
| Network failure during bulk update | Partial results may occur; refresh shows actual states |
| Two users bulk-update overlapping orders simultaneously | Each order's first update wins; second sees conflict for those orders |

---

## UI/UX Notes
- Mass action toolbar appears above the table when at least one order is selected
- Toolbar shows: selected count, current status of selected orders, action button
- Action button label: "Move {N} orders to {NextStatus}"
- If mixed statuses: button disabled with tooltip explaining the constraint
- Confirmation dialog: modal with order count, current status, target status
- Result dialog: shows success count with checkmark, failed orders with red X and reason
- Loading state during bulk processing
- After successful bulk update, the table refreshes to reflect new statuses
- Mobile: mass action toolbar is sticky at bottom
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-155 | Cook Order List View | Provides the checkboxes and order selection |
| F-157 | Single Order Status Update | Single-order version of this feature |
| F-159 | Order Status Transition Validation | Validates each order individually |
| F-175 | Commission Deduction on Completion | Triggered per-order on bulk Completed |
| F-171 | Withdrawable Timer Logic | Timer starts per-order on bulk Completed |
