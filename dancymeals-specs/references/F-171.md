# F-171 — Withdrawable Timer Logic

> Module: Wallet
> Priority: Must-have
> Precedence: F-169
> Type: functional

---

## What It Does
Manages the time-based transition of cook wallet funds from unwithdrawable to withdrawable. When an order is marked as Completed, the payment amount (after commission deduction) is held as unwithdrawable for a configurable period (default 3 hours). After the hold period expires, a scheduled job transitions the funds to withdrawable. The cook is notified when funds become available. The timer is paused if an active complaint is filed against the order during the hold period.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Scheduled job checks and transitions funds automatically |
| Cook | Receives notification when funds become withdrawable |
| Admin | Configures the hold period duration via platform settings |

---

## User Scenarios
### Scenario 1: Standard clearance
An order is completed at 2:00 PM. The hold period is 3 hours. At 5:00 PM, the scheduled job runs, detects this order's hold has expired, and transitions 4,500 XAF from unwithdrawable to withdrawable. The cook receives a notification: "4,500 XAF from Order #ORD-1234 is now withdrawable."

### Scenario 2: Complaint filed during hold
An order is completed at 2:00 PM with a 3-hour hold. At 3:00 PM, the client files a complaint. The timer pauses at 1 hour remaining. The complaint is resolved at 6:00 PM (no refund). The timer resumes — funds become withdrawable at 7:00 PM (1 hour remaining after resume).

### Scenario 3: Complaint resolved with refund during hold
An order is completed. A complaint is filed and resolved with a refund during the hold period. The funds are decremented from unwithdrawable (never become withdrawable for this order).

### Scenario 4: Multiple orders clearing simultaneously
Three orders complete within minutes of each other. The scheduled job processes all three when their hold periods expire. The cook receives one consolidated notification: "13,500 XAF from 3 orders is now withdrawable."

### Scenario 5: Admin changes hold period
The admin changes the hold period from 3 hours to 6 hours. Orders completed after the change use the new 6-hour hold. Orders already in hold continue with their original 3-hour period.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-333 | Hold period starts when order status changes to Completed |
| BR-334 | Default hold period is 3 hours, configurable by admin via platform settings |
| BR-335 | After hold period expires, funds transition from unwithdrawable to withdrawable |
| BR-336 | A scheduled job runs periodically (every 5 minutes) to check and transition eligible funds |
| BR-337 | Cook is notified (push + DB) when funds become withdrawable |
| BR-338 | The timer pauses if a complaint is filed on the order during the hold period |
| BR-339 | The timer resumes when the complaint is resolved (if no refund was issued) |
| BR-340 | If the complaint results in a refund, the funds are removed from unwithdrawable (never become withdrawable) |
| BR-341 | Changes to the hold period setting apply only to orders completed after the change |
| BR-342 | A wallet transaction record is created when funds become withdrawable (type: became_withdrawable) |
| BR-343 | Transition is logged via Spatie Activitylog |

---

## Data Involved
**Reads:**
- `orders` table for `completed_at` timestamp and complaint status
- `cook_wallets` table for unwithdrawable and withdrawable amounts
- Platform settings for hold period duration
- Complaint records to check for active complaints on each order

**Creates:**
- Wallet transaction record (type: became_withdrawable)
- Notification to cook (push + DB)
- Activity log entry

**Updates:**
- `cook_wallets.unwithdrawable_amount` decremented
- `cook_wallets.withdrawable_amount` incremented
- Order clearance tracking record (e.g., `order_clearances.cleared_at`)

**Relationships:**
- Clearance record belongsTo Order
- CookWallet belongsTo Tenant
- Complaint pauses the timer for the related order

---

## Acceptance Criteria
- **Given** an order completed 3+ hours ago with no complaint, **when** the scheduled job runs, **then** the funds transition to withdrawable
- **Given** an order completed less than 3 hours ago, **when** the scheduled job runs, **then** the funds remain unwithdrawable
- **Given** an order with an active complaint during hold, **when** the scheduled job runs, **then** the funds remain unwithdrawable (timer paused)
- **Given** a complaint is resolved with no refund, **when** the remaining hold time expires, **then** the funds become withdrawable
- **Given** funds become withdrawable, **when** the cook checks their wallet, **then** the withdrawable balance has increased
- **Given** funds become withdrawable, **when** checking notifications, **then** the cook received a notification

---

## Verification Steps
1. Complete an order and wait for the hold period to expire
2. Run the scheduled job and verify funds transition to withdrawable
3. Verify the cook's wallet reflects the updated amounts
4. Verify the cook received a notification
5. File a complaint during the hold period and verify the timer pauses
6. Resolve the complaint (no refund) and verify the timer resumes
7. Resolve a complaint with a refund and verify funds are removed from unwithdrawable
8. Change the hold period setting and verify new orders use the new period

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Scheduled job fails to run | Next run catches up; funds transition when job resumes |
| Order completed exactly at hold period boundary | Strict comparison: cleared when elapsed >= hold_period |
| Multiple complaints on the same order | Timer remains paused until all complaints are resolved |
| Complaint filed after hold period already expired | No effect; funds already withdrawable |
| Hold period set to 0 hours | Funds become withdrawable immediately on completion |
| Server time zone differences | Use UTC consistently for all timestamp comparisons |

---

## UI/UX Notes
- No dedicated UI for this feature; it runs as a background scheduled job
- Effects visible on:
  - Cook wallet dashboard (F-169): withdrawable amount increases
  - Cook wallet transactions (F-170): "became withdrawable" entry appears
  - Notifications: cook receives push notification
- Admin configures the hold period in platform settings (F-063)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-169 | Cook Wallet Dashboard | Displays withdrawable and unwithdrawable amounts |
| F-170 | Cook Wallet Transaction History | Shows "became withdrawable" transactions |
| F-172 | Cook Withdrawal Request | Can withdraw once funds are withdrawable |
| F-175 | Commission Deduction on Completion | Commission deducted before hold period starts |
| F-183 | Client Complaint Submission | Complaint pauses the timer |
| F-063 | Platform Settings Management | Admin configures the hold period |
