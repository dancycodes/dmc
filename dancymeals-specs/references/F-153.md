# F-153 â€” Wallet Balance Payment

> Module: Payment
> Priority: Must-have
> Precedence: F-149, F-166
> Type: functional

---

## What It Does
Allows a client to pay for an order using their wallet balance. The wallet typically contains funds from previous refunds. Wallet payment is only available when two conditions are met: the admin has enabled wallet payments globally, and the client's wallet balance is greater than or equal to the order total. When used, the order total is deducted from the wallet balance instantly. No external payment gateway is involved. The transaction is recorded and the order immediately moves to "Paid" status.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Pays for their order using available wallet balance |
| Admin | Enables or disables wallet payments globally |

---

## User Scenarios
### Scenario 1: Successful wallet payment
The client has 10,000 XAF in their wallet. The order total is 6,500 XAF. They select "Wallet Balance" and click "Pay Now." 6,500 XAF is deducted immediately. Remaining balance: 3,500 XAF. The order status changes to "Paid" and the confirmation page (F-154) is shown.

### Scenario 2: Wallet balance exactly matches order
The client has 5,000 XAF and the order is 5,000 XAF. They pay with wallet. Balance becomes 0 XAF. Order is paid.

### Scenario 3: Admin has disabled wallet payments
The admin has turned off wallet payments. The wallet payment option does not appear on the payment method selection page, regardless of the client's balance.

### Scenario 4: Insufficient wallet balance
The client has 2,000 XAF but the order is 6,500 XAF. The wallet option is visible but disabled with "Insufficient balance (2,000 XAF available)."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-387 | Wallet payment is available only when admin has enabled it globally |
| BR-388 | Wallet balance must be >= order total for the option to be selectable |
| BR-389 | On wallet payment: deduct order total from wallet balance |
| BR-390 | Wallet deduction is instant; no external payment gateway involved |
| BR-391 | Order status immediately changes to "Paid" on wallet payment |
| BR-392 | A wallet transaction record is created (type: "payment", amount: negative) |
| BR-393 | Cook's wallet is credited with (order amount - commission), same as Flutterwave flow |
| BR-394 | Commission is calculated and recorded identically to Flutterwave payments |
| BR-395 | Wallet payment is logged via Spatie Activitylog |
| BR-396 | Partial wallet payment (wallet + mobile money for remainder) is NOT supported |
| BR-397 | All text must be localized via `__()` |

---

## Data Involved
**Reads:**
- Client wallet balance
- Admin setting: wallet payments enabled
- Order total

**Creates:**
- Wallet transaction record (deduction)
- Cook wallet credit transaction
- Commission transaction record
- Order payment record
- Activity log entry

**Updates:**
- Client wallet balance (decreased)
- Cook wallet balance (increased, unwithdrawable)
- Order status to "Paid"

**Relationships:**
- Follows F-149 (Payment Method Selection)
- Uses wallet data from F-166 (Client Wallet)
- Leads to F-154 (Payment Receipt & Confirmation)
- Commission logic shared with F-151 (Payment Webhook Handling)

---

## Acceptance Criteria
- **Given** wallet enabled and balance >= total, **when** client selects wallet and clicks "Pay Now", **then** wallet is deducted and order is "Paid"
- **Given** wallet balance is 10,000 XAF and order is 6,500 XAF, **when** payment processes, **then** remaining balance is 3,500 XAF
- **Given** wallet disabled by admin, **when** viewing payment options, **then** wallet option is not shown
- **Given** wallet balance < order total, **when** viewing payment options, **then** wallet option is disabled
- **Given** wallet payment succeeds, **when** checking cook wallet, **then** cook is credited with (order total - commission)
- **Given** wallet payment, **when** checking transactions, **then** a deduction transaction is recorded

---

## Verification Steps
1. Enable wallet payments as admin; load a client's wallet with sufficient funds
2. Select wallet payment and click "Pay Now"; verify instant order status change to "Paid"
3. Verify client wallet balance decreased by the order amount
4. Verify cook wallet credited with correct amount (minus commission)
5. Verify commission transaction recorded
6. Disable wallet payments as admin; verify option disappears
7. Test with insufficient balance; verify option is disabled
8. Verify activity log records the wallet payment

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Concurrent wallet payments deplete balance | Race condition handled with database locking; second payment fails if balance insufficient |
| Client has exactly 0 XAF in wallet | Wallet option disabled |
| Wallet payment and Flutterwave payment initiated simultaneously | Should not be possible; payment method selection is exclusive |
| Admin disables wallet after client selects but before clicking "Pay Now" | Payment fails with message; client must select another method |
| Refund to wallet after wallet payment | Balance increases; can be used for next order |

---

## UI/UX Notes
- Wallet payment confirmation is instant: no waiting state needed
- Success: immediate redirect to F-154 (Payment Receipt & Confirmation)
- Wallet balance shown clearly before and after payment
- "Pay with Wallet Balance" button styled distinctly from mobile money options
- Confirmation dialog before deduction: "Pay 6,500 XAF from your wallet? Remaining balance: 3,500 XAF"

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-149 | Payment Method Selection | Previous step |
| F-166 | Client Wallet | Source of wallet balance |
| F-154 | Payment Receipt & Confirmation | Shown after successful payment |
| F-151 | Payment Webhook Handling | Shares commission calculation logic |
