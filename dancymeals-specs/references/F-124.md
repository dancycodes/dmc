# F-124 — Meal Component Quantity Settings

> Module: Meal Component
> Priority: Must-have
> Precedence: F-118
> Type: functional

---

## What It Does
Configures the quantity constraints for a meal component: minimum order quantity (the fewest units a client must order of this component), maximum order quantity (the most units a client can order in a single order), and currently available quantity (the total stock available). When available quantity reaches 0, the component automatically toggles to unavailable. Available quantity decrements on order placement. These settings are managed via the component edit interface, which can also be accessed from the component list. Managed via Gale.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Configures quantity limits and stock for each component |
| Manager | Configures quantities if granted `manage-meals` permission |
| Client | Experiences min/max constraints during ordering |

---

## User Scenarios
### Scenario 1: Default quantities (no limits)
The cook creates a component with defaults: min 0, max unlimited, available unlimited. Clients can order any quantity.

### Scenario 2: Set minimum order quantity
The cook sets min quantity to 2 for "Party Pack." Clients must order at least 2 units. Ordering 1 shows: "Minimum order is 2."

### Scenario 3: Set maximum order quantity
The cook sets max quantity to 5 for "Special Plate." Clients cannot order more than 5 per order. Ordering 6 shows: "Maximum order is 5."

### Scenario 4: Set available quantity
The cook sets available quantity to 20 for "Jollof Rice plate." After 20 plates are ordered, the component auto-toggles to unavailable.

### Scenario 5: Available quantity reaches 0
The 20th plate is ordered. The system decrements available quantity to 0 and automatically sets `is_available = false`. The component shows "Sold Out."

### Scenario 6: Cook replenishes stock
The cook updates available quantity from 0 to 30 and re-enables availability. Clients can order again.

### Scenario 7: Client exceeds available quantity
A client tries to order 5 plates but only 3 are available. Validation: "Only 3 available."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-334 | Minimum quantity default is 0 (no minimum enforced — but 0 means the component is optional in the order) |
| BR-335 | Maximum quantity default is null (unlimited) |
| BR-336 | Available quantity default is null (unlimited) |
| BR-337 | When available quantity reaches 0, the component auto-toggles to is_available = false |
| BR-338 | Available quantity decrements on successful order placement (not on cart add, but on payment confirmation) |
| BR-339 | Minimum quantity must be >= 0 |
| BR-340 | Maximum quantity must be >= minimum quantity (when both are set) |
| BR-341 | Available quantity must be >= 0 |
| BR-342 | A client cannot order more than the available quantity |
| BR-343 | A client must order at least the minimum quantity if they include the component |
| BR-344 | A client cannot order more than the maximum quantity per order |
| BR-345 | Quantity changes take immediate effect for new orders |
| BR-346 | Only users with `manage-meals` permission can configure quantities |
| BR-347 | Quantity changes are logged via Spatie Activitylog |

---

## Data Involved
**Creates:**
- Nothing (uses existing fields on MealComponent from F-118)

**Reads:**
- MealComponent record for current values

**Updates:**
- MealComponent `min_quantity`, `max_quantity`, `available_quantity`, and `is_available` fields

**Relationships:**
- MealComponent has order line items that decrement available quantity

---

## Acceptance Criteria
- **Given** a component with min 2, **when** a client orders 1, **then** validation fails
- **Given** a component with max 5, **when** a client orders 6, **then** validation fails
- **Given** a component with available qty 3, **when** a client orders 4, **then** validation fails
- **Given** a component with available qty 1, **when** the order is confirmed, **then** available qty decrements to 0 and auto-toggles unavailable
- **Given** available qty is null (unlimited), **when** ordering any quantity, **then** no stock constraint applies
- **Given** the cook sets min = 5 and max = 3, **when** submitted, **then** validation fails

---

## Verification Steps
1. Set min quantity and verify ordering below it is rejected
2. Set max quantity and verify ordering above it is rejected
3. Set available quantity and place orders until it reaches 0 — confirm auto-unavailable
4. Reset available quantity and re-enable — confirm clients can order again
5. Set invalid min > max — confirm validation error
6. Order with unlimited max/available — confirm no constraints
7. Check activity log for quantity setting changes
8. Verify quantity decrement on order placement

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Available quantity set to 0 manually | Auto-toggles to unavailable immediately |
| Min quantity = 0 and component is optional | Client can include 0 or more of this component (it is not required) |
| Min quantity > 0 | If client adds this component, they must order at least min — but they can still skip the component entirely |
| Concurrent orders depleting stock | Last order validated against current stock; potential overselling handled at database level |
| Order cancelled — stock increment | Available quantity incremented back on cancellation (if cancellation feature supports it) |
| Available quantity negative (edge case) | System treats as 0; auto-unavailable |

---

## UI/UX Notes
- Quantity fields in the component edit form (F-119) or a dedicated section
- Fields: Min Quantity (default "No minimum"), Max Quantity (default "Unlimited"), Available Quantity (default "Unlimited")
- Clear labels explaining each field's purpose
- Real-time validation feedback
- Stock indicator on the component list showing available count or "Unlimited"
- Warning indicator when stock is low (e.g., under 5 remaining)
- During ordering: client sees available stock if limited
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-118 | Meal Component Creation | Defines the quantity fields |
| F-119 | Meal Component Edit | Quantity settings are part of component edit |
| F-123 | Meal Component Availability Toggle | Auto-toggled when stock depletes |
| F-125 | Meal Component List View | Shows quantity info per component |
| F-138 | Meal Component Selection & Cart Add | Enforces quantity constraints during ordering |
