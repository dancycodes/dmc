# F-217 â€” Cook Promo Code Deactivation

> Module: Promo
> Priority: Should-have
> Precedence: F-215
> Type: functional

---

## What It Does
Allows a cook to activate or deactivate promo codes for their tenant. Deactivated codes cannot be applied at checkout even if they are within their valid date range. The cook sees a comprehensive list of all promo codes with their status (active, inactive, or expired), usage count, and date range. The cook can toggle individual codes between active and inactive states. Bulk deactivation is supported for managing multiple codes at once. All activation and deactivation actions are logged via Spatie Activitylog.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Activates, deactivates, and bulk-deactivates promo codes; views the promo code list |
| Manager | Cannot manage promo code status (cook-reserved action) |
| Client | Affected when a code they try to use has been deactivated |
| Admin | Can view promo code statuses in admin tenant details |

---

## User Scenarios
### Scenario 1: Cook deactivates a promo code
The cook views the promo list and clicks the toggle for "WELCOME10" to switch it from active to inactive. A toast confirms: "WELCOME10 deactivated." Clients can no longer use this code at checkout.

### Scenario 2: Cook reactivates a promo code
The cook toggles "WELCOME10" back to active. Clients can now use it again (assuming it meets all other validation criteria).

### Scenario 3: Cook views expired codes
The promo list shows "LAUNCH500" with status "Expired" because its end date has passed. The expired status is computed, not toggled. The cook cannot reactivate an expired code without extending the end date first (via F-216).

### Scenario 4: Bulk deactivation
The cook selects multiple promo codes using checkboxes and clicks "Deactivate Selected." All selected codes switch to inactive. A toast confirms: "3 promo codes deactivated."

### Scenario 5: Cook reviews promo performance
The promo list shows each code's usage count (e.g., "47/100 used") and date range, helping the cook decide which codes to keep active.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-560 | Promo code statuses: active, inactive (manual), expired (computed from end date) |
| BR-561 | A deactivated code cannot be applied at checkout regardless of date range |
| BR-562 | A deactivated code can be reactivated by the cook |
| BR-563 | An expired code cannot be reactivated via toggle; the end date must be extended first (F-216) |
| BR-564 | The promo list displays: code, discount type/value, status, usage count (used/max), start date, end date |
| BR-565 | Bulk deactivation: cook selects multiple codes and deactivates them in one action |
| BR-566 | Bulk reactivation is not supported (individual toggle only for reactivation) |
| BR-567 | Expired status is computed: current date > end date |
| BR-568 | Only the cook can toggle promo code status (cook-reserved action) |
| BR-569 | All status changes are logged via Spatie Activitylog |
| BR-570 | All user-facing text must use `__()` localization |
| BR-571 | Gale handles all toggle and bulk actions without page reloads |

---

## Data Involved
**Creates:**
- Activity log entries for each status change

**Reads:**
- All promo codes for this tenant
- Usage counts per promo code
- Current date for expired status computation

**Updates:**
- `promo_codes` table: `status` column (active/inactive)

**Relationships:**
- PromoCode belongsTo Tenant
- PromoCode hasMany PromoCodeUsages (for usage count)

---

## Acceptance Criteria
- **Given** an active promo code, **when** the cook toggles it, **then** it becomes inactive
- **Given** an inactive promo code, **when** the cook toggles it, **then** it becomes active
- **Given** an expired promo code, **when** the cook views it, **then** the status shows "Expired" and the toggle is disabled
- **Given** a deactivated code, **when** a client tries to use it at checkout, **then** it is rejected
- **Given** multiple selected codes, **when** the cook clicks "Deactivate Selected," **then** all are deactivated
- **Given** the promo list, **when** viewing, **then** all codes show correct status, usage count, and dates
- **Given** a status change, **when** checked in the activity log, **then** the change is recorded

---

## Verification Steps
1. View the promo code list -- confirm all codes display with status, usage, and dates
2. Toggle an active code to inactive -- confirm status changes and toast appears
3. Toggle the inactive code back to active -- confirm reactivation
4. Verify an expired code shows "Expired" status with disabled toggle
5. Select 3 codes and bulk deactivate -- confirm all switch to inactive
6. Attempt to use a deactivated code at checkout -- confirm rejection
7. Reactivate a code and use it at checkout -- confirm it works
8. Check activity log for all status change entries

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Deactivation during an active checkout | If the code was already validated in the session, the order proceeds; future attempts fail |
| Code expires while cook is viewing the list | Status updates to "Expired" on next Gale refresh/poll |
| Bulk deactivation includes already-inactive codes | No-op for those; only active codes are toggled |
| Code has no end date | Never expires; status is either active or inactive |
| All promo codes are expired | List shows all as expired; empty state for active tab if filtered |
| Cook deactivates a code mid-campaign | Immediate; clients currently on checkout see an error if they submit |
| Promo list with 100+ codes | Paginated list with search/filter capabilities |

---

## UI/UX Notes
- Promo list is the main view of the Promo section in the cook dashboard
- List layout: table on desktop, card list on mobile
- Columns: Code, Type, Value, Status (badge), Uses (X/Y or X/unlimited), Dates, Actions
- Status badges: green for Active, grey for Inactive, red for Expired
- Toggle switch inline for active/inactive (disabled for expired codes)
- Checkbox column for bulk selection
- Bulk action bar appears when items are selected: "Deactivate Selected (X)"
- Search/filter bar at the top: filter by status (All, Active, Inactive, Expired)
- Sorting: by creation date (default), by usage count, by end date
- Usage count display: "47/100" or "47/unlimited"
- Expired codes shown with strikethrough on dates or a dimmed row
- Mobile: swipe to toggle, long-press for bulk selection
- All interactions via Gale

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-215 | Cook Promo Code Creation | Creates codes managed here |
| F-216 | Cook Promo Code Edit | Edit details; extend dates to un-expire |
| F-218 | Promo Code Application at Checkout | Checks active status during validation |
| F-219 | Promo Code Validation Rules | Includes active status check |
