# F-219 â€” Promo Code Validation Rules

> Module: Promo
> Priority: Should-have
> Precedence: F-215
> Type: edge-case

---

## What It Does
Defines the complete validation ruleset for promo code redemption. When a client enters a promo code at checkout (F-218), the system runs it through a series of checks in order. Each validation failure returns a specific, user-friendly error message. The validation is deterministic and returns the first failing rule's message. Promo code input is case-insensitive (normalized to uppercase). This feature does not have its own UI -- it is the validation engine consumed by F-218.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Receives validation error messages when a code fails any check |
| Cook | Indirectly benefits from consistent enforcement of promo rules |
| Developer | Implements the validation pipeline |

---

## User Scenarios
### Scenario 1: Code does not exist
The client enters "FREEBIE." No promo code with this name exists for the current tenant. Error: "This promo code is not valid."

### Scenario 2: Code belongs to another tenant
The client enters "WELCOME10" on `moussa.dm.test`, but this code only exists on `latifa.dm.test`. Error: "This promo code is not valid." (Same generic message to avoid leaking cross-tenant information.)

### Scenario 3: Code is deactivated
The code "SUMMER20" exists but was deactivated by the cook. Error: "This promo code is currently inactive."

### Scenario 4: Code has not started yet
The code "NEWYEAR" has a start date of January 1st, but today is December 15th. Error: "This promo code is not yet active. It starts on January 1, 2027."

### Scenario 5: Code has expired
The code "LAUNCH500" ended yesterday. Error: "This promo code has expired."

### Scenario 6: Code reached maximum total uses
The code "FLASH10" has max_uses = 50 and has been used 50 times. Error: "This promo code has been fully redeemed."

### Scenario 7: Client exceeded per-client limit
The code "LOYAL5" allows 2 uses per client. This client has already used it twice. Error: "You have already used this promo code the maximum number of times."

### Scenario 8: Order total below promo minimum
The code "BIG20" requires a minimum order of 5,000 XAF. The client's cart subtotal is 3,000 XAF. Error: "This promo code requires a minimum order of 5,000 XAF. Add 2,000 XAF more to qualify."

### Scenario 9: All checks pass
All validations pass. The code is applied successfully with no error.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-586 | Validation check 1: Code exists and belongs to the current tenant |
| BR-587 | Validation check 2: Code status is "active" (not inactive) |
| BR-588 | Validation check 3: Current date is on or after the code's start date |
| BR-589 | Validation check 4: Current date is on or before the code's end date (if set) |
| BR-590 | Validation check 5: Total usage count is below max_uses (if max_uses > 0) |
| BR-591 | Validation check 6: Client's personal usage count is below max_uses_per_client (if > 0) |
| BR-592 | Validation check 7: Cart food subtotal meets or exceeds the promo's minimum_order_amount |
| BR-593 | Validations run in order (1-7); the first failure stops evaluation and returns the error |
| BR-594 | Non-existent and cross-tenant codes return the same generic error to prevent information leakage |
| BR-595 | Promo code input is case-insensitive; normalized to uppercase before lookup |
| BR-596 | Each validation failure returns a specific, localized error message |
| BR-597 | Error messages must use `__()` localization for EN/FR support |
| BR-598 | Validation is re-run at order submission time (not only at apply time) to catch race conditions |

---

## Data Involved
**Creates:**
- Nothing (validation only)

**Reads:**
- `promo_codes` table: code, tenant_id, status, starts_at, ends_at, max_uses, max_uses_per_client, minimum_order_amount
- `promo_code_usages` table: total count for this code, count for this client
- Cart session data: food subtotal
- Current tenant ID from request context

**Updates:**
- Nothing (validation only)

**Relationships:**
- PromoCode hasMany PromoCodeUsages
- PromoCodeUsage belongsTo User (client)
- Validation is consumed by F-218 (checkout) and F-148 (order creation)

---

## Acceptance Criteria
- **Given** a non-existent code, **when** validated, **then** error: "This promo code is not valid."
- **Given** a code from another tenant, **when** validated, **then** error: "This promo code is not valid."
- **Given** an inactive code, **when** validated, **then** error: "This promo code is currently inactive."
- **Given** a code that hasn't started, **when** validated, **then** error includes the start date
- **Given** an expired code, **when** validated, **then** error: "This promo code has expired."
- **Given** a code at max total uses, **when** validated, **then** error: "This promo code has been fully redeemed."
- **Given** a client at per-client max, **when** validated, **then** error: "You have already used this promo code the maximum number of times."
- **Given** a cart below the promo minimum, **when** validated, **then** error includes the minimum and remaining amount
- **Given** all checks pass, **when** validated, **then** no error is returned and the code is accepted
- **Given** a code entered in lowercase, **when** validated, **then** it matches the uppercase stored code

---

## Verification Steps
1. Enter a non-existent code -- confirm generic "not valid" error
2. Enter a code from another tenant -- confirm same generic "not valid" error
3. Deactivate a code and attempt to use it -- confirm "currently inactive" error
4. Create a future-dated code and attempt to use it -- confirm start date error
5. Create a past-dated code and attempt to use it -- confirm "expired" error
6. Use a code until max_uses is reached, then attempt again -- confirm "fully redeemed" error
7. Use a code until per-client max is reached, then attempt again -- confirm per-client error
8. Enter a code with a 5,000 XAF minimum when cart has 3,000 XAF -- confirm minimum error with amounts
9. Enter a valid code that passes all checks -- confirm acceptance
10. Enter "welcome10" (lowercase) -- confirm it matches "WELCOME10"
11. Validate at both apply-time and order-submit-time -- confirm double validation

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Code with max_uses = 0 (unlimited) | Check 5 is skipped; no total usage limit |
| Code with max_uses_per_client = 0 (unlimited) | Check 6 is skipped; no per-client limit |
| Code with minimum_order_amount = 0 | Check 7 is skipped; no minimum requirement |
| Code with no end date (null) | Check 4 is skipped; code never expires |
| Start date is today | Valid; code is usable today |
| End date is today | Valid; code is usable today (expires at end of day) |
| Two clients apply the same code simultaneously, both hitting max_uses | The first order submission records usage; the second fails at submit-time re-validation |
| Code was valid at apply-time but max_uses hit before submit | Submit-time re-validation catches this; order fails with error |
| Promo's minimum_order_amount vs. tenant's minimum order amount | Both are independent checks; both must be satisfied |
| Whitespace in code input | Trimmed before lookup (e.g., " WELCOME10 " becomes "WELCOME10") |
| Empty string submitted | Validation rejects: "Please enter a promo code" (handled at form level) |

---

## UI/UX Notes
- No standalone UI for this feature; validation messages are displayed within F-218's promo code input area
- Error messages are displayed inline below the promo code input field in red text
- Each error is specific and actionable:
  - "not valid" -- generic, no information leakage
  - "currently inactive" -- tells client to try later or contact the cook
  - "not yet active" -- includes start date so client knows when to return
  - "expired" -- clear finality
  - "fully redeemed" -- the promo is exhausted
  - "maximum number of times" -- client has used their allotment
  - "minimum order of X XAF, add Y XAF more" -- tells client exactly what to do
- All error messages must be localized (EN/FR)
- Messages should be conversational, not technical

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-215 | Cook Promo Code Creation | Defines the promo code parameters validated here |
| F-216 | Cook Promo Code Edit | Edits may change validation parameters |
| F-217 | Cook Promo Code Deactivation | Active/inactive status is checked here |
| F-218 | Promo Code Application at Checkout | Consumes this validation engine |
| F-148 | Order Creation | Re-runs validation at order submission time |
