# F-015 â€” Email Notification Infrastructure

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Configures the email notification system for DancyMeals. Sets up Laravel's mail driver (SMTP or another supported driver), creates a branded base email layout consistent with DancyMeals design, and configures email delivery via queued jobs for non-blocking performance. Creates a base Mailable class with consistent styling that all feature-specific emails extend. Supports both main-domain-branded and tenant-branded email variants.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Receives transactional emails (order confirmations, payment receipts, password resets) |
| Cook | Receives email notifications for critical events (new orders, withdrawals) |
| Admin | Receives email notifications for escalated issues |
| Developer | Extends the base email templates for specific notification types |

---

## User Scenarios
### Scenario 1: Order confirmation email
A client completes a payment. A queued email job sends them a branded confirmation email with order details, payment amount, and expected delivery/pickup information. The email arrives within seconds.

### Scenario 2: Tenant-branded email
A client orders from Latifa's cook site. The confirmation email includes Latifa's brand name and logo alongside DancyMeals branding, making it clear which cook the order is from.

### Scenario 3: Email delivery failure
An email to a user fails because of an invalid address. The queue worker logs the failure and the system retries according to the configured retry policy. After exhausting retries, the failure is logged for admin review.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-114 | All emails must be sent via queued jobs (never synchronously blocking the request) |
| BR-115 | The base email layout must include DancyMeals logo, footer with unsubscribe link, and social links |
| BR-116 | Emails triggered from a tenant context must include the tenant's brand name |
| BR-117 | The `from` address must be configurable (default: `noreply@dancymeals.com`) |
| BR-118 | All email text must be localized based on the recipient's `preferred_language` |
| BR-119 | Email templates must be responsive (readable on mobile email clients) |
| BR-120 | Failed email deliveries must be retried up to 3 times with exponential backoff |
| BR-121 | Critical emails (password reset, email verification) use the `high` queue priority |

---

## Data Involved
**Creates:**
- Mail configuration in `.env` (SMTP host, port, username, password, encryption)
- Base email layout Blade template (`emails/layouts/base.blade.php`)
- Base Mailable class with DancyMeals branding
- Queue configuration for email jobs

**Reads:**
- User's email address and `preferred_language`
- Tenant context for branded emails
- Mail driver configuration from `.env`

**Updates:**
- `config/mail.php` with appropriate defaults
- `config/queue.php` with email queue configuration
- `.env` with mail driver credentials

**Relationships:**
- Extended by all notification features that include email (F-191 through F-195)
- F-023 (Email Verification) uses this infrastructure
- F-026 (Password Reset) uses this infrastructure

---

## Acceptance Criteria
- **Given** the mail driver is configured, **when** sending a test email via artisan, **then** the email is delivered successfully
- **Given** an email notification is triggered, **when** the job processes, **then** the email is sent asynchronously via the queue
- **Given** the base email template, **when** rendered, **then** it includes the DancyMeals header, content area, and branded footer
- **Given** a tenant context, **when** an email is sent, **then** the tenant's brand name appears in the email
- **Given** a French-speaking recipient, **when** receiving an email, **then** the content is in French
- **Given** an email delivery failure, **when** retries are exhausted, **then** the failure is logged

---

## Verification Steps
1. Configure SMTP credentials and send a test email via `php artisan tinker`
2. Trigger a queued email notification and verify it is processed by the queue worker
3. Inspect the email content and confirm DancyMeals branding is present
4. Send an email in tenant context and verify the tenant brand name appears
5. Verify email renders correctly in a mobile email client preview
6. Test with an invalid email address and confirm failure is logged after retries

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| SMTP credentials not configured | Email sending fails gracefully with a logged warning; app continues working |
| Queue worker not running | Emails queue up in the jobs table; delivered when worker starts |
| Recipient's email bounces | Logged as a failed delivery; admin can review in logs |
| Email content exceeds size limit | Unlikely for transactional emails; content is concise by design |
| Special characters in user name | Properly encoded in email headers and body |

---

## UI/UX Notes
- No user-facing UI in this feature. This establishes the email infrastructure.
- Base email template design guidelines:
  - Clean, simple layout (single-column for mobile readability)
  - DancyMeals logo at the top
  - Clear call-to-action button for actionable emails
  - Footer with: DancyMeals address, unsubscribe link, support contact
  - Colors consistent with DancyMeals brand (respect both light email clients and dark mode email clients)
- All emails should pass common spam filter checks (proper headers, SPF, DKIM).

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; base project must exist |
| F-014 | Push Notification Infrastructure | Sibling notification channel |
| F-023 | Email Verification Flow | Uses email infrastructure for verification emails |
| F-026 | Password Reset Request | Uses email infrastructure for reset emails |
| F-191 | Order Creation Notifications | Extends base email for order emails |
| F-194 | Payment Notifications | Extends base email for payment emails |
