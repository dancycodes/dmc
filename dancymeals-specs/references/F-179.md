# F-179 â€” Cook Overall Rating Calculation

> Module: Rating
> Priority: Must-have
> Precedence: F-176
> Type: functional

---

## What It Does
Calculates and maintains the cook's overall rating as a weighted average of all order ratings across all their meals. The overall rating is displayed on the cook card in discovery (F-067), the cook's tenant landing page (F-126), and the cook's dashboard (F-077). The rating is recalculated each time a new rating is submitted. Displays as "X.X/5 (N reviews)" where N is the total number of ratings.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Recalculates the overall rating on each new rating submission |
| Client | Sees the cook's overall rating on discovery and tenant pages |
| Cook | Sees their own overall rating on the dashboard |

---

## User Scenarios
### Scenario 1: First rating
A cook receives their first order rating: 5 stars. The overall rating is set to 5.0/5 (1 review). This appears on their cook card in discovery and their landing page.

### Scenario 2: Rating recalculation
A cook has 10 ratings averaging 4.5/5. A new rating of 3 stars is submitted. The system recalculates: (sum of all 11 ratings) / 11 = new average. The updated rating appears across all display locations.

### Scenario 3: View on discovery page
A client browsing the discovery page sees cook cards. Each card shows: cook name, cover image, "4.3/5 (45 reviews)" with star visualization.

### Scenario 4: View on tenant landing page
A visitor views a cook's landing page. The header area shows the cook's overall rating: "4.3/5 (45 reviews)" prominently.

### Scenario 5: View on cook dashboard
The cook views their dashboard home. A stat card shows: "Your Rating: 4.3/5 (45 reviews)" with trend indicator (up/down compared to last month).

### Scenario 6: Cook with no ratings
A new cook has zero ratings. Discovery card shows "New cook" or no rating indicator. Landing page shows "No ratings yet."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-417 | Overall rating = sum of all stars / number of ratings (simple average) |
| BR-418 | Displayed as X.X/5 with one decimal place |
| BR-419 | Total review count (N) includes all ratings, even those without review text |
| BR-420 | Rating is recalculated immediately when a new rating is submitted |
| BR-421 | The calculated rating is cached/stored on the tenant or cook record for performance |
| BR-422 | Rating is displayed on: cook card (F-067), tenant landing page (F-126/F-130), cook dashboard (F-077) |
| BR-423 | Cooks with zero ratings show "New" or "No ratings yet" instead of 0/5 |
| BR-424 | Ratings from cancelled or refunded orders remain in the calculation (they reflect the experience) |
| BR-425 | The rating is tenant-scoped (a cook with multiple tenants has separate ratings per tenant) |

---

## Data Involved
**Reads:**
- `ratings` table for all ratings linked to the tenant's orders
- Tenant/cook record for current cached rating

**Creates:**
- Nothing

**Updates:**
- Cached overall rating and review count on the tenant or cook record
- Updated values propagated to all display locations

**Relationships:**
- Rating belongsTo Order
- Order belongsTo Tenant
- Tenant stores cached: `average_rating`, `rating_count`

---

## Acceptance Criteria
- **Given** a new rating is submitted, **when** the system processes it, **then** the cook's overall rating is recalculated
- **Given** the cook has ratings, **when** viewing discovery, **then** the cook card shows the correct average and count
- **Given** the cook has ratings, **when** viewing the tenant landing page, **then** the rating is displayed prominently
- **Given** the cook has no ratings, **when** viewing discovery, **then** "New" or equivalent is shown instead of stars
- **Given** a cook with multiple meals, **when** calculating the overall rating, **then** all order ratings across all meals are included

---

## Verification Steps
1. Submit a first rating for a cook and verify the overall rating is set
2. Submit additional ratings and verify the average is recalculated correctly
3. Verify the rating appears on the discovery page cook card
4. Verify the rating appears on the tenant landing page
5. Verify the rating appears on the cook dashboard
6. Verify a new cook with no ratings shows appropriate placeholder
7. Verify the rating count is accurate

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| All ratings are 5 stars | Overall rating is 5.0/5 |
| Single rating of 1 star | Overall rating is 1.0/5 |
| Very many ratings (1000+) | Calculation remains accurate; cached value prevents performance issues |
| Rating submitted while recalculation is in progress | Atomic update prevents stale data |
| Cook's tenant is deactivated | Rating cached value remains; not displayed since cook is hidden from discovery |

---

## UI/UX Notes
- Star visualization: filled stars (full, half, empty) based on the average
- Format: "X.X/5 (N reviews)" or "X.X (N)" for compact display
- On cook card: compact format below the cook name
- On landing page: larger format in the header section
- On dashboard: stat card with trend arrow (up/down vs. previous period)
- No rating: "New" badge or "No ratings yet" text
- All text localized via `__()`

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-176 | Order Rating Prompt | Triggers recalculation when a rating is submitted |
| F-067 | Cook Card Component | Displays the overall rating on discovery |
| F-126 | Tenant Landing Page Layout | Landing page shows the rating |
| F-130 | Ratings Summary Display | Detailed rating summary on landing page |
| F-077 | Cook Dashboard Home | Dashboard shows the cook's own rating |
