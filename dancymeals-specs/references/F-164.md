# F-164 — Client Transaction History

> Module: Client Financial
> Priority: Must-have
> Precedence: F-024, F-151
> Type: functional

---

## What It Does
Displays a paginated list of all financial transactions for the authenticated client. Transaction types include: payments (order payments via mobile money), refunds (wallet credits from cancellations or complaint resolutions), and wallet payments (orders paid from wallet balance). Each entry shows the date, description, amount, transaction type (debit or credit), status, and reference. Clients can filter by type and sort by date. This is a cross-tenant view showing transactions from all orders.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Views their complete financial transaction history |

---

## User Scenarios
### Scenario 1: View all transactions
The client navigates to "Transaction History" from their account menu. A paginated list shows all financial transactions sorted by date (newest first). Each entry shows a description (e.g., "Payment for Order #ORD-1234"), amount with debit/credit indicator, type, status, and date.

### Scenario 2: Filter by type
The client selects "Refunds" from the type filter. Only refund transactions are displayed. They switch to "Payments" to see only payment transactions.

### Scenario 3: View a payment transaction
A payment entry shows: "Payment for Order #ORD-1234 — 5,000 XAF (Debit) — MTN MoMo — Completed — 2026-02-10." The client clicks it to view full details (F-165).

### Scenario 4: View a refund transaction
A refund entry shows: "Refund for Order #ORD-1234 — 5,000 XAF (Credit) — Wallet — Completed — 2026-02-11."

### Scenario 5: No transactions
A new client with no orders sees: "No transactions yet. Your payment history will appear here once you place your first order."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-260 | Transaction history shows all client transactions across all tenants |
| BR-261 | Transaction types: payment (debit), refund (credit), wallet_payment (debit) |
| BR-262 | Default sort is by date descending (newest first) |
| BR-263 | Transactions are paginated with 20 per page (configurable) |
| BR-264 | Each transaction shows: date, description, amount (XAF), type (debit/credit), status, reference |
| BR-265 | Debit transactions are shown with a negative indicator or red color |
| BR-266 | Credit transactions are shown with a positive indicator or green color |
| BR-267 | Filter by type allows: All, Payments, Refunds, Wallet Payments |
| BR-268 | Clicking a transaction navigates to the transaction detail view (F-165) |
| BR-269 | Authentication is required |
| BR-270 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `client_transactions` or `transactions` table filtered by `user_id`
- `orders` table for order references
- Payment provider data for Flutterwave references

**Creates:**
- Nothing

**Updates:**
- Nothing

**Relationships:**
- Transaction belongsTo User (client)
- Transaction belongsTo Order (optional, for reference)

---

## Acceptance Criteria
- **Given** an authenticated client, **when** they visit transaction history, **then** a paginated list of all their transactions is displayed
- **Given** transactions of different types exist, **when** viewing the list, **then** each type is visually distinguished (debit/credit indicators)
- **Given** the client selects a type filter, **when** applied, **then** only transactions of that type are shown
- **Given** the client clicks a transaction, **when** navigating, **then** they reach the transaction detail page (F-165)
- **Given** no transactions exist, **when** viewing the page, **then** an appropriate empty state is shown

---

## Verification Steps
1. Navigate to transaction history and verify the list loads with correct columns
2. Verify pagination works with more than 20 transactions
3. Apply the type filter (Payments, Refunds, Wallet Payments) and verify filtering
4. Verify debit transactions show negative/red indicators
5. Verify credit transactions show positive/green indicators
6. Click a transaction and verify navigation to detail page
7. Test with no transactions and verify empty state
8. Verify transactions span across multiple tenants

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Transaction references a deleted order | Description still shows order ID; detail may show "Order no longer available" |
| Failed payment transaction | Shows with "Failed" status badge; amount displayed but not charged |
| Pending transaction | Shows with "Pending" status badge |
| Very many transactions (100+) | Pagination handles efficiently |
| Client accesses from tenant domain | Same list shown (transactions are cross-tenant) |

---

## UI/UX Notes
- Accessible from account menu under "Transaction History" or "Financial"
- Table layout on desktop; card layout on mobile
- Amount column: green text with "+" for credits, red text with "-" for debits
- Status badge: Completed (green), Pending (amber), Failed (red)
- Type filter as pills or segmented control above the list
- Each row/card is clickable to view details
- Empty state with illustration
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-024 | User Login | Authentication required |
| F-151 | Payment Webhook Handling | Creates payment transactions |
| F-165 | Transaction Detail View | Clicking a transaction navigates here |
| F-163 | Order Cancellation Refund Processing | Creates refund transactions |
| F-166 | Client Wallet Dashboard | Links to full transaction history |
