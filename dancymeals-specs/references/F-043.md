# F-043 — Admin Panel Layout & Access Control

> Module: Admin
> Priority: Must-have
> Precedence: F-006, F-016
> Type: functional

---

## What It Does
Provides the admin panel layout with sidebar navigation, accessible only on the main domain at `/vault-entry` and `/vault-entry/*` routes. Middleware blocks all access from tenant subdomains and custom domains. Users must have the `can-access-admin-panel` permission (granted to admin and super-admin roles). The layout is fully responsive with a collapsible sidebar on mobile.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Super-Admin | Full access to all admin panel sections |
| Admin | Access to admin panel sections permitted by their role |
| Cook / Client | Blocked — middleware returns 403 or redirects to homepage |

---

## User Scenarios
### Scenario 1: Admin navigates to admin panel
An admin visits `http://dm.test/vault-entry`. The middleware verifies they are on the main domain, checks their authentication, and confirms the `can-access-admin-panel` permission. The admin panel loads with a sidebar listing: Dashboard, Tenants, Users, Roles, Analytics, Finance, Complaints, Settings, Activity Logs, Payouts.

### Scenario 2: Tenant domain access attempt
A user navigates to `http://cook1.dm.test/vault-entry`. The middleware detects this is a tenant domain and blocks access, returning a 404 (not 403, to avoid revealing admin routes exist on tenant domains).

### Scenario 3: Unauthorized user on main domain
A logged-in client visits `http://dm.test/vault-entry`. They lack the `can-access-admin-panel` permission. The middleware returns a 403 Forbidden response.

### Scenario 4: Mobile navigation
An admin opens the panel on a mobile device. The sidebar is collapsed behind a hamburger menu. Tapping the menu slides the sidebar in as an overlay. Tapping outside or selecting a section closes it.

### Scenario 5: Unauthenticated access
A guest visits `http://dm.test/vault-entry`. They are redirected to the login page. After logging in with valid admin credentials, they are returned to the admin panel.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-043 | Admin panel routes are ONLY accessible on the main domain (dm.test in dev, dancymeals.com in production) |
| BR-044 | Requests to `/vault-entry/*` on any tenant domain must return 404 |
| BR-045 | Only users with `can-access-admin-panel` permission may access the admin panel |
| BR-046 | The sidebar must display navigation sections based on the user's permissions — sections without permission are hidden |
| BR-047 | The admin layout must support both light and dark mode |
| BR-048 | All admin pages must be fully responsive (mobile-first) |

---

## Data Involved
**Reads:**
- Current request domain (to verify main domain)
- Authenticated user's permissions
- Navigation section permission mappings

**Creates:**
- Nothing (layout feature)

**Updates:**
- Nothing (layout feature)

**Relationships:**
- F-006: Provides the permission/role system used for access control
- F-016: Provides the tenant domain resolution middleware this feature builds upon

---

## Acceptance Criteria
- **Given** an admin on the main domain, **when** they visit `/vault-entry`, **then** the admin panel loads with the full sidebar navigation
- **Given** any user on a tenant domain, **when** they visit `/vault-entry`, **then** a 404 is returned
- **Given** a client user on the main domain, **when** they visit `/vault-entry`, **then** a 403 is returned
- **Given** a guest, **when** they visit `/vault-entry`, **then** they are redirected to the login page
- **Given** an admin with limited permissions, **when** the sidebar renders, **then** only sections they have permission for are visible
- **Given** a mobile viewport, **when** the admin panel loads, **then** the sidebar is collapsed and accessible via hamburger menu

---

## Verification Steps
1. Log in as super-admin and navigate to `/vault-entry` — confirm all 10 sidebar sections are visible
2. Access `/vault-entry` from a tenant subdomain — confirm 404 response
3. Log in as a client and access `/vault-entry` on main domain — confirm 403
4. Resize browser to mobile width — confirm sidebar collapses to hamburger menu
5. Toggle dark mode — confirm admin panel layout renders correctly in both themes
6. Log out and visit `/vault-entry` — confirm redirect to login page

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| User's permissions change while in admin panel | Next navigation action re-checks permissions; hidden sections update |
| Admin's account deactivated while in session | Next request triggers active-status middleware, logs them out |
| Browser back button after logout | Redirected to login, no cached admin content |
| Admin has `can-access-admin-panel` but no section-specific permissions | Panel loads but sidebar is empty except Dashboard |

---

## UI/UX Notes
- Sidebar width: ~260px on desktop, full overlay on mobile
- Active navigation item highlighted with accent color
- Sidebar sections grouped logically: Overview (Dashboard), Management (Tenants, Users, Roles), Insights (Analytics, Finance), Operations (Complaints, Payouts), System (Settings, Activity Logs)
- Admin panel uses the platform's default theme (not tenant themes)
- Breadcrumb navigation on all admin pages
- Page title reflects current section

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-006 | Spatie Permission Setup | Provides RBAC system for access control |
| F-016 | Multi-Domain Middleware | Provides domain detection this feature relies on |
| F-044 | Super-Admin Creation | Creates first user who can access this panel |
| F-045 | Tenant Creation Form | Child page within admin panel |
| F-057 | Platform Analytics Dashboard | Child page within admin panel |
| F-063 | Platform Settings Management | Child page within admin panel |
