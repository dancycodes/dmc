# F-112 — Meal Status Toggle (Draft/Live)

> Module: Meal
> Priority: Must-have
> Precedence: F-108
> Type: functional

---

## What It Does
Allows a cook to toggle a meal between "draft" and "live" status. A meal cannot go live without at least one meal component. Draft meals are invisible to clients on the tenant landing page. Live meals are visible to clients (subject to availability and schedule). The toggle has immediate effect and is performed via Gale. Going live is a significant action and is logged.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Cook | Toggles meals between draft and live status |
| Manager | Toggles status if granted `manage-meals` permission |
| Client | Sees only live meals on the tenant landing page |

---

## User Scenarios
### Scenario 1: Publish a meal (draft to live)
The cook has a meal "Ndole" in draft status with 2 components. They click the "Go Live" toggle. The status changes to "live." The meal becomes visible on the tenant landing page. Toast: "Ndole is now live."

### Scenario 2: Attempt to go live without components
The cook tries to publish "New Meal" which has no components. The toggle is blocked with a message: "Add at least one component before going live."

### Scenario 3: Unpublish a meal (live to draft)
The cook has a live meal "Old Dish" and toggles it to draft. The meal is immediately hidden from clients. Pending orders for this meal are unaffected (they proceed normally). Toast: "Old Dish is now in draft."

### Scenario 4: Quick toggle from meal list
On the meal list (F-116), the cook clicks the status toggle directly on the "Ndole" row without opening the edit page. The status changes inline via Gale.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-227 | A meal must have at least one meal component to go live |
| BR-228 | Draft meals are not visible to clients on the tenant landing page |
| BR-229 | Live meals are visible to clients (subject to availability F-113 and schedule) |
| BR-230 | Toggling to draft does not affect pending or active orders |
| BR-231 | Status toggle has immediate effect |
| BR-232 | Status change is logged via Spatie Activitylog |
| BR-233 | Only users with `manage-meals` permission can toggle status |
| BR-234 | Status enum values: `draft`, `live` |

---

## Data Involved
**Creates:**
- Nothing

**Reads:**
- Meal record and its component count
- Meal status

**Updates:**
- Meal `status` field

**Relationships:**
- Meal hasMany MealComponents (count checked for live validation)

---

## Acceptance Criteria
- **Given** a draft meal with components, **when** toggled to live, **then** status changes and meal appears on landing page
- **Given** a draft meal with no components, **when** toggled to live, **then** the toggle is blocked with an error
- **Given** a live meal, **when** toggled to draft, **then** status changes and meal is hidden from clients
- **Given** a live meal with pending orders, **when** toggled to draft, **then** the toggle succeeds and orders are unaffected
- **Given** the toggle action, **when** completed, **then** the change is logged in the activity log

---

## Verification Steps
1. Toggle a meal with components from draft to live — confirm it appears on the landing page
2. Attempt to toggle a meal without components to live — confirm it is blocked
3. Toggle a live meal to draft — confirm it is hidden from clients
4. Toggle from the meal list view (quick toggle) — confirm inline update
5. Check activity log for the status change
6. Verify pending orders are unaffected by draft toggle

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| All components deleted from a live meal | Meal remains live (components were present at go-live); future re-validation recommended |
| Toggling status rapidly | Only the final state persists; no race conditions |
| Manager permission revoked mid-action | Permission re-checked; action blocked if unauthorized |
| Meal is also unavailable (F-113) | Can be toggled to live while unavailable — "live + unavailable" means exists but temporarily not orderable |

---

## UI/UX Notes
- Toggle switch or button on meal edit page and meal list
- Visual indicator: "Draft" badge (grey) vs "Live" badge (green)
- Error message shown inline if going live without components
- Toggle action via Gale (no page reload)
- Toast notification on success
- On meal list: inline toggle with immediate visual feedback

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-108 | Meal Creation Form | Creates meals in draft status |
| F-113 | Meal Availability Toggle | Separate toggle for temporary unavailability |
| F-116 | Meal List View (Cook Dashboard) | Shows status and provides quick toggle |
| F-118 | Meal Component Creation | Components required before going live |
| F-128 | Available Meals Grid Display | Shows only live meals to clients |
