# F-006 â€” Role & Permission Seed Setup

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Configures Spatie Laravel Permission for DancyMeals. Defines a comprehensive set of granular permissions covering every protected action in the platform. Creates the five core roles (super-admin, admin, cook, manager, client) and assigns appropriate permissions to each. Provides a seeder that can be run to populate the database with roles and permissions. Permissions for cook, manager, and client roles operate within a tenant context.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Super-Admin | Has all permissions; created via artisan command (F-044) |
| Admin | Manages platform-level operations via assigned permissions |
| Cook | Manages their tenant's content and orders via assigned permissions |
| Manager | Operates with a configurable subset of cook permissions |
| Client | Has browse, order, and interaction permissions |
| Developer | Runs the seeder to populate roles and permissions |

---

## User Scenarios
### Scenario 1: Initial seeding
The developer runs the permission seeder. All permissions are created in the database, all five roles are created, and each role is assigned its defined permissions. The seeder is idempotent and can be re-run safely.

### Scenario 2: Permission check on a protected action
A cook attempts to access the admin panel. The authorization middleware checks their permissions, finds they lack `can-access-admin-panel`, and returns a 403 Forbidden response.

### Scenario 3: Role inheritance verification
A user with the "cook" role visits a tenant domain. They can perform all client actions (browse, order) in addition to their cook-specific actions (manage meals, manage orders), because every role inherits client capabilities.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-038 | Permissions are granular and action-specific (e.g., `can-manage-meals`, not `meal-access`) |
| BR-039 | Super-admin role has ALL permissions and is never restricted |
| BR-040 | Admin role covers platform management: tenants, users, financials, complaints, settings |
| BR-041 | Cook role covers tenant management: meals, orders, brand, locations, schedules, managers, promos |
| BR-042 | Manager role starts with no permissions; cook configures them from a subset of cook permissions |
| BR-043 | Client role covers consumer actions: browse, order, pay, rate, review, complain, message |
| BR-044 | Every role inherits all client permissions (every user can do what a client does) |
| BR-045 | Permissions for cook/manager/client are evaluated within the tenant context |
| BR-046 | The seeder must be idempotent: re-running it does not create duplicate entries |
| BR-047 | Guard name for all roles and permissions is "web" |

---

## Data Involved
**Creates:**
- Permissions (examples): `can-access-admin-panel`, `can-create-tenant`, `can-edit-tenant`, `can-manage-users`, `can-manage-meals`, `can-manage-orders`, `can-manage-locations`, `can-manage-schedules`, `can-manage-brand`, `can-manage-managers`, `can-manage-promos`, `can-manage-complaints`, `can-manage-financials`, `can-manage-settings`, `can-view-analytics`, `can-export-data`, `can-browse-meals`, `can-place-orders`, `can-manage-wallet`, `can-rate-orders`, `can-submit-testimonials`, `can-submit-complaints`, `can-send-messages`, `can-manage-favorites`, `can-view-activity-log`
- Roles: super-admin, admin, cook, manager, client
- `RoleAndPermissionSeeder` class

**Reads:**
- Spatie permission config for guard and table names

**Updates:**
- `roles` and `permissions` tables (Spatie)
- `role_has_permissions` pivot table
- `DatabaseSeeder` to include the permission seeder

**Relationships:**
- Role hasMany Permissions (Spatie)
- User belongsToMany Roles (Spatie)

---

## Acceptance Criteria
- **Given** the seeder has run, **when** querying roles, **then** all five roles exist: super-admin, admin, cook, manager, client
- **Given** the seeder has run, **when** querying permissions, **then** all defined granular permissions exist
- **Given** the super-admin role, **when** checking permissions, **then** it has every permission in the system
- **Given** the cook role, **when** checking permissions, **then** it has all tenant management and client permissions
- **Given** the manager role, **when** checking permissions, **then** it has no permissions by default (configured per tenant)
- **Given** the seeder has already run, **when** running it again, **then** no duplicates are created
- **Given** the client role, **when** checking permissions, **then** it has browse, order, and interaction permissions

---

## Verification Steps
1. Run the seeder and confirm all five roles exist in the database
2. Confirm super-admin has all permissions using `$role->permissions->count()`
3. Confirm admin role has platform management permissions but not tenant-specific ones
4. Confirm cook role includes all client permissions plus tenant management permissions
5. Confirm manager role has zero permissions initially
6. Re-run the seeder and confirm no duplicate roles or permissions are created

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Seeder run on populated database | Existing roles/permissions are not duplicated; new ones are added |
| Permission deleted from seeder but exists in DB | Remains in DB; no automatic cleanup (manual migration needed) |
| Role assigned to user then role deleted | Spatie handles cascading; user loses the role |
| Guard mismatch | All roles and permissions use "web" guard; mismatches are caught by Spatie |

---

## UI/UX Notes
No user-facing UI in this feature. Roles and permissions are managed programmatically and through the admin panel (F-052 through F-056).

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Prerequisite; spatie/laravel-permission must be installed |
| F-005 | Authentication Scaffolding | Users are assigned roles during/after registration |
| F-029 | Active Status Enforcement | Works alongside role checks for authorization |
| F-043 | Admin Panel Layout | Uses `can-access-admin-panel` permission |
| F-044 | Super-Admin Creation | Creates user with super-admin role |
| F-052 | Create Role | Admin UI for creating custom roles |
| F-209 | Cook Creates Manager Role | Cook configures manager permissions |
