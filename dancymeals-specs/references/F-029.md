# F-029 — Active Status Enforcement

> Module: Auth
> Type: functional
> Priority: Must-have
> Precedence: F-006, F-024

---

## What It Does

Middleware checks the authenticated user's `is_active` status on every request. If the user's
account has been deactivated (`is_active = false`), they see an "account deactivated" message
and are logged out. Only active users can perform actions. Admins can toggle the active status
of any user.

---

## Who Uses It

- **All authenticated users** — the middleware runs on every authenticated request.
- **Admins/Super-admins** — can toggle a user's active status.

---

## User Scenarios

### Happy Path
1. Authenticated user with `is_active = true` makes a request.
2. Middleware passes. The request proceeds normally.
3. User experiences no interruption.

### Alternate Path — Admin Deactivates a User
1. Admin navigates to the user management section (F-051).
2. Admin toggles a user's status to inactive.
3. The user's `is_active` is set to `false`.
4. Activity is logged: "User deactivated by admin."
5. On the user's next request, the middleware catches the inactive status.

### Error Path — Deactivated User Makes a Request
1. A user whose account has been deactivated makes any authenticated request.
2. The middleware detects `is_active = false`.
3. The user's session is destroyed (logged out).
4. The user is redirected to a page showing: "Your account has been deactivated. Please contact support."
5. The user cannot log back in until reactivated (see F-024 BR-053).

### Alternate Path — Admin Reactivates a User
1. Admin toggles the user's status back to active.
2. The user's `is_active` is set to `true`.
3. Activity is logged: "User reactivated by admin."
4. The user can now log in and use the platform normally.

---

## Business Rules

| Code | Rule |
|------|------|
| BR-089 | The active status check middleware must run on every authenticated request. |
| BR-090 | Users with `is_active = false` must be immediately logged out and shown a deactivation message. |
| BR-091 | Deactivated users cannot log in (enforced at login, see F-024). |
| BR-092 | Only users with the appropriate permission (admin, super-admin) can toggle another user's active status. |
| BR-093 | Super-admin accounts cannot be deactivated by regular admins — only by other super-admins. |
| BR-094 | A user cannot deactivate their own account. |
| BR-095 | Active status toggle must be logged via Spatie Activitylog with the admin as causer. |
| BR-096 | The deactivation message page must be accessible without authentication (since the user is logged out). |

---

## Data Involved

### User Model
| Field | Type | Details |
|-------|------|---------|
| is_active | boolean | Default: true. Determines access to the platform. |

### Activity Log (on toggle)
| Field | Value |
|-------|-------|
| Event | "deactivated" or "reactivated" |
| Subject | The affected user |
| Causer | The admin who toggled the status |
| Properties | `{ is_active: false }` or `{ is_active: true }` |

---

## Acceptance Criteria

```
Given I am an active authenticated user
When I make any request
Then the request proceeds normally

Given my account has been deactivated by an admin
When I make my next request
Then I am logged out and see "Your account has been deactivated"

Given my account is deactivated
When I try to log in
Then I see "Your account has been deactivated" and cannot authenticate

Given I am an admin
When I toggle a user's status to inactive
Then the user's is_active is set to false and the action is logged

Given I am a regular admin
When I try to deactivate a super-admin
Then the action is denied

Given I am an admin
When I reactivate a deactivated user
Then the user can log in and use the platform again
```

---

## Verification Steps

1. Log in as an active user and confirm normal access to protected pages.
2. Have an admin deactivate the user; on the user's next request, confirm logout and deactivation message.
3. Try to log in as the deactivated user — confirm login is denied.
4. Have an admin reactivate the user — confirm the user can log in again.
5. As a regular admin, attempt to deactivate a super-admin — confirm the action is denied.
6. Check the activity log for deactivation/reactivation events.

---

## Edge Cases

- Admin deactivates a user who is currently in the middle of a checkout flow — the user is logged out on their next request; any pending cart data is lost (session destroyed).
- Admin deactivates themselves — BR-094 prevents this.
- Race condition: admin deactivates a user at the exact moment the user submits a form — the middleware catches it before the controller processes the request.
- Deactivated user with a "remember me" cookie — the middleware still catches them since it checks the database, not just the session.
- API requests from a deactivated user — should return 403 with appropriate message.

---

## UI/UX Notes

- The deactivation message page is a standalone, simple page with the DancyMeals logo.
- The message is clear and provides a way to contact support (e.g., email link).
- No navigation menu is shown (user is logged out).
- Light/dark mode support based on system preference (no user preference available since logged out).
- The admin toggle in user management is a clear on/off switch with a confirmation dialog.

---

## Related Features

- **F-006** — Role & Permission Seed Setup (provides admin permissions)
- **F-024** — User Login (checks is_active during login)
- **F-017** — Activity Logging Setup (logs activation/deactivation events)
- **F-051** — User Detail View & Status Toggle (admin UI for toggling status)
