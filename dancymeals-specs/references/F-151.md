# F-151 â€” Payment Webhook Handling

> Module: Payment
> Priority: Must-have
> Precedence: F-150
> Type: functional

---

## What It Does
Handles incoming webhook callbacks from Flutterwave after a payment attempt. Verifies the webhook signature for authenticity, processes the event type, and updates the order and financial records accordingly. On `charge.completed` with success status: updates the order to "Paid", credits the cook's wallet with the cook's share (marked as unwithdrawable initially), calculates and records the platform commission, and creates transaction records. On failure: updates the order to "Payment Failed." All webhook handling is idempotent and retry-safe.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Receives and processes Flutterwave webhooks automatically |
| Cook | Wallet is credited after successful payment |
| Client | Order status updates to "Paid" after successful payment |

---

## User Scenarios
### Scenario 1: Successful charge completion
Flutterwave sends a `charge.completed` webhook with `status: successful`. The system verifies the signature, finds the matching order by transaction reference, updates the order status to "Paid", credits the cook's wallet with (amount - commission), records commission as platform revenue, and creates transaction records.

### Scenario 2: Failed charge
Flutterwave sends a `charge.completed` webhook with `status: failed`. The system updates the order to "Payment Failed" and triggers the retry flow (F-152).

### Scenario 3: Duplicate webhook
Flutterwave retries a webhook for an already-processed transaction. The system checks the transaction reference, finds it already processed, and returns a 200 OK without making changes (idempotent).

### Scenario 4: Invalid webhook signature
A request arrives at the webhook endpoint with an invalid or missing signature. The system rejects it with a 401 response and logs the attempt.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-364 | Webhook endpoint must verify the Flutterwave webhook signature/hash |
| BR-365 | On `charge.completed` with `status: successful`: order status changes to "Paid" |
| BR-366 | On successful payment: cook's wallet is credited with (order amount - platform commission) |
| BR-367 | Cook wallet credit is initially "unwithdrawable" (becomes withdrawable after a configurable delay, default 3 hours) |
| BR-368 | Platform commission = order amount * cook's commission rate (default 10%) |
| BR-369 | Commission is recorded as a separate transaction record |
| BR-370 | On `charge.completed` with `status: failed`: order status changes to "Payment Failed" |
| BR-371 | Webhook processing must be idempotent: processing the same event twice has no additional effect |
| BR-372 | Each webhook creates or updates a transaction record with the Flutterwave reference |
| BR-373 | Invalid webhook signatures result in 401 rejection with logging |
| BR-374 | All webhook processing is logged via Spatie Activitylog |
| BR-375 | Webhook endpoint must return 200 OK promptly to prevent Flutterwave retries |

---

## Data Involved
**Reads:**
- Incoming webhook payload (event type, status, transaction reference, amount)
- Order record (matched by transaction reference)
- Cook's commission rate
- Existing transaction records (for idempotency check)

**Creates:**
- Transaction record (payment type, amount, reference, status)
- Wallet transaction for cook (credit, unwithdrawable)
- Commission transaction record
- Activity log entry

**Updates:**
- Order status (to "Paid" or "Payment Failed")
- Cook wallet balance (credit on success)

**Relationships:**
- Receives events from Flutterwave initiated by F-150
- On failure, triggers F-152 (Payment Retry with Timeout)
- On success, enables F-154 (Payment Receipt & Confirmation)
- Cook wallet managed by wallet features (F-166, etc.)

---

## Acceptance Criteria
- **Given** a valid `charge.completed` webhook with success status, **when** processed, **then** the order status is "Paid"
- **Given** a successful payment, **when** processed, **then** the cook's wallet is credited with the correct amount
- **Given** a successful payment, **when** processed, **then** the commission is recorded separately
- **Given** a failed charge, **when** processed, **then** the order status is "Payment Failed"
- **Given** a duplicate webhook for the same transaction, **when** processed, **then** no duplicate records are created
- **Given** an invalid webhook signature, **when** received, **then** a 401 response is returned

---

## Verification Steps
1. Simulate a successful Flutterwave webhook and verify order status changes to "Paid"
2. Verify cook wallet is credited with the correct amount (order total - commission)
3. Verify commission is recorded in the transaction records
4. Verify the wallet credit is marked as "unwithdrawable"
5. Simulate a failed webhook and verify order status changes to "Payment Failed"
6. Send the same webhook twice and verify idempotent handling
7. Send a webhook with invalid signature and verify 401 rejection
8. Check the activity log for webhook processing entries

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Webhook arrives before order is fully created | Queue the webhook; retry after a short delay |
| Transaction reference not found in database | Log as orphan; return 200 to prevent retries |
| Webhook payload malformed | Log error; return 200 to prevent retries |
| Commission rate is 0% (no commission) | Cook receives full amount; no commission record |
| Very large payment amount | Handled normally; no upper limit on processing |
| Network timeout during webhook processing | Flutterwave retries; idempotency prevents duplicates |

---

## UI/UX Notes
- No direct UI; this is a backend-only endpoint
- Client's "Waiting for payment" UI is updated via Gale SSE when webhook is processed
- On success: client is redirected to F-154 (Payment Receipt & Confirmation)
- On failure: client sees the failure message and retry options (F-152)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-150 | Flutterwave Payment Initiation | Source of the payment that triggers this webhook |
| F-152 | Payment Retry with Timeout | Triggered on payment failure |
| F-154 | Payment Receipt & Confirmation | Shown to client after successful payment |
| F-166 | Client Wallet | Wallet credited on successful payment |
