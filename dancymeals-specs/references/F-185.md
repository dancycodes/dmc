# F-185 — Complaint Auto-Escalation

> Module: Complaint
> Priority: Must-have
> Precedence: F-184
> Type: functional

---

## What It Does
A scheduled job runs periodically (every 15 minutes) to check for open complaints that have not received a cook response within 24 hours of submission. When such complaints are found, the system automatically escalates them: the complaint status changes to "escalated," the admin team is notified, the client is notified that their complaint has been escalated for review, and the cook is notified that they failed to respond in time. This ensures no complaint goes unaddressed.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Scheduled job runs automatically to detect and escalate overdue complaints |
| Admin | Receives notification of escalated complaints for manual resolution |
| Client | Receives notification that their complaint was escalated |
| Cook | Receives notification that their complaint was auto-escalated due to no response |

---

## User Scenarios
### Scenario 1: Complaint escalated after 24 hours
A client filed a complaint at 2:00 PM yesterday. The cook did not respond. At approximately 2:00 PM today (when the scheduled job runs), the system detects the complaint is overdue, changes its status to "escalated," and sends notifications to the admin, client, and cook.

### Scenario 2: Cook responded in time — no escalation
A client filed a complaint at 10:00 AM. The cook responded at 4:00 PM the same day (6 hours later). When the escalation job runs after the 24-hour mark, it skips this complaint because the cook has already responded and the status is "in_review."

### Scenario 3: Multiple complaints escalated at once
Three complaints from different tenants have all passed the 24-hour window without cook responses. The scheduled job escalates all three in a single run, sending individual notifications to each relevant party.

### Scenario 4: Complaint already resolved before escalation
A complaint was filed 20 hours ago. The cook responded and the admin resolved it within 24 hours. The escalation job skips this complaint because its status is "resolved."

---

## Business Rules
| Code | Rule |
|------|------|
| BR-207 | The escalation job runs as a Laravel scheduled command every 15 minutes |
| BR-208 | A complaint is eligible for escalation if its status is "open" and more than 24 hours have passed since `created_at` |
| BR-209 | Complaints with status "in_review," "escalated," or "resolved" are never escalated |
| BR-210 | On escalation, the complaint status changes from "open" to "escalated" |
| BR-211 | Admin users receive push + DB notification for each escalated complaint |
| BR-212 | Client receives push + DB notification that their complaint was escalated to platform administration |
| BR-213 | Cook receives push + DB notification that their complaint was auto-escalated due to non-response |
| BR-214 | Escalation is logged via Spatie Activitylog with the system as the actor |
| BR-215 | The escalation job must be idempotent — running it multiple times does not re-escalate already-escalated complaints |
| BR-216 | If the cook responds after escalation, the complaint remains in "escalated" status (only admin can resolve) |

---

## Data Involved
**Creates:**
- Notifications (push + DB) for admin, client, and cook per escalated complaint

**Reads:**
- `complaints` table filtered by status "open" and `created_at` older than 24 hours
- `users` table for admin users, complaint client, and tenant cook

**Updates:**
- `complaints.status` from "open" to "escalated"
- `complaints.escalated_at` timestamp set to current time

**Relationships:**
- Complaint belongsTo Order (for context in notifications)
- Complaint belongsTo Tenant (to identify the cook)
- Complaint belongsTo User (client)

---

## Acceptance Criteria
- **Given** an open complaint older than 24 hours, **when** the escalation job runs, **then** its status changes to "escalated"
- **Given** a complaint with status "in_review," **when** the escalation job runs, **then** it is not escalated
- **Given** escalation occurs, **when** the admin checks notifications, **then** they see a notification for the escalated complaint
- **Given** escalation occurs, **when** the client checks notifications, **then** they see a notification that their complaint was escalated
- **Given** escalation occurs, **when** the cook checks notifications, **then** they see a notification about the auto-escalation
- **Given** the escalation job has already run, **when** it runs again, **then** already-escalated complaints are not processed again

---

## Verification Steps
1. Create a complaint and manually set `created_at` to 25 hours ago with status "open"
2. Run the escalation command and confirm the complaint status changes to "escalated"
3. Verify admin, client, and cook all receive notifications
4. Run the escalation command again and confirm no duplicate processing
5. Create a complaint with status "in_review" older than 24 hours; confirm it is not escalated
6. Create a complaint less than 24 hours old; confirm it is not escalated
7. Verify `escalated_at` timestamp is set on the complaint
8. Check activity log for the escalation entry with system as actor

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| No admin users exist in the system | Escalation still occurs; notification delivery fails silently but complaint status updates |
| Hundreds of complaints eligible for escalation | Job processes in batches to avoid memory/timeout issues |
| Scheduled job fails mid-execution | Already-escalated complaints in this batch retain their status; remaining are picked up on next run |
| Cook responds seconds before escalation job runs | If response is committed before the job queries, complaint is skipped |
| Complaint was filed exactly 24 hours ago | Eligible for escalation (>= 24 hours) |
| Database timezone mismatch | All time comparisons use UTC |

---

## UI/UX Notes
- No direct user-facing UI for the escalation process itself
- Escalated complaints appear with a distinct "Escalated" status badge (red/orange) in the admin panel, cook dashboard, and client complaint view
- Admin notification includes a direct link to the complaint in the admin panel
- Client notification message: "Your complaint has been escalated to our support team for review"
- Cook notification message: "A complaint on order #[ID] was escalated because no response was provided within 24 hours"

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-183 | Client Complaint Submission | Creates the complaints that may be escalated |
| F-184 | Cook/Manager Complaint Response | Responding cancels escalation for that complaint |
| F-187 | Complaint Status Tracking | Shows "escalated" status to both parties |
| F-193 | Complaint Notifications | Notification channel details for escalation events |
