# F-152 â€” Payment Retry with Timeout

> Module: Payment
> Priority: Must-have
> Precedence: F-150
> Type: edge-case

---

## What It Does
Handles payment failure scenarios by providing a retry mechanism within a 15-minute window. When a payment fails (timeout, insufficient funds, wrong PIN, or other errors), the client sees the error reason and can retry the payment. The order remains in "Pending Payment" status during the retry window. A visible countdown timer shows the remaining time. After 15 minutes, if no successful payment has been made, the order auto-expires and is cancelled. A maximum of 3 retry attempts is allowed.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client (authenticated) | Sees payment failure, retries within the allowed window |
| System | Monitors the retry window and auto-cancels expired orders |

---

## User Scenarios
### Scenario 1: Retry after insufficient funds
The client's MTN MoMo payment fails with "Insufficient funds." They see: "Payment failed: Insufficient funds. You have 14:23 remaining to retry." They add funds to their MoMo account, click "Retry Payment," and the payment is re-initiated successfully.

### Scenario 2: Retry after wrong PIN
The client entered the wrong PIN on the USSD prompt. The failure reason shows: "Transaction declined." They click "Retry Payment" and enter the correct PIN on the second USSD prompt.

### Scenario 3: Retry limit reached
The client has failed 3 times. The retry button is disabled. A message shows: "Maximum retry attempts reached. Your order has been cancelled." They can start a new order if desired.

### Scenario 4: Timeout expiration
The client's payment fails. They see the retry option with a 15-minute countdown. They do not retry. The countdown reaches 00:00. The order is automatically cancelled. The UI updates to show: "Order expired. Payment was not completed within the allowed time."

### Scenario 5: Successful retry
After one failure, the client retries. The second attempt succeeds. The order status changes to "Paid" and the client is redirected to the confirmation page (F-154).

---

## Business Rules
| Code | Rule |
|------|------|
| BR-376 | On payment failure, the order remains in "Pending Payment" status for the retry window |
| BR-377 | The retry window is 15 minutes from the initial payment attempt |
| BR-378 | A visible countdown timer shows the remaining retry time |
| BR-379 | Maximum 3 retry attempts allowed per order |
| BR-380 | Each retry attempt creates a new Flutterwave charge with the same order details |
| BR-381 | After 15 minutes without successful payment, the order is auto-cancelled |
| BR-382 | Auto-cancellation is handled by a scheduled job or timeout mechanism |
| BR-383 | The failure reason from Flutterwave is displayed to the client |
| BR-384 | After retry limit is reached, the "Retry" button is disabled |
| BR-385 | Cancelled orders release any held stock/availability |
| BR-386 | All text and error messages must be localized via `__()` |

---

## Data Involved
**Reads:**
- Order payment status and attempt count
- Flutterwave failure reason
- Retry window start time

**Creates:**
- New Flutterwave charge on each retry attempt
- Updated transaction records per attempt

**Updates:**
- Order retry count
- Order status to "Cancelled" on timeout/limit
- Transaction records with retry attempt details

**Relationships:**
- Triggered by payment failure from F-150 (Flutterwave Payment Initiation) or F-151 (Webhook)
- On successful retry, leads to F-154 (Payment Receipt & Confirmation)
- Auto-cancellation restores availability

---

## Acceptance Criteria
- **Given** a payment failure, **when** the failure is displayed, **then** the error reason and retry option are shown
- **Given** the retry window is active, **when** viewing the page, **then** a countdown timer is visible
- **Given** the client clicks "Retry Payment", **when** the retry initiates, **then** a new Flutterwave charge is created
- **Given** 3 failed attempts, **when** the limit is reached, **then** the retry button is disabled and the order is cancelled
- **Given** no successful payment within 15 minutes, **when** the timer expires, **then** the order is auto-cancelled
- **Given** a successful retry, **when** the payment confirms, **then** the client is redirected to the confirmation page

---

## Verification Steps
1. Simulate a payment failure and verify the error message and retry option display
2. Verify the 15-minute countdown timer is visible and counting down
3. Click "Retry Payment" and verify a new charge is initiated
4. Simulate 3 failures and verify the retry button is disabled
5. Wait for the timeout to expire and verify the order is auto-cancelled
6. Retry successfully and verify redirect to confirmation page
7. Check that auto-cancelled orders release held stock

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Client closes browser during retry window | Timer continues server-side; order auto-cancels on timeout |
| Client returns to the page within the retry window | Timer reflects the correct remaining time |
| Payment succeeds but webhook arrives after timeout | If order was already cancelled, payment is refunded automatically |
| Flutterwave API is down during retry | Show error: "Payment service temporarily unavailable" |
| Client tries to start a new order while retry window is active | Allowed; previous order auto-cancels on timeout |

---

## UI/UX Notes
- Failure message displayed in a prominent alert/card with the reason
- Countdown timer in large, visible format (MM:SS)
- "Retry Payment" button prominently displayed
- Retry attempt counter: "Attempt 2 of 3"
- After max retries: button disabled with explanatory text
- After timeout: order cancelled message with "Start New Order" option
- Client can choose a different payment method on retry
- "Cancel Order" option available at any time during retry window

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-150 | Flutterwave Payment Initiation | Source of payment attempts |
| F-151 | Payment Webhook Handling | Processes retry payment results |
| F-154 | Payment Receipt & Confirmation | Shown on successful retry |
