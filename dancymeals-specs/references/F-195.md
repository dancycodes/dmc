# F-195 â€” System Announcement Notifications

> Module: Notification
> Priority: Should-have
> Precedence: F-014, F-015, F-043
> Type: functional

---

## What It Does
Allows admins to send announcement notifications to targeted groups of users from the admin panel. The admin writes the announcement text, selects the target audience (all users, all cooks, all clients, or a specific tenant's users), and chooses to send immediately or schedule for a future date/time. Announcements are delivered via all three channels: push, database, and email. This enables platform-wide communication for maintenance notices, feature announcements, policy updates, and promotional messages.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Admin | Creates and sends/schedules announcements from the admin panel |
| All Users | Receive announcements based on targeting criteria |

---

## User Scenarios
### Scenario 1: Announce to all users
The admin writes "DancyMeals will undergo maintenance on Saturday from 2 AM to 4 AM. Orders placed before 2 AM will be processed normally." They select "All Users" as the target and click "Send Now." All users receive push + DB + email.

### Scenario 2: Announce to all cooks
The admin writes "New feature: You can now set promo codes for your meals! Visit your dashboard to get started." They target "All Cooks" and send immediately. Only users with the cook role receive the announcement.

### Scenario 3: Announce to a specific tenant
The admin writes a message for a specific cook's team: "Your account has been flagged for review. Please contact support." They select the specific tenant. Only the cook and managers of that tenant receive it.

### Scenario 4: Schedule a future announcement
The admin schedules an announcement for next Monday at 9:00 AM targeting all clients about a promotional offer. The announcement is saved as "Scheduled" and will be dispatched automatically at the specified time.

### Scenario 5: View sent announcements
The admin navigates to the announcements section and sees a list of past and scheduled announcements with their status (Sent, Scheduled, Draft), target audience, and send date.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-311 | Only admins (users with admin or super-admin role) can create announcements |
| BR-312 | Target audience options: all_users, all_cooks, all_clients, specific_tenant |
| BR-313 | For specific_tenant targeting, admin selects a tenant from a searchable dropdown |
| BR-314 | Announcement text is required, maximum 2000 characters |
| BR-315 | All three channels are used: push + DB + email |
| BR-316 | Immediate send dispatches notifications via queue |
| BR-317 | Scheduled announcements are stored and dispatched by a scheduled job at the specified time |
| BR-318 | Scheduled time must be in the future (minimum 5 minutes from now) |
| BR-319 | Email subject: "DancyMeals Announcement" with the first line of the announcement as preview |
| BR-320 | Announcements are logged via Spatie Activitylog with the admin as actor |
| BR-321 | All user-facing text must use `__()` localization |
| BR-322 | Admin can cancel a scheduled announcement before it is sent |

---

## Data Involved
**Creates:**
- `announcements` table record: `id`, `user_id` (admin), `content` (text), `target_type` (enum), `target_id` (nullable, for specific tenant), `status` (draft, scheduled, sent), `scheduled_at` (nullable timestamp), `sent_at` (nullable timestamp), `created_at`
- Push notifications to target users
- DB notification records for target users
- Emails to target users

**Reads:**
- `users` table filtered by target criteria (role, tenant association)
- `tenants` table for specific tenant targeting
- `announcements` table for list view

**Updates:**
- `announcements.status` from "scheduled" to "sent" when dispatched
- `announcements.sent_at` timestamp set on dispatch

**Relationships:**
- Announcement belongsTo User (admin who created it)
- Announcement optionally belongsTo Tenant (for specific tenant targeting)

---

## Acceptance Criteria
- **Given** an admin on the announcements page, **when** they write content and select "All Users," **then** the announcement is sent to all users via push + DB + email
- **Given** "All Cooks" targeting, **when** sent, **then** only users with the cook role receive the notification
- **Given** a specific tenant target, **when** sent, **then** only the cook and managers of that tenant receive it
- **Given** a scheduled announcement, **when** the scheduled time arrives, **then** it is dispatched automatically
- **Given** a scheduled announcement, **when** the admin cancels it before dispatch, **then** it is not sent
- **Given** the announcement list, **when** viewed, **then** past and scheduled announcements are displayed

---

## Verification Steps
1. Send an announcement to "All Users" and verify all users receive push + DB + email
2. Send to "All Cooks" and verify only cooks receive it
3. Send to "All Clients" and verify only clients receive it
4. Send to a specific tenant and verify only that tenant's cook and managers receive it
5. Schedule an announcement for 5 minutes in the future and verify it dispatches on time
6. Cancel a scheduled announcement and verify it is not sent
7. View the announcements list and confirm status, target, and timestamps are correct
8. Check activity log for the announcement creation

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| No users match the target criteria | Announcement saved but no notifications sent; admin informed |
| Very large user base (thousands) | Notifications dispatched in batches via queue to prevent timeouts |
| Scheduled time in the past | Validation error: "Scheduled time must be in the future" |
| Admin edits a scheduled announcement | Content and target can be modified until dispatch |
| Email delivery partially fails | Push and DB still delivered to all; email failures logged |
| Announcement text contains HTML | Sanitized; displayed as plain text in push/DB, rendered safely in email |

---

## UI/UX Notes
- Announcements section in the admin panel sidebar
- Create form: rich text area for content, target audience radio buttons, schedule toggle with date/time picker
- "Send Now" button (primary) and "Schedule" button (secondary)
- Announcements list: table with columns for content preview, target, status badge, date, actions
- Status badges: Draft (gray), Scheduled (blue), Sent (green)
- Cancel button on scheduled announcements with confirmation dialog
- Preview option before sending
- All interactions via Gale (no page reload)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-014 | PWA & Push Notification Infrastructure | Push delivery mechanism |
| F-015 | Notification Center | Displays DB notifications |
| F-043 | Admin Panel Layout | Admin panel where announcements are managed |
