# F-167 — Client Wallet Refund Credit

> Module: Wallet
> Priority: Must-have
> Precedence: F-166
> Type: functional

---

## What It Does
Credits a refund amount to the client's wallet when a refund is processed, either from order cancellation (F-163) or admin complaint resolution (F-061). The wallet balance is incremented, a wallet transaction record is created, and the client is notified via push, database, and email notifications. This is a server-side operation triggered by other features, not a user-facing action.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| System | Credits the wallet automatically when a refund is triggered |
| Client | Receives the credit and sees updated balance in their wallet |

---

## User Scenarios
### Scenario 1: Refund from order cancellation
The client cancels an order worth 5,000 XAF. The cancellation refund process (F-163) calls this feature. The client's wallet balance increases by 5,000 XAF. A transaction record is created: type "refund," amount "+5,000 XAF," description "Refund for Order #ORD-1234." The client receives notifications.

### Scenario 2: Refund from complaint resolution
An admin resolves a complaint in the client's favor and issues a partial refund of 2,000 XAF. This feature credits 2,000 XAF to the client's wallet. Transaction record: type "refund," amount "+2,000 XAF," description "Complaint resolution refund for Order #ORD-5678."

### Scenario 3: First-ever refund (wallet does not exist yet)
A client has never visited their wallet page, so no wallet record exists. The refund is processed, the wallet is lazily created with the refund amount as the initial balance.

### Scenario 4: Multiple refunds
The client receives two refunds in quick succession. Each is processed independently. The wallet balance reflects the sum of both. Two separate transaction records are created.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-290 | Refund credits increase the client wallet balance by the refund amount |
| BR-291 | A wallet transaction record is created for each refund with type "refund" |
| BR-292 | The transaction record includes: amount, type, description, order reference, timestamp |
| BR-293 | If no wallet exists for the client, one is created with the refund as initial balance |
| BR-294 | Wallet balance cannot go negative (refunds only add) |
| BR-295 | Client is notified of the refund via push + DB + email |
| BR-296 | The notification includes the refund amount and the order reference |
| BR-297 | Refund credit operations are atomic (database transaction) |
| BR-298 | Refund credit is logged via Spatie Activitylog |

---

## Data Involved
**Reads:**
- `client_wallets` table for current balance (or check if wallet exists)
- Order data for the refund reference

**Creates:**
- `client_wallets` record if none exists
- Wallet transaction record (type: refund, credit)
- Notifications (push, DB, email)
- Activity log entry

**Updates:**
- `client_wallets.balance` incremented by refund amount

**Relationships:**
- Wallet belongsTo User (client)
- WalletTransaction belongsTo Wallet
- WalletTransaction references Order

---

## Acceptance Criteria
- **Given** a refund is triggered, **when** this feature processes it, **then** the client's wallet balance increases by the refund amount
- **Given** no wallet exists, **when** a refund is processed, **then** a wallet is created with the refund as the initial balance
- **Given** the refund is processed, **when** checking transactions, **then** a new refund transaction record exists
- **Given** the refund is processed, **when** checking notifications, **then** the client received push, DB, and email notifications
- **Given** two concurrent refunds, **when** both process, **then** both are applied correctly without race conditions

---

## Verification Steps
1. Trigger a cancellation refund and verify wallet balance increases
2. Trigger a complaint resolution refund and verify wallet balance increases
3. Verify a wallet transaction record is created with correct details
4. Verify the client receives all three notification types
5. Test with a client who has no wallet — verify wallet is created
6. Trigger two refunds rapidly and verify both are applied correctly
7. Check the activity log for the refund entry

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Refund amount is 0 XAF | Transaction record created but balance unchanged; notifications still sent |
| Database error during credit | Transaction rolls back; refund retried or flagged for admin |
| Concurrent refund and wallet payment | Atomic operations prevent balance inconsistencies |
| Extremely large refund amount | No upper limit; wallet balance updated correctly |

---

## UI/UX Notes
- No dedicated UI; this is a server-side operation
- Results visible on:
  - Client wallet dashboard (F-166): updated balance and new transaction
  - Client notifications: refund notification
  - Email: refund confirmation email

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-166 | Client Wallet Dashboard | Displays the updated balance |
| F-163 | Order Cancellation Refund Processing | Triggers this feature for cancellation refunds |
| F-061 | Admin Complaint Resolution | Triggers this feature for complaint refunds |
| F-164 | Client Transaction History | Refund transactions appear here |
| F-168 | Client Wallet Payment for Orders | Uses the balance credited here |
