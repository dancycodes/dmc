# F-097 â€” OpenStreetMap Neighbourhood Search

> Module: Location
> Priority: Must-have
> Precedence: F-003
> Type: functional

---

## What It Does

Integrates with the OpenStreetMap Nominatim API to provide an autocomplete/search component for neighbourhood-level location selection. When a user types a location name, the component queries Nominatim with results scoped to Cameroon and displays matching neighbourhoods, quarters, and areas. This component is used during the ordering process for clients to specify their exact delivery address within a cook's quarter, and in other location-related features where precise address entry benefits from autocomplete suggestions.

---

## Who Uses It

| Role | Interaction |
|------|-------------|
| Client | Searches for their delivery neighbourhood when placing an order |
| Cook | May use to verify locations or add precise addresses to pickup locations |

---

## User Scenarios

### Scenario 1: Client enters delivery address
A client is placing an order and reaches the delivery address step. They start typing "Bonab" in the address field. After typing 3 characters, an autocomplete dropdown appears showing: "Bonaberi, Douala, Cameroon", "Bonaberi Sector, Douala, Cameroon." They select "Bonaberi, Douala, Cameroon." The address field fills with the selected location.

### Scenario 2: Narrow search results
A client types "Akwa Douala" to narrow results. The dropdown shows locations matching both "Akwa" and "Douala" in Cameroon.

### Scenario 3: No matching results
A client types "xyzabc" with no matching results. The dropdown shows: "No locations found. Try a different search term."

### Scenario 4: Select and refine
A client selects "Bonaberi, Douala" from autocomplete, then manually adds details in a separate field: "Near Total station, opposite the pharmacy." The autocomplete provides the neighbourhood; the client adds specifics.

### Scenario 5: Slow or offline API
The Nominatim API is slow or unreachable. The autocomplete shows a loading state for up to 3 seconds, then shows: "Unable to search locations. Please type your address manually." The address field remains usable for manual input.

---

## Business Rules

| Code | Rule |
|------|------|
| BR-315 | Nominatim API queries are scoped to Cameroon (countrycodes=cm) |
| BR-316 | Autocomplete triggers after 3+ characters are typed |
| BR-317 | Input is debounced at 400ms to respect Nominatim rate limits |
| BR-318 | Nominatim usage policy: maximum 1 request per second, include a valid User-Agent |
| BR-319 | Results are displayed as a dropdown list below the input field |
| BR-320 | Selected result fills the address field; user can still edit manually |
| BR-321 | The component is reusable across any feature needing location search |
| BR-322 | API requests are made server-side (through a Laravel endpoint) to avoid CORS and control rate limiting |
| BR-323 | If the API is unavailable, the field degrades gracefully to manual text input |
| BR-324 | No API key is required for Nominatim (free tier), but rate limits must be respected |

---

## Data Involved

**Reads (external):**
- OpenStreetMap Nominatim API: `/search` endpoint with parameters:
  - `q`: search query
  - `countrycodes`: `cm` (Cameroon)
  - `format`: `jsonv2`
  - `addressdetails`: `1`
  - `limit`: `5`

**Creates:**
- Nothing (component provides input data; consuming features handle storage)

**Updates:**
- Nothing

---

## Acceptance Criteria

- **Given** the search component, **when** a user types 3+ characters, **then** autocomplete suggestions appear from Nominatim scoped to Cameroon
- **Given** matching results, **when** the dropdown renders, **then** up to 5 location suggestions are shown
- **Given** a selected result, **when** clicked, **then** the address field fills with the location name
- **Given** no matching results, **when** the query runs, **then** a "No locations found" message is shown
- **Given** the API is unavailable, **when** the request times out, **then** the field allows manual input with a friendly message
- **Given** rapid typing, **when** characters are entered, **then** requests are debounced at 400ms

---

## Verification Steps

1. Type "Douala" and confirm Cameroon-specific results appear
2. Type "Bonaberi" and confirm neighbourhood-level results
3. Select a result and confirm the address field is populated
4. Type a nonsensical string and confirm "No locations found"
5. Verify requests are debounced (network tab shows delay between keystrokes and requests)
6. Simulate API timeout and confirm graceful degradation to manual input
7. Verify the User-Agent header is set on API requests

---

## Edge Cases & Exceptions

| Condition | Expected Behavior |
|-----------|-------------------|
| User types exactly 2 characters | No API request; wait for 3rd character |
| API returns results outside Cameroon | Should not happen with countrycodes=cm; filter client-side if needed |
| Nominatim rate limit hit (429 response) | Retry after delay; show "Try again in a moment" |
| User pastes a full address (many characters at once) | Single debounced request fires with full pasted text |
| Non-Latin characters in search | UTF-8 encoding; Nominatim handles multilingual queries |
| Multiple instances of the component on one page | Each operates independently with separate debounce timers |

---

## UI/UX Notes

- Search input field with magnifying glass or map pin icon
- Dropdown appears below the field with a subtle shadow/border
- Each suggestion shows: primary name, area/city, "Cameroon" (formatted from address details)
- Clicking outside the dropdown closes it
- Loading spinner in the input field during API request
- Selected suggestion highlighted in the dropdown on keyboard navigation (arrow keys + Enter)
- The component is a Blade component for reuse: `<x-location-search />`
- Mobile: dropdown is full-width; suggestions are touch-friendly (adequate tap targets)
- Accessible: keyboard navigation, screen reader labels, ARIA attributes

---

## Related Features

| Code | Feature | Relationship |
|------|---------|-------------|
| F-003 | Core Package Installation | Project must have base packages and HTTP client configured |
| F-092 | Add Pickup Location | May use this component for address entry |
| F-074 | Delivery Areas Step | May use for location suggestions during onboarding |
