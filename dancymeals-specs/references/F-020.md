# F-020 â€” Testing Infrastructure

> Module: Foundation
> Priority: Must-have
> Precedence: F-003
> Type: foundation

---

## What It Does
Configures the complete testing infrastructure for DancyMeals. Sets up Pest as the testing framework with proper database configuration (PostgreSQL test database). Creates base test case classes with common helpers and traits. Verifies Playwright MCP is available for browser-based end-to-end testing. Creates an initial smoke test that confirms the application loads successfully. Configures test factories and the base setup so every subsequent feature can write meaningful tests immediately.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Developer | Writes and runs Pest feature/unit tests and Playwright browser tests |
| CI/CD pipeline | Executes the test suite automatically on commits/PRs |

---

## User Scenarios
### Scenario 1: Running the initial smoke test
The developer runs `php artisan test` after setup. The smoke test verifies the application boots, the home page returns a 200 status, and the database connection is functional. All tests pass with green output.

### Scenario 2: Creating a new feature test
A developer implements a new feature and creates a test using `php artisan make:test --pest MealCreationTest`. The test extends the base test case, uses the test database, and has access to factories and helper methods.

### Scenario 3: Database isolation between tests
Each test runs within a database transaction that is rolled back after the test completes. This ensures test isolation -- no test's data affects another test.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-160 | Pest is the only testing framework (no PHPUnit direct usage) |
| BR-161 | Tests must run against a dedicated PostgreSQL test database (`dancymeals_test`) |
| BR-162 | Each test must be isolated: database state is reset between tests |
| BR-163 | Use `RefreshDatabase` trait (or Pest equivalent) for database isolation |
| BR-164 | Test factories must be created for every model (established in each feature's implementation) |
| BR-165 | Browser tests use Playwright MCP (not Laravel Dusk) |
| BR-166 | All tests must pass before any feature is considered complete |
| BR-167 | Feature tests are the default; unit tests are used for isolated business logic |
| BR-168 | Tests must use existing factories and their states rather than manual model setup |
| BR-169 | The `fake()` helper is preferred for test data generation (follow project convention) |

---

## Data Involved
**Creates:**
- `phpunit.xml` configuration with PostgreSQL test database settings
- `tests/Pest.php` configuration file
- `tests/TestCase.php` base test case with common setup
- `tests/Feature/SmokeTest.php` initial smoke test
- `tests/Helpers/` directory for shared test utilities (if needed)
- `.env.testing` with test database credentials

**Reads:**
- `.env.testing` for test environment configuration
- `phpunit.xml` for test suite configuration
- Factory definitions for model creation in tests

**Updates:**
- `phpunit.xml` with PostgreSQL test database connection
- `tests/Pest.php` with base test case binding and common uses
- `.env.testing` with `DB_DATABASE=dancymeals_test` and other test-specific values

**Relationships:**
- Every subsequent feature creates tests using this infrastructure
- F-002 provides the test database configuration

---

## Acceptance Criteria
- **Given** the testing infrastructure is set up, **when** running `php artisan test`, **then** all tests pass (including the smoke test)
- **Given** the smoke test, **when** executed, **then** it verifies the home page returns HTTP 200
- **Given** a test with database operations, **when** the test completes, **then** the database is restored to its pre-test state
- **Given** `.env.testing`, **when** inspecting its values, **then** `DB_DATABASE` is set to `dancymeals_test`
- **Given** `tests/Pest.php`, **when** inspected, **then** it binds the base test case and configures common traits
- **Given** the Playwright MCP server, **when** checking its availability, **then** it can be used for browser automation tests

---

## Verification Steps
1. Run `php artisan test` and confirm the smoke test passes
2. Verify `.env.testing` exists with `DB_DATABASE=dancymeals_test`
3. Inspect `phpunit.xml` and confirm the PostgreSQL test database is configured
4. Create a test that inserts a database record, then run another test and confirm the record does not exist (isolation)
5. Verify `tests/Pest.php` is configured with the base test case
6. Run a quick Playwright command to verify MCP availability
7. Confirm `php artisan make:test --pest ExampleTest` creates a valid Pest test file

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Test database does not exist | Tests fail with a clear connection error; developer creates the test database |
| Test database has pending migrations | `RefreshDatabase` trait runs migrations before tests |
| Parallel test execution | Tests are isolated via transactions; parallel execution supported if configured |
| Playwright MCP not available | Browser tests are skipped with a clear message; Pest tests still run |
| Factory not defined for a model | Test fails with a clear error indicating the missing factory |
| Test modifies `.env` values | Tests should use `config()` overrides, not modify `.env` directly |

---

## UI/UX Notes
No user-facing UI. This is a developer-only infrastructure feature.

Test output conventions:
- Use `--compact` flag for concise output during development
- Use `--filter` to run specific tests during feature development
- Aim for descriptive test names: `it('creates a meal with valid data')`, not `test_meal_1`

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-002 | Database Configuration | Provides the test database setup |
| F-003 | Core Package Installation | Prerequisite; Pest must be installed |
| Every feature | All features | All features create tests using this infrastructure |
