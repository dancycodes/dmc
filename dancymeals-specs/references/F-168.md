# F-168 — Client Wallet Payment for Orders

> Module: Wallet
> Priority: Must-have
> Precedence: F-166, F-063
> Type: functional

---

## What It Does
When enabled by the admin (via platform settings F-063), allows clients to use their wallet balance to pay for orders at checkout. The wallet appears as a payment option alongside mobile money methods. Clients can pay the full order amount from their wallet, or use a partial wallet payment combined with mobile money for the remainder. Wallet balance cannot be withdrawn; it can only be used for future orders.

---

## Who Uses It
| Role | Interaction |
|------|-------------|
| Client | Uses wallet balance to pay for orders at checkout |
| Admin | Enables or disables the wallet payment feature via platform settings |

---

## User Scenarios
### Scenario 1: Full wallet payment
The client has 5,000 XAF in their wallet. Their order total is 3,000 XAF. At checkout, the wallet option shows "Pay from Wallet (Balance: 5,000 XAF)." The client selects it and confirms. The order is paid entirely from the wallet. New wallet balance: 2,000 XAF.

### Scenario 2: Partial wallet + mobile money
The client has 2,000 XAF in their wallet. Their order total is 5,000 XAF. At checkout, the wallet option shows "Use Wallet Balance (2,000 XAF) + Mobile Money (3,000 XAF)." The client selects it and is redirected to Flutterwave to pay the remaining 3,000 XAF via mobile money.

### Scenario 3: Insufficient wallet balance
The client has 500 XAF in their wallet. Their order total is 5,000 XAF. The wallet option shows: "Use Wallet Balance (500 XAF) + Mobile Money (4,500 XAF)." The client can choose to use the partial amount or skip wallet payment entirely.

### Scenario 4: Wallet payment disabled
The admin has disabled wallet payments. At checkout, the wallet option does not appear. Only mobile money payment methods are available.

### Scenario 5: Zero wallet balance
The client's wallet balance is 0 XAF. The wallet payment option is hidden at checkout (nothing to pay with).

### Scenario 6: Full wallet payment — no Flutterwave needed
The client has enough wallet balance to cover the entire order. No Flutterwave redirect is needed. The payment is processed immediately, and the order status moves to Paid.

---

## Business Rules
| Code | Rule |
|------|------|
| BR-299 | Wallet payment is only available when enabled by admin via platform settings (F-063) |
| BR-300 | Wallet payment option is hidden when wallet balance is 0 XAF |
| BR-301 | Client can pay fully from wallet if balance is sufficient |
| BR-302 | Client can pay partially from wallet + remainder via mobile money |
| BR-303 | Wallet deduction happens atomically as part of the payment process |
| BR-304 | For full wallet payments, no Flutterwave redirect is needed; order moves to Paid immediately |
| BR-305 | For partial wallet payments, the mobile money portion goes through Flutterwave |
| BR-306 | Wallet balance cannot go negative |
| BR-307 | A wallet transaction record is created (type: wallet_payment, debit) |
| BR-308 | If the mobile money portion of a partial payment fails, the wallet deduction is reversed |
| BR-309 | Wallet balance cannot be withdrawn to external methods; only used for orders |
| BR-310 | All user-facing text must use `__()` localization |

---

## Data Involved
**Reads:**
- `client_wallets` table for current balance
- Platform settings for wallet payment enabled/disabled
- Order total for amount comparison

**Creates:**
- Wallet transaction record (type: wallet_payment, debit)
- Payment record for the mobile money portion (if partial)

**Updates:**
- `client_wallets.balance` decremented by the wallet payment amount
- `orders.payment_method` to reflect wallet or wallet+mobile_money
- `orders.status` to Paid (for full wallet payments)

**Relationships:**
- Wallet belongsTo User (client)
- WalletTransaction belongsTo Wallet, references Order
- Partial payment integrates with F-150 (Flutterwave Payment Initiation)

---

## Acceptance Criteria
- **Given** wallet payments are enabled and the client has balance, **when** at checkout, **then** the wallet payment option is visible
- **Given** sufficient balance for the full order, **when** the client selects wallet payment, **then** the order is paid without Flutterwave redirect
- **Given** insufficient balance for the full order, **when** the client selects partial wallet, **then** they pay the remainder via mobile money
- **Given** wallet payments are disabled by admin, **when** at checkout, **then** the wallet option is not shown
- **Given** zero wallet balance, **when** at checkout, **then** the wallet option is hidden
- **Given** a partial payment where mobile money fails, **when** the failure occurs, **then** the wallet deduction is reversed

---

## Verification Steps
1. Enable wallet payments in admin settings
2. Add balance to a client's wallet (via a refund)
3. At checkout, verify the wallet payment option appears with correct balance
4. Complete a full wallet payment and verify no Flutterwave redirect, order moves to Paid
5. Complete a partial wallet + mobile money payment
6. Disable wallet payments and verify the option disappears at checkout
7. Test with zero balance and verify the option is hidden
8. Simulate a mobile money failure on partial payment and verify wallet deduction reversal

---

## Edge Cases & Exceptions
| Condition | Expected Behavior |
|-----------|-------------------|
| Wallet balance changes between checkout page load and payment | Server re-validates balance at payment time |
| Concurrent wallet payment and refund credit | Atomic operations prevent race conditions |
| Wallet balance exactly equals order total | Full wallet payment; balance becomes 0 XAF |
| Order total is 0 XAF (fully covered by promo) | No wallet deduction needed; order is free |
| Admin disables wallet payments while client is at checkout | Server validates setting at payment time; rejects wallet option |

---

## UI/UX Notes
- Wallet payment option appears in the payment method selection step (F-149)
- Shows wallet icon, current balance, and how much would be applied
- For partial payments: clear breakdown of "Wallet: X XAF + Mobile Money: Y XAF"
- Toggle or radio button to choose: "Use wallet balance" or "Pay full amount via mobile money"
- Balance display updates if the checkout amount changes
- Loading state while processing wallet payment
- Success toast for full wallet payments
- All interactions via Gale (no page reloads)

---

## Related Features
| Code | Feature | Relationship |
|------|---------|-------------|
| F-166 | Client Wallet Dashboard | Shows the wallet balance used here |
| F-063 | Platform Settings Management | Admin toggle for enabling/disabling wallet payments |
| F-149 | Payment Method Selection | Wallet appears as a payment option here |
| F-150 | Flutterwave Payment Initiation | Handles the mobile money portion of partial payments |
| F-167 | Client Wallet Refund Credit | Credits balance that can be spent here |
