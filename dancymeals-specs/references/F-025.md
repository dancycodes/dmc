# F-025 — User Logout

> Module: Auth
> Type: functional
> Priority: Must-have
> Precedence: F-024

---

## What It Does

Provides a logout action accessible from the navigation on any domain. Destroys the user's
session, logs the logout activity, and redirects the user to the home page of the current
domain. Works consistently across main and tenant domains.

---

## Who Uses It

- **Authenticated users** (any role) who want to end their session.

---

## User Scenarios

### Happy Path
1. Authenticated user clicks "Log Out" in the navigation menu.
2. The session is destroyed and the authentication cookie is invalidated.
3. The logout event is logged via Spatie Activitylog.
4. The user is redirected to the home page of the current domain.
5. Navigation updates to show unauthenticated state (login/register links).

### Alternate Path — Logout from Tenant Domain
1. User is authenticated and browsing a cook's tenant site.
2. User clicks "Log Out" in the tenant site navigation.
3. Session is destroyed.
4. User is redirected to the tenant's home/landing page.

### Alternate Path — Logout via Direct URL
1. User navigates directly to the logout URL.
2. If authenticated, the user is logged out and redirected.
3. If already unauthenticated, the user is redirected to the home page.

---

## Business Rules

| Code | Rule |
|------|------|
| BR-058 | Logout destroys the entire server-side session and invalidates the session cookie. |
| BR-059 | After logout, the user is redirected to the home page of the domain they logged out from. |
| BR-060 | The logout action must be a POST request (CSRF-protected), not a GET request. |
| BR-061 | Logout activity is logged via Spatie Activitylog (event: "logged_out"). |
| BR-062 | After logout, the user should not be able to access protected pages without re-authenticating. |
| BR-063 | Logout must work on any domain (main or tenant). |

---

## Data Involved

### Session (destroyed)
| Action | Details |
|--------|---------|
| Session invalidation | Server-side session data removed |
| Cookie removal | Session cookie invalidated |
| CSRF token | Regenerated |

### Activity Log (created)
| Field | Value |
|-------|-------|
| Event | "logged_out" |
| Subject | The user who logged out |
| Causer | The user who logged out |

---

## Acceptance Criteria

```
Given I am authenticated on the main domain
When I click "Log Out" in the navigation
Then my session is destroyed and I am redirected to the main home page

Given I am authenticated on a tenant domain
When I click "Log Out" in the navigation
Then my session is destroyed and I am redirected to the tenant's home page

Given I have logged out
When I try to access a protected page (e.g., /profile)
Then I am redirected to the login page

Given I log out
When the activity log is checked
Then a "logged_out" event is recorded for my user
```

---

## Verification Steps

1. Log in, then click "Log Out" — confirm redirect to the home page of the current domain.
2. After logout, try to access a protected route — confirm redirect to login.
3. Check the activity log for the "logged_out" event.
4. Verify the logout button sends a POST request (inspect the form or link).

---

## Edge Cases

- User's session has already expired — clicking logout should still redirect gracefully without errors.
- Double-clicking the logout button — should not cause errors; handle idempotently.
- Logout on a tenant domain while cross-domain sessions are active — session should be invalidated globally (see F-028).
- User has multiple tabs open — after logout, other tabs should show unauthenticated state on next interaction.

---

## UI/UX Notes

- The logout option is in the user dropdown menu in the navigation bar.
- On mobile, it is in the slide-out menu or user section.
- Logout is implemented as a form with a POST button, not a plain link.
- No confirmation dialog needed — logout is immediate.
- Full page reload is acceptable after logout (auth state change).

---

## Related Features

- **F-024** — User Login (the reverse of this feature)
- **F-028** — Cross-Domain Session Sharing (logout should invalidate across domains)
- **F-017** — Activity Logging Setup (logs the logout event)
- **F-016** — Base Layout & Responsive Navigation (provides the navigation where logout appears)
